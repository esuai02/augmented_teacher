# 룰과 온톨로지 균형점 설계 문서

**생성일**: 2025-11-26  
**시스템명**: AI 튜터 룰-온톨로지 통합 시스템  
**버전**: 1.0  
**기반**: DESIGN_DOCUMENT.md, Agent01 Onboarding 설계 원리

---

## 1. 개요

### 1.1 목적

실제 수업 상황에서 AI 튜터가 "실제 선생님처럼" 동작하기 위한 룰(Rule)과 온톨로지(Ontology)의 역할 분담 및 협업 설계.

### 1.2 핵심 개념: 역할 분담

| 구분 | **룰 (Rule)** | **온톨로지 (Ontology)** |
|------|--------------|------------------------|
| **역할** | "언제, 무엇을" (When & What) | "왜, 어떻게" (Why & How) |
| **특성** | 반응적, 즉각적, 결정적 | 맥락적, 관계적, 추론적 |
| **비유** | 선생님의 **반사 행동** | 선생님의 **경험 지식** |
| **예시** | "3초 멈춤 → 인지부하 의심 → 대기" | "이 학생은 추상 약함형 + 선행 부족 → 구체적 예시 우선" |

---

## 2. 사고 흐름 모델

```
┌─────────────────────────────────────────────────────────────┐
│                    실제 선생님의 사고 흐름                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [관찰] ──→ [패턴인식] ──→ [의도추론] ──→ [개입결정] ──→ [실행] │
│      │          │            │            │            │    │
│      ▼          ▼            ▼            ▼            ▼    │
│   온톨로지    룰+온톨로지    온톨로지       룰         룰+온톨로지│
│   (컨텍스트)  (조건매칭)   (Intent층)   (Action)    (피드백)  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 균형점 설계 원칙

### 원칙 1: "온톨로지가 맥락을, 룰이 행동을"

```yaml
# 온톨로지: 학생 상태 이해 (Context → Interpretation)
student_context:
  persona: "P009_추상약함형"
  current_concept: "유리수의 나눗셈"
  prerequisite_status: "분수 계산 불완전"
  emotional_state: "혼란"
  cognitive_load: "high"
  
# 룰: 즉각적 개입 결정 (Decision → Execution)
rule:
  condition: cognitive_load == "high" AND persona == "P009"
  action: "INT_3_3_구체적수대입"  # 문자→숫자 변환 시연
```

### 원칙 2: "룰은 빠르고 좁게, 온톨로지는 깊고 넓게"

| 적용 시점 | 룰 우선 | 온톨로지 우선 |
|-----------|---------|--------------|
| **즉시 반응 필요** | ✅ 계산 실수 즉시 교정 | |
| **패턴 감지** | ✅ 3초 멈춤 = 막힘 | |
| **원인 추론** | | ✅ 왜 막혔는지? (선행 부족? 추상 어려움?) |
| **전략 수립** | | ✅ 이 학생에게 맞는 교수법 선택 |
| **개입 실행** | ✅ 구체적 액션 선택 | |
| **장기 적응** | | ✅ 학생 프로파일 업데이트 |

### 원칙 3: "Will Layer가 최종 심판"

```yaml
will_layer:
  priority_1: "학생이 좌절하지 않도록 한다"
  priority_2: "핵심 개념을 확실히 이해하도록 한다"
  priority_3: "단원 간 연결성을 이해하도록 한다"

# 룰이 Will에 위배되면 온톨로지가 override
example:
  rule_suggests: "난이도 높은 문제로 도전"
  will_check: "현재 감정상태 = 좌절 직전"
  ontology_override: "작은 성공 만들기(INT_7_4) 먼저 실행"
```

---

## 4. 레이어별 구현 설계

### 4.1 Phase 1: 즉각 반응 레이어 (룰 중심)

**적용 위치**: `learning_interface.php`, `rule_evaluator.php`

```
필기 패턴 감지 → 룰 트리거:
- 3초 정지 → U2_R1 "인지 부하 대기" (INT_1_1)
- 반복 지우기 → "혼란 감지" (INT_5_7 메타인지 질문)
- 빠른 풀이 → "검증 필요" (INT_6_1 즉시 교정 대기)

제스처 입력 → 즉각 응답:
- ✓ → 다음 단계 진행
- ✗ → 재설명 트리거
- ? → 비침습적 질문 표시
```

**룰 정의 예시**:

```php
$immediate_rules = [
    [
        'rule_id' => 'IMM_R1_pause_detection',
        'priority' => 99,
        'conditions' => [
            ['field' => 'pause_duration', 'operator' => '>', 'value' => 3],
            ['field' => 'current_step', 'operator' => '!=', 'value' => 'completed']
        ],
        'action' => 'INT_1_1', // 인지 부하 대기
        'confidence' => 0.85
    ]
];
```

### 4.2 Phase 2: 맥락 이해 레이어 (온톨로지 중심)

**적용 위치**: `ontology_generator.php`

```
온톨로지가 담당할 영역:

1. 학생 프로파일 구축 (OIW Context Layer)
   - 페르소나 + 학습 이력 + 선행 상태 → 종합 컨텍스트
   
2. 문항별 요구 분석 (Content Ontology)
   - 문항 "(-12) ÷ (+8/3) ÷ (+9/4)"
   - 요구 개념: [부호 규칙, 분수 나눗셈, 역수, 연속 계산]
   - 선행 필요: [정수 나눗셈, 분수 개념]

3. 갭 분석 (Interpretation Layer)
   - 학생_컨텍스트 ∩ 문항_요구 → 취약점 도출
```

**온톨로지 정의 예시**:

```php
$item_ontology = [
    'id' => 'ITEM_4_context',
    'class' => 'mk:ProblemContext',
    'properties' => [
        'requires_concepts' => ['sign_rule', 'fraction_division', 'reciprocal'],
        'prerequisite_concepts' => ['integer_division', 'fraction_basics'],
        'common_mistakes' => ['sign_error', 'reciprocal_forget', 'order_error'],
        'recommended_personas_focus' => ['P004', 'P008', 'P009']
    ]
];
```

### 4.3 Phase 3: 전략 결정 레이어 (룰+온톨로지 협업)

**협업 흐름**:

```yaml
student_request: "이거 어떻게 해요?"

step_1_ontology:  # 맥락 파악
  student_persona: "P009_추상약함형"
  current_item_difficulty: "hard"
  prerequisite_gap: ["분수 역수 개념 불완전"]
  emotional_state: "혼란"

step_2_rule_matching:  # 조건 매칭
  matched_rules:
    - U2_R1 (개념 혼란 지점 식별)
    - INT_3_3 (구체적 수 대입)
    - INT_5_4 (선택지 질문)

step_3_ontology_filter:  # Will 검증
  will_check: "좌절 방지 우선"
  filter_result: "INT_5_4 우선 (부담 경감)"

step_4_execution:  # 최종 액션
  action: "선택지 질문"
  message: "(-12) ÷ (+8/3)를 먼저 해볼까, 아니면 (+8/3)을 역수로 바꾸는 것부터 해볼까?"
```

### 4.4 Phase 4: Will Layer 검증 시스템

**Will 검증 로직**:

```php
class WillValidator {
    private $will_priorities = [
        ['value' => '학생이 좌절하지 않도록 한다', 'priority' => 10],
        ['value' => '핵심 개념을 확실히 이해하도록 한다', 'priority' => 9],
        ['value' => '단원 간 연결성을 이해하도록 한다', 'priority' => 8]
    ];
    
    public function validateAction($proposed_action, $student_context) {
        // 감정 상태가 "좌절 직전"이면 난이도 상승 액션 차단
        if ($student_context['emotional_state'] === 'frustrated' && 
            $proposed_action['type'] === 'increase_difficulty') {
            return [
                'approved' => false,
                'override_action' => 'INT_7_4', // 작은 성공 만들기
                'reason' => 'Will Priority 1 위배: 좌절 방지'
            ];
        }
        return ['approved' => true];
    }
}
```

---

## 5. 구현 우선순위

```
┌─────────────────────────────────────────────────────────────┐
│   Priority 1: 즉각 반응 시스템 (룰 기반)                       │
├─────────────────────────────────────────────────────────────┤
│   • 필기 패턴 → 개입 트리거 연결                               │
│   • 페르소나별 기본 룰셋 정의                                  │
│   • 42가지 개입 활동 → 룰 액션 매핑                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│   Priority 2: 문항별 온톨로지 구축                            │
├─────────────────────────────────────────────────────────────┤
│   • 각 문항의 요구 개념 온톨로지                               │
│   • 선행-후행 관계 그래프                                     │
│   • 흔한 오류 패턴 매핑                                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│   Priority 3: 학생 컨텍스트 누적 시스템                        │
├─────────────────────────────────────────────────────────────┤
│   • 세션별 상호작용 누적                                      │
│   • 페르소나 신뢰도 업데이트                                   │
│   • 취약 개념 히스토리                                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│   Priority 4: Will Layer 검증 시스템                          │
├─────────────────────────────────────────────────────────────┤
│   • 룰 액션 전 Will 위배 검사                                 │
│   • 온톨로지 기반 override 로직                               │
│   • 장기 목표 vs 즉각 반응 균형                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 실제 선생님 행동 모델 (5단계)

```
┌──────────────────────────────────────────────────────────────────┐
│              실제 선생님의 5단계 사고 모델                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 관찰 (Observe)                                               │
│     └─ 온톨로지: StudentContext 수집                              │
│        "이 학생 지금 펜 멈췄네, 표정이 굳었어"                       │
│                                                                  │
│  2. 해석 (Interpret)                                             │
│     └─ 온톨로지: Interpretation Layer                            │
│        "추상 약함형인데 분수 연산에서 막힌 것 같아"                   │
│                                                                  │
│  3. 결정 (Decide)                                                │
│     └─ 룰: 조건 매칭 → 온톨로지: Will 검증                         │
│        "구체적 숫자로 바꿔서 보여주면 되겠다"                        │
│                                                                  │
│  4. 실행 (Execute)                                               │
│     └─ 룰: 액션 실행                                             │
│        "8/3의 역수가 뭐게? 3/8이지? 그럼 -12 × 3/8 = ?"           │
│                                                                  │
│  5. 적응 (Adapt)                                                 │
│     └─ 온톨로지: Context 업데이트                                  │
│        "아, 역수 개념은 알았네. 부호에서 다시 막히네"                 │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 7. 설계 기준 요약 표

| 기준 | 룰 적용 | 온톨로지 적용 |
|------|---------|--------------|
| **반응 시간 < 1초** | ✅ | |
| **패턴 매칭 (단순 조건)** | ✅ | |
| **원인 추론 필요** | | ✅ |
| **학생 특성 고려** | | ✅ |
| **다중 요소 종합** | | ✅ |
| **개입 액션 선택** | ✅ | |
| **Will 위배 검사** | | ✅ |
| **장기 프로파일 업데이트** | | ✅ |

---

## 8. 관련 문서

- `DESIGN_DOCUMENT.md`: AI 튜터 시스템 전체 설계
- `db/schema.sql`: 데이터베이스 스키마
- `db/schema_interaction.sql`: 상호작용 스키마
- `includes/rule_evaluator.php`: 룰 평가기
- `includes/ontology_generator.php`: 온톨로지 생성기
- `ui/learning_interface.php`: 학습 인터페이스

---

## 9. 구현 완료 내역

### 9.1 생성된 파일 구조

```
AItutor/
├── rules/                              # Phase 1: 즉각 반응 시스템
│   ├── immediate_rules.php             # 즉각 반응 룰셋 (25개 룰)
│   ├── persona_rules.php               # 페르소나별 룰셋 (12개 × 3개)
│   └── intervention_mapping.php        # 42가지 개입 활동 매핑
│
├── ontology/                           # Phase 2: 문항별 온톨로지
│   └── problem_ontology.php            # 유리수 나눗셈 온톨로지
│
├── services/                           # Phase 3-4: 서비스 레이어
│   ├── interaction_service.php         # 상호작용 서비스 (Phase 1)
│   ├── ontology_service.php            # 온톨로지 서비스 (Phase 2)
│   ├── context_service.php             # 컨텍스트 서비스 (Phase 3)
│   └── will_validator.php              # Will 검증 서비스 (Phase 4)
│
└── docs/
    └── RULE_ONTOLOGY_BALANCE_DESIGN.md # 이 문서
```

### 9.2 Phase별 구현 요약

| Phase | 구현 내용 | 핵심 클래스/파일 |
|-------|----------|-----------------|
| **Phase 1** | 즉각 반응 시스템 | `InteractionService`, `immediate_rules.php` |
| **Phase 2** | 문항별 온톨로지 | `OntologyService`, `problem_ontology.php` |
| **Phase 3** | 학생 컨텍스트 누적 | `ContextService` |
| **Phase 4** | Will Layer 검증 | `WillValidator` |

### 9.3 주요 기능

1. **즉각 반응 룰 (25개)**
   - U0: 시스템 제어 (2개)
   - U1: 상태 인식/패턴 감지 (4개)
   - U2: 제스처 입력 처리 (5개)
   - U3: 감정 기반 개입 (4개)
   - U4: 반영/학습 (1개)

2. **페르소나별 룰셋 (12개)**
   - 각 페르소나별 3개 맞춤 룰
   - 회피/선호 개입 활동 정의
   - 긍정 전환 메시지 포함

3. **42가지 개입 활동 매핑**
   - 7개 카테고리 체계화
   - UI 액션 타입 정의
   - 트리거 신호 → 개입 활동 연결

4. **문항별 온톨로지**
   - 4개 개념 정의 (부호규칙, 역수, 분수나눗셈, 연속나눗셈)
   - 4개 문항 상세 정보
   - 오류 패턴 4종 정의
   - 개념 관계 그래프

5. **Will Layer 검증**
   - 3대 Will 우선순위
   - 감정 상태별 금지 액션
   - Override 로직
   - 장기/단기 균형 검사

---

**문서 버전**: 1.1  
**최종 수정일**: 2025-11-26  
**작성자**: AI 튜터 설계 팀  
**구현 상태**: ✅ 완료

