<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-title {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .test-result {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        button:hover {
            background: #3182ce;
        }
        .loading {
            text-align: center;
            color: #718096;
            padding: 20px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸</h1>
        
        <button onclick="runTests()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        
        <div id="results"></div>
    </div>

    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</div>';
            
            const tests = [
                {
                    name: '1. API í†µí•© í…ŒìŠ¤íŠ¸',
                    async test() {
                        // save_interaction.php í…ŒìŠ¤íŠ¸
                        const testData = {
                            action: 'create_interaction',
                            studentId: 2,  // í…ŒìŠ¤íŠ¸ìš© í•™ìƒ ID
                            teacherId: 2,  // í…ŒìŠ¤íŠ¸ìš© ì„ ìƒë‹˜ ID
                            problemType: 'test',
                            problemText: 'í…ŒìŠ¤íŠ¸ ë¬¸ì œ',
                            modificationPrompt: 'í†µí•© í…ŒìŠ¤íŠ¸'
                        };
                        
                        const response = await fetch('save_interaction.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(testData)
                        });
                        
                        const result = await response.json();
                        return {
                            success: result.success,
                            message: result.success ? 
                                `âœ“ save_interaction.php ì •ìƒ ì‘ë™ (ID: ${result.interactionId})` : 
                                `âœ— save_interaction.php ì˜¤ë¥˜: ${result.error}`
                        };
                    }
                },
                {
                    name: '2. ìƒˆë¡œìš´ ìš”ì²­ ê°€ì ¸ì˜¤ê¸°',
                    async test() {
                        const response = await fetch('get_new_requests.php?teacherid=2');
                        const result = await response.json();
                        
                        return {
                            success: result.success,
                            message: result.success ? 
                                `âœ“ get_new_requests.php ì •ìƒ ì‘ë™ (${result.total}ê°œ ìš”ì²­)` :
                                `âœ— get_new_requests.php ì˜¤ë¥˜: ${result.error}`
                        };
                    }
                },
                {
                    name: '3. í•™ìƒ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°',
                    async test() {
                        const response = await fetch('get_student_messages.php?studentid=2&page=0&perpage=5');
                        const result = await response.json();
                        
                        return {
                            success: result.success,
                            message: result.success ? 
                                `âœ“ get_student_messages.php ì •ìƒ ì‘ë™ (${result.messages ? result.messages.length : 0}ê°œ ë©”ì‹œì§€)` :
                                `âœ— get_student_messages.php ì˜¤ë¥˜: ${result.error}`
                        };
                    }
                },
                {
                    name: '4. íŒŒì¼ ì‹œìŠ¤í…œ í™•ì¸',
                    async test() {
                        const files = [
                            'student_inbox.php',
                            'teachingagent.php',
                            'save_interaction.php',
                            'get_new_requests.php',
                            'get_student_messages.php'
                        ];
                        
                        const checks = [];
                        for (const file of files) {
                            try {
                                const response = await fetch(file, { method: 'HEAD' });
                                checks.push(`âœ“ ${file}: ì¡´ì¬`);
                            } catch (e) {
                                checks.push(`âœ— ${file}: ì—†ìŒ`);
                            }
                        }
                        
                        // ë°±ì—… íŒŒì¼ í™•ì¸
                        try {
                            const response = await fetch('simple_save_interaction.php', { method: 'HEAD' });
                            checks.push('âœ— simple_save_interaction.php: ì•„ì§ ì¡´ì¬ (ì œê±° í•„ìš”)');
                        } catch (e) {
                            checks.push('âœ“ simple_save_interaction.php: ì œê±°ë¨');
                        }
                        
                        return {
                            success: true,
                            message: checks.join('\n')
                        };
                    }
                },
                {
                    name: '5. ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸',
                    async test() {
                        const steps = [];
                        
                        // Step 1: í•™ìƒì´ ì§ˆë¬¸ ì œì¶œ
                        const submitData = {
                            action: 'create_interaction',
                            studentId: 817,
                            teacherId: 2,
                            problemType: 'ì‹œì¤‘êµì¬',
                            problemText: 'ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸',
                            problemImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                        };
                        
                        const submitResponse = await fetch('save_interaction.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(submitData)
                        });
                        
                        const submitResult = await submitResponse.json();
                        if (submitResult.success) {
                            steps.push(`âœ“ í•™ìƒ ì§ˆë¬¸ ì œì¶œ ì„±ê³µ (ID: ${submitResult.interactionId})`);
                            
                            // Step 2: ì„ ìƒë‹˜ì´ ìƒˆë¡œìš´ ìš”ì²­ í™•ì¸
                            const requestsResponse = await fetch('get_new_requests.php?teacherid=2');
                            const requestsResult = await requestsResponse.json();
                            
                            if (requestsResult.success) {
                                const found = requestsResult.requests.find(r => r.id == submitResult.interactionId);
                                if (found) {
                                    steps.push('âœ“ ì„ ìƒë‹˜ í™”ë©´ì— ìƒˆë¡œìš´ ìš”ì²­ í‘œì‹œë¨');
                                } else {
                                    steps.push('âœ— ì„ ìƒë‹˜ í™”ë©´ì— ìš”ì²­ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ');
                                }
                            }
                        } else {
                            steps.push(`âœ— í•™ìƒ ì§ˆë¬¸ ì œì¶œ ì‹¤íŒ¨: ${submitResult.error}`);
                        }
                        
                        return {
                            success: true,
                            message: steps.join('\n')
                        };
                    }
                }
            ];
            
            let html = '';
            
            for (const test of tests) {
                html += `<div class="test-section">`;
                html += `<div class="test-title">${test.name}</div>`;
                
                try {
                    const result = await test.test();
                    const className = result.success ? 'success' : 'error';
                    html += `<div class="test-result ${className}"><pre>${result.message}</pre></div>`;
                } catch (error) {
                    html += `<div class="test-result error"><pre>í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜: ${error.message}</pre></div>`;
                }
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>