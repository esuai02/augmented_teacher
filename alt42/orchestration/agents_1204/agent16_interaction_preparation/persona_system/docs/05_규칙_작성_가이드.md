# 규칙 작성 가이드

## 1. 개요

이 가이드는 Agent16의 rules.yaml 파일을 작성하고 관리하는 방법을 설명합니다.
규칙은 상황 감지, 세계관 선택, 페르소나 활성화를 제어합니다.

---

## 2. 규칙 파일 위치

```
agents/agent16_interaction_preparation/
├── rules/
│   └── rules.yaml          # 메인 규칙 파일
│
└── persona_system/
    └── engine/
        └── Agent16PersonaEngine.php  # 규칙 로드 및 실행
```

---

## 3. 규칙 구조

### 3.1 기본 형식

```yaml
rules:
  - name: "규칙 이름"
    description: "규칙 설명"
    priority: 1
    conditions:
      - type: condition_type
        value: condition_value
    actions:
      - type: action_type
        value: action_value
```

### 3.2 필수 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| name | string | 규칙 고유 이름 |
| conditions | array | 조건 목록 (AND 연산) |
| actions | array | 실행할 액션 목록 |

### 3.3 선택 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| description | string | 규칙 설명 |
| priority | int | 우선순위 (낮을수록 먼저 실행) |
| enabled | bool | 활성화 여부 (기본: true) |

---

## 4. 조건 유형

### 4.1 상황 그룹 조건

```yaml
conditions:
  - type: situation
    value: S0
```

**지원 값**: S0, S1, S2, S3, S4, S5, S6

### 4.2 세계관 조건

```yaml
conditions:
  - type: worldview
    value: exam_prep
```

**지원 값**: curriculum, personalized, exam_prep, short_mission, self_reflection, self_directed, apprenticeship, time_reflection, inquiry

### 4.3 학습 단계 조건

```yaml
conditions:
  - type: learning_stage
    value: exploration
```

**지원 값**: exploration, acquisition, integration, mastery

### 4.4 키워드 조건

```yaml
conditions:
  - type: keyword
    value: "시험"
```

### 4.5 복합 조건

```yaml
conditions:
  - type: situation
    value: S4
  - type: worldview
    value: exam_prep
  - type: keyword
    value: "취약"
```

---

## 5. 액션 유형

### 5.1 페르소나 선택

```yaml
actions:
  - type: select_persona
    value: A16_P3
```

### 5.2 세계관 설정

```yaml
actions:
  - type: select_worldview
    value: exam_prep
```

### 5.3 톤 설정

```yaml
actions:
  - type: set_tone
    value: Analytical
```

### 5.4 개입 전략 설정

```yaml
actions:
  - type: set_intervention
    value: StrategicSupport
```

### 5.5 응답 템플릿 지정

```yaml
actions:
  - type: use_template
    value: exam_preparation_response
```

### 5.6 플래그 설정

```yaml
actions:
  - type: set_flag
    value: urgent_mode
```

---

## 6. 상황 그룹별 규칙 예시

### 6.1 S0 - 상태 감지

```yaml
# 초기 상태 감지 및 학습 단계 파악
- name: "S0_initial_detection"
  description: "학습자 현재 상태 파악"
  conditions:
    - type: situation
      value: S0
  actions:
    - type: select_persona
      value: A16_P2
    - type: set_flag
      value: needs_assessment
```

### 6.2 S1 - 세계관 매핑

```yaml
# 시험대비 세계관 감지시
- name: "S1_exam_worldview"
  conditions:
    - type: situation
      value: S1
    - type: worldview
      value: exam_prep
  actions:
    - type: select_persona
      value: A16_P3
    - type: set_tone
      value: Analytical

# 자기주도 세계관 감지시
- name: "S1_self_directed_worldview"
  conditions:
    - type: situation
      value: S1
    - type: worldview
      value: self_directed
  actions:
    - type: select_persona
      value: A16_P6
    - type: set_tone
      value: Empowering
```

### 6.3 S2 - 학원 맥락

```yaml
- name: "S2_academy_context"
  description: "학원 환경 특성 반영"
  conditions:
    - type: situation
      value: S2
  actions:
    - type: select_persona
      value: A16_P1
    - type: set_intervention
      value: GuidedDiscovery
```

### 6.4 S3 - 실시간 상호작용

```yaml
- name: "S3_realtime_interaction"
  description: "즉각적 반응 필요 상황"
  conditions:
    - type: situation
      value: S3
  actions:
    - type: select_persona
      value: A16_P4
    - type: set_tone
      value: Motivational
```

### 6.5 S4 - 취약점 기반 준비

```yaml
- name: "S4_weakness_based"
  description: "약점 보완 전략"
  conditions:
    - type: situation
      value: S4
  actions:
    - type: select_persona
      value: A16_P3
    - type: set_intervention
      value: StrategicSupport
```

### 6.6 S5 - 수준 차별화

```yaml
- name: "S5_level_differentiation"
  description: "학습 수준 맞춤"
  conditions:
    - type: situation
      value: S5
  actions:
    - type: select_persona
      value: A16_P2
    - type: set_intervention
      value: PersonalizedGuidance
```

### 6.7 S6 - 연속성

```yaml
- name: "S6_continuity"
  description: "학습 흐름 유지"
  conditions:
    - type: situation
      value: S6
  actions:
    - type: set_flag
      value: maintain_context
```

---

## 7. 학습 단계별 규칙

### 7.1 탐색 단계

```yaml
- name: "stage_exploration"
  conditions:
    - type: learning_stage
      value: exploration
  actions:
    - type: select_worldview
      value: inquiry
    - type: select_persona
      value: A16_P9
```

### 7.2 습득 단계

```yaml
- name: "stage_acquisition"
  conditions:
    - type: learning_stage
      value: acquisition
  actions:
    - type: select_worldview
      value: curriculum
    - type: select_persona
      value: A16_P1
```

### 7.3 통합 단계

```yaml
- name: "stage_integration"
  conditions:
    - type: learning_stage
      value: integration
  actions:
    - type: select_worldview
      value: self_reflection
    - type: select_persona
      value: A16_P5
```

### 7.4 숙달 단계

```yaml
- name: "stage_mastery"
  conditions:
    - type: learning_stage
      value: mastery
  actions:
    - type: select_worldview
      value: self_directed
    - type: select_persona
      value: A16_P6
```

---

## 8. 우선순위 규칙

### 8.1 우선순위 원칙

1. **낮은 숫자 = 높은 우선순위**
2. 동일 조건 만족시 우선순위 높은 규칙만 실행
3. 우선순위 미지정시 정의 순서대로 실행

### 8.2 예시

```yaml
# 우선순위 1: 긴급 상황
- name: "urgent_exam"
  priority: 1
  conditions:
    - type: keyword
      value: "내일 시험"
  actions:
    - type: select_persona
      value: A16_P3
    - type: set_flag
      value: urgent

# 우선순위 5: 일반 시험 준비
- name: "general_exam"
  priority: 5
  conditions:
    - type: worldview
      value: exam_prep
  actions:
    - type: select_persona
      value: A16_P3
```

---

## 9. 조건 연산자

### 9.1 기본 연산자 (암묵적 AND)

```yaml
# 모든 조건이 만족해야 실행
conditions:
  - type: situation
    value: S4
  - type: worldview
    value: exam_prep
```

### 9.2 OR 연산

```yaml
# 하나라도 만족하면 실행
conditions:
  - type: or
    values:
      - type: worldview
        value: exam_prep
      - type: worldview
        value: short_mission
```

### 9.3 NOT 연산

```yaml
# 조건이 만족하지 않아야 실행
conditions:
  - type: not
    condition:
      type: worldview
      value: self_directed
```

---

## 10. 변수 사용

### 10.1 컨텍스트 변수

```yaml
conditions:
  - type: context
    key: course_id
    operator: exists

actions:
  - type: set_context
    key: active_course
    value: "${context.course_id}"
```

### 10.2 시스템 변수

```yaml
conditions:
  - type: system
    key: hour
    operator: gte
    value: 22
actions:
  - type: set_tone
    value: Supportive
```

---

## 11. 규칙 검증

### 11.1 YAML 문법 검증

```bash
# yamllint 사용
yamllint rules.yaml

# Python으로 검증
python -c "import yaml; yaml.safe_load(open('rules.yaml'))"
```

### 11.2 PHP 로드 테스트

```php
$rulesPath = __DIR__ . '/rules/rules.yaml';
$content = file_get_contents($rulesPath);
$rules = yaml_parse($content);

if ($rules === false) {
    echo "YAML 파싱 실패\n";
} else {
    echo "규칙 로드 성공: " . count($rules['rules']) . "개\n";
}
```

---

## 12. 디버그 및 로깅

### 12.1 규칙 실행 로깅

```yaml
# 디버그 플래그가 있는 규칙
- name: "debug_rule"
  debug: true
  conditions:
    - type: worldview
      value: exam_prep
  actions:
    - type: log
      value: "exam_prep worldview detected"
    - type: select_persona
      value: A16_P3
```

### 12.2 PHP에서 로깅

```php
if ($rule['debug'] ?? false) {
    error_log(sprintf(
        "[Agent16 Rules] %s matched - %s",
        $rule['name'],
        json_encode($rule['actions'])
    ));
}
```

---

## 13. 모범 사례

### 13.1 규칙 작성 원칙

1. **명확한 이름**: 규칙의 목적이 드러나도록
2. **설명 포함**: description 필드 활용
3. **적절한 우선순위**: 충돌 방지
4. **단일 책임**: 하나의 규칙은 하나의 목적
5. **테스트 우선**: 새 규칙 추가 전 테스트

### 13.2 피해야 할 패턴

```yaml
# BAD: 너무 일반적인 조건
- name: "too_generic"
  conditions:
    - type: keyword
      value: "안녕"  # 너무 흔한 키워드
  actions:
    - type: select_persona
      value: A16_P1

# GOOD: 구체적인 조건
- name: "specific_greeting"
  conditions:
    - type: situation
      value: S0
    - type: keyword
      value: "처음"
  actions:
    - type: select_persona
      value: A16_P2
```

### 13.3 규칙 그룹화

```yaml
# 상황 그룹별로 섹션 구분
# ===== S0 규칙 =====
- name: "S0_rule_1"
  # ...

# ===== S1 규칙 =====
- name: "S1_rule_1"
  # ...
```

---

## 14. 규칙 마이그레이션

### 14.1 버전 관리

```yaml
# 파일 상단에 버전 명시
version: "1.0.0"
last_updated: "2025-06-02"
rules:
  # ...
```

### 14.2 백업 및 복원

```bash
# 백업
cp rules.yaml rules.yaml.bak

# 복원
cp rules.yaml.bak rules.yaml
```

---

*이 문서는 rules.yaml 작성 및 관리 방법을 설명합니다.*
*관련: [02_세계관_설정_가이드.md](./02_세계관_설정_가이드.md), [04_엔진_확장_가이드.md](./04_엔진_확장_가이드.md)*
