# 세계관 설정 가이드

## 1. 개요

세계관(Worldview)은 학습 상황을 분류하는 프레임워크입니다.
이 가이드는 세계관을 정의하고 트리거를 설정하는 방법을 설명합니다.

---

## 2. 세계관 구조

### 2.1 필수 속성

| 속성 | 설명 | 예시 |
|------|------|------|
| id | 고유 식별자 (영문) | exam_prep |
| name_ko | 한글 이름 | 시험대비 |
| description | 설명 | "시험 준비 집중 모드" |
| triggers | 감지 키워드 배열 | ["시험", "테스트"] |
| priority | 우선순위 (1-9) | 3 |

### 2.2 선택 속성

| 속성 | 설명 | 예시 |
|------|------|------|
| name_en | 영문 이름 | "Exam Preparation" |
| context_rules | 맥락 규칙 | {...} |
| time_sensitivity | 시간 민감도 | high, medium, low |

---

## 3. 현재 세계관 목록

```
┌─────────────────┬──────────────┬─────────────────────────────┐
│ ID              │ 한글명       │ 트리거 키워드               │
├─────────────────┼──────────────┼─────────────────────────────┤
│ curriculum      │ 커리큘럼     │ 정규과정, 단원, 학기, 교과서│
│ personalized    │ 맞춤학습     │ 내 수준, 맞춤, 개인화       │
│ exam_prep       │ 시험대비     │ 시험, 테스트, 평가, 중간고사│
│ short_mission   │ 단기미션     │ 오늘, 지금, 빠르게, 미션    │
│ self_reflection │ 자기성찰     │ 왜, 이유, 생각해보면        │
│ self_directed   │ 자기주도     │ 내가, 스스로, 직접, 계획    │
│ apprenticeship  │ 도제학습     │ 선생님, 가르쳐, 알려주세요  │
│ time_reflection │ 시간성찰     │ 시간, 일정, 관리, 언제      │
│ inquiry         │ 탐구학습     │ 궁금, 탐구, 조사, 실험      │
└─────────────────┴──────────────┴─────────────────────────────┘
```

---

## 4. 세계관 감지 알고리즘

### 4.1 감지 흐름

```
[사용자 메시지] → [트리거 매칭] → [신뢰도 계산] → [세계관 선택]
```

### 4.2 코드 구현

```php
/**
 * 메시지에서 세계관 감지
 */
private function detectWorldview(string $message): ?string {
    $detected = null;
    $highestPriority = PHP_INT_MAX;

    foreach ($this->worldviews as $id => $worldview) {
        foreach ($worldview['triggers'] as $trigger) {
            if (mb_strpos($message, $trigger) !== false) {
                // 우선순위가 더 높은(숫자가 낮은) 세계관 선택
                if ($worldview['priority'] < $highestPriority) {
                    $detected = $id;
                    $highestPriority = $worldview['priority'];
                }
                break;
            }
        }
    }

    return $detected;
}
```

### 4.3 신뢰도 계산

```php
/**
 * 세계관 매칭 신뢰도 계산
 * @return float 0.0 ~ 1.0
 */
private function calculateWorldviewConfidence(
    string $message,
    ?string $worldviewId
): float {
    if (!$worldviewId) return 0.0;

    $worldview = $this->worldviews[$worldviewId] ?? null;
    if (!$worldview) return 0.0;

    $matchCount = 0;
    $totalTriggers = count($worldview['triggers']);

    foreach ($worldview['triggers'] as $trigger) {
        if (mb_strpos($message, $trigger) !== false) {
            $matchCount++;
        }
    }

    // 기본 신뢰도: 매칭 비율 * 0.7 + 기본값 0.3
    return min(1.0, ($matchCount / $totalTriggers) * 0.7 + 0.3);
}
```

---

## 5. 새 세계관 추가하기

### 5.1 Agent16PersonaEngine.php 수정

```php
private $worldviews = [
    // 기존 세계관들...

    'new_worldview' => [
        'id' => 'new_worldview',
        'name_ko' => '새 세계관',
        'name_en' => 'New Worldview',
        'description' => '새 세계관에 대한 설명',
        'triggers' => ['키워드1', '키워드2', '키워드3'],
        'priority' => 10  // 기존 1-9 외의 새 우선순위
    ]
];
```

### 5.2 ontology.jsonld 추가

```json
{
  "@id": "worldview:NewWorldview",
  "@type": "worldview:Worldview",
  "name": "새 세계관",
  "worldview:id": "new_worldview",
  "description": "새 세계관에 대한 설명",
  "triggers": ["키워드1", "키워드2", "키워드3"],
  "priority": 10
}
```

### 5.3 연결된 페르소나 추가

새 세계관을 추가하면 반드시 연결된 페르소나도 추가해야 합니다.

```php
// selectPersonaByWorldview() 메서드에 매핑 추가
case 'new_worldview':
    return $this->personas['A16_P10'] ?? $this->getDefaultPersona();
```

---

## 6. 트리거 설정 가이드

### 6.1 효과적인 트리거 설계

**DO (권장):**
- 구체적이고 명확한 키워드 사용
- 해당 세계관에 특화된 용어 선택
- 3-5개의 트리거 유지
- 한글 트리거 우선

**DON'T (피해야 할 것):**
- 너무 일반적인 단어 (예: "공부", "학습")
- 다른 세계관과 중복되는 키워드
- 10개 이상의 트리거

### 6.2 트리거 우선순위

```
우선순위 규칙:
1. 고유 키워드 (해당 세계관에만 존재)
2. 맥락 키워드 (문맥상 의미 있는)
3. 보조 키워드 (추가 확인용)
```

### 6.3 예시: 시험대비 세계관

```php
'exam_prep' => [
    'triggers' => [
        '시험',       // 고유 키워드 - 명확함
        '테스트',     // 고유 키워드
        '평가',       // 맥락 키워드
        '중간고사',   // 고유 키워드 - 구체적
        '기말고사'    // 고유 키워드 - 구체적
    ]
]
```

---

## 7. 세계관 우선순위 조정

### 7.1 우선순위 원칙

1. **학습 맥락의 긴급성**: 긴급한 상황일수록 높은 우선순위
2. **구체성**: 더 구체적인 세계관이 높은 우선순위
3. **사용 빈도**: 자주 사용되는 세계관은 중간 우선순위

### 7.2 현재 우선순위 로직

```
커리큘럼 (1) → 정규 과정 기반, 가장 일반적
맞춤학습 (2) → 개인화 필요시 차선
시험대비 (3) → 긴급 상황
단기미션 (4) → 즉각적 액션 필요
자기성찰 (5) → 메타인지 활동
자기주도 (6) → 자율적 학습자
도제학습 (7) → 멘토링 요청시
시간성찰 (8) → 시간 관리 맥락
탐구학습 (9) → 탐구적 질문
```

---

## 8. 세계관 테스트

### 8.1 API로 세계관 감지 테스트

```bash
# 단일 메시지 세계관 감지
curl -X POST '.../api/chat.php' \
  -H 'Content-Type: application/json' \
  -d '{
    "action": "detect_worldview",
    "message": "다음 주 시험 준비를 도와줘"
  }'

# 예상 응답
{
  "success": true,
  "message": "다음 주 시험 준비를 도와줘",
  "detected_worldview": "exam_prep",
  "worldview_name": "시험대비",
  "confidence": 0.65,
  "description": "시험 준비 집중 모드의 세계관"
}
```

### 8.2 수동 세계관 설정

```bash
curl -X POST '.../api/chat.php' \
  -H 'Content-Type: application/json' \
  -d '{
    "action": "set_worldview",
    "worldview_id": "exam_prep"
  }'
```

---

## 9. 상황 그룹과의 연동

### 9.1 세계관 → 상황 그룹 매핑

```
S0 (상태 감지)       → 세계관 감지 전 단계
S1 (세계관 매핑)     → 감지된 세계관 기반 페르소나 선택
S2 (학원 맥락)       → curriculum 세계관과 연관
S3 (실시간 상호작용) → short_mission 세계관과 연관
S4 (취약점 기반)     → exam_prep 세계관과 연관
S5 (수준 차별화)     → personalized 세계관과 연관
S6 (연속성)          → 이전 세계관 유지
```

### 9.2 rules.yaml 연동

```yaml
# rules.yaml 예시
- name: "S1_exam_worldview"
  conditions:
    - situation: S1
    - worldview_detected: exam_prep
  actions:
    - select_persona: A16_P3
    - set_tone: Analytical
```

---

## 10. 문제 해결

### 10.1 세계관이 감지되지 않음

```php
// 디버그 모드 활성화
$engine = new Agent16PersonaEngine('agent16', ['debug_mode' => true]);
$result = $engine->process($userId, $message, []);

// 디버그 정보 확인
print_r($result['debug']['worldview_detection']);
```

### 10.2 잘못된 세계관 감지

1. **트리거 중복 확인**: 다른 세계관과 겹치는 트리거가 없는지
2. **우선순위 확인**: 의도한 세계관의 우선순위가 적절한지
3. **메시지 길이**: 너무 짧은 메시지는 정확도 떨어짐

### 10.3 신뢰도가 낮음

- 트리거 키워드 추가 고려
- 복합 트리거 패턴 구현 검토
- 맥락 정보 활용 확대

---

## 11. 고급 기능

### 11.1 복합 트리거 패턴

```php
// 두 키워드가 모두 있어야 매칭
private function checkCompoundTrigger(string $message): ?string {
    if (mb_strpos($message, '시험') !== false
        && mb_strpos($message, '준비') !== false) {
        return 'exam_prep';
    }
    return null;
}
```

### 11.2 맥락 기반 가중치

```php
// 세션 데이터 기반 가중치 조정
private function adjustConfidenceByContext(
    float $baseConfidence,
    array $sessionData
): float {
    // 이전 세계관과 동일하면 가중치 증가
    if (isset($sessionData['previous_worldview'])
        && $sessionData['previous_worldview'] === $currentWorldview) {
        return min(1.0, $baseConfidence + 0.1);
    }
    return $baseConfidence;
}
```

---

*이 문서는 세계관 설정 및 관리 방법을 설명합니다.*
*관련: [01_페르소나_정의_가이드.md](./01_페르소나_정의_가이드.md), [05_규칙_작성_가이드.md](./05_규칙_작성_가이드.md)*
