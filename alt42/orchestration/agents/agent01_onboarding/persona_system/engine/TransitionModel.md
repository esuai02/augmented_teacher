# Persona Transition Model - 페르소나 전환 관계 모델

> 생성일: 2025-12-02
> 버전: 1.0
> 목적: 상황별 페르소나 전환 규칙 및 관계 정의

---

## 📋 개요

학생의 상태 변화에 따라 페르소나가 동적으로 전환됩니다.
전환은 규칙 기반으로 관리되며, 모든 전환 이벤트가 기록됩니다.

---

## 🔄 상황(Situation) 전환 다이어그램

```
                              ┌─────────────────────────────────────────┐
                              │              Q (일반 질문)               │
                              │   모든 상황에서 진입/이탈 가능            │
                              └───────────────┬─────────────────────────┘
                                              │
                                              ▼
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│     S0       │ ──────► │     S1       │ ──────► │     S2       │
│  정보 수집    │         │  신규 등록    │         │  학습 설계    │
└──────────────┘         └──────────────┘         └──────┬───────┘
       ▲                        │                        │
       │                        │                        ▼
       │                        │                 ┌──────────────┐
       │                        │                 │     S3       │
       │                        │                 │  진도 판단    │
       │                        │                 └──────┬───────┘
       │                        │                        │
       │                        ▼                        ▼
       │                 ┌──────────────┐         ┌──────────────┐
       │                 │      E       │         │     S4       │
       │                 │  정서적 UX   │         │  학부모 상담  │
       │                 └──────────────┘         └──────┬───────┘
       │                        │                        │
       │                        │                        ▼
       │                        │                 ┌──────────────┐
       │                        │                 │     S5       │
       │                        └────────────────►│  장기 목표    │
       │                                          └──────────────┘
       │
       │                 ┌──────────────┐
       └─────────────────│      C       │◄───── 어느 상황에서든 진입 가능
                         │  복합 상황    │        (complexity > 0.8)
                         └──────────────┘
```

---

## 📊 상황별 전환 매트릭스

### From → To 허용 전환표

| From ↓ / To → | S0 | S1 | S2 | S3 | S4 | S5 | C | Q | E |
|---------------|----|----|----|----|----|----|---|---|---|
| **S0** | - | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| **S1** | ✅ | - | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ | ✅ |
| **S2** | ❌ | ✅ | - | ✅ | ❌ | ❌ | ✅ | ✅ | ✅ |
| **S3** | ❌ | ❌ | ✅ | - | ✅ | ✅ | ✅ | ✅ | ✅ |
| **S4** | ❌ | ❌ | ✅ | ✅ | - | ✅ | ✅ | ✅ | ❌ |
| **S5** | ❌ | ❌ | ✅ | ✅ | ❌ | - | ✅ | ✅ | ✅ |
| **C** | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | - | ✅ | ✅ |
| **Q** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | - | ✅ |
| **E** | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ | - |

### 전환 조건 상세

#### S0 (정보 수집) 전환

| 목표 | 조건 | 최소 신뢰도 | 트리거 |
|------|------|------------|--------|
| S1 | 신규 학생 등록 필요 | 0.60 | `new_registration` |
| S2 | 학습 계획 수립 준비 | 0.70 | `ready_for_planning` |
| S3 | 진도 평가 필요 | 0.65 | `progress_assessment` |
| Q | 일반 질문 감지 | 0.50 | `general_question` |
| E | 정서적 반응 감지 | 0.70 | `emotional_trigger` |

#### S1 (신규 등록) 전환

| 목표 | 조건 | 최소 신뢰도 | 트리거 |
|------|------|------------|--------|
| S2 | 등록 완료 | 0.70 | `registration_complete` |
| S0 | 추가 정보 필요 | 0.60 | `need_more_info` |
| C | 복합 문제 발견 | 0.80 | `complex_situation` |
| E | 정서적 반응 | 0.70 | `emotional_trigger` |

#### S2 (학습 설계) 전환

| 목표 | 조건 | 최소 신뢰도 | 트리거 |
|------|------|------------|--------|
| S3 | 계획 수립 완료 | 0.70 | `plan_created` |
| S1 | 재평가 필요 | 0.60 | `need_reassessment` |
| C | 복합 문제 발견 | 0.80 | `complex_situation` |
| E | 정서적 반응 | 0.70 | `emotional_trigger` |

#### S3 (진도 판단) 전환

| 목표 | 조건 | 최소 신뢰도 | 트리거 |
|------|------|------------|--------|
| S2 | 계획 조정 필요 | 0.65 | `need_plan_adjustment` |
| S4 | 학부모 상담 필요 | 0.70 | `parent_consultation_needed` |
| S5 | 목표 논의 필요 | 0.65 | `goal_discussion` |
| C | 복합 문제 발견 | 0.80 | `complex_situation` |
| E | 정서적 반응 | 0.70 | `emotional_trigger` |

---

## 🎯 전환 트리거 유형

### 1. 메시지 기반 트리거

| 트리거명 | 감지 키워드 | 대상 상황 | 신뢰도 영향 |
|---------|------------|----------|------------|
| `anxiety_increase` | 불안, 걱정, 무서워, 두려워, 긴장 | E | +0.15 |
| `frustration_increase` | 짜증, 화나, 답답, 포기, 못하겠어 | E | +0.20 |
| `confidence_gain` | 할 수 있, 해볼게, 이해했, 알겠 | - | +0.10 |
| `help_request` | 도와주세요, 모르겠어요, 어떻게 | - | 플래그 설정 |

### 2. 행동 기반 트리거

| 트리거명 | 조건 | 액션 | 영향 |
|---------|------|------|------|
| `repeated_short_response` | 연속 짧은 응답 ≥ 3회 | 참여 유도 증가 | -0.10 |
| `long_silence` | 무응답 ≥ 5분 | 참여 프롬프트 | 이탈 위험 플래그 |
| `rapid_improvement` | 긍정 응답 ≥ 5회 | S3 전환 고려 | +0.15 |

### 3. 신뢰도 기반 트리거

| 트리거명 | 임계값 | 조건 | 액션 |
|---------|-------|------|------|
| `high_confidence_stable` | ≥ 0.85 | 연속 3회 매칭 | 페르소나 확정 |
| `low_confidence_drop` | < 0.50 | - | S0로 재평가 |
| `confidence_oscillation` | 분산 > 0.20 | 5회 윈도우 | C (복합 상황) 전환 |

---

## 📈 페르소나 전환 패턴 분석

### 일반적인 전환 경로

#### 1. 신규 학생 온보딩 경로
```
S0 → S1 → S2 → S3
(정보수집 → 등록 → 계획 → 진도)
```

#### 2. 정서적 개입 경로
```
Any → E → S2/S3
(어느 상황 → 정서 지원 → 학습 복귀)
```

#### 3. 복합 문제 해결 경로
```
Any → C → S0 → (정상 경로)
(복합 상황 → 재평가 → 새로운 접근)
```

#### 4. 학부모 협력 경로
```
S3 → S4 → S5 → S2
(진도 → 상담 → 목표 → 계획 수정)
```

### 안정성 점수 계산

```
Stability Score = max(0, 100 - (전환 횟수 / 고유 페르소나 수 × 10))
```

- **높은 안정성 (80+)**: 페르소나가 잘 고정됨
- **중간 안정성 (50-80)**: 일반적인 전환 패턴
- **낮은 안정성 (<50)**: 잦은 전환, 복합 상황 의심

---

## 🔧 구현 예시

### 전환 실행

```php
$transitionManager = new PersonaTransitionManager();

// 전환 가능 여부 확인
$canTransit = $transitionManager->canTransition('S1', 'S2', 0.75);
if ($canTransit['allowed']) {
    // 전환 실행
    $transitionManager->executeTransition(
        $userId,
        $sessionKey,
        'S1_P2',           // 이전 페르소나
        'S2_P1',           // 새 페르소나
        'message_analysis', // 트리거 유형
        ['confidence' => 0.75, 'trigger_keyword' => '계획']
    );
}
```

### 전환 트리거 감지

```php
$trigger = $transitionManager->detectMessageTrigger(
    '수학이 너무 불안해요',
    $currentContext
);
// 반환: ['trigger_name' => 'anxiety_increase', 'target_situation' => 'E', ...]
```

### 전환 패턴 분석

```php
$patterns = $transitionManager->analyzeTransitionPatterns($userId);
/*
반환:
[
    'total_transitions' => 15,
    'situation_frequency' => ['S2' => 5, 'S3' => 4, ...],
    'common_transitions' => ['S2_P1 → S3_P1' => 3, ...],
    'stability_score' => 72.5
]
*/
```

---

## 📝 참고 문서

- [PersonaTransitionManager.php](./PersonaTransitionManager.php) - 전환 관리 클래스
- [DataSourceMapping.md](./DataSourceMapping.md) - DB 연동 명세
- [personas.md](../personas.md) - 페르소나 정의
- [rules.yaml](../rules.yaml) - 식별 규칙
