# DB 스키마 가이드

## 1. 개요

이 가이드는 Agent16 페르소나 시스템에서 사용하는 데이터베이스 테이블 구조를 설명합니다.
MySQL 5.7 환경에서 Moodle 3.7과 통합되어 운영됩니다.

---

## 2. 테이블 개요

```
┌─────────────────────────────┬─────────────────────────────────┐
│ 테이블명                    │ 용도                            │
├─────────────────────────────┼─────────────────────────────────┤
│ at_agent_persona_state      │ 현재 페르소나 상태 저장         │
│ at_agent_persona_history    │ 페르소나 변경 이력              │
│ at_agent_messages           │ 에이전트 간 메시지              │
│ mdl_user_info_data          │ 사용자 역할 정보 (Moodle 기본)  │
└─────────────────────────────┴─────────────────────────────────┘
```

---

## 3. at_agent_persona_state

현재 활성화된 페르소나 상태를 저장합니다.

### 3.1 테이블 구조

```sql
CREATE TABLE `at_agent_persona_state` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `agent_id` int(11) NOT NULL COMMENT '에이전트 번호 (1-21)',
  `user_id` bigint(20) NOT NULL COMMENT '사용자 ID',
  `persona_id` varchar(20) NOT NULL COMMENT '페르소나 ID (예: A16_P1)',
  `context_data` text COMMENT 'JSON 형식 컨텍스트 데이터',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `last_interaction` datetime DEFAULT NULL COMMENT '마지막 상호작용 시간',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_agent_user` (`agent_id`, `user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_updated_at` (`updated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3.2 컬럼 설명

| 컬럼 | 타입 | NULL | 설명 |
|------|------|------|------|
| id | bigint(20) | NO | 자동 증가 PK |
| agent_id | int(11) | NO | 에이전트 번호 (16 = Agent16) |
| user_id | bigint(20) | NO | Moodle 사용자 ID |
| persona_id | varchar(20) | NO | 페르소나 식별자 |
| context_data | text | YES | JSON 컨텍스트 |
| created_at | datetime | NO | 생성 시간 |
| updated_at | datetime | NO | 수정 시간 |
| last_interaction | datetime | YES | 마지막 상호작용 |

### 3.3 context_data JSON 구조

```json
{
  "worldview": "exam_prep",
  "worldview_confidence": 0.85,
  "situation_group": "S4",
  "learning_stage": "preparation",
  "previous_persona": "A16_P1",
  "session_count": 5,
  "custom_flags": ["urgent", "needs_review"]
}
```

### 3.4 사용 예시

```php
// 상태 조회
$state = $DB->get_record('at_agent_persona_state', [
    'agent_id' => 16,
    'user_id' => $USER->id
]);

// 상태 업데이트/삽입
$data = new stdClass();
$data->agent_id = 16;
$data->user_id = $USER->id;
$data->persona_id = 'A16_P3';
$data->context_data = json_encode($contextData);
$data->last_interaction = date('Y-m-d H:i:s');

if ($state) {
    $data->id = $state->id;
    $DB->update_record('at_agent_persona_state', $data);
} else {
    $DB->insert_record('at_agent_persona_state', $data);
}
```

---

## 4. at_agent_persona_history

페르소나 변경 이력을 추적합니다.

### 4.1 테이블 구조

```sql
CREATE TABLE `at_agent_persona_history` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `agent_id` int(11) NOT NULL COMMENT '에이전트 번호',
  `user_id` bigint(20) NOT NULL COMMENT '사용자 ID',
  `from_persona` varchar(20) DEFAULT NULL COMMENT '이전 페르소나',
  `to_persona` varchar(20) NOT NULL COMMENT '새 페르소나',
  `trigger_message` text COMMENT '변경 트리거 메시지',
  `trigger_worldview` varchar(50) DEFAULT NULL COMMENT '감지된 세계관',
  `confidence` decimal(3,2) DEFAULT NULL COMMENT '신뢰도 (0.00-1.00)',
  `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_agent_user` (`agent_id`, `user_id`),
  KEY `idx_changed_at` (`changed_at`),
  KEY `idx_to_persona` (`to_persona`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 4.2 컬럼 설명

| 컬럼 | 타입 | NULL | 설명 |
|------|------|------|------|
| id | bigint(20) | NO | 자동 증가 PK |
| agent_id | int(11) | NO | 에이전트 번호 |
| user_id | bigint(20) | NO | 사용자 ID |
| from_persona | varchar(20) | YES | 이전 페르소나 (첫 상호작용은 NULL) |
| to_persona | varchar(20) | NO | 새 페르소나 |
| trigger_message | text | YES | 변경을 유발한 메시지 |
| trigger_worldview | varchar(50) | YES | 감지된 세계관 ID |
| confidence | decimal(3,2) | YES | 세계관 감지 신뢰도 |
| changed_at | datetime | NO | 변경 시간 |

### 4.3 사용 예시

```php
// 이력 기록
$history = new stdClass();
$history->agent_id = 16;
$history->user_id = $USER->id;
$history->from_persona = $previousPersona;
$history->to_persona = $newPersona;
$history->trigger_message = $message;
$history->trigger_worldview = $worldviewId;
$history->confidence = $confidence;

$DB->insert_record('at_agent_persona_history', $history);

// 이력 조회
$records = $DB->get_records_sql(
    "SELECT * FROM {at_agent_persona_history}
     WHERE agent_id = ? AND user_id = ?
     ORDER BY changed_at DESC
     LIMIT ?",
    [16, $USER->id, 20]
);
```

---

## 5. at_agent_messages

에이전트 간 메시지 전달을 위한 테이블입니다.

### 5.1 테이블 구조

```sql
CREATE TABLE `at_agent_messages` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `from_agent` int(11) NOT NULL COMMENT '발신 에이전트',
  `to_agent` int(11) NOT NULL COMMENT '수신 에이전트',
  `user_id` bigint(20) NOT NULL COMMENT '관련 사용자',
  `message_type` varchar(50) NOT NULL COMMENT '메시지 유형',
  `payload` text NOT NULL COMMENT 'JSON 페이로드',
  `priority` tinyint(4) DEFAULT '5' COMMENT '우선순위 (1-10)',
  `status` enum('pending','processing','completed','failed') DEFAULT 'pending',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `processed_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_to_agent_status` (`to_agent`, `status`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 5.2 메시지 유형

| message_type | 설명 |
|--------------|------|
| persona_change | 페르소나 변경 알림 |
| state_sync | 상태 동기화 요청 |
| context_share | 컨텍스트 공유 |
| request_data | 데이터 요청 |
| response_data | 데이터 응답 |

### 5.3 사용 예시

```php
// 메시지 전송
$message = new stdClass();
$message->from_agent = 16;
$message->to_agent = 1;  // Agent01
$message->user_id = $USER->id;
$message->message_type = 'context_share';
$message->payload = json_encode([
    'current_worldview' => 'exam_prep',
    'persona_id' => 'A16_P3'
]);
$message->priority = 5;

$DB->insert_record('at_agent_messages', $message);

// 메시지 수신
$messages = $DB->get_records_sql(
    "SELECT * FROM {at_agent_messages}
     WHERE to_agent = ? AND status = 'pending'
     ORDER BY priority ASC, created_at ASC",
    [16]
);
```

---

## 6. mdl_user_info_data

Moodle 기본 테이블로, 사용자 역할 정보를 저장합니다.

### 6.1 역할 조회

```php
// fieldid='22'가 역할 필드
$userRole = $DB->get_record_sql(
    "SELECT data FROM mdl_user_info_data
     WHERE userid = ? AND fieldid = '22'",
    [$USER->id]
);

$role = $userRole ? $userRole->data : 'student';
// 가능한 값: 'student', 'teacher', 'admin'
```

---

## 7. 인덱스 설계

### 7.1 현재 인덱스

```sql
-- at_agent_persona_state
UNIQUE KEY `uk_agent_user` (`agent_id`, `user_id`)  -- 상태 조회
KEY `idx_user_id` (`user_id`)                        -- 사용자별 조회
KEY `idx_updated_at` (`updated_at`)                  -- 최근 업데이트 조회

-- at_agent_persona_history
KEY `idx_agent_user` (`agent_id`, `user_id`)         -- 이력 조회
KEY `idx_changed_at` (`changed_at`)                  -- 시간순 정렬
KEY `idx_to_persona` (`to_persona`)                  -- 페르소나별 통계

-- at_agent_messages
KEY `idx_to_agent_status` (`to_agent`, `status`)     -- 펜딩 메시지 조회
KEY `idx_user_id` (`user_id`)                        -- 사용자별 메시지
```

### 7.2 인덱스 추가 가이드

```sql
-- 필요시 추가할 인덱스
-- 세계관별 이력 조회
ALTER TABLE at_agent_persona_history
ADD INDEX idx_trigger_worldview (trigger_worldview);

-- 복합 조회 최적화
ALTER TABLE at_agent_persona_state
ADD INDEX idx_persona_updated (persona_id, updated_at);
```

---

## 8. 데이터 타입 가이드

### 8.1 ID 필드

```sql
-- 자동 증가 PK
`id` bigint(20) NOT NULL AUTO_INCREMENT

-- 외래 키 참조 (Moodle user.id)
`user_id` bigint(20) NOT NULL
```

### 8.2 문자열 필드

```sql
-- 고정 길이 코드
`persona_id` varchar(20)      -- A16_P1 형식
`worldview_id` varchar(50)    -- exam_prep 형식
`message_type` varchar(50)    -- 메시지 유형

-- 가변 길이 텍스트
`trigger_message` text        -- 사용자 메시지 (최대 65KB)
`context_data` text           -- JSON 데이터
`payload` text                -- JSON 페이로드
```

### 8.3 날짜/시간 필드

```sql
-- 자동 생성 시간
`created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP

-- 자동 업데이트 시간
`updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

-- 수동 설정 시간
`last_interaction` datetime DEFAULT NULL
```

### 8.4 숫자 필드

```sql
-- 에이전트 번호 (1-21)
`agent_id` int(11) NOT NULL

-- 신뢰도 (0.00-1.00)
`confidence` decimal(3,2) DEFAULT NULL

-- 우선순위 (1-10)
`priority` tinyint(4) DEFAULT '5'
```

---

## 9. 마이그레이션

### 9.1 테이블 생성 스크립트

```php
<?php
/**
 * Agent16 DB 마이그레이션 스크립트
 * 위치: migration/create_persona_tables.php
 */

include_once("/home/moodle/public_html/moodle/config.php");
global $DB;

// at_agent_persona_state 테이블 생성
$sql1 = "CREATE TABLE IF NOT EXISTS `at_agent_persona_state` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `agent_id` int(11) NOT NULL,
  `user_id` bigint(20) NOT NULL,
  `persona_id` varchar(20) NOT NULL,
  `context_data` text,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `last_interaction` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_agent_user` (`agent_id`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";

// at_agent_persona_history 테이블 생성
$sql2 = "CREATE TABLE IF NOT EXISTS `at_agent_persona_history` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `agent_id` int(11) NOT NULL,
  `user_id` bigint(20) NOT NULL,
  `from_persona` varchar(20) DEFAULT NULL,
  `to_persona` varchar(20) NOT NULL,
  `trigger_message` text,
  `trigger_worldview` varchar(50) DEFAULT NULL,
  `confidence` decimal(3,2) DEFAULT NULL,
  `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_agent_user` (`agent_id`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";

try {
    $DB->execute($sql1);
    echo "at_agent_persona_state 생성 완료\n";

    $DB->execute($sql2);
    echo "at_agent_persona_history 생성 완료\n";
} catch (Exception $e) {
    echo "오류: " . $e->getMessage() . "\n";
}
```

### 9.2 데이터 백업

```sql
-- 테이블 백업
CREATE TABLE at_agent_persona_state_backup AS
SELECT * FROM at_agent_persona_state;

-- 복원
INSERT INTO at_agent_persona_state
SELECT * FROM at_agent_persona_state_backup;
```

---

## 10. 쿼리 최적화

### 10.1 자주 사용되는 쿼리

```sql
-- 현재 상태 조회 (가장 빈번)
SELECT persona_id, context_data, last_interaction
FROM at_agent_persona_state
WHERE agent_id = 16 AND user_id = ?;

-- 최근 이력 조회
SELECT from_persona, to_persona, trigger_worldview, changed_at
FROM at_agent_persona_history
WHERE agent_id = 16 AND user_id = ?
ORDER BY changed_at DESC
LIMIT 10;

-- 페르소나 사용 통계
SELECT to_persona, COUNT(*) as count
FROM at_agent_persona_history
WHERE agent_id = 16
GROUP BY to_persona
ORDER BY count DESC;
```

### 10.2 성능 주의사항

1. **text 컬럼 조회 최소화**: context_data, payload는 필요할 때만 SELECT
2. **인덱스 활용**: WHERE 절에 인덱스 컬럼 사용
3. **LIMIT 사용**: 이력 조회시 항상 LIMIT 지정
4. **날짜 범위**: 오래된 이력은 별도 아카이브 고려

---

## 11. 데이터 정리

### 11.1 오래된 이력 삭제

```sql
-- 90일 이상 된 이력 삭제
DELETE FROM at_agent_persona_history
WHERE changed_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 11.2 처리 완료 메시지 정리

```sql
-- 7일 이상 된 완료/실패 메시지 삭제
DELETE FROM at_agent_messages
WHERE status IN ('completed', 'failed')
AND processed_at < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

---

*이 문서는 DB 스키마 구조 및 관리 방법을 설명합니다.*
*관련: [00_시스템_개요.md](./00_시스템_개요.md), [07_통합_배포_가이드.md](./07_통합_배포_가이드.md)*
