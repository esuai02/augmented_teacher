#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
dataindex.html 파일에 테이블명과 툴팁 추가
"""

import re
import sys

# 데이터 항목별 테이블/필드 매핑
DATA_MAPPING = {
    "거주지 주소": ("mdl_user", ["address", "city"]),
    "등하교 시간": ("설문", ["(설문으로 수집)"]),
    "통학 거리": ("설문", ["(설문으로 수집)"]),
    "학원/과외 거리": ("설문", ["(설문으로 수집)"]),
    "개인 학습 공간 유무": ("설문", ["(설문으로 수집)"]),
    "최근 학교 시험 범위": ("설문", ["(설문으로 수집)"]),
    "학년 대비 선행 진도 정도": ("계산값", ["(진도 기반 계산)"]),
    "문제집 완료율": ("설문", ["(설문으로 수집)"]),
    "교과서 활용 여부": ("설문", ["(설문으로 수집)"]),
    "경시/심화 경험 여부": ("설문", ["(설문으로 수집)"]),
    "고난도 선호도": ("설문", ["(설문으로 수집)"]),
    "반복 학습 선호도": ("설문", ["(설문으로 수집)"]),
    "집중 시간 평균": ("설문", ["(설문으로 수집)"]),
    "쉬는 시간 패턴": ("설문", ["(설문으로 수집)"]),
    "포모도로 경험 유무": ("설문", ["(설문으로 수집)"]),
    "공부 장소 패턴": ("설문", ["(설문으로 수집)"]),
    "숙제 수행률": ("설문", ["(설문으로 수집)"]),
    "문제 오답 정리 습관": ("설문", ["(설문으로 수집)"]),
    "실수 vs 개념 미해결 비율": ("설문", ["(설문으로 수집)"]),
    "필기 습관 유무": ("설문", ["(설문으로 수집)"]),
    "정리 도구(노션/노트 등) 사용 여부": ("설문", ["(설문으로 수집)"]),
    "학습 자료 스스로 선택 여부": ("설문", ["(설문으로 수집)"]),
    "수학 스트레스 정도": ("설문", ["(설문으로 수집)"]),
    "실패 경험에 대한 반응": ("설문", ["(설문으로 수집)"]),
    "성취 경험 빈도": ("설문", ["(설문으로 수집)"]),
    "학습 목표 스스로 설정하는지": ("설문", ["(설문으로 수집)"]),
    "목표 도달 경험 유무": ("설문", ["(설문으로 수집)"]),
    "수업 중 감정 상태 기록": ("설문", ["(설문으로 수집)"]),
    "질문 요청 경향": ("설문", ["(설문으로 수집)"]),
    "경쟁심 or 협동성": ("설문", ["(설문으로 수집)"]),
    "경험 기간 (총 개월수)": ("설문", ["(설문으로 수집)"]),
    "과거 시험 성적 히스토리": ("설문", ["(설문으로 수집)"]),
    "개념 완성 이력": ("설문", ["(설문으로 수집)"]),
    "누적 오답노트 보유 여부": ("설문", ["(설문으로 수집)"]),
    "자가진단/레벨 테스트 이력": ("설문", ["(설문으로 수집)"]),
    "과목별 튜터링 여부": ("설문", ["(설문으로 수집)"]),
    "학기별 학습 강도 변화": ("설문", ["(설문으로 수집)"]),
    "단기 목표 (예: 숙제 완수)": ("설문", ["(설문으로 수집)"]),
    "중기 목표 (예: 개념 완성)": ("설문", ["(설문으로 수집)"]),
    "목표 우선순위": ("설문", ["(설문으로 수집)"]),
    "본인이 설정한 목표 vs 부모 설정": ("설문", ["(설문으로 수집)"]),
    "목표에 대한 지속력": ("설문", ["(설문으로 수집)"]),
    "목표 달성 후 보상 방식": ("설문", ["(설문으로 수집)"]),
    "목표 리뷰 빈도": ("설문", ["(설문으로 수집)"]),
    "목표 실패 원인 분석 능력": ("설문", ["(설문으로 수집)"]),
    "목표 기반 루틴 이행률": ("설문", ["(설문으로 수집)"]),
    "학습에 대한 관심도": ("설문", ["(설문으로 수집)"]),
    "자주 확인하는 항목": ("설문", ["(설문으로 수집)"]),
    "학습 계획 세워주는지 여부": ("설문", ["(설문으로 수집)"]),
    "학습 내용 공유 빈도": ("설문", ["(설문으로 수집)"]),
    "학습 스트레스 조율 방식": ("설문", ["(설문으로 수집)"]),
    "보호자 직업군 (교육 관련 여부)": ("설문", ["(설문으로 수집)"]),
    "보호자의 수학 이해도": ("설문", ["(설문으로 수집)"]),
    "가정 내 학습 분위기": ("설문", ["(설문으로 수집)"]),
    "주말/방학 학습 지도 방식": ("설문", ["(설문으로 수집)"]),
}

def add_table_info(html_file):
    with open(html_file, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 패턴: <td class="data-name">데이터 이름</td>
    pattern = r'<td class="data-name">([^<]+)</td>'
    
    def replace_func(match):
        data_name = match.group(1).strip()
        
        # 이미 wrapper가 있는 경우는 건너뛰기
        if 'data-name-wrapper' in content[content.find(match.group(0))-100:content.find(match.group(0))+100]:
            return match.group(0)
        
        # 매핑에서 찾기
        if data_name in DATA_MAPPING:
            table_name, fields = DATA_MAPPING[data_name]
        else:
            table_name = "설문"
            fields = ["(설문으로 수집)"]
        
        # 필드 리스트 생성
        fields_html = '\n'.join([f'                                            <div class="tooltip-field">{field}</div>' for field in fields])
        
        return f'''<td class="data-name">
                                <div class="data-name-wrapper">
                                    <span>{data_name}</span>
                                    <span class="table-name">{table_name}</span>
                                    <div class="tooltip">
                                        <div class="tooltip-table">{table_name}</div>
                                        <div class="tooltip-fields">
{fields_html}
                                        </div>
                                    </div>
                                </div>
                            </td>'''
    
    new_content = re.sub(pattern, replace_func, content)
    
    with open(html_file, 'w', encoding='utf-8') as f:
        f.write(new_content)
    
    print(f"완료: {html_file}")

if __name__ == "__main__":
    html_file = "alt42/orchestration/agents/agent01_onboarding/rules/dataindex.html"
    add_table_info(html_file)

