# Agent 21 - Intervention Execution Mission

## 🎯 미션 핵심

Agent 21은 **최종적으로 개입을 실행**하는 것을 목표로 합니다. Agent 20에서 전달받은 개입 계획을 실제로 실행하고, 결과를 기록하며, 효과를 모니터링합니다.

---

## 📋 목적/스코프

### 핵심 목적
- **개입방법 수신**: Agent 20에서 전달받은 개입 계획 및 방법 수신
- **개인 목록 관리**: 현재 학생의 개인 개입 목록에 새로운 개입 추가
- **우선순위 재조정**: 기존 목록과 새로운 개입을 통합하여 우선순위 재조정
- **실행 시점 타게팅**: 최적의 실행 시점을 계산하고 타게팅
- **개입 실행**: 실제 개입을 실행하여 학생에게 전달
- **결과 기록**: 실행 결과, 학생 반응, 성과 지표를 기록

### 실행 범위
- **개입 목록 통합**: 기존 개입 목록과 새로운 개입을 하나의 우선순위 목록으로 통합
- **우선순위 재계산**: 룰 기반 우선순위 계산 알고리즘을 통해 실행 순서 결정
- **타이밍 최적화**: 학생의 학습 패턴, 집중 시간대, 활동 상태를 고려한 최적 실행 시점 결정
- **실행 모니터링**: 개입 실행 후 학생 반응 및 효과 모니터링
- **알림 관리**: 메시지 양이 과도한 경우 선생님에게 알림하여 직접 조정 요청

---

## 📊 데이터 소스 및 입력

### 1. 개입 계획 데이터 (Agent 20에서 전달)
- **개입 위치**: 인터페이스 위치 또는 데이터 트리거
- **개입 방식**: 알림 표시, 메시지, 채팅, 호출
- **상호작용 유형**: 텍스트 전달, 상호작용 컨텐츠, 학습루틴 개선, 타임쉬프팅, 활동반려, 멀티턴 상호작용, 비선형 상호작용
- **개입 컨텐츠**: Agent 19에서 생성된 상호작용 컨텐츠 패키지
- **예상 타이밍**: Agent 20에서 제안한 개입 시간창
- **대상 학생**: 개입을 받을 학생 정보

### 2. 개인 개입 목록 (기존 데이터)
- **대기 중인 개입**: 아직 실행되지 않은 개입 목록
- **우선순위 점수**: 각 개입의 현재 우선순위 점수
- **예정된 실행 시점**: 각 개입의 예정 실행 시간
- **의존성 관계**: 개입 간 선후 관계 및 의존성

### 3. 학생 상태 데이터
- **현재 활동**: 학생이 현재 수행 중인 활동
- **집중 시간대**: 학생의 최적 집중 시간대 (Agent 01에서 수집)
- **학습 패턴**: 일일/주간 학습 패턴 (Agent 09에서 수집)
- **감정 상태**: 현재 감정 상태 및 동기 수준 (Agent 05에서 수집)
- **위험도**: 학습 이탈 위험도 (Agent 13에서 수집)

### 4. 우선순위 룰 (rules.yaml)
- **우선순위 계산 알고리즘**: 목표 기여도, 긴급도, 효과성 예측 등을 종합한 점수 계산
- **타이밍 룰**: 실행 가능한 시간대 및 제약 조건
- **메시지 제한 룰**: 일일 최대 메시지 수, 시간당 최대 메시지 수 등

### 5. 실행 히스토리
- **과거 실행 기록**: 이전 개입 실행 기록 및 결과
- **효과성 데이터**: 각 개입 유형별 효과성 지표
- **학생 반응 패턴**: 학생의 개입 반응 패턴 분석

---

## 🔍 데이터 트리거 옵션 (Agent 20에서 이동)

Agent 20에서 개입 계획 수립 시 사용하는 데이터 트리거 옵션은 Agent 21에서 실제 실행 시점을 결정하는 데 사용됩니다.

### 데이터 트리거 옵션 (15개)
```
침착도 하락, 필기 지연, 지연된 풀이,
포모도르 미작성, 점수 저조, 휴식 없음,
오늘활동 위험, 풀이노트 이상, 개념노트 이상,
지각, 휴식시간 초과, 개인규칙 이탈,
귀가검사 준비 미비, 오답노트 누락, 과제 미제출
```

### 트리거 모니터링
- 각 데이터 트리거는 실시간으로 모니터링됩니다
- 트리거 조건이 충족되면 해당 개입이 실행 대기 목록에 추가됩니다
- 트리거 기반 개입은 즉시 실행 또는 다음 최적 시점에 실행됩니다

---

## ⚙️ 개입 실행 워크플로우

### 1단계: 개입방법 수신 및 목록 추가

#### 입력 처리
- Agent 20에서 전달받은 개입 계획 데이터 수신
- 개입 메타데이터 검증 (대상, 방식, 컨텐츠, 타이밍)

#### 개인 목록 추가
```
신규 개입 → 개인 개입 목록에 추가
- 개입 ID 생성
- 초기 우선순위 점수 할당
- 예정 실행 시점 설정 (Agent 20 제안값)
- 상태: "대기중"
```

#### 출력
- 개입 목록 업데이트 완료
- 총 대기 중인 개입 수
- 새로 추가된 개입 정보

---

### 2단계: 우선순위 재조정

#### 기존 목록과 통합
- 기존 대기 중인 개입 목록과 신규 개입을 하나의 목록으로 통합
- 각 개입의 우선순위 점수를 재계산

#### 우선순위 계산 알고리즘

**기본 우선순위 점수 계산식** (Agent 17 참조)
```
우선순위 점수 = (목표 기여도 × 0.4) + (긴급도 × 0.3) + (효과성 예측 × 0.2) + (완료 용이성 × 0.1)
```

**개입 특화 가중치 적용**
```
개입 우선순위 점수 = 기본 점수 × 개입 가중치

개입 가중치 요소:
- 데이터 트리거 개입: 1.2배 (즉시 대응 필요)
- 인터페이스 위치 개입: 1.0배 (일반)
- 후속 조치 개입: 0.8배 (낮은 우선순위)
- 예방적 개입: 0.9배 (중간 우선순위)
```

**시간 가중치 적용**
```
시간 가중치 = 1.0 + (긴급도 보정)

긴급도 보정:
- 즉시 실행 필요 (Critical): +0.5
- 당일 실행 필요 (High): +0.3
- 이번 주 실행 필요 (Medium): +0.1
- 다음 주 실행 가능 (Low): 0.0
```

#### 우선순위 재조정 룰

**의존성 고려**
- 선행 개입이 완료되어야 실행 가능한 개입은 후순위로 배치
- 관련 개입은 연속 실행이 효과적일 경우 근접 배치

**시간 제약 고려**
- 예정 실행 시점이 가까운 개입 우선
- 학생의 집중 시간대와 일치하는 개입 우선
- 학생이 현재 활동 중인 경우 개입 실행 지연 가능

**효과성 예측 고려**
- 과거 실행 기록에서 효과성이 높았던 개입 유형 우선
- 학생의 선호도와 잘 맞는 개입 방식 우선

#### 출력
- 재조정된 우선순위 목록
- 각 개입의 최종 우선순위 점수
- 예상 실행 순서

---

### 3단계: 실행 시점 타게팅

#### 최적 실행 시점 계산

**학생 상태 기반 타이밍**
- 현재 활동 중단 가능 여부 확인
- 집중 시간대와의 일치도 계산
- 감정 상태 고려 (부정 감정 시 개입 지연 고려)

**학습 패턴 기반 타이밍**
- 일일 학습 패턴 분석 (언제 활동 전환이 일어나는지)
- 주간 학습 패턴 분석 (요일별 최적 시간대)
- 과거 개입 효과성 데이터 기반 최적 시간대

**데이터 트리거 기반 타이밍**
- 트리거 발생 즉시 실행 또는 지연 실행 결정
- 트리거 강도에 따른 우선순위 조정
- 연쇄 트리거 발생 시 개입 통합 고려

#### 실행 시점 결정 알고리즘

```
최적 실행 시점 = 현재 시각 + 타이밍 오프셋

타이밍 오프셋 계산:
- 즉시 실행 필요: 0분 (즉시)
- 최적 시간대 대인: 다음 최적 시간대까지 대기
- 활동 전환 지점 대인: 현재 활동 완료 예상 시점
- 집중 시간대 대인: 다음 집중 시간대까지 대기
```

#### 출력
- 각 개입의 최종 실행 시점
- 실행 대기 시간
- 실행 시점 결정 근거

---

### 4단계: 개입 실행

#### 실행 전 검증
- 실행 시점 도달 확인
- 학생 상태 재확인 (활동 중이 아닌지, 휴식 중인지는 개입 가능)
- 메시지 제한 확인 (일일/시간당 제한 초과 여부)

#### 메시지 양 관리

**메시지 제한 룰**
```
일일 최대 메시지 수: 10개
시간당 최대 메시지 수: 3개
연속 메시지 간 최소 간격: 5분
```

**제한 초과 시 처리**
1. 메시지 양이 임계값(일일 8개 또는 시간당 2개)에 도달하면 선생님에게 알림
2. 선생님 승인 후 개입 실행 또는 선생님이 직접 조정
3. 자동 실행 중단 및 선생님 개입 대기

**선생님 알림 메시지**
```
"[경고] 학생 [이름]에게 오늘 이미 8개의 개입 메시지가 전송되었습니다.
추가 개입이 필요하신 경우 수동으로 승인해주세요.
- 대기 중인 개입 수: [N]개
- 다음 개입 예정: [개입 내용] (예정 시각: [시간])
- 승인/조정하기"
```

#### 개입 실행

**실행 방식별 처리**

1. **알림 표시** (🔔)
   - UI에 알림 아이콘 표시
   - 알림 클릭 시 상호작용 컨텐츠 표시

2. **메시지** (💬)
   - 메시지함에 메시지 전송
   - 상호작용 컨텐츠 포함

3. **채팅** (💬)
   - 실시간 채팅 인터페이스 활성화
   - 멀티턴 상호작용 시작

4. **호출** (📞)
   - 즉각적인 주의 요청
   - 강제 알림 및 화면 전환

#### 실행 기록
- 실행 시각 기록
- 실행 방식 기록
- 전달된 컨텐츠 ID 기록
- 실행 상태: "실행완료"

---

### 5단계: 결과 기록 및 모니터링

#### 실행 결과 기록

**즉시 기록 항목**
- 실행 시각
- 실행 방식
- 전달된 컨텐츠
- 학생 반응 (클릭 여부, 읽음 여부, 응답 여부)

**후속 모니터링 항목** (24시간 후)
- 학생 반응: 반응 여부, 반응 시간, 반응 내용
- 성과 지표: 목표 달성 여부, 행동 변화 여부
- 효과성 평가: 개입 효과성 점수 (0~100)

#### 결과 분석

**효과성 계산**
```
효과성 점수 = (학생 반응 점수 × 0.4) + (목표 달성도 × 0.4) + (행동 변화도 × 0.2)

학생 반응 점수:
- 즉시 반응: 100점
- 1시간 내 반응: 80점
- 24시간 내 반응: 60점
- 무반응: 0점

목표 달성도:
- 완전 달성: 100점
- 부분 달성: 50점
- 미달성: 0점

행동 변화도:
- 긍정적 변화: 100점
- 변화 없음: 50점
- 부정적 변화: 0점
```

#### 피드백 루프
- 효과성 데이터를 Agent 20, Agent 19에 피드백
- 향후 개입 계획에 효과성 데이터 반영
- 효과성이 낮은 개입 유형/방식 식별 및 개선

---

## 🔗 다른 에이전트와의 연계

### Agent 20 (Intervention Preparation) 연계
- **입력**: 개입 계획, 개입 방식, 개입 위치, 상호작용 유형
- **목적**: 개입 계획을 실제 실행으로 전환
- **출력**: 실행 결과를 Agent 20에 피드백하여 향후 계획 개선

### Agent 19 (Interaction Content) 연계
- **입력**: 패키징된 상호작용 컨텐츠
- **목적**: 생성된 컨텐츠를 학생에게 전달
- **출력**: 컨텐츠 효과성 데이터를 Agent 19에 피드백

### Agent 17 (Remaining Activities) 연계
- **입력**: 우선순위 계산 알고리즘 참조
- **목적**: 개입 우선순위 재조정 시 Agent 17의 우선순위 로직 활용
- **출력**: 개입 실행으로 인한 활동 변화를 Agent 17에 통보

### Agent 14 (Current Position) 연계
- **입력**: 현재 진행 위치, 위험도 등급
- **목적**: 개입 실행 시점 결정 시 학생 상태 고려
- **출력**: 개입 실행 후 진행 상태 변화를 Agent 14에 반영

### Agent 01 (Onboarding) 연계
- **입력**: 학생 프로필, 집중 시간대, 학습 스타일
- **목적**: 최적 실행 시점 결정 시 학생 특성 고려
- **출력**: 개입 실행 결과를 학생 프로필에 반영

### Agent 05 (Learning Emotion) 연계
- **입력**: 현재 감정 상태, 동기 수준
- **목적**: 개입 실행 시점 결정 시 감정 상태 고려
- **출력**: 개입이 감정 상태에 미친 영향을 Agent 05에 피드백

### Agent 13 (Learning Dropout) 연계
- **입력**: 이탈 위험도
- **목적**: 고위험 학생에게 우선순위 높은 개입 실행
- **출력**: 개입 실행 후 위험도 변화를 Agent 13에 반영

---

## 📤 출력 형식

### 1. 개입 목록 통합 결과

```
=== 개입 목록 통합 결과 ===

[기존 대기 개입]
- 총 개입 수: 5개
- 최고 우선순위: [개입 ID] (점수: 85.3)

[신규 추가 개입]
- 추가된 개입 수: 2개
- 개입 ID: [ID1], [ID2]

[통합 후 목록]
- 총 개입 수: 7개
- 재조정 완료
```

### 2. 우선순위 재조정 결과

```
=== 우선순위 재조정 결과 ===

[실행 순서]
1. [개입 ID1] - 우선순위: 92.5점
   - 실행 시점: 2025-01-21 19:10
   - 방식: 메시지
   - 이유: 데이터 트리거 발생, 긴급도 높음

2. [개입 ID2] - 우선순위: 88.3점
   - 실행 시점: 2025-01-21 20:00
   - 방식: 알림 표시
   - 이유: 집중 시간대 일치, 효과성 예측 높음

3. [개입 ID3] - 우선순위: 75.1점
   - 실행 시점: 2025-01-22 09:00
   - 방식: 채팅
   - 이유: 후속 조치, 낮은 우선순위
...
```

### 3. 실행 결과 기록

```
=== 개입 실행 결과 ===

[실행 정보]
- 개입 ID: [ID]
- 실행 시각: 2025-01-21 19:10:25
- 실행 방식: 메시지
- 전달 컨텐츠: [컨텐츠 ID]

[학생 반응]
- 읽음 여부: 읽음 (19:10:30)
- 클릭 여부: 클릭 (19:11:15)
- 응답 여부: 응답 (19:12:00)
- 반응 시간: 1분 35초

[효과성 평가] (24시간 후)
- 학생 반응 점수: 100점
- 목표 달성도: 80점
- 행동 변화도: 90점
- 종합 효과성: 91점
```

---

## 🚨 특수 상황 대응

### 1. 메시지 양 과다

**상황**
- 일일 메시지 수가 8개 이상 또는 시간당 3개 이상

**조치**
1. 자동 실행 중단
2. 선생님에게 알림 전송
3. 선생님 승인 대기 또는 직접 조정 대기
4. 승인된 개입만 실행

**알림 메시지 예시**
```
"[경고] 메시지 제한 초과
학생 [이름]에게 오늘 이미 8개의 개입 메시지가 전송되었습니다.
추가 개입 실행을 위해서는 선생님의 승인이 필요합니다.

대기 중인 개입:
1. [개입 내용] - 예정: [시간] - 우선순위: [점수]
2. [개입 내용] - 예정: [시간] - 우선순위: [점수]
...

승인/조정하기"
```

### 2. 연쇄 트리거 발생

**상황**
- 동시에 여러 데이터 트리거가 발생하여 여러 개입이 동시에 실행 대기

**조치**
1. 관련 개입 통합 검토
2. 통합 가능한 경우 하나의 개입으로 통합
3. 통합 불가능한 경우 우선순위에 따라 순차 실행
4. 학생에게 과도한 부담을 주지 않도록 타이밍 조정

### 3. 학생이 활동 중

**상황**
- 실행 시점에 학생이 학습 활동 중

**조치**
1. 활동 종료 예상 시점까지 대기
2. 긴급 개입인 경우 활동 중단 가능 여부 확인
3. 활동 중단이 어려운 경우 다음 최적 시점으로 재조정

### 4. 개입 실행 실패

**상황**
- 개입 실행 중 오류 발생 (네트워크 오류, 컨텐츠 오류 등)

**조치**
1. 오류 로그 기록
2. 재시도 로직 실행 (최대 3회)
3. 재시도 실패 시 선생님에게 알림
4. 다음 최적 시점에 재실행 시도

---

## 📈 성공 기준

### 개입 실행 성공 판정

1. **실행 완료**: 개입이 성공적으로 학생에게 전달됨
2. **반응 수신**: 학생이 개입에 반응함 (읽음, 클릭, 응답 등)
3. **목표 달성**: 개입의 목표가 달성됨
4. **효과성**: 효과성 점수가 70점 이상

### 측정 지표

- **실행 성공률**: 성공적으로 실행된 개입 / 전체 실행 시도 개입
- **학생 반응률**: 학생 반응이 있는 개입 / 전체 실행 개입
- **목표 달성률**: 목표 달성 개입 / 전체 실행 개입
- **평균 효과성 점수**: 모든 실행 개입의 효과성 점수 평균
- **메시지 제한 준수율**: 메시지 제한을 준수한 일수 / 전체 일수

---

## 🔄 업데이트 주기

- **실시간**: 데이터 트리거 발생 시 즉시 개입 목록 업데이트 및 우선순위 재조정
- **분 단위**: 실행 시점 도달 확인 및 개입 실행
- **시간 단위**: 메시지 제한 확인 및 선생님 알림
- **일 단위**: 일일 실행 결과 종합 및 효과성 평가
- **주 단위**: 주간 개입 효과성 분석 및 알고리즘 개선

---

## 📝 실행 예시

### 예시 1: 데이터 트리거 기반 즉시 개입

**상황**
- 데이터 트리거 "침착도 하락" 발생
- Agent 20에서 개입 계획 수신 (메시지 방식, 상호작용 컨텐츠 포함)

**실행**
1. 개인 목록에 추가 (우선순위: 95점, 긴급도: Critical)
2. 우선순위 재조정 후 1순위로 배정
3. 즉시 실행 시점 결정 (타이밍 오프셋: 0분)
4. 메시지 제한 확인 (오늘 3개 전송, 제한 내)
5. 메시지 전송 실행
6. 학생 반응 모니터링 (5분 내 읽음, 10분 내 응답)
7. 24시간 후 효과성 평가 (효과성: 88점)

---

### 예시 2: 메시지 제한 초과 시 선생님 알림

**상황**
- 오늘 이미 8개의 개입 메시지 전송 완료
- 추가 개입 3개가 실행 대기 중 (우선순위: 85점, 82점, 78점)

**실행**
1. 메시지 제한 확인 (8개 전송, 제한: 10개, 임계값: 8개)
2. 자동 실행 중단
3. 선생님에게 알림 전송
4. 선생님 승인 대기
5. 선생님이 2개 개입 승인, 1개 개입 연기 결정
6. 승인된 2개 개입만 실행
7. 실행 결과 기록

---

### 예시 3: 집중 시간대 기반 최적 타이밍 개입

**상황**
- Agent 20에서 개입 계획 수신 (채팅 방식, 집중 시간대 19:00-21:00)
- 현재 시각: 18:30

**실행**
1. 개인 목록에 추가 (우선순위: 80점)
2. 우선순위 재조정 후 3순위로 배정
3. 최적 실행 시점 계산 (집중 시간대 시작: 19:00)
4. 타이밍 오프셋: 30분
5. 19:00에 채팅 인터페이스 활성화
6. 학생과 멀티턴 상호작용 시작
7. 상호작용 완료 후 결과 기록

---

Last Updated: 2025-01-21
