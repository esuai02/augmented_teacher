# 온톨로지 통합 체크리스트 및 리팩터링 플랜

**생성일**: 2025-01-27  
**버전**: 1.0  
**상태**: ✅ 엔진 구현 완료 → 🔧 통합 진행 중

---

## 📊 현재 상태 평가

### ✅ 완료된 부분 (공통 엔진 레벨)

| 항목 | 상태 | 비고 |
|------|------|------|
| `create_instance` 구현 | ✅ 완료 | 인스턴스 생성 및 DB 저장 정상 동작 |
| `set_property` 구현 | ✅ 완료 | 프로퍼티 설정 정상 동작 |
| `reason_over` 구현 | ✅ 완료 | 추론 로직 구현 완료 |
| `get_instance` 구현 | ✅ 완료 | 인스턴스 조회 정상 동작 |
| 데이터베이스 스키마 | ✅ 완료 | `alt42_ontology_instances` 테이블 자동 생성 |
| 룰 엔진 연동 | 🔄 진행 중 | 에이전트별 진행 상황 상이 |

### 🔧 에이전트별 상태

| 에이전트 | 룰 엔진 연동 | 응답 생성 통합 | 비고 |
|----------|--------------|----------------|------|
| **Agent 01 (Onboarding)** | ✅ 완료 | ✅ 완료 | 실제 사용 검증 단계 |
| **Agent 04 (Weakpoints)** | ⏳ 대기 | ⏳ 대기 | 룰 엔진 연동 및 응답 통합 필요 |

---

## 🔍 실제 호출 흐름 (표준)

```
[1] 사용자 질문/활동 입력
    ↓
[2] 룰 엔진 평가 (Python/PHP)
    ↓
[3] decision['actions'] 반환 (온톨로지 액션 포함)
    ↓
[4] OntologyActionHandler::executeAction() - 액션 실행
    ↓
[5] OntologyEngine - 인스턴스 생성/추론/전략 생성
    ↓
[6] decision['ontology_results']에 결과 저장
    ↓
[7] 응답 생성기 - 온톨로지 결과 활용
    ↓
[8] 최종 응답 반환
```

---

## 📋 통합 체크리스트

### 1. 엔진 레벨 (공통)

- [x] `OntologyEngine.php` 구현
- [x] `OntologyActionHandler.php` 구현
- [x] 데이터베이스 스키마 생성
- [x] 인스턴스 CRUD 기능
- [x] 추론 로직 구현

### 2. 룰 엔진 연동

#### Agent 01 (Onboarding)
- [x] Python 룰 엔진에서 온톨로지 액션 반환
- [x] PHP에서 온톨로지 액션 감지 및 실행
- [x] 결과 저장 및 반환

#### Agent 04 (Weakpoints)
- [ ] Python 룰 엔진에서 온톨로지 액션 반환
- [ ] PHP에서 온톨로지 액션 감지 및 실행
- [ ] 결과 저장 및 반환

### 3. 응답 생성 통합

#### Agent 01 (Onboarding)
- [x] 온톨로지 결과 추출
- [x] 전략/절차 데이터를 메시지에 반영
- [x] 추론 결과를 제안에 반영

#### Agent 04 (Weakpoints)
- [ ] 온톨로지 결과 추출
- [ ] 보강 방안 데이터를 메시지에 반영
- [ ] 실행 계획 데이터를 메시지에 반영

### 4. 실제 사용 검증

- [ ] 실제 사용자 질문/활동으로 테스트
- [ ] 온톨로지 인스턴스가 올바르게 생성되는지 확인
- [ ] 추론 결과가 의미 있는지 확인
- [ ] UI에서 온톨로지 결과가 표시되는지 확인

---

## 🎯 리팩터링 플랜

### Phase 1: 추론 로직 강화

**목표**: `reason_over`가 실제 의미 있는 추론 결과 반환

- ✅ **Agent 01**: 단원 추천, 난이도 추론, 정렬 전략 추론
- ✅ **Agent 04**: 심각도 추론, 보강 전략 추론, 우선순위 추론
- [ ] **공통**: 온톨로지 그래프 탐색 (관계 기반 추론), 제약 조건 검증

### Phase 2: 응답 생성 통합

**목표**: 온톨로지 결과를 실제 응답 메시지에 반영

- ✅ **Agent 01**: 전략/절차 데이터 메시지 반영 완료
- [ ] **Agent 04**: 보강 방안/실행 계획 메시지 반영 필요
- [ ] **공통**: 프롬프트 템플릿에 온톨로지 데이터 자동 주입

### Phase 3: 성능 최적화 (대기 ⏳)

**목표**: 대량 인스턴스 처리 시 성능 개선

- [ ] 인스턴스 캐싱 (자주 사용되는 인스턴스)
- [ ] 배치 처리 (여러 인스턴스 동시 생성)
- [ ] 인덱스 최적화 (쿼리 성능 향상)

### Phase 4: 버전 관리 및 히스토리 (대기 ⏳)

**목표**: 온톨로지 인스턴스의 버전 관리

- [ ] 인스턴스 버전 관리 (변경 이력 추적)
- [ ] 타임라인 조회
- [ ] 롤백 기능

---

## ⚠️ 주의사항

### 1. 인스턴스 순서 의존성
- **문제**: `set_property`는 마지막으로 생성된 인스턴스에 적용됨
- **해결책**: 인스턴스 ID를 명시적으로 추적하거나 액션 순서를 보장하는 메커니즘 추가

### 2. 변수 치환
- **문제**: `{variable}` 같은 변수가 컨텍스트에 없으면 빈 값으로 설정됨
- **해결책**: 변수 존재 여부 사전 검증, 기본값 설정, 에러 로깅 강화

### 3. 추론 결과 검증
- **문제**: 추론 결과가 항상 의미 있는 것은 아님
- **해결책**: 추론 결과 신뢰도 점수 추가, 최소 데이터 요구사항 정의, 빈 결과에 대한 기본값 제공

---

## 📝 참고 문서

- `ONTOLOGY_ENGINE_INTEGRATION.md`: 온톨로지 엔진 연계 메커니즘
- `ONTOLOGY_RULE_INTEGRATION_CHECK.md`: 룰 연동 검증 리포트
