# Persona-based Response Rules for Agent 08 - Calmness
# Version: 1.0
# Purpose: 진정도(Calmness) 기반 페르소나 식별 및 맞춤형 감정 조절 지원
# Reference: personas.md, engine/CalmnessActionExecutor.php, engine/CalmnessConditionEvaluator.php

version: "1.0"
scenario: "calmness_support"
description: "학생 진정도 수준 식별 및 맞춤형 감정 조절 지원"

# ============================================================
# SECTION 1: 위기 상태 즉시 개입 룰 (최우선)
# ============================================================

crisis_intervention_rules:

  # === 공황 상태 감지 ===

  - rule_id: "CRISIS_001_panic_attack"
    priority: 100
    description: "공황 상태형(C_crisis_P1) 즉시 감지 및 개입"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["숨이 안 쉬어", "죽을 것 같", "무서워", "도와줘", "못 참겠어"]
        - field: "calmness_score"
          operator: "<"
          value: 50
        - AND:
          - field: "breathing_pattern"
            operator: "=="
            value: "hyperventilating"
          - field: "physical_symptoms"
            operator: "array_contains"
            value: "trembling"
    action:
      - "identify_persona: 'C_crisis_P1'"
      - "trigger_crisis_protocol: { severity: 'critical', type: 'panic' }"
      - "start_breathing_exercise: { type: '4-7-8', guided: true }"
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Very_Slow'"
      - "send_reassurance: { type: 'immediate', message: '지금 함께 호흡할게요. 제가 옆에 있어요.' }"
    confidence: 0.98
    rationale: "공황 상태는 즉각적인 안정화 개입이 필수"

  # === 해리 상태 감지 ===

  - rule_id: "CRISIS_002_dissociation"
    priority: 100
    description: "해리 상태형(C_crisis_P2) 감지 및 그라운딩"
    conditions:
      - OR:
        - field: "response_coherence"
          operator: "<"
          value: 30
        - field: "user_message"
          operator: "contains_any"
          value: ["여기가 어디", "제가 누구", "모르겠어요", "진짜예요?"]
        - field: "eye_contact"
          operator: "=="
          value: "unfocused"
        - field: "response_delay"
          operator: ">="
          value: 10
    action:
      - "identify_persona: 'C_crisis_P2'"
      - "trigger_crisis_protocol: { severity: 'high', type: 'dissociation' }"
      - "start_grounding_exercise: { type: '5-4-3-2-1', immediate: true }"
      - "send_reassurance: { type: 'grounding', message: '지금 여기 안전해요. 주변을 한번 둘러볼까요?' }"
      - "set_monitoring: { level: 'intensive', duration: 30 }"
    confidence: 0.95
    rationale: "해리 상태는 현재 연결 그라운딩이 최우선"

  # === 자해/자살 위험 감지 ===

  - rule_id: "CRISIS_003_self_harm_risk"
    priority: 100
    description: "자해/자살 위험형(C_crisis_P3) 즉시 전문가 연계"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["죽고 싶", "없어지고 싶", "끝났으면", "아프면 나아질까", "다 끝내고 싶"]
        - field: "self_harm_indicator"
          operator: "=="
          value: true
        - field: "farewell_behavior"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C_crisis_P3'"
      - "trigger_crisis_protocol: { severity: 'critical', type: 'self_harm' }"
      - "escalate_to_professional: { immediate: true }"
      - "provide_crisis_resources: { region: 'korea' }"
      - "set_monitoring: { level: 'continuous', notify_supervisor: true }"
      - "send_reassurance: { type: 'unconditional_support' }"
    confidence: 0.99
    rationale: "자살/자해 위험은 즉시 전문가 연계 필수 - 학습 중단"

  # === 트라우마 재경험 감지 ===

  - rule_id: "CRISIS_004_trauma_reexperience"
    priority: 100
    description: "트라우마 재경험형(C_crisis_P4) 현재 연결"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["그때처럼", "또 그런 일이", "그 사람이", "플래시백"]
        - field: "freeze_response"
          operator: "=="
          value: true
        - field: "hypervigilance"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C_crisis_P4'"
      - "trigger_crisis_protocol: { severity: 'high', type: 'trauma' }"
      - "start_grounding_exercise: { type: '5-4-3-2-1' }"
      - "send_reassurance: { type: 'safety', message: '지금 여기는 안전해요. 그때와 지금은 달라요.' }"
      - "set_monitoring: { level: 'intensive' }"
    confidence: 0.95
    rationale: "트라우마 반응은 현재 안전 확인과 그라운딩 우선"

  # === 급성 스트레스 반응 ===

  - rule_id: "CRISIS_005_acute_stress"
    priority: 98
    description: "급성 스트레스 반응형(C_crisis_P5) 안정화"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["이게 뭐예요", "어떻게 된 거예요", "왜요 왜요", "진짜예요?"]
        - field: "shock_indicators"
          operator: "=="
          value: true
        - AND:
          - field: "calmness_score"
            operator: "<"
            value: 70
          - field: "sudden_event"
            operator: "=="
            value: true
    action:
      - "identify_persona: 'C_crisis_P5'"
      - "trigger_crisis_protocol: { severity: 'moderate', type: 'acute_stress' }"
      - "start_breathing_exercise: { type: 'box' }"
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Slow'"
      - "send_reassurance: { type: 'orientation' }"
    confidence: 0.90
    rationale: "급성 스트레스는 차분한 현재 상황 설명과 호흡 안정화"

# ============================================================
# SECTION 2: 진정도 레벨별 페르소나 식별 룰
# ============================================================

calmness_level_identification_rules:

  # === C95: 매우 안정 상태 ===

  - rule_id: "CL_C95_001_mindfulness_master"
    priority: 70
    description: "마음챙김 마스터(C95_P1) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C95"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["괜찮아요", "천천히", "할 수 있어요", "배우면 되죠"]
        - field: "self_regulation_demonstrated"
          operator: "=="
          value: true
        - field: "emotional_stability"
          operator: ">="
          value: 90
    action:
      - "identify_persona: 'C95_P1'"
      - "set_calmness_tone: 'Professional'"
      - "set_intervention_strategy: 'ProgressRecognition'"
      - "acknowledge_progress: { type: 'self_regulation' }"
    confidence: 0.88
    rationale: "높은 자기 조절력은 마음챙김 마스터의 핵심 특성"

  - rule_id: "CL_C95_002_natural_optimist"
    priority: 68
    description: "자연스러운 낙관주의자(C95_P2) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C95"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["재미있네요", "좋아요", "기대돼요", "다음에 더 잘하면"]
        - field: "positive_outlook"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C95_P2'"
      - "set_calmness_tone: 'Encouraging'"
      - "set_intervention_strategy: 'ProgressRecognition'"
    confidence: 0.85
    rationale: "긍정적 관점과 밝은 에너지는 자연스러운 낙관주의의 신호"

  - rule_id: "CL_C95_003_calm_analyst"
    priority: 66
    description: "차분한 분석가(C95_P3) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C95"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["제 상태는", "이해가 안 돼서", "차근차근", "분석해보면"]
        - field: "analytical_approach"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C95_P3'"
      - "set_calmness_tone: 'Professional'"
      - "set_intervention_strategy: 'InformationProvision'"
    confidence: 0.84
    rationale: "감정과 사고 분리 능력은 분석적 성향의 지표"

  # === C90: 안정 상태 ===

  - rule_id: "CL_C90_001_balanced_learner"
    priority: 72
    description: "균형 잡힌 학습자(C90_P1) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C90"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["해볼게요", "쉬고 다시", "도움이 필요할 것 같아요"]
        - field: "self_management"
          operator: "=="
          value: "good"
    action:
      - "identify_persona: 'C90_P1'"
      - "set_calmness_tone: 'Supportive'"
      - "set_intervention_strategy: 'SkillBuilding'"
    confidence: 0.85
    rationale: "균형 잡힌 자기 관리와 적절한 도움 요청"

  - rule_id: "CL_C90_002_diligent_worker"
    priority: 70
    description: "성실한 노력가(C90_P2) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C90"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["조금씩 나아지", "어제보다", "계속 하다 보면"]
        - field: "persistent_effort"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C90_P2'"
      - "set_calmness_tone: 'Encouraging'"
      - "set_intervention_strategy: 'SkillBuilding'"
      - "acknowledge_progress: { type: 'effort' }"
    confidence: 0.86
    rationale: "꾸준한 노력과 과정 중시는 성실한 노력가의 특성"

  - rule_id: "CL_C90_003_social_collaborator"
    priority: 68
    description: "사교적 협력자(C90_P3) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C90"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["같이 하면", "선생님", "친구랑", "함께"]
        - field: "seeks_social_support"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C90_P3'"
      - "set_calmness_tone: 'Warm'"
      - "set_intervention_strategy: 'EmotionalSupport'"
    confidence: 0.82
    rationale: "관계를 통한 안정감 추구는 협력자의 핵심 특성"

  # === C85: 적당히 안정 상태 ===

  - rule_id: "CL_C85_001_mild_tension"
    priority: 75
    description: "가벼운 긴장형(C85_P1) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C85"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["긴장되네요", "맞게 하고 있는", "어렵지 않아요?"]
        - field: "mild_anxiety_signs"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C85_P1'"
      - "set_calmness_tone: 'Supportive'"
      - "set_intervention_strategy: 'MindfulnessSupport'"
      - "start_breathing_exercise: { type: '4-7-8', brief: true }"
    confidence: 0.84
    rationale: "가벼운 긴장감 표현은 C85_P1의 핵심 신호"

  - rule_id: "CL_C85_002_perfectionist_caution"
    priority: 76
    description: "완벽주의적 신중함(C85_P2) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C85"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["확인해볼게요", "맞아요?", "틀리면 어떡해"]
        - field: "checking_behavior"
          operator: ">="
          value: 2
    action:
      - "identify_persona: 'C85_P2'"
      - "set_calmness_tone: 'Gentle'"
      - "set_intervention_strategy: 'FocusGuidance'"
      - "send_reassurance: { type: 'process_over_perfection' }"
    confidence: 0.85
    rationale: "반복적 확인과 실수 걱정은 완벽주의적 신중함의 지표"

  - rule_id: "CL_C85_003_energy_management"
    priority: 73
    description: "에너지 관리 필요형(C85_P3) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C85"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["피곤해요", "쉬어도", "아침에는 더"]
        - field: "fatigue_indicators"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C85_P3'"
      - "set_calmness_tone: 'Supportive'"
      - "set_intervention_strategy: 'MindfulnessSupport'"
      - "start_breathing_exercise: { type: 'deep', energizing: true }"
    confidence: 0.80
    rationale: "피로감과 에너지 변동은 C85_P3의 특징적 신호"

  # === C80: 약간 불안 상태 ===

  - rule_id: "CL_C80_001_aware_anxious"
    priority: 80
    description: "불안 인식형(C80_P1) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C80"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["걱정돼요", "잘 할 수 있을까", "불안해요", "어떻게 해야"]
        - field: "anxiety_verbalization"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C80_P1'"
      - "set_calmness_tone: 'Gentle'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_breathing_exercise: { type: '4-7-8' }"
      - "send_reassurance: { type: 'validation' }"
    confidence: 0.88
    rationale: "불안의 언어적 표현은 C80_P1의 핵심 특성"

  - rule_id: "CL_C80_002_scattered_avoidant"
    priority: 78
    description: "산만한 회피형(C80_P2) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C80"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["잠깐만요", "나중에", "다른 거 먼저"]
        - field: "avoidance_behavior"
          operator: "=="
          value: true
        - field: "attention_span"
          operator: "<="
          value: "short"
    action:
      - "identify_persona: 'C80_P2'"
      - "set_calmness_tone: 'Supportive'"
      - "set_intervention_strategy: 'FocusGuidance'"
      - "start_grounding_exercise: { type: 'object_focus' }"
    confidence: 0.82
    rationale: "주제 이탈과 회피 시도는 불안 관리 시도의 신호"

  - rule_id: "CL_C80_003_comparison_anxious"
    priority: 79
    description: "비교 불안형(C80_P3) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C80"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["다른 애들은", "저만 못하는", "평균이 어때요"]
        - field: "comparison_with_others"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C80_P3'"
      - "set_calmness_tone: 'Encouraging'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_grounding_exercise: { type: 'safe_place' }"
    confidence: 0.85
    rationale: "타인 비교와 자존감 흔들림은 비교 불안의 명확한 신호"

  - rule_id: "CL_C80_004_hidden_anxious"
    priority: 81
    description: "숨기는 불안형(C80_P4) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C80"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["괜찮아요 진짜", "혼자 할 수 있어요", "별거 아니에요"]
        - AND:
          - field: "verbal_denial"
            operator: "=="
            value: true
          - field: "physical_tension"
            operator: "=="
            value: true
    action:
      - "identify_persona: 'C80_P4'"
      - "set_calmness_tone: 'Warm'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_grounding_exercise: { type: 'body_scan' }"
    confidence: 0.80
    rationale: "말과 신체 반응의 불일치는 숨기는 불안의 지표"

  # === C75: 불안 상태 ===

  - rule_id: "CL_C75_001_trembling_tension"
    priority: 88
    description: "떨리는 긴장형(C75_P1) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C75"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["못하겠어요", "너무 떨려요", "머리가 하얘졌어요", "숨이 안 쉬어져요"]
        - field: "physical_trembling"
          operator: "=="
          value: true
        - field: "speech_pattern"
          operator: "=="
          value: "stuttering"
    action:
      - "identify_persona: 'C75_P1'"
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Slow'"
      - "set_intervention_strategy: 'CalmnessCoaching'"
      - "start_breathing_exercise: { type: 'deep', guided: true }"
      - "start_grounding_exercise: { type: '5-4-3-2-1' }"
    confidence: 0.92
    rationale: "신체적 떨림과 강한 긴장감은 C75_P1의 핵심 신호"

  - rule_id: "CL_C75_002_overwhelmed_helpless"
    priority: 90
    description: "압도된 무력형(C75_P2) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C75"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["모르겠어요", "안 돼요", "뭘 해야", "그냥..."]
        - field: "response_minimal"
          operator: "=="
          value: true
        - field: "helplessness_indicators"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'C75_P2'"
      - "set_calmness_tone: 'Warm'"
      - "set_calmness_pace: 'Very_Slow'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_grounding_exercise: { type: 'body_scan' }"
      - "send_reassurance: { type: 'unconditional_support' }"
    confidence: 0.90
    rationale: "무력감과 최소 반응은 압도된 상태의 명확한 신호"

  - rule_id: "CL_C75_003_anger_expression"
    priority: 89
    description: "분노 표출형(C75_P3) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C75"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["짜증나", "왜 이렇게", "그만할래요", "누가 시켰어요"]
        - field: "anger_indicators"
          operator: "=="
          value: true
        - field: "voice_volume"
          operator: "=="
          value: "raised"
    action:
      - "identify_persona: 'C75_P3'"
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Slow'"
      - "set_intervention_strategy: 'CalmnessCoaching'"
      - "start_breathing_exercise: { type: 'box' }"
      - "send_reassurance: { type: 'emotion_validation' }"
    confidence: 0.88
    rationale: "분노 표현과 저항은 불안의 다른 형태 표출"

  - rule_id: "CL_C75_004_somatic_anxious"
    priority: 87
    description: "신체화 불안형(C75_P4) 식별"
    conditions:
      - field: "calmness_score"
        operator: "calmness_score_at_level"
        value: "C75"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["머리 아파요", "배가 아파요", "어지러워요", "쉬고 싶어요"]
        - field: "somatic_complaints"
          operator: ">="
          value: 1
    action:
      - "identify_persona: 'C75_P4'"
      - "set_calmness_tone: 'Gentle'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_breathing_exercise: { type: 'deep' }"
      - "send_reassurance: { type: 'somatic_validation' }"
    confidence: 0.86
    rationale: "신체 증상 호소는 불안의 신체화 신호"

# ============================================================
# SECTION 3: 불안 트리거별 페르소나 식별 룰
# ============================================================

anxiety_trigger_identification_rules:

  - rule_id: "TRG_001_test_anxiety"
    priority: 85
    description: "시험 불안형(T_P1) 식별"
    conditions:
      - field: "context"
        operator: "contains"
        value: "exam"
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["시험 보면", "시험만 아니면", "시험 전에 잠을"]
        - field: "has_anxiety_trigger"
          operator: "=="
          value: "exam"
    action:
      - "identify_persona: 'T_P1'"
      - "set_intervention_strategy: 'FocusGuidance'"
      - "apply_calmness_coaching: { focus: 'test_preparation' }"
      - "start_breathing_exercise: { type: '4-7-8', pre_test: true }"
    confidence: 0.88
    rationale: "시험 상황 특이적 불안은 T_P1의 핵심 특성"

  - rule_id: "TRG_002_presentation_anxiety"
    priority: 84
    description: "발표 불안형(T_P2) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["발표는 못해요", "쳐다보잖아요", "창피해요", "목소리가 안 나와"]
        - field: "has_anxiety_trigger"
          operator: "=="
          value: "presentation"
    action:
      - "identify_persona: 'T_P2'"
      - "set_intervention_strategy: 'CalmnessCoaching'"
      - "apply_calmness_coaching: { focus: 'public_speaking' }"
      - "start_breathing_exercise: { type: '4-7-8' }"
    confidence: 0.87
    rationale: "발표 상황 특이적 불안과 회피는 T_P2의 신호"

  - rule_id: "TRG_003_social_anxiety"
    priority: 83
    description: "사회적 불안형(T_P3) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["이상하게 볼", "뭐라고 말해야", "혼자가 편해요"]
        - field: "has_anxiety_trigger"
          operator: "=="
          value: "social"
    action:
      - "identify_persona: 'T_P3'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "start_grounding_exercise: { type: 'safe_place' }"
    confidence: 0.85
    rationale: "대인 관계 상황에서의 불안은 T_P3의 특성"

  - rule_id: "TRG_004_separation_anxiety"
    priority: 82
    description: "분리 불안형(T_P4) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["엄마한테 전화", "집에 가고 싶어요", "엄마가 걱정돼요"]
        - field: "has_anxiety_trigger"
          operator: "=="
          value: "separation"
    action:
      - "identify_persona: 'T_P4'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "send_reassurance: { type: 'connection_object' }"
    confidence: 0.84
    rationale: "분리 상황에서의 불안은 T_P4의 핵심 특성"

  - rule_id: "TRG_005_performance_anxiety"
    priority: 84
    description: "수행 불안형(T_P5) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["해야 하는데 못하겠", "시작을 못하겠", "완벽하지 않으면"]
        - field: "has_anxiety_trigger"
          operator: "=="
          value: "performance"
    action:
      - "identify_persona: 'T_P5'"
      - "set_intervention_strategy: 'FocusGuidance'"
      - "start_breathing_exercise: { type: 'box' }"
      - "apply_calmness_coaching: { focus: 'start_small' }"
    confidence: 0.86
    rationale: "수행 상황에서의 시작 어려움은 T_P5의 특성"

# ============================================================
# SECTION 4: 회복 경로별 페르소나 식별 룰
# ============================================================

recovery_pattern_identification_rules:

  - rule_id: "REC_001_fast_recovery"
    priority: 75
    description: "빠른 회복형(R_P1) 식별"
    conditions:
      - AND:
        - field: "calmness_trend"
          operator: "calmness_improving"
          value: true
        - field: "recovery_time"
          operator: "<="
          value: 5
    action:
      - "identify_persona: 'R_P1'"
      - "acknowledge_progress: { type: 'self_regulation' }"
      - "set_intervention_strategy: 'SkillBuilding'"
    confidence: 0.85
    rationale: "빠른 회복은 높은 탄력성의 지표"

  - rule_id: "REC_002_gradual_recovery"
    priority: 73
    description: "점진적 회복형(R_P2) 식별"
    conditions:
      - AND:
        - field: "calmness_trend"
          operator: "calmness_improving"
          value: true
        - field: "recovery_time"
          operator: ">"
          value: 10
    action:
      - "identify_persona: 'R_P2'"
      - "set_intervention_strategy: 'MindfulnessSupport'"
      - "send_reassurance: { type: 'patience' }"
    confidence: 0.82
    rationale: "점진적 회복은 지속적 지원 필요의 신호"

  - rule_id: "REC_003_relationship_recovery"
    priority: 74
    description: "관계 의존 회복형(R_P3) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["같이 있어주세요", "옆에 있으니까 괜찮", "혼자 있으면 무서워요"]
        - field: "recovery_depends_on"
          operator: "=="
          value: "social_support"
    action:
      - "identify_persona: 'R_P3'"
      - "set_intervention_strategy: 'EmotionalSupport'"
      - "apply_calmness_coaching: { focus: 'together_breathing' }"
    confidence: 0.83
    rationale: "타인 존재로 인한 안정화는 관계 의존 회복의 신호"

  - rule_id: "REC_004_activity_recovery"
    priority: 72
    description: "활동 기반 회복형(R_P4) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["움직이면 나아져", "가만히 있으면 답답", "산책하고 올게요"]
        - field: "recovery_depends_on"
          operator: "=="
          value: "physical_activity"
    action:
      - "identify_persona: 'R_P4'"
      - "set_intervention_strategy: 'MindfulnessSupport'"
      - "start_grounding_exercise: { type: 'body_scan', active: true }"
    confidence: 0.81
    rationale: "신체 활동을 통한 불안 해소는 R_P4의 특성"

  - rule_id: "REC_005_cognitive_recovery"
    priority: 74
    description: "인지적 재구성 회복형(R_P5) 식별"
    conditions:
      - OR:
        - field: "user_message"
          operator: "contains_any"
          value: ["생각해보니", "다르게 보면", "사실은 괜찮은"]
        - field: "cognitive_reframe"
          operator: "=="
          value: true
    action:
      - "identify_persona: 'R_P5'"
      - "set_intervention_strategy: 'FocusGuidance'"
      - "apply_calmness_coaching: { focus: 'cognitive_restructuring' }"
    confidence: 0.84
    rationale: "인지적 재해석 능력은 R_P5의 핵심 특성"

# ============================================================
# SECTION 5: 호흡/그라운딩 기법 추천 룰
# ============================================================

exercise_recommendation_rules:

  # === 호흡 기법 추천 ===

  - rule_id: "EX_001_immediate_calming"
    priority: 90
    description: "즉각적 진정 필요 시 4-7-8 호흡법"
    conditions:
      - OR:
        - field: "calmness_score"
          operator: "<"
          value: 80
        - field: "needs_breathing"
          operator: "=="
          value: true
        - field: "anxiety_level"
          operator: ">="
          value: "moderate"
    action:
      - "start_breathing_exercise: { type: '4-7-8', guided: true }"
      - "set_calmness_tone: 'Calm'"
    rationale: "4-7-8 호흡법은 부교감신경 활성화에 효과적"

  - rule_id: "EX_002_focus_restoration"
    priority: 85
    description: "집중력 회복 필요 시 박스 호흡법"
    conditions:
      - OR:
        - field: "attention_issues"
          operator: "=="
          value: true
        - field: "scattered_feeling"
          operator: "=="
          value: true
    action:
      - "start_breathing_exercise: { type: 'box' }"
    rationale: "박스 호흡법은 집중력 향상에 효과적"

  - rule_id: "EX_003_energy_boost"
    priority: 80
    description: "에너지 부족 시 활력 호흡법"
    conditions:
      - OR:
        - field: "fatigue_level"
          operator: ">="
          value: "moderate"
        - field: "low_energy"
          operator: "=="
          value: true
    action:
      - "start_breathing_exercise: { type: 'energizing' }"
    rationale: "활력 호흡법은 에너지 회복에 도움"

  # === 그라운딩 기법 추천 ===

  - rule_id: "EX_004_reality_grounding"
    priority: 95
    description: "현실 연결 필요 시 5-4-3-2-1 그라운딩"
    conditions:
      - OR:
        - field: "needs_grounding"
          operator: "=="
          value: true
        - field: "dissociation_signs"
          operator: "=="
          value: true
        - field: "calmness_score"
          operator: "<"
          value: 70
    action:
      - "start_grounding_exercise: { type: '5-4-3-2-1' }"
    rationale: "5-4-3-2-1 감각 그라운딩은 현재 연결에 효과적"

  - rule_id: "EX_005_body_awareness"
    priority: 85
    description: "신체 인식 필요 시 바디 스캔"
    conditions:
      - OR:
        - field: "somatic_disconnect"
          operator: "=="
          value: true
        - field: "hidden_tension"
          operator: "=="
          value: true
    action:
      - "start_grounding_exercise: { type: 'body_scan' }"
    rationale: "바디 스캔은 신체 인식 향상에 효과적"

  - rule_id: "EX_006_safe_visualization"
    priority: 88
    description: "안전감 필요 시 안전한 장소 시각화"
    conditions:
      - OR:
        - field: "safety_need"
          operator: "=="
          value: true
        - field: "trauma_triggered"
          operator: "=="
          value: true
    action:
      - "start_grounding_exercise: { type: 'safe_place' }"
    rationale: "안전한 장소 시각화는 정서적 안전감 제공"

  - rule_id: "EX_007_focus_anchor"
    priority: 82
    description: "집중 앵커 필요 시 물체 집중 그라운딩"
    conditions:
      - OR:
        - field: "attention_scattered"
          operator: "=="
          value: true
        - field: "racing_thoughts"
          operator: "=="
          value: true
    action:
      - "start_grounding_exercise: { type: 'object_focus' }"
    rationale: "물체 집중은 사고 정지에 효과적"

# ============================================================
# SECTION 6: 응답 생성 룰
# ============================================================

response_generation_rules:

  # === 진정도 레벨별 응답 템플릿 ===

  - rule_id: "RG_C95_001_high_calmness_response"
    priority: 70
    description: "C95 레벨 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C95"
    action:
      - "set_calmness_tone: 'Professional'"
      - "set_calmness_pace: 'Normal'"
      - "set_intervention_strategy: 'ProgressRecognition'"
    response_templates:
      opening: "정서적으로 매우 안정된 상태네요."
      body: "현재의 좋은 상태를 유지하면서, {learning_goal}에 집중해볼까요?"
      closing: "어려운 상황에서도 잘 조절하는 능력이 있어요. 대단해요!"

  - rule_id: "RG_C90_001_stable_response"
    priority: 72
    description: "C90 레벨 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C90"
    action:
      - "set_calmness_tone: 'Supportive'"
      - "set_calmness_pace: 'Normal'"
      - "set_intervention_strategy: 'SkillBuilding'"
    response_templates:
      opening: "안정적인 상태에서 잘 하고 있어요."
      body: "지금처럼 균형을 유지하면서 {learning_activity}을 해볼까요?"
      closing: "필요하면 언제든 말해주세요. 함께해요."

  - rule_id: "RG_C85_001_mild_tension_response"
    priority: 75
    description: "C85 레벨 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C85"
    action:
      - "set_calmness_tone: 'Gentle'"
      - "set_calmness_pace: 'Slow'"
      - "set_intervention_strategy: 'MindfulnessSupport'"
    response_templates:
      opening: "조금 긴장되는 것 같아요. 괜찮아요, 자연스러운 거예요."
      body: "잠깐 깊은 숨을 한 번 쉬어볼까요? 그러고 나서 {learning_activity}을 해봐요."
      closing: "천천히 가도 괜찮아요. 옆에서 도와줄게요."

  - rule_id: "RG_C80_001_anxious_response"
    priority: 80
    description: "C80 레벨 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C80"
    action:
      - "set_calmness_tone: 'Warm'"
      - "set_calmness_pace: 'Slow'"
      - "set_intervention_strategy: 'EmotionalSupport'"
    response_templates:
      opening: "지금 불안한 마음이 느껴져요. 그 마음을 알아요."
      body: "먼저 마음을 좀 편안하게 해볼까요? 같이 호흡해봐요. {breathing_guide}"
      closing: "불안한 건 자연스러운 거예요. 조금씩 나아질 거예요."

  - rule_id: "RG_C75_001_high_anxiety_response"
    priority: 88
    description: "C75 레벨 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C75"
    action:
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Very_Slow'"
      - "set_intervention_strategy: 'CalmnessCoaching'"
    response_templates:
      opening: "지금 많이 힘들죠. 제가 옆에 있어요."
      body: "지금은 공부보다 마음이 먼저예요. 같이 천천히 호흡해볼까요? {breathing_guide}"
      closing: "괜찮아질 거예요. 지금 이 순간만 함께해요."

  - rule_id: "RG_CRISIS_001_crisis_response"
    priority: 100
    description: "위기 상태 학생 대응"
    conditions:
      - field: "calmness_level"
        operator: "calmness_level_is"
        value: "C_crisis"
    action:
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Very_Slow'"
      - "set_intervention_strategy: 'CrisisIntervention'"
      - "trigger_crisis_protocol: { auto: true }"
    response_templates:
      opening: "지금 많이 힘들어요. 제가 여기 있어요."
      body: "지금은 다른 건 다 괜찮아요. 그냥 같이 있어요. {immediate_support}"
      closing: "혼자가 아니에요. 함께 해결해나가요."

# ============================================================
# SECTION 7: 톤 및 페이스 조절 룰
# ============================================================

tone_pace_rules:

  - rule_id: "TP_001_crisis_mode"
    priority: 100
    description: "위기 상황 - 최대 진정 모드"
    conditions:
      - field: "calmness_score"
        operator: "<"
        value: 75
    action:
      - "set_calmness_tone: 'Calm'"
      - "set_calmness_pace: 'Very_Slow'"
      - "reduce_information_density: true"
      - "pause_academic_content: true"
    message_modifications:
      opening: "지금 가장 중요한 건 {student_name} 학생이에요."
      transitions: "천천히요... 괜찮아요..."
      closing: "지금 이 순간만 함께해요."

  - rule_id: "TP_002_anxious_support"
    priority: 85
    description: "불안 상태 - 따뜻한 지지"
    conditions:
      - field: "calmness_score"
        operator: "between"
        value: [75, 84]
    action:
      - "set_calmness_tone: 'Warm'"
      - "set_calmness_pace: 'Slow'"
      - "add_emotional_checkpoints: true"
    message_modifications:
      opening: "{student_name} 학생, 어떤 마음이에요?"
      transitions: "한 번 더 깊은 숨을 쉬어볼까요?"
      closing: "조금씩 나아지고 있어요."

  - rule_id: "TP_003_stable_encouragement"
    priority: 75
    description: "안정 상태 - 격려와 지지"
    conditions:
      - field: "calmness_score"
        operator: ">="
        value: 85
    action:
      - "set_calmness_tone: 'Supportive'"
      - "set_calmness_pace: 'Normal'"
    message_modifications:
      opening: "좋은 상태네요!"
      transitions: "다음으로 넘어가볼까요?"
      closing: "잘하고 있어요!"

# ============================================================
# SECTION 8: 진정도 상태 전환 감지 룰
# ============================================================

calmness_transition_rules:

  - rule_id: "CT_001_anxiety_escalation"
    priority: 95
    description: "불안 상승 감지 - 즉시 개입"
    conditions:
      - field: "calmness_trend"
        operator: "calmness_declining"
        value: true
      - field: "decline_rate"
        operator: ">="
        value: 10
    action:
      - "reassess_calmness_level"
      - "shift_to_calming_mode"
      - "start_breathing_exercise: { type: '4-7-8', immediate: true }"
      - "log_transition: 'anxiety_escalation'"
      - "set_monitoring: { level: 'intensive' }"

  - rule_id: "CT_002_positive_recovery"
    priority: 80
    description: "긍정적 회복 감지 - 격려"
    conditions:
      - field: "calmness_trend"
        operator: "calmness_improving"
        value: true
      - field: "improvement_rate"
        operator: ">="
        value: 5
    action:
      - "acknowledge_progress: { type: 'recovery' }"
      - "gradually_increase_challenge"
      - "log_transition: 'positive_recovery'"

  - rule_id: "CT_003_crisis_entry"
    priority: 100
    description: "위기 진입 감지 - 즉시 프로토콜 발동"
    conditions:
      - AND:
        - field: "previous_state"
          operator: "previous_state_was"
          value: "C75"
        - field: "calmness_score"
          operator: "<"
          value: 75
    action:
      - "trigger_crisis_protocol: { auto: true }"
      - "set_monitoring: { level: 'continuous' }"
      - "log_transition: 'crisis_entry'"

  - rule_id: "CT_004_consecutive_crisis"
    priority: 100
    description: "연속 위기 세션 감지 - 전문가 연계 검토"
    conditions:
      - field: "consecutive_crisis_sessions"
        operator: "consecutive_crisis_sessions"
        value: 2
    action:
      - "escalate_to_professional: { review: true }"
      - "notify_supervisor: true"
      - "log_transition: 'consecutive_crisis'"

# ============================================================
# SECTION 9: 모니터링 및 기록 룰
# ============================================================

monitoring_rules:

  - rule_id: "MON_001_session_tracking"
    priority: 60
    description: "세션 진정도 추적"
    conditions:
      - field: "session_active"
        operator: "=="
        value: true
    action:
      - "save_calmness_score: { interval: 5 }"
      - "track_emotional_changes"
      - "record_intervention_effectiveness"

  - rule_id: "MON_002_trigger_logging"
    priority: 70
    description: "불안 트리거 기록"
    conditions:
      - field: "anxiety_trigger_detected"
        operator: "=="
        value: true
    action:
      - "log_anxiety_trigger"
      - "update_trigger_profile"

  - rule_id: "MON_003_intervention_tracking"
    priority: 65
    description: "개입 효과성 추적"
    conditions:
      - field: "intervention_completed"
        operator: "=="
        value: true
    action:
      - "evaluate_intervention_effectiveness"
      - "update_intervention_history"
      - "adjust_future_recommendations"

# ============================================================
# DEFAULT FALLBACK
# ============================================================

default_rule:
  rule_id: "default"
  action:
    - "set_calmness_tone: 'Supportive'"
    - "set_calmness_pace: 'Normal'"
    - "maintain_safe_environment"
    - "continue_calmness_observation"
  message: "학생의 감정 상태를 살피면서 맞춤형으로 지원할게요."
  confidence: 0.5

# ============================================================
# METADATA
# ============================================================

metadata:
  total_rules: 58
  crisis_rules: 5
  calmness_level_rules: 15
  trigger_rules: 5
  recovery_rules: 5
  exercise_rules: 7
  response_rules: 6
  tone_pace_rules: 3
  transition_rules: 4
  monitoring_rules: 3

  intervention_types:
    - CrisisIntervention
    - CrisisSupport
    - SafetyNet
    - CalmnessCoaching
    - EmotionalSupport
    - FocusGuidance
    - MindfulnessSupport
    - InformationProvision
    - SkillBuilding
    - ProgressRecognition

  breathing_exercises:
    - 4-7-8
    - box
    - deep
    - calming
    - energizing
    - coherent

  grounding_exercises:
    - 5-4-3-2-1
    - body_scan
    - safe_place
    - object_focus
    - counting
    - anchoring

  calmness_tones:
    - Calm
    - Warm
    - Gentle
    - Supportive
    - Encouraging
    - Professional

  calmness_paces:
    - Very_Slow
    - Slow
    - Normal
    - Adaptive
