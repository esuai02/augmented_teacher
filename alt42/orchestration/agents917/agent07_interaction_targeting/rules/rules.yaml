# Rules for Agent 07 - Interaction Targeting
# 현직 수학선생님 수준의 90% 달성을 위한 룰 정의

version: "2.0"
scenario: "interaction_targeting"
description: "학생과의 상호작용을 최적의 타이밍과 상황에서 타겟팅하는 에이전트"
last_updated: "2025-01-27"
target_level: "현직 수학선생님 수준의 90%"

rules:
  # ============================================
  # Step 1: 상황 식별 및 우선순위 결정
  # ============================================
  
  - rule_id: "S1_R1_real_time_concern"
    name: "실시간 고민 상황 감지"
    priority: 1
    condition:
      - "학생 질문/도움 요청 있음"
    action:
      - "상황 = '실시간 고민'"
      - "우선순위 = 최우선"
      - "즉시_개입 = true"
    confidence: 0.95
    rationale: "학생이 즉시 도움을 요청하면 최우선으로 대응해야 함"
    
  - rule_id: "S1_R2_pomodoro_situation"
    name: "포모도르 상황 감지"
    priority: 2
    condition:
      - "포모도르 세션 활성 상태"
    action:
      - "상황 = '포모도르 상황 중 선택'"
      - "우선순위 = 높음"
      - "IF (포모도르 경과 >= 20분 AND 집중도 < 5) THEN 하위_상황 = '집중도_하락'"
      - "IF (포모도르 경과 >= 15분 AND 성취감 < 3) THEN 하위_상황 = '동기_부여_필요'"
    confidence: 0.90
    rationale: "포모도르 세션 중 실시간 상태 모니터링 및 개입 필요"
    
  - rule_id: "S1_R3_class_preparation"
    name: "수업준비 상황 감지"
    priority: 2
    condition:
      - "학습 시작 전"
      - "(학원 수업 예정 OR 학교 수업 예정)"
    action:
      - "상황 = '수업준비'"
      - "우선순위 = 높음"
      - "IF (학원 수업 예정) THEN 하위_상황 = '학원_수업_준비'"
      - "IF (학교 수업 예정) THEN 하위_상황 = '학교_수업_준비'"
    confidence: 0.85
    rationale: "수업 준비는 학습 효과 극대화를 위해 중요"
    
  - rule_id: "S1_R4_goal_setting"
    name: "목표 설정 상황 감지"
    priority: 3
    condition:
      - "(오늘 목표 없음 OR 오늘 목표 변경됨) OR (주간 목표 없음 OR 주간 목표 변경됨) OR (분기 목표 없음 OR 분기 목표 변경됨)"
    action:
      - "IF (오늘 목표 관련) THEN 상황 = '오늘목표 설정', 우선순위 = 중간"
      - "IF (주간 목표 관련) THEN 상황 = '주간목표 설정', 우선순위 = 낮음"
      - "IF (분기 목표 관련) THEN 상황 = '분기목표 수립', 우선순위 = 낮음"
    confidence: 0.80
    rationale: "목표 설정은 학습 계획의 기초"
    
  - rule_id: "S1_R5_reflection_situation"
    name: "귀가검사 상황 감지"
    priority: 3
    condition:
      - "(학습 마무리 시점 AND 귀가검사 전) OR (귀가검사 실행 시점)"
    action:
      - "IF (학습 마무리 시점) THEN 상황 = '귀가검사 준비', 우선순위 = 중간"
      - "IF (귀가검사 실행) THEN 상황 = '귀가검사 상황', 우선순위 = 중간"
    confidence: 0.85
    rationale: "학습 마무리 및 회고는 다음 학습을 위한 중요 단계"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "report_id"
          - "date"
          - "responses"
    
  - rule_id: "S1_R5_1_goinghome_calmness"
    name: "귀가검사 차분함 상태 기반 타겟팅"
    priority: 3
    condition:
      - "귀가검사 완료 AND calmness 데이터 있음"
    action:
      - "IF (calmness >= 7) THEN 상태 = '안정', 권장_모드 = ['자기성찰', '자기주도'], 톤 = '성찰 유도'"
      - "IF (calmness >= 4 AND calmness < 7) THEN 상태 = '보통', 권장_모드 = ['맞춤학습', '시간성찰'], 톤 = '균형 격려'"
      - "IF (calmness < 4) THEN 상태 = '불안정', 권장_모드 = ['도제학습', '단기미션'], 톤 = '안정 유도', 개입_우선순위 = 높음"
    confidence: 0.85
    rationale: "학습 마무리 시점의 차분함 상태에 따라 다음 세션 준비 방향 결정"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "calmness"
    
  - rule_id: "S1_R5_2_goinghome_inefficiency"
    name: "비효율성 인식 기반 개선 타겟팅"
    priority: 3
    condition:
      - "귀가검사 완료 AND inefficiency 데이터 있음"
    action:
      - "IF (inefficiency >= 7) THEN 학습_개선_필요 = true, 권장_조치 = '학습 방법 재점검', 모드 = '맞춤학습'"
      - "IF (inefficiency >= 4 AND inefficiency < 7) THEN 학습_개선_필요 = 부분적, 권장_조치 = '특정 영역 개선', 모드 = '단기미션'"
      - "IF (inefficiency < 4) THEN 학습_효율성 = 양호, 권장_조치 = '현재 방식 유지'"
      - "다음_세션_추천 = 비효율_영역_집중"
    confidence: 0.80
    rationale: "학생이 인식한 비효율성을 기반으로 맞춤형 개선 제안"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "inefficiency"
    
  - rule_id: "S1_R5_3_goinghome_missed_opportunity"
    name: "놓친 기회 분석 기반 타겟팅"
    priority: 3
    condition:
      - "귀가검사 완료 AND missed_opportunity 데이터 있음"
    action:
      - "IF (missed_opportunity 있음) THEN 회고_포인트 = missed_opportunity"
      - "다음_세션_권장 = '놓친 기회 복습'"
      - "IF (missed_opportunity 반복 패턴) THEN 패턴_분석 = true, 개선_계획_수립 = 필요"
      - "톤 = '아쉬움 공감 + 다음 기회 격려'"
    confidence: 0.80
    rationale: "놓친 기회를 다음 학습에서 보완할 수 있도록 안내"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "missed_opportunity"
    
  - rule_id: "S1_R5_4_goinghome_positive_moment"
    name: "긍정적 순간 강화 타겟팅"
    priority: 3
    condition:
      - "귀가검사 완료 AND positive_moment 데이터 있음"
    action:
      - "IF (positive_moment 있음) THEN 성취_강조 = true, 톤 = '성취 인정 + 격려'"
      - "성공_패턴_기록 = positive_moment"
      - "다음_세션_연계 = '성공 경험 재현 유도'"
      - "IF (positive_moment 빈번) THEN 자존감_향상_메시지 = true"
    confidence: 0.85
    rationale: "긍정적 경험을 강화하여 학습 동기 유지"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "positive_moment"
    
  - rule_id: "S1_R5_5_goinghome_pace_anxiety"
    name: "학습 속도 불안 감지 및 대응"
    priority: 2
    condition:
      - "귀가검사 완료 AND pace_anxiety 데이터 있음"
    action:
      - "IF (pace_anxiety >= 7) THEN 불안_수준 = 높음, 즉시_개입 = true, 톤 = '안심 + 현실적 조언'"
      - "IF (pace_anxiety >= 4 AND pace_anxiety < 7) THEN 불안_수준 = 중간, 권장_조치 = '속도 조절 제안'"
      - "IF (pace_anxiety < 4) THEN 불안_수준 = 낮음, 현재_속도_유지 = true"
      - "IF (pace_anxiety 지속적 높음) THEN 커리큘럼_조정_검토 = 필요, 모드 = '맞춤학습'"
    confidence: 0.85
    rationale: "학습 속도에 대한 불안은 학습 지속성에 영향을 미치므로 적극 대응"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "pace_anxiety"
    
  - rule_id: "S1_R5_6_goinghome_comprehensive"
    name: "귀가검사 데이터 종합 분석"
    priority: 3
    condition:
      - "귀가검사 완료 AND responses 데이터 있음"
    action:
      - "종합_분석 = responses 전체 평가"
      - "IF (calmness < 4 AND pace_anxiety >= 7) THEN 긴급_개입 = true, 모드 = '도제학습', 톤 = '안정화 우선'"
      - "IF (positive_moment 있음 AND inefficiency < 4) THEN 상태 = '양호', 모드 = '자기주도'"
      - "IF (missed_opportunity 있음 AND inefficiency >= 4) THEN 개선_계획_수립 = true, 모드 = '맞춤학습'"
      - "일일_리포트_생성 = report_id + date 기준"
      - "추세_분석 = date별 데이터 비교"
    confidence: 0.85
    rationale: "귀가검사 데이터를 종합 분석하여 전체적인 학습 상태 파악"
    data_sources:
      - table: "alt42_goinghome"
        fields:
          - "responses"
          - "calmness"
          - "inefficiency"
          - "missed_opportunity"
          - "positive_moment"
          - "pace_anxiety"
          - "report_id"
          - "date"
    
  - rule_id: "S1_R6_curriculum_design"
    name: "커리큘럼 설계 상황 감지"
    priority: 4
    condition:
      - "커리큘럼 조정 필요 OR 장기 목표 재설정"
    action:
      - "상황 = '장기목표(커리큘럼) 설계'"
      - "우선순위 = 낮음"
    confidence: 0.75
    rationale: "장기 커리큘럼은 주기적으로 조정 필요"
    
  # ============================================
  # Step 2: 수학 학습 단계별 타겟팅
  # ============================================
  
  - rule_id: "S2_R1_concept_learning"
    name: "개념 학습 단계 타겟팅"
    priority: 1
    condition:
      - "현재_학습_단계 == '개념 학습'"
    action:
      - "권장_모드 = ['도제학습', '탐구학습']"
      - "IF (학생_수준 == '하위권') THEN 우선_모드 = '도제학습'"
      - "IF (학생_수준 == '상위권') THEN 우선_모드 = '탐구학습'"
      - "최적_타이밍 = '집중도 >= 7 AND 에너지 >= 보통'"
      - "회피_타이밍 = '에너지 == 낮음 OR 집중도 < 5'"
    confidence: 0.90
    rationale: "개념 학습은 집중도 높을 때, 도제학습/탐구학습 모드 효과적"
    
  - rule_id: "S2_R2_type_practice"
    name: "유형 연습 단계 타겟팅"
    priority: 1
    condition:
      - "현재_학습_단계 == '유형 연습'"
    action:
      - "권장_모드 = ['단기미션', '자기주도']"
      - "IF (학생_수준 == '하위권') THEN 우선_모드 = '단기미션'"
      - "IF (학생_수준 == '상위권') THEN 우선_모드 = '자기주도'"
      - "최적_타이밍 = '에너지 >= 보통 AND 집중도 >= 6'"
    confidence: 0.90
    rationale: "유형 연습은 목표 설정 및 성취 강조, 단기미션/자기주도 모드 효과적"
    
  - rule_id: "S2_R3_advanced_problem"
    name: "심화 문제 단계 타겟팅"
    priority: 1
    condition:
      - "현재_학습_단계 == '심화 문제'"
    action:
      - "권장_모드 = ['자기성찰', '맞춤학습']"
      - "IF (학생_수준 == '하위권') THEN 우선_모드 = '맞춤학습'"
      - "IF (학생_수준 == '상위권') THEN 우선_모드 = '자기성찰'"
      - "최적_타이밍 = '에너지 == 높음 AND 집중도 >= 7'"
      - "회피_타이밍 = '에너지 == 낮음 OR 집중도 < 6'"
    confidence: 0.90
    rationale: "심화 문제는 에너지 충분할 때, 자기성찰/맞춤학습 모드 효과적"
    
  - rule_id: "S2_R4_past_exam"
    name: "기출 문제 단계 타겟팅"
    priority: 1
    condition:
      - "현재_학습_단계 == '기출 문제'"
    action:
      - "권장_모드 = ['시험대비', '시간성찰']"
      - "IF (시험_Dday <= 7) THEN 우선_모드 = '시험대비'"
      - "ELSE 우선_모드 = '시간성찰'"
      - "최적_타이밍 = '시험_Dday <= 14'"
    confidence: 0.90
    rationale: "기출 문제는 시험 D-day 고려, 시험대비/시간성찰 모드 효과적"
    
  # ============================================
  # Step 3: 단원별 특성 기반 타겟팅
  # ============================================
  
  - rule_id: "S2_R5_unit_characteristics"
    name: "단원별 특성 기반 타겟팅"
    priority: 1
    condition:
      - "현재_단원 정보 있음"
    action:
      - "함수 단원: 특성='추상적', 권장_모드=['도제학습', '탐구학습']"
      - "통계 단원: 특성='실용적', 권장_모드=['맞춤학습', '단기미션']"
      - "도형 단원: 특성='시각적', 권장_모드=['도제학습', '탐구학습']"
      - "방정식 단원: 특성='계산적', 권장_모드=['단기미션', '자기주도']"
    confidence: 0.85
    rationale: "단원별 특성에 맞는 모드 선택이 효과적"
    
  - rule_id: "S2_R6_unit_mastery"
    name: "단원별 학생 수준 고려"
    priority: 1
    condition:
      - "단원_정답률 정보 있음"
    action:
      - "IF (단원_정답률 < 0.5) THEN 단원_수준 = '취약', 모드_조정 = '도제학습 우선'"
      - "IF (단원_정답률 >= 0.7) THEN 단원_수준 = '강함', 모드_조정 = '자기주도/자기성찰 우선'"
      - "ELSE 단원_수준 = '보통', 모드_조정 = '단기미션/맞춤학습 우선'"
    confidence: 0.85
    rationale: "단원별 학생 수준에 맞는 모드 조정 필요"
    
  # ============================================
  # Step 4: 오류 유형별 타겟팅
  # ============================================
  
  - rule_id: "S2_R7_error_type"
    name: "계산 실수 vs 개념 오류 구분"
    priority: 1
    condition:
      - "오류_패턴 정보 있음"
    action:
      - "IF (계산_실수_비율 >= 0.6) THEN 오류_유형 = '계산_실수', 모드 = '단기미션', 내용 = '반복 연습'"
      - "IF (개념_오류_비율 >= 0.6) THEN 오류_유형 = '개념_오류', 모드 = '도제학습', 내용 = '개념 재학습'"
      - "ELSE 오류_유형 = '혼합', 모드 = '맞춤학습', 내용 = '종합적 개선'"
    confidence: 0.85
    rationale: "오류 유형별 맞춤 전략 필요"
    
  # ============================================
  # Step 5: 학생 수준별 타겟팅
  # ============================================
  
  - rule_id: "S2_R8_low_level_student"
    name: "하위권 학생 타겟팅"
    priority: 1
    condition:
      - "학생_수준 == '하위권'"
    action:
      - "모드_우선순위 = ['도제학습', '맞춤학습', '단기미션']"
      - "회피_모드 = ['자기주도', '자기성찰']"
      - "톤 = '격려 중심, 성취감 강조'"
      - "내용 = '기초 개념, 작은 목표, 반복 연습'"
    confidence: 0.90
    rationale: "하위권 학생은 기초 설명 및 격려 중심 필요"
    
  - rule_id: "S2_R9_mid_level_student"
    name: "중위권 학생 타겟팅"
    priority: 1
    condition:
      - "학생_수준 == '중위권'"
    action:
      - "모드_우선순위 = ['단기미션', '맞춤학습', '자기주도']"
      - "톤 = '목표 설정, 단계별 가이드'"
      - "내용 = '유형 연습, 오답 정리, 목표 달성'"
    confidence: 0.90
    rationale: "중위권 학생은 목표 설정 및 단계별 가이드 효과적"
    
  - rule_id: "S2_R10_high_level_student"
    name: "상위권 학생 타겟팅"
    priority: 1
    condition:
      - "학생_수준 == '상위권'"
    action:
      - "모드_우선순위 = ['자기성찰', '자기주도', '탐구학습']"
      - "톤 = '도전 중심, 성장 마인드셋'"
      - "내용 = '심화 문제, 변형 문제, 창의 문제'"
    confidence: 0.90
    rationale: "상위권 학생은 독립 학습 및 도전 문제 효과적"
    
  # ============================================
  # Step 6: 학원 수업 맥락 고려
  # ============================================
  
  - rule_id: "S2_R11_academy_prep"
    name: "학원 수업 전 예습 타겟팅"
    priority: 1
    condition:
      - "학원_수업_예정 AND 현재_시간 < 학원_수업_시간 - 2시간"
    action:
      - "모드 = ['맞춤학습', '도제학습', '단기미션']"
      - "목적 = '예습 가이드'"
      - "내용 = '오늘 배울 단원 개념 미리보기, 기본 문제 풀기'"
      - "타이밍 = '수업 2시간 전까지'"
    confidence: 0.85
    rationale: "학원 수업 전 예습은 학습 효과 극대화"
    
  - rule_id: "S2_R12_academy_review"
    name: "학원 수업 후 복습 타겟팅"
    priority: 1
    condition:
      - "학원_수업_완료 AND 현재_시간 >= 학원_수업_시간 + 1시간"
    action:
      - "모드 = ['자기주도', '도제학습', '자기성찰']"
      - "목적 = '복습 안내'"
      - "내용 = '오늘 배운 내용 정리, 연습 문제 풀기'"
      - "타이밍 = '수업 후 1시간 이후 (당일 또는 다음날)'"
      - "IF (수업_후_당일) THEN 우선순위 = 높음"
    confidence: 0.85
    rationale: "학원 수업 후 복습은 당일이 효과적"
    
  # ============================================
  # Step 7: 시험 D-day 맥락 고려
  # ============================================
  
  - rule_id: "S2_R13_exam_dday"
    name: "시험 D-day별 타겟팅 조정"
    priority: 1
    condition:
      - "시험_Dday 정보 있음"
    action:
      - "IF (시험_Dday <= 3) THEN 모드_우선순위 = ['시험대비', '시간성찰'], 내용 = '기출 문제 중심'"
      - "IF (시험_Dday <= 7) THEN 모드_우선순위 = ['시험대비', '단기미션'], 내용 = '취약 단원 집중'"
      - "IF (시험_Dday <= 14) THEN 모드_우선순위 = ['맞춤학습', '단기미션'], 내용 = '전체 범위 학습'"
    confidence: 0.90
    rationale: "시험 D-day에 따라 타겟팅 전략 조정 필요"
    
  # ============================================
  # Step 8: 타이밍 최적화
  # ============================================
  
  - rule_id: "S3_R1_time_slot"
    name: "시간대별 타겟팅"
    priority: 1
    condition:
      - "현재_시간대 정보 있음"
    action:
      - "아침 (6-9시): 최적_활동 = '개념 학습', 권장_모드 = ['도제학습', '탐구학습', '단기미션']"
      - "오전 (9-12시): 최적_활동 = '개념 학습, 유형 연습', 권장_모드 = ['도제학습', '단기미션']"
      - "오후 (12-18시): 최적_활동 = '유형 연습, 심화 문제', 권장_모드 = ['단기미션', '자기주도', '맞춤학습']"
      - "저녁 (18-22시): 최적_활동 = '복습, 정리', 권장_모드 = ['자기주도', '자기성찰', '시간성찰']"
      - "밤 (22시 이후): 최적_활동 = '가벼운 복습', 권장_모드 = ['자기주도', '시간성찰']"
    confidence: 0.85
    rationale: "시간대별 최적 활동 및 모드 다름"
    
  - rule_id: "S3_R2_energy_focus"
    name: "에너지/집중도 기반 타이밍 조정"
    priority: 1
    condition:
      - "에너지_레벨 AND 집중도 정보 있음"
    action:
      - "IF (에너지 == 높음 AND 집중도 >= 7) THEN 최적_활동 = '어려운 과제', 권장_모드 = ['도제학습', '탐구학습', '자기성찰']"
      - "IF (에너지 == 보통 AND 집중도 >= 6) THEN 최적_활동 = '보통 과제', 권장_모드 = ['단기미션', '자기주도', '맞춤학습']"
      - "IF (에너지 == 낮음 OR 집중도 < 5) THEN 최적_활동 = '가벼운 과제', 권장_모드 = ['자기주도', '시간성찰'], 회피_활동 = '어려운 과제'"
    confidence: 0.90
    rationale: "에너지/집중도에 따라 활동 난이도 조정 필요"
    
  # ============================================
  # Step 9: 최종 모드 선정
  # ============================================
  
  - rule_id: "S3_R3_mode_selection"
    name: "모드 우선순위 종합 계산"
    priority: 1
    condition:
      - "모든_판단_기준_완료"
    action:
      - "모드_점수 계산: 학습_단계별(30점) + 단원별(20점) + 학생_수준별(20점) + 시간대별(15점) + 에너지_집중도(10점) + 학원_수업_맥락(5점)"
      - "최종_모드 = 모드_점수 최고점 모드"
    confidence: 0.85
    rationale: "다양한 기준을 종합하여 최적 모드 선정"
    
  # ============================================
  # 예외 처리
  # ============================================
  
  - rule_id: "EXCEPTION_R1_low_data_quality"
    name: "데이터 부족 시 기본 타겟팅"
    priority: 0
    condition:
      - "데이터_완성도 < 0.6"
    action:
      - "기본_타겟팅_사용 = true"
      - "기본_모드 = '맞춤학습'"
      - "로그_기록 = '데이터 부족으로 기본 타겟팅 사용'"
    confidence: 0.70
    rationale: "데이터 부족 시에도 기본 기능 제공"
    
  - rule_id: "EXCEPTION_R2_multiple_situations"
    name: "다중 상황 발생 시 우선순위 적용"
    priority: 0
    condition:
      - "여러_상황_동시_발생"
    action:
      - "최종_상황 = 우선순위_가장_높은_상황"
      - "보조_상황 = 다음_우선순위_상황"
      - "로그_기록 = '다중 상황 발생, 우선순위 적용'"
    confidence: 0.80
    rationale: "다중 상황 발생 시 우선순위에 따라 결정"

default_rule:
  rule_id: "default"
  action:
    - "상황 = '오늘목표 설정'"
    - "모드 = '맞춤학습'"
    - "타이밍 = '현재 시간대'"
  confidence: 0.50
  rationale: "기본값: 가장 범용적인 상황 및 모드"

# ============================================
# 데이터 소스 정의
# ============================================

data_sources:
  # 귀가검사 테이블 (alt42_goinghome)
  alt42_goinghome:
    description: "하교 전 학습 상태 설문 데이터"
    type: "survey_json"
    fields:
      responses:
        type: "json"
        description: "전체 설문 응답 데이터 (JSON 형식)"
        usage: "종합 분석, 패턴 추출"
      calmness:
        type: "integer"
        range: "1-10"
        description: "학습 마무리 시점의 차분함/안정도"
        usage: "감정 상태 판단, 다음 세션 모드 결정"
      inefficiency:
        type: "integer"
        range: "1-10"
        description: "학생이 인식한 학습 비효율성 정도"
        usage: "학습 방법 개선 제안, 맞춤형 피드백"
      missed_opportunity:
        type: "text"
        description: "오늘 학습에서 놓쳤다고 느끼는 기회"
        usage: "회고 분석, 다음 학습 계획 수립"
      positive_moment:
        type: "text"
        description: "오늘 학습에서 긍정적이었던 순간"
        usage: "성취 강화, 동기 부여, 성공 패턴 분석"
      pace_anxiety:
        type: "integer"
        range: "1-10"
        description: "학습 속도에 대한 불안 정도"
        usage: "심리적 지원 타이밍, 커리큘럼 조정 판단"
      report_id:
        type: "integer"
        description: "귀가검사 리포트 고유 식별자"
        usage: "데이터 추적, 리포트 참조"
      date:
        type: "date"
        description: "귀가검사 수행 날짜"
        usage: "추세 분석, 날짜별 비교"
  
  # 사용자 테이블 (user)
  user:
    description: "사용자 기본 정보 테이블"
    type: "system"
    fields:
      id:
        type: "integer"
        description: "사용자 고유 식별자"
        usage: "데이터 조회, 사용자 매칭, 다른 테이블 연계"
        note: "모든 학생 데이터 조회의 기본 키"
