# Rules for Agent 13 - Learning Dropout
# Generated at: 2025-01-21
# Purpose: 수학 학습 이탈 조기 탐지 및 맞춤형 개입 설계
# Source: teacher_level_evaluation.md 기반 수학 특화 확장

version: "1.0"
scenario: "learning_dropout"
description: "수학 학습 이탈 조기 탐지 및 예방 개입 - 수학 단원별/난이도별/학원 맥락 통합 분석"

#
# 포괄형 질문 1: "이 학생의 학습 몰입 흐름이 어느 시점에서 끊기고 있는지, 그 원인을 어떻게 조기 탐지·예방해야 할까?"
#   - 연계 룰: S0_R1~S0_R6 (수학 특화 정보 수집), S1_R1~S1_R3 (이탈 조기 탐지 및 개입), S8_R1~S8_R4 (기본 이탈 탐지 및 위험도 평가)
#   - 데이터 소스: pomodoro_pattern, emotion_change_rate, note_taking_trend, goal_input_delay, routine_collapse_point, dropout_prediction, intervention_timing, intervention_message, action_routine, immersion_break_point, dropout_cause
#   - 온톨로지: DropoutEarlyDetection
#   - 연계 에이전트: Agent 05 (감정 분석), Agent 18 (시그너처 루틴)
#
# 포괄형 질문 2: "이 학생의 집중 회복력을 높이기 위해 어떤 루틴과 환경 변수를 조정해야 할까?"
#   - 연계 룰: S8_R3 (루틴 보정), S1_R2 (단원별 맞춤형 개입), S2_R1~S2_R3 (난이도별 이탈 분석)
#   - 데이터 소스: return_success_rate, return_delay_after_dropout, emotion_recovery_speed, fatigue_accumulation_index, routine_maintenance_stability, return_loop_strategy, routine_adjustment, time_intensity_reward, concentration_recovery, environment_variables
#   - 온톨로지: ConcentrationRecovery
#   - 연계 에이전트: Agent 05 (감정 회복), Agent 12 (휴식 루틴), Agent 18 (루틴 조정)
#
# 포괄형 질문 3: "이 학생이 장기적으로 이탈이 줄고, 자기조절 루틴이 자리잡도록 하기 위해 지금 어떤 피드백 체계를 구축해야 할까?"
#   - 연계 룰: S8_R4 (에스컬레이션), S3_R1~S3_R3 (학습 단계별 이탈 분석), S4_R1~S4_R3 (학원 맥락 이탈 분석)
#   - 데이터 소스: weekly_dropout_trend, emotion_rest_data, teacher_intervention_effect, feedback_tolerance, return_loop_completion_rate, self_regulation_routine, emotional_recovery_routine, long_term_dropout_reduction, self_regulation_establishment, feedback_system
#   - 온톨로지: SelfRegulationRoutine
#   - 연계 에이전트: Agent 05 (감정/휴식 데이터), Agent 06 (교사 개입 효과), Agent 18 (자기조절 루틴)
#
# 자세한 데이터 기반 질문 정의는 data_based_questions.js의 agent13 섹션을 참조하세요.
#

rules:
  # ========== S0: 수학 특화 필수 정보 수집 룰 ==========
  
  - rule_id: "S0_R1_current_math_unit_collection"
    priority: 99
    description: "현재 학습 중인 수학 단원 정보 수집"
    conditions:
      - field: "current_math_unit"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "ninactive"
          operator: ">="
          value: 1
    action:
      - "collect_info: 'current_math_unit'"
      - "validate: '수학 단원 정보는 학년과 단원명을 포함해야 합니다 (예: 중2-함수)'"
      - "display_message: '현재 학습 중인 수학 단원을 파악하여 단원별 이탈 패턴을 분석합니다.'"
      - "question: '현재 학습 중인 수학 단원은 무엇인가요? (예: 중2-함수, 중3-이차방정식)'"
    confidence: 0.96
    rationale: "S0: 단원별 이탈 패턴 분석을 위해 현재 단원 정보 필수"
  
  - rule_id: "S0_R2_problem_difficulty_collection"
    priority: 98
    description: "현재 풀고 있는 문제 난이도 정보 수집"
    conditions:
      - field: "problem_difficulty"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "eye_count"
          operator: ">="
          value: 1
    action:
      - "collect_info: 'problem_difficulty'"
      - "validate: '문제 난이도는 기본형, 유형, 심화 중 하나여야 합니다'"
      - "display_message: '현재 풀고 있는 문제 난이도를 파악하여 난이도별 이탈 패턴을 분석합니다.'"
      - "question: '현재 풀고 있는 문제 난이도는? (A) 기본형 (B) 유형 (C) 심화'"
    confidence: 0.95
    rationale: "S0: 난이도별 이탈 분석을 위해 문제 난이도 정보 필수"
  
  - rule_id: "S0_R3_learning_stage_collection"
    priority: 97
    description: "현재 학습 단계 정보 수집 (개념/유형/심화/기출)"
    conditions:
      - field: "learning_stage"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "tlaststroke_min"
          operator: ">="
          value: 5
    action:
      - "collect_info: 'learning_stage'"
      - "validate: '학습 단계는 개념 학습, 유형 연습, 심화 문제, 기출 문제 중 하나여야 합니다'"
      - "display_message: '현재 학습 단계를 파악하여 단계별 이탈 패턴을 분석합니다.'"
      - "question: '현재 어떤 학습 단계인가요? (A) 개념 학습 (B) 유형 연습 (C) 심화 문제 (D) 기출 문제'"
    confidence: 0.94
    rationale: "S0: 학습 단계별 이탈 분석을 위해 현재 단계 정보 필수"
  
  - rule_id: "S0_R4_academy_class_understanding_collection"
    priority: 96
    description: "학원 수업 이해도 정보 수집"
    conditions:
      - field: "academy_class_understanding"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "ninactive"
          operator: ">="
          value: 2
    action:
      - "collect_info: 'academy_class_understanding'"
      - "validate: '학원 수업 이해도는 완전히 이해, 대부분 이해, 반만 이해, 거의 이해 못함 중 하나여야 합니다'"
      - "display_message: '오늘 학원 수업 이해도를 파악하여 학원 맥락 기반 이탈 원인을 분석합니다.'"
      - "question: '오늘 학원 수업을 이해하셨나요? (A) 완전히 이해 (B) 대부분 이해 (C) 반만 이해 (D) 거의 이해 못함'"
    confidence: 0.93
    rationale: "S0: 학원 수업 이해도는 이탈 원인 분석의 핵심 요소"
  
  - rule_id: "S0_R5_academy_homework_burden_collection"
    priority: 95
    description: "학원 과제 부담 정보 수집"
    conditions:
      - field: "academy_homework_burden"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "risk_tier"
          operator: "=="
          value: "Medium"
    action:
      - "collect_info: 'academy_homework_burden'"
      - "validate: '학원 과제 부담은 적절함, 조금 많음, 너무 많음 중 하나여야 합니다'"
      - "display_message: '오늘 학원 과제 양을 파악하여 과제 부담 기반 이탈 원인을 분석합니다.'"
      - "question: '오늘 학원 과제 양이 적절하신가요? (A) 적절함 (B) 조금 많음 (C) 너무 많음'"
    confidence: 0.92
    rationale: "S0: 학원 과제 부담은 이탈 증가의 주요 원인"
  
  - rule_id: "S0_R6_math_level_collection"
    priority: 94
    description: "수학 성적 수준 정보 수집 (하위/중위/상위)"
    conditions:
      - field: "math_level"
        operator: "=="
        value: null
      - OR:
        - field: "detect_dropout_risk"
          operator: "=="
          value: true
        - field: "risk_tier"
          operator: "in"
          value: ["Medium", "High"]
    action:
      - "collect_info: 'math_level'"
      - "validate: '수학 성적 수준은 하위권, 중위권, 상위권 중 하나여야 합니다'"
      - "display_message: '수학 성적 수준을 파악하여 수준별 맞춤형 이탈 대응 전략을 수립합니다.'"
      - "question: '현재 수학 성적 수준은? (A) 하위권 (B) 중위권 (C) 상위권'"
    confidence: 0.91
    rationale: "S0: 수준별 이탈 원인 차별화를 위해 수학 성적 수준 필수"
  
  # ========== S1: 단원별 이탈 패턴 분석 룰 ==========
  
  - rule_id: "S1_R1_unit_difficulty_dropout_analysis"
    priority: 90
    description: "어려운 단원에서 이탈 증가 패턴 분석"
    conditions:
      - field: "current_math_unit"
        operator: "!="
        value: null
      - field: "ninactive"
        operator: ">="
        value: 2
      - OR:
        - field: "current_math_unit"
          operator: "contains"
          value: "함수"
        - field: "current_math_unit"
          operator: "contains"
          value: "도형"
        - field: "current_math_unit"
          operator: "contains"
          value: "이차"
    action:
      - "analyze: 'unit_difficulty_dropout_pattern'"
      - "load_db: 'math_unit_difficulty.yaml'"  # 단원별 난이도 DB 로드
      - "identify_dropout_patterns: 'difficult_unit_dropout'"
      - "generate_description: 'difficult_unit_dropout_analysis'"
      - "display_message: '{current_math_unit} 단원은 난이도가 높아 이탈이 빈번합니다. 기본 개념부터 다시 복습하는 것을 권장합니다.'"
      - "suggest_easy_win: 'unit_basic_concept_review'"
      - "recommend_path: '기본 개념 재학습 → 쉬운 문제 연습 → 단원 완료'"
    confidence: 0.88
    rationale: "S1: 어려운 단원(함수, 도형, 이차)에서 이탈 증가는 난이도 조정 필요 신호"
  
  - rule_id: "S1_R2_unit_specific_intervention"
    priority: 89
    description: "단원별 맞춤형 개입 전략 적용"
    conditions:
      - field: "current_math_unit"
        operator: "!="
        value: null
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
    action:
      - "analyze: 'unit_specific_dropout_cause'"
      - "generate_description: 'unit_specific_intervention_strategy'"
      - "load_db: 'unit_intervention_strategies.yaml'"  # 단원별 개입 전략 DB
      - "suggest_easy_win: 'unit_specific_easy_task'"
      - "display_message: '{current_math_unit} 단원 특성에 맞는 쉬운 승리 과제를 제시합니다.'"
      - "adjust_routine: 'unit_based_session_length'"
    confidence: 0.87
    rationale: "S1: 단원별 특성에 맞는 개입 전략이 효과적"
  
  # ========== S2: 난이도별 이탈 분석 룰 ==========
  
  - rule_id: "S2_R1_difficulty_dropout_analysis"
    priority: 88
    description: "심화 문제에서 이탈 증가 시 기본형 전환 제안"
    conditions:
      - field: "problem_difficulty"
        operator: "=="
        value: "심화"
      - field: "ninactive"
        operator: ">="
        value: 2
      - OR:
        - field: "eye_count"
          operator: ">="
          value: 2
        - field: "tlaststroke_min"
          operator: ">="
          value: 10
    action:
      - "analyze: 'difficulty_based_dropout_pattern'"
      - "identify_dropout_patterns: 'high_difficulty_dropout'"
      - "generate_description: 'difficulty_dropout_analysis'"
      - "display_message: '심화 문제에서 이탈이 증가하고 있습니다. 기본형 문제로 전환하여 학습 흐름을 유지하는 것을 권장합니다.'"
      - "suggest_easy_win: 'switch_to_basic_problems'"
      - "recommend_path: '기본형 문제 완료 → 유형 문제 → 심화 문제 순서로 재진입'"
      - "adjust_routine: 'reduce_difficulty_level'"
    confidence: 0.86
    rationale: "S2: 심화 문제에서 이탈 증가는 난이도가 너무 높다는 신호 → 기본형 전환"
  
  - rule_id: "S2_R2_difficulty_progression_intervention"
    priority: 87
    description: "난이도별 단계적 재진입 전략"
    conditions:
      - field: "problem_difficulty"
        operator: "!="
        value: null
      - field: "risk_tier"
        operator: "=="
        value: "High"
    action:
      - "analyze: 'difficulty_progression_analysis'"
      - "generate_description: 'difficulty_progression_strategy'"
      - "suggest_easy_win: 'gradual_difficulty_increase'"
      - "display_message: '난이도별 단계적 재진입 전략을 제시합니다. 현재 난이도보다 한 단계 낮은 문제부터 시작하세요.'"
      - "adjust_routine: 'step_by_step_difficulty'"
    confidence: 0.85
    rationale: "S2: 단계적 난이도 증가가 이탈 방지에 효과적"
  
  # ========== S3: 학원 수업 이해도 기반 이탈 분석 룰 ==========
  
  - rule_id: "S3_R1_academy_understanding_dropout_analysis"
    priority: 86
    description: "학원 수업 이해 못함으로 인한 이탈 분석"
    conditions:
      - field: "academy_class_understanding"
        operator: "in"
        value: ["반만 이해", "거의 이해 못함"]
      - field: "ninactive"
        operator: ">="
        value: 2
    action:
      - "analyze: 'academy_understanding_dropout_pattern'"
      - "identify_dropout_patterns: 'low_understanding_dropout'"
      - "generate_description: 'academy_understanding_dropout_analysis'"
      - "display_message: '학원 수업을 이해하지 못한 상태에서 자습 시 이탈이 증가합니다. 이해 못한 내용을 먼저 복습하는 것을 권장합니다.'"
      - "suggest_easy_win: 'review_unclear_concepts'"
      - "recommend_path: '학원 교재 개념 부분 재학습 → 이해한 후 문제 풀이 재진입'"
      - "send_refocus_message: 'academy_concept_review_focus'"
    confidence: 0.84
    rationale: "S3: 학원 수업 이해 못함 → 자습 시 이탈 증가 → 예습/복습 강화 필요"
  
  - rule_id: "S3_R2_academy_concept_review_intervention"
    priority: 85
    description: "학원 수업 이해도 기반 맞춤형 개입"
    conditions:
      - field: "academy_class_understanding"
        operator: "in"
        value: ["반만 이해", "거의 이해 못함"]
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
    action:
      - "analyze: 'academy_concept_review_strategy'"
      - "generate_description: 'academy_concept_review_intervention'"
      - "suggest_easy_win: 'academy_textbook_concept_review'"
      - "display_message: '학원 교재의 개념 부분을 다시 보며 이해도를 높인 후 문제 풀이를 재개하세요.'"
      - "adjust_routine: 'concept_first_then_problems'"
    confidence: 0.83
    rationale: "S3: 개념 이해 후 문제 풀이가 이탈 방지에 효과적"
  
  # ========== S4: 학습 단계별 이탈 분석 룰 ==========
  
  - rule_id: "S4_R1_concept_learning_dropout_intervention"
    priority: 84
    description: "개념 학습 중 이탈 시 설명 보강 제안"
    conditions:
      - field: "learning_stage"
        operator: "=="
        value: "개념 학습"
      - field: "eye_count"
        operator: ">="
        value: 1
      - field: "tlaststroke_min"
        operator: ">="
        value: 5
    action:
      - "analyze: 'concept_learning_dropout_pattern'"
      - "identify_dropout_patterns: 'concept_stage_dropout'"
      - "generate_description: 'concept_learning_dropout_analysis'"
      - "display_message: '개념 학습 중 이탈이 감지되었습니다. 시각 자료나 예시를 활용하여 설명을 보강하는 것을 권장합니다.'"
      - "suggest_easy_win: 'visual_concept_explanation'"
      - "recommend_path: '시각 자료/예시 활용 개념 학습 → 간단한 확인 문제 → 재진입'"
      - "send_refocus_message: 'concept_explanation_enhancement'"
    confidence: 0.82
    rationale: "S4: 개념 학습 이탈은 설명 부족 가능성 → 시각 자료/예시 보강"
  
  - rule_id: "S4_R2_problem_solving_dropout_intervention"
    priority: 83
    description: "문제 풀이 중 이탈 시 쉬운 문제 제시"
    conditions:
      - field: "learning_stage"
        operator: "=="
        value: "유형 연습"
      - field: "ninactive"
        operator: ">="
        value: 2
    action:
      - "analyze: 'problem_solving_dropout_pattern'"
      - "identify_dropout_patterns: 'problem_stage_dropout'"
      - "generate_description: 'problem_solving_dropout_analysis'"
      - "display_message: '문제 풀이 중 이탈이 증가하고 있습니다. 한 단계 쉬운 문제로 전환하여 학습 흐름을 유지하세요.'"
      - "suggest_easy_win: 'switch_to_easier_problems'"
      - "recommend_path: '쉬운 문제 1개 완료 → 자신감 회복 → 원래 난이도 재진입'"
      - "adjust_routine: 'problem_difficulty_adjustment'"
    confidence: 0.81
    rationale: "S4: 문제 풀이 이탈은 난이도 높음 가능성 → 쉬운 문제로 전환"
  
  # ========== S5: 학원 과제 부담 기반 이탈 분석 룰 ==========
  
  - rule_id: "S5_R1_homework_burden_dropout_analysis"
    priority: 82
    description: "학원 과제 과다로 인한 이탈 분석"
    conditions:
      - field: "academy_homework_burden"
        operator: "in"
        value: ["조금 많음", "너무 많음"]
      - field: "ninactive"
        operator: ">="
        value: 2
    action:
      - "analyze: 'homework_burden_dropout_pattern'"
      - "identify_dropout_patterns: 'high_homework_burden_dropout'"
      - "generate_description: 'homework_burden_dropout_analysis'"
      - "display_message: '학원 과제가 많아 이탈이 증가하고 있습니다. 과제 우선순위를 조정하여 집중할 수 있는 과제부터 완료하는 것을 권장합니다.'"
      - "suggest_easy_win: 'prioritize_homework_tasks'"
      - "recommend_path: '가장 쉬운 과제 1개 완료 → 성취감 획득 → 다음 과제 진행'"
      - "adjust_routine: 'homework_priority_adjustment'"
    confidence: 0.80
    rationale: "S5: 과제 과다 → 이탈 증가 → 우선순위 조정 필요"
  
  # ========== S6: 수학 성적 수준별 이탈 원인 차별화 룰 ==========
  
  - rule_id: "S6_R1_low_level_dropout_intervention"
    priority: 81
    description: "하위권 학생 이탈 원인 분석 및 대응 (너무 어려워서 포기)"
    conditions:
      - field: "math_level"
        operator: "=="
        value: "하위권"
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
    action:
      - "analyze: 'low_level_dropout_cause'"
      - "identify_dropout_patterns: 'too_difficult_dropout'"
      - "generate_description: 'low_level_dropout_analysis'"
      - "display_message: '하위권 학생의 이탈은 대부분 난이도가 너무 높아서입니다. 쉬운 문제부터 차근차근 풀어보세요.'"
      - "suggest_easy_win: 'start_with_easiest_problems'"
      - "recommend_path: '가장 쉬운 기본형 문제 1개 완료 → 성취감 → 다음 문제'"
      - "adjust_routine: 'low_level_focused_session'"
    confidence: 0.79
    rationale: "S6: 하위권 → 너무 어려워서 포기 → 쉬운 문제부터"
  
  - rule_id: "S6_R2_mid_level_dropout_intervention"
    priority: 80
    description: "중위권 학생 이탈 원인 분석 및 대응 (집중력 부족)"
    conditions:
      - field: "math_level"
        operator: "=="
        value: "중위권"
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
    action:
      - "analyze: 'mid_level_dropout_cause'"
      - "identify_dropout_patterns: 'concentration_lack_dropout'"
      - "generate_description: 'mid_level_dropout_analysis'"
      - "display_message: '중위권 학생의 이탈은 집중력 부족이 주된 원인입니다. 루틴을 강화하여 집중력을 유지하세요.'"
      - "suggest_easy_win: 'routine_strengthening_task'"
      - "recommend_path: '10분 세션 완료 → 1분 휴식 → 다음 세션'"
      - "adjust_routine: 'mid_level_routine_focus'"
    confidence: 0.78
    rationale: "S6: 중위권 → 집중력 부족 → 루틴 강화"
  
  - rule_id: "S6_R3_high_level_dropout_intervention"
    priority: 79
    description: "상위권 학생 이탈 원인 분석 및 대응 (권태로움)"
    conditions:
      - field: "math_level"
        operator: "=="
        value: "상위권"
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
    action:
      - "analyze: 'high_level_dropout_cause'"
      - "identify_dropout_patterns: 'boredom_dropout'"
      - "generate_description: 'high_level_dropout_analysis'"
      - "display_message: '상위권 학생의 이탈은 권태로움이 주된 원인입니다. 도전할 만한 과제를 제시하여 동기를 유지하세요.'"
      - "suggest_easy_win: 'challenging_task_presentation'"
      - "recommend_path: '창의 문제/변형 문제 도전 → 흥미 유발 → 재진입'"
      - "adjust_routine: 'high_level_challenge_focus'"
    confidence: 0.77
    rationale: "S6: 상위권 → 권태로움 → 도전 과제 제시"
  
  # ========== S7: 수학 학습 스타일별 이탈 패턴 분석 룰 ==========
  
  - rule_id: "S7_R1_learning_style_dropout_analysis"
    priority: 78
    description: "학습 스타일별 이탈 빈도 높은 활동 파악 및 전환 제안"
    conditions:
      - field: "math_learning_style"
        operator: "!="
        value: null
      - field: "ninactive"
        operator: ">="
        value: 2
    action:
      - "analyze: 'learning_style_dropout_pattern'"
      - "identify_dropout_patterns: 'style_mismatch_dropout'"
      - "generate_description: 'learning_style_dropout_analysis'"
      - "load_db: 'learning_style_activities.yaml'"  # 스타일별 적합 활동 DB
      - "suggest_easy_win: 'style_matched_activity'"
      - "display_message: '{math_learning_style} 학습 스타일에 맞는 활동으로 전환하여 이탈을 방지합니다.'"
      - "adjust_routine: 'style_based_activity_switch'"
    confidence: 0.76
    rationale: "S7: 학습 스타일과 맞지 않는 활동에서 이탈 증가 → 스타일 맞는 활동으로 전환"
  
  # ========== S8: 기본 이탈 탐지 및 개입 룰 (기존 로직 강화) ==========
  
  - rule_id: "S8_R1_basic_dropout_detection"
    priority: 75
    description: "기본 이탈 위험도 탐지 (기존 로직)"
    conditions:
      - OR:
        - field: "ninactive"
          operator: ">="
          value: 4
        - field: "npomodoro"
          operator: "<"
          value: 2
        - field: "tlaststroke_min"
          operator: ">="
          value: 30
    action:
      - "detect_dropout_risk: true"
      - "calculate_risk_tier: 'High'"
      - "identify_dropout_patterns: 'basic_high_risk'"
      - "display_message: '이탈 위험이 높습니다. 즉시 개입이 필요합니다.'"
      - "send_refocus_message: 'urgent_refocus'"
      - "suggest_easy_win: 'immediate_easy_task'"
    confidence: 0.90
    rationale: "S8: 기본 이탈 탐지 로직 (High 등급)"
  
  - rule_id: "S8_R2_medium_risk_intervention"
    priority: 74
    description: "중간 위험도 개입"
    conditions:
      - field: "risk_tier"
        operator: "=="
        value: "Medium"
    action:
      - "detect_dropout_risk: true"
      - "calculate_risk_tier: 'Medium'"
      - "send_refocus_message: 'gentle_refocus'"
      - "suggest_easy_win: 'gentle_easy_task'"
      - "display_message: '이탈 조짐이 감지되었습니다. 짧은 리포커스 후 쉬운 과제부터 시작하세요.'"
    confidence: 0.85
    rationale: "S8: 중간 위험도 개입"
  
  - rule_id: "S8_R3_routine_adjustment"
    priority: 73
    description: "루틴 보정 (세션 길이, 휴식 주기 조정)"
    conditions:
      - field: "risk_tier"
        operator: "in"
        value: ["Medium", "High"]
      - field: "npomodoro"
        operator: "<"
        value: 5
    action:
      - "adjust_routine: 'session_length_reduction'"
      - "adjust_routine: 'rest_interval_adjustment'"
      - "display_message: '세션 길이를 15분에서 10분으로 줄이고, 휴식 주기를 50분에서 40분으로 조정합니다.'"
      - "generate_description: 'routine_adjustment_strategy'"
    confidence: 0.80
    rationale: "S8: 포모도로 부족 시 루틴 보정"
  
  - rule_id: "S8_R4_escalation_intervention"
    priority: 72
    description: "High 등급 연속 발생 시 에스컬레이션"
    conditions:
      - field: "risk_tier"
        operator: "=="
        value: "High"
      - field: "consecutive_high_days"
        operator: ">="
        value: 2
    action:
      - "notify_parents: 'high_risk_escalation'"
      - "notify_teacher: 'high_risk_escalation'"
      - "display_message: 'High 등급이 2일 연속 발생하여 보호자 및 담임 선생님께 알림을 전송합니다.'"
      - "generate_description: 'escalation_report'"
    confidence: 0.75
    rationale: "S8: 지속적 High 등급 시 에스컬레이션 (운영정책 준수)"

default_rule:
  rule_id: "default_dropout_monitoring"
  action:
    - "detect_dropout_risk: true"
    - "calculate_risk_tier: 'Low'"
    - "display_message: '학습 이탈 위험을 지속적으로 모니터링합니다.'"
  confidence: 0.5
  rationale: "기본 모니터링 룰"

# ============================================
# 데이터 소스 매핑 정보
# ============================================
# 이 섹션은 Agent13 Learning Dropout에서 사용하는 외부 테이블 데이터 소스 정보입니다.
# source_type: interface = 사용자 인터페이스 입력 (uidata)
# source_type: survey = 설문 조사 데이터 (survdata)
# source_type: system = 시스템 자동 생성 데이터 (sysdata)
# source_type: generated = LLM 모델링 생성 데이터 (gendata)

data_sources:
  # 귀가검사 테이블 (alt42_goinghome)
  alt42_goinghome:
    description: "하교 전 학습 상태 설문 데이터 - 학습 이탈 회고 및 감정 상태 파악"
    type: "survey_json"
    fields:
      responses:
        type: "json"
        description: "전체 설문 응답 데이터 (JSON 형식)"
        usage: "종합 분석, 패턴 추출, data_storage_only"
      calmness:
        type: "integer"
        range: "1-10"
        description: "학습 마무리 시점의 차분함/안정도"
        usage: "감정 상태 기반 이탈 위험 분석, 복귀 가능성 예측"
      inefficiency:
        type: "text"
        description: "학생이 인식한 학습 비효율성 내용"
        usage: "이탈 원인 분석, 학습 방법 개선 제안"
      missed_opportunity:
        type: "text"
        description: "오늘 학습에서 놓쳤다고 느끼는 기회"
        usage: "이탈 패턴 분석, 회고 기반 복귀 전략"
      positive_moment:
        type: "text"
        description: "오늘 학습에서 긍정적이었던 순간"
        usage: "복귀 동기 강화, 성공 패턴 분석"
      pace_anxiety:
        type: "integer"
        range: "1-10"
        description: "학습 속도에 대한 불안 정도"
        usage: "이탈 예측, 속도 기반 루틴 조정"
      report_id:
        type: "integer"
        description: "귀가검사 리포트 고유 식별자"
        usage: "reference_key"
      created_at:
        type: "datetime"
        description: "리포트 생성 시간"
        usage: "timestamp"
      date:
        type: "date"
        description: "귀가검사 수행 날짜"
        usage: "timestamp, 추세 분석"

  # 메시지/노트 활동 테이블 (abessi_messages)
  abessi_messages:
    description: "학습 활동 및 노트 데이터 - 실시간 이탈 감지용"
    type: "column"
    fields:
      tlaststroke:
        type: "integer"
        description: "마지막 필기 시간 (Unix timestamp)"
        usage: "이탈 시점 감지, 비활성 시간 계산"
      nstroke:
        type: "integer"
        description: "총 필기 횟수"
        usage: "활동 수준 측정, 참여도 분석"
      usedtime:
        type: "integer"
        description: "사용 시간 (초)"
        usage: "학습 시간 추적, 세션 분석"
      nretry:
        type: "integer"
        description: "재시도 횟수"
        usage: "학습 지속성 분석, 포기 패턴 감지"
      nfeedback:
        type: "integer"
        description: "피드백 수신 횟수"
        usage: "교사 개입 효과 분석"
      tracking:
        type: "text"
        description: "학습 트래킹 데이터"
        usage: "상세 활동 패턴 분석"
      realtime:
        type: "integer"
        description: "실시간 활동 플래그"
        usage: "현재 활동 상태 판단"
      onair:
        type: "integer"
        description: "실시간 연결 상태"
        usage: "접속 상태 확인"
      star:
        type: "integer"
        description: "별점 평가"
        usage: "학습 만족도 측정"
      rating_understanding:
        type: "integer"
        description: "이해도 자가 평가"
        usage: "이탈 원인 분석 (이해 부족)"
      rating_methodology:
        type: "integer"
        description: "방법론 자가 평가"
        usage: "학습 방법 적합성 분석"
      rating_ideation:
        type: "integer"
        description: "아이디어 자가 평가"
        usage: "창의적 사고 참여도"
      timetoday:
        type: "integer"
        description: "오늘 학습 시간"
        usage: "일일 학습량 추적"
      timereviewed:
        type: "integer"
        description: "복습 시간"
        usage: "복습 패턴 분석"
      tremember:
        type: "integer"
        description: "기억 시간"
        usage: "학습 효과 측정"

  # 온보딩 테이블 (alt42o_onboarding)
  alt42o_onboarding:
    description: "학생 온보딩 데이터 - 이탈 예측 배경 정보"
    type: "survey"
    fields:
      math_confidence:
        type: "text"
        description: "수학 자신감 수준"
        usage: "이탈 위험 예측 요소, 개입 강도 결정"
      feedback_preference:
        type: "text"
        description: "피드백 선호도"
        usage: "개입 방식 최적화, 복귀 메시지 스타일"
      problem_preference:
        type: "text"
        description: "문제 유형 선호도"
        usage: "난이도 기반 이탈 분석"
      short_term_goal:
        type: "text"
        description: "단기 학습 목표"
        usage: "목표 달성 진도 기반 이탈 분석"
      mid_term_goal:
        type: "text"
        description: "중기 학습 목표"
        usage: "중장기 이탈 패턴 분석"
      long_term_goal:
        type: "text"
        description: "장기 학습 목표"
        usage: "동기 유지 전략"
      goal_note:
        type: "text"
        description: "목표 관련 메모"
        usage: "개인화된 이탈 방지 메시지"
      learning_notes:
        type: "text"
        description: "학습 메모"
        usage: "학습 스타일 분석"
      vacation_hours:
        type: "integer"
        description: "방학 학습 시간"
        usage: "학습 패턴 변화 분석"
      updated_at:
        type: "datetime"
        description: "마지막 업데이트 시간"
        usage: "timestamp"

  # 오늘 목표/검사 테이블 (abessi_today)
  abessi_today:
    description: "일일 학습 목표 및 검사 데이터 - 이탈 위험도 계산"
    type: "column"
    fields:
      score:
        type: "integer"
        description: "학습 점수"
        usage: "일일 성취도 기반 이탈 위험 계산"
      planscore:
        type: "integer"
        description: "계획 점수"
        usage: "계획 대비 실행 분석"
      goallevel:
        type: "integer"
        description: "목표 레벨"
        usage: "목표 난이도 기반 이탈 분석"
      hide:
        type: "integer"
        description: "숨김 여부 플래그"
        usage: "system_flag"
      cid:
        type: "integer"
        description: "컨텐츠 ID"
        usage: "reference_key"
      wboardid:
        type: "integer"
        description: "화이트보드 ID"
        usage: "reference_key"
      timecreated:
        type: "integer"
        description: "생성 시간 (Unix timestamp)"
        usage: "timestamp"
      timemodified:
        type: "integer"
        description: "수정 시간 (Unix timestamp)"
        usage: "timestamp, 활동 추적"

  # 트래킹 테이블 (abessi_tracking)
  abessi_tracking:
    description: "타임스캐폴딩 데이터 - 직접적 이탈 지표"
    type: "column"
    fields:
      duration:
        type: "integer"
        description: "학습 세션 기간 (초)"
        usage: "세션 길이 분석, 이탈 타이밍 감지"
      ndisengagement:
        type: "integer"
        description: "이탈 횟수"
        usage: "직접적 이탈 빈도 측정, 핵심 지표"
      nwboard:
        type: "integer"
        description: "화이트보드 사용 수"
        usage: "활동 다양성 분석"
      timefinished:
        type: "integer"
        description: "종료 시간 (Unix timestamp)"
        usage: "세션 완료 패턴 분석"
      wbtimeave:
        type: "integer"
        description: "화이트보드 평균 사용 시간"
        usage: "집중도 분석"

  # 포모도로 요약 테이블 (abessi_indicators)
  abessi_indicators:
    description: "포모도로 요약 데이터 - 집중 패턴 분석"
    type: "column"
    fields:
      kpomodoro:
        type: "float"
        description: "포모도로 K값 (집중 효율 지표)"
        usage: "집중 패턴 분석, 이탈 예측"
      memorytime:
        type: "integer"
        description: "기억 시간 (초)"
        usage: "학습 효과 측정"
      todayscore:
        type: "integer"
        description: "오늘 총점"
        usage: "일일 성취도 분석"
      weekscore:
        type: "integer"
        description: "주간 총점"
        usage: "주간 추세 분석, 장기 이탈 예측"
      managerid:
        type: "integer"
        description: "담당 관리자 ID"
        usage: "reference_key, 에스컬레이션 대상"

# ============================================
# 필드 메타데이터 정의
# ============================================
# 이 섹션은 규칙에서 사용하는 필드의 상세 정의입니다.
# dataindex_user.php에서 필드 타입 식별을 위한 메타데이터

fields:
  # ========== alt42_goinghome 테이블 필드 (귀가검사 설문 데이터) ==========
  - field: "calmness"
    source_type: "survey"
    description: "평온함/차분함 수준 (1-10)"
    table: "alt42_goinghome"
    data_type: "integer"
    range: [1, 10]
    related_rules: ["S8_R2_medium_risk_intervention", "S8_R3_routine_adjustment"]
    
  - field: "pace_anxiety"
    source_type: "survey"
    description: "학습 속도 불안감 (1-10)"
    table: "alt42_goinghome"
    data_type: "integer"
    range: [1, 10]
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R2_medium_risk_intervention"]
    
  - field: "inefficiency"
    source_type: "generated"
    description: "비효율성 분석 (LLM 생성 텍스트)"
    table: "alt42_goinghome"
    data_type: "text"
    related_rules: ["S1_R1_unit_difficulty_dropout_analysis"]
    
  - field: "missed_opportunity"
    source_type: "generated"
    description: "놓친 기회 분석 (LLM 생성 텍스트)"
    table: "alt42_goinghome"
    data_type: "text"
    related_rules: ["S1_R2_unit_specific_intervention"]
    
  - field: "positive_moment"
    source_type: "generated"
    description: "긍정적인 순간 (LLM 생성 텍스트)"
    table: "alt42_goinghome"
    data_type: "text"
    related_rules: ["S8_R2_medium_risk_intervention"]
    
  - field: "responses"
    source_type: "system"
    description: "전체 설문 응답 데이터 (JSON)"
    table: "alt42_goinghome"
    data_type: "json"
    usage: "data_storage_only"
    
  - field: "report_id"
    source_type: "system"
    description: "귀가검사 리포트 고유 식별자"
    table: "alt42_goinghome"
    data_type: "integer"
    usage: "reference_key"
    
  - field: "created_at"
    source_type: "system"
    description: "리포트 생성 시간"
    table: "alt42_goinghome"
    data_type: "datetime"
    usage: "timestamp"
    
  - field: "date"
    source_type: "system"
    description: "귀가검사 수행 날짜"
    table: "alt42_goinghome"
    data_type: "date"
    usage: "timestamp"

  # ========== abessi_messages 테이블 필드 (메시지/노트 활동 데이터) ==========
  - field: "tlaststroke"
    source_type: "system"
    description: "마지막 필기 시간 (Unix timestamp)"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S0_R3_learning_stage_collection", "S2_R1_difficulty_dropout_analysis"]
    
  - field: "nstroke"
    source_type: "system"
    description: "총 필기 횟수"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection"]
    
  - field: "usedtime"
    source_type: "system"
    description: "사용 시간 (초)"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R3_routine_adjustment"]
    
  - field: "nretry"
    source_type: "system"
    description: "재시도 횟수"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S6_R1_low_level_dropout_intervention"]
    
  - field: "nfeedback"
    source_type: "system"
    description: "피드백 수신 횟수"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R4_escalation_intervention"]
    
  - field: "tracking"
    source_type: "system"
    description: "학습 트래킹 데이터"
    table: "abessi_messages"
    data_type: "text"
    related_rules: ["S7_R1_learning_style_dropout_analysis"]
    
  - field: "realtime"
    source_type: "system"
    description: "실시간 활동 플래그"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection"]
    
  - field: "onair"
    source_type: "system"
    description: "실시간 연결 상태"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection"]
    
  - field: "star"
    source_type: "survey"
    description: "별점 평가"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R2_medium_risk_intervention"]
    
  - field: "rating_understanding"
    source_type: "survey"
    description: "이해도 자가 평가"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S3_R1_academy_understanding_dropout_analysis"]
    
  - field: "rating_methodology"
    source_type: "survey"
    description: "방법론 자가 평가"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S7_R1_learning_style_dropout_analysis"]
    
  - field: "rating_ideation"
    source_type: "survey"
    description: "아이디어 자가 평가"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S6_R3_high_level_dropout_intervention"]
    
  - field: "timetoday"
    source_type: "system"
    description: "오늘 학습 시간"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S8_R3_routine_adjustment"]
    
  - field: "timereviewed"
    source_type: "system"
    description: "복습 시간"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S1_R2_unit_specific_intervention"]
    
  - field: "tremember"
    source_type: "system"
    description: "기억 시간"
    table: "abessi_messages"
    data_type: "integer"
    related_rules: ["S1_R1_unit_difficulty_dropout_analysis"]

  # ========== alt42o_onboarding 테이블 필드 (온보딩 데이터) ==========
  - field: "math_confidence"
    source_type: "survey"
    description: "수학 자신감 수준"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S6_R1_low_level_dropout_intervention", "S6_R2_mid_level_dropout_intervention"]
    
  - field: "feedback_preference"
    source_type: "survey"
    description: "피드백 선호도"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S8_R2_medium_risk_intervention", "S8_R4_escalation_intervention"]
    
  - field: "problem_preference"
    source_type: "survey"
    description: "문제 유형 선호도"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S2_R1_difficulty_dropout_analysis", "S2_R2_difficulty_progression_intervention"]
    
  - field: "short_term_goal"
    source_type: "interface"
    description: "단기 학습 목표"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S8_R2_medium_risk_intervention"]
    
  - field: "mid_term_goal"
    source_type: "interface"
    description: "중기 학습 목표"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S8_R4_escalation_intervention"]
    
  - field: "long_term_goal"
    source_type: "interface"
    description: "장기 학습 목표"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S8_R4_escalation_intervention"]
    
  - field: "goal_note"
    source_type: "interface"
    description: "목표 관련 메모"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S8_R2_medium_risk_intervention"]
    
  - field: "learning_notes"
    source_type: "survey"
    description: "학습 메모"
    table: "alt42o_onboarding"
    data_type: "text"
    related_rules: ["S7_R1_learning_style_dropout_analysis"]
    
  - field: "vacation_hours"
    source_type: "survey"
    description: "방학 학습 시간"
    table: "alt42o_onboarding"
    data_type: "integer"
    related_rules: ["S8_R3_routine_adjustment"]
    
  - field: "updated_at"
    source_type: "system"
    description: "마지막 업데이트 시간"
    table: "alt42o_onboarding"
    data_type: "datetime"
    usage: "timestamp"

  # ========== abessi_today 테이블 필드 (오늘 목표/검사 데이터) ==========
  - field: "score"
    source_type: "system"
    description: "학습 점수"
    table: "abessi_today"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R2_medium_risk_intervention"]
    
  - field: "planscore"
    source_type: "system"
    description: "계획 점수"
    table: "abessi_today"
    data_type: "integer"
    related_rules: ["S8_R3_routine_adjustment"]
    
  - field: "goallevel"
    source_type: "system"
    description: "목표 레벨"
    table: "abessi_today"
    data_type: "integer"
    related_rules: ["S2_R1_difficulty_dropout_analysis", "S2_R2_difficulty_progression_intervention"]
    
  - field: "hide"
    source_type: "system"
    description: "숨김 여부 플래그"
    table: "abessi_today"
    data_type: "integer"
    usage: "system_flag"
    
  - field: "cid"
    source_type: "system"
    description: "컨텐츠 ID"
    table: "abessi_today"
    data_type: "integer"
    usage: "reference_key"
    
  - field: "wboardid"
    source_type: "system"
    description: "화이트보드 ID"
    table: "abessi_today"
    data_type: "integer"
    usage: "reference_key"
    
  - field: "timecreated"
    source_type: "system"
    description: "생성 시간 (Unix timestamp)"
    table: "abessi_today"
    data_type: "integer"
    usage: "timestamp"
    
  - field: "timemodified"
    source_type: "system"
    description: "수정 시간 (Unix timestamp)"
    table: "abessi_today"
    data_type: "integer"
    usage: "timestamp"

  # ========== abessi_tracking 테이블 필드 (트래킹 데이터) ==========
  - field: "duration"
    source_type: "system"
    description: "학습 세션 기간 (초)"
    table: "abessi_tracking"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R3_routine_adjustment"]
    
  - field: "ndisengagement"
    source_type: "system"
    description: "이탈 횟수 - 핵심 이탈 지표"
    table: "abessi_tracking"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R2_medium_risk_intervention", "S8_R4_escalation_intervention"]
    
  - field: "nwboard"
    source_type: "system"
    description: "화이트보드 사용 수"
    table: "abessi_tracking"
    data_type: "integer"
    related_rules: ["S7_R1_learning_style_dropout_analysis"]
    
  - field: "timefinished"
    source_type: "system"
    description: "종료 시간 (Unix timestamp)"
    table: "abessi_tracking"
    data_type: "integer"
    usage: "timestamp"
    related_rules: ["S8_R1_basic_dropout_detection"]
    
  - field: "wbtimeave"
    source_type: "system"
    description: "화이트보드 평균 사용 시간"
    table: "abessi_tracking"
    data_type: "integer"
    related_rules: ["S8_R3_routine_adjustment"]

  # ========== abessi_indicators 테이블 필드 (포모도로 요약 데이터) ==========
  - field: "kpomodoro"
    source_type: "system"
    description: "포모도로 K값 (집중 효율 지표)"
    table: "abessi_indicators"
    data_type: "float"
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R3_routine_adjustment"]
    
  - field: "memorytime"
    source_type: "system"
    description: "기억 시간 (초)"
    table: "abessi_indicators"
    data_type: "integer"
    related_rules: ["S1_R1_unit_difficulty_dropout_analysis"]
    
  - field: "todayscore"
    source_type: "system"
    description: "오늘 총점"
    table: "abessi_indicators"
    data_type: "integer"
    related_rules: ["S8_R1_basic_dropout_detection", "S8_R2_medium_risk_intervention"]
    
  - field: "weekscore"
    source_type: "system"
    description: "주간 총점"
    table: "abessi_indicators"
    data_type: "integer"
    related_rules: ["S8_R4_escalation_intervention"]
    
  - field: "managerid"
    source_type: "system"
    description: "담당 관리자 ID"
    table: "abessi_indicators"
    data_type: "integer"
    usage: "reference_key"
    related_rules: ["S8_R4_escalation_intervention"]