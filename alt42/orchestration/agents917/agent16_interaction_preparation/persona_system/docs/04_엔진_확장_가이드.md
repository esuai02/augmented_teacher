# 엔진 확장 가이드

## 1. 개요

이 가이드는 Agent16PersonaEngine을 확장하고 커스터마이징하는 방법을 설명합니다.
공통 추상 클래스를 상속받아 에이전트별 특화 기능을 구현할 수 있습니다.

---

## 2. 아키텍처 구조

### 2.1 상속 계층

```
PersonaEngineInterface (인터페이스)
         │
         ▼
AbstractPersonaEngine (추상 클래스)
         │
         ▼
Agent16PersonaEngine (구현 클래스)
```

### 2.2 파일 위치

```
ontology_engineering/persona_engine/
├── core/
│   ├── PersonaEngineInterface.php   # 인터페이스 정의
│   └── AbstractPersonaEngine.php    # 추상 클래스
│
├── impl/
│   ├── BaseWorldviewManager.php     # 세계관 관리
│   ├── BasePersonaSelector.php      # 페르소나 선택
│   ├── BaseSituationDetector.php    # 상황 감지
│   ├── BaseRuleEngine.php           # 규칙 엔진
│   └── BaseResponseGenerator.php    # 응답 생성
│
└── communication/
    ├── AgentCommunicator.php        # 에이전트 통신
    ├── AgentMessenger.php           # 메시지 전달
    └── AgentStateSync.php           # 상태 동기화

agents/agent16_interaction_preparation/persona_system/
└── engine/
    └── Agent16PersonaEngine.php     # Agent16 전용 구현
```

---

## 3. 핵심 인터페이스

### 3.1 PersonaEngineInterface

```php
interface PersonaEngineInterface {
    /**
     * 메시지 처리 (메인 진입점)
     */
    public function process(
        int $userId,
        string $message,
        array $sessionData = []
    ): array;

    /**
     * 규칙 파일 로드
     */
    public function loadRules(): bool;

    /**
     * 세계관 정보 조회
     */
    public function getWorldview(string $worldviewId): ?array;

    /**
     * 전체 세계관 목록
     */
    public function getWorldviews(): array;

    /**
     * 세계관 기반 페르소나 선택
     */
    public function selectPersonaByWorldview(string $worldviewId): array;

    /**
     * 디버그 정보 조회
     */
    public function getDebugInfo(): array;
}
```

---

## 4. 추상 클래스 구조

### 4.1 AbstractPersonaEngine

```php
abstract class AbstractPersonaEngine implements PersonaEngineInterface {
    protected string $agentId;
    protected array $config;
    protected array $rules = [];
    protected bool $debugMode = false;
    protected $db;

    /**
     * 생성자
     */
    public function __construct(string $agentId, array $config = []) {
        $this->agentId = $agentId;
        $this->config = array_merge($this->getDefaultConfig(), $config);
        $this->debugMode = $config['debug_mode'] ?? false;
        $this->initializeDatabase();
    }

    /**
     * 기본 설정 (오버라이드 가능)
     */
    protected function getDefaultConfig(): array {
        return [
            'rules_path' => null,
            'cache_enabled' => true,
            'debug_mode' => false
        ];
    }

    /**
     * 메시지 분석 (하위 클래스에서 확장)
     */
    protected function analyzeMessage(
        array $context,
        string $message
    ): array {
        return [
            'original_message' => $message,
            'timestamp' => date('c'),
            'user_context' => $context
        ];
    }

    /**
     * 응답 생성 (하위 클래스에서 구현 필수)
     */
    abstract protected function generateResponse(
        array $persona,
        array $analysis,
        string $message
    ): array;

    /**
     * 기본 페르소나 반환 (하위 클래스에서 구현 필수)
     */
    abstract protected function getDefaultPersona(): array;
}
```

---

## 5. Agent16 구현 상세

### 5.1 세계관 정의

```php
class Agent16PersonaEngine extends AbstractPersonaEngine {
    private $worldviews = [
        'curriculum' => [
            'id' => 'curriculum',
            'name_ko' => '커리큘럼',
            'name_en' => 'Curriculum',
            'description' => '체계적인 학습 과정 기반의 세계관',
            'triggers' => ['정규과정', '단원', '학기', '교과서'],
            'priority' => 1
        ],
        // ... 나머지 8개 세계관
    ];
}
```

### 5.2 페르소나 정의

```php
private $personas = [
    'A16_P1' => [
        'persona_id' => 'A16_P1',
        'persona_name' => '체계적 가이드',
        'worldview' => 'curriculum',
        'tone' => 'Professional',
        'intervention' => 'GuidedDiscovery',
        'priority' => 1
    ],
    // ... 나머지 8개 페르소나
];
```

### 5.3 메시지 분석 확장

```php
protected function analyzeMessage(
    array $context,
    string $message
): array {
    // 부모 클래스 기본 분석
    $analysis = parent::analyzeMessage($context, $message);

    // Agent16 전용 분석 추가
    $analysis['detected_worldview'] = $this->detectWorldview($message);
    $analysis['worldview_confidence'] = $this->calculateWorldviewConfidence(
        $message,
        $analysis['detected_worldview']
    );
    $analysis['situation_group'] = $this->detectSituationGroup(
        $message,
        $context
    );
    $analysis['learning_stage'] = $this->detectLearningStage(
        $message,
        $context
    );

    return $analysis;
}
```

---

## 6. 새 에이전트 엔진 만들기

### 6.1 기본 템플릿

```php
<?php
/**
 * AgentXXPersonaEngine - Agent XX 전용 페르소나 엔진
 */

require_once(__DIR__ . '/../../../../ontology_engineering/persona_engine/core/AbstractPersonaEngine.php');

class AgentXXPersonaEngine extends AbstractPersonaEngine {

    private $worldviews = [];
    private $personas = [];

    public function __construct(string $agentId, array $config = []) {
        parent::__construct($agentId, $config);
        $this->initializeWorldviews();
        $this->initializePersonas();
    }

    private function initializeWorldviews(): void {
        $this->worldviews = [
            // 에이전트별 세계관 정의
        ];
    }

    private function initializePersonas(): void {
        $this->personas = [
            // 에이전트별 페르소나 정의
        ];
    }

    protected function generateResponse(
        array $persona,
        array $analysis,
        string $message
    ): array {
        // 에이전트별 응답 생성 로직
        return [
            'text' => '응답 텍스트',
            'suggestions' => [],
            'actions' => []
        ];
    }

    protected function getDefaultPersona(): array {
        return $this->personas['AXX_P1'] ?? [
            'persona_id' => 'AXX_P1',
            'persona_name' => '기본 페르소나',
            'tone' => 'Neutral'
        ];
    }

    public function getWorldview(string $worldviewId): ?array {
        return $this->worldviews[$worldviewId] ?? null;
    }

    public function getWorldviews(): array {
        return $this->worldviews;
    }

    public function selectPersonaByWorldview(string $worldviewId): array {
        // 세계관-페르소나 매핑 로직
        foreach ($this->personas as $persona) {
            if ($persona['worldview'] === $worldviewId) {
                return $persona;
            }
        }
        return $this->getDefaultPersona();
    }
}
```

---

## 7. 주요 확장 포인트

### 7.1 세계관 감지 커스터마이징

```php
/**
 * 복합 조건 세계관 감지
 */
protected function detectWorldview(string $message): ?string {
    // 1. 기본 키워드 매칭
    $detected = $this->basicKeywordMatch($message);

    // 2. 복합 패턴 매칭
    if (!$detected) {
        $detected = $this->compoundPatternMatch($message);
    }

    // 3. 맥락 기반 추론
    if (!$detected) {
        $detected = $this->contextBasedInference($message);
    }

    return $detected;
}
```

### 7.2 상황 그룹 확장

```php
/**
 * 커스텀 상황 그룹 감지
 */
private function detectSituationGroup(
    string $message,
    array $context
): string {
    // 시간 기반 상황
    $hour = (int)date('H');
    if ($hour >= 22 || $hour < 6) {
        return 'S_LATE_NIGHT';  // 커스텀 상황
    }

    // 성적 기반 상황
    if (isset($context['recent_score']) && $context['recent_score'] < 60) {
        return 'S4';  // 취약점 기반
    }

    // 기본 상황
    return 'S0';
}
```

### 7.3 응답 생성 확장

```php
protected function generateResponse(
    array $persona,
    array $analysis,
    string $message
): array {
    $tone = $persona['tone'] ?? 'Neutral';
    $intervention = $persona['intervention'] ?? 'DirectGuidance';

    // 톤별 응답 스타일 적용
    $responseStyle = $this->getToneStyle($tone);

    // 개입 전략별 응답 구조
    $responseStructure = $this->getInterventionStructure($intervention);

    // 최종 응답 조합
    return [
        'text' => $this->composeResponse(
            $message,
            $responseStyle,
            $responseStructure
        ),
        'suggestions' => $this->generateSuggestions($analysis),
        'actions' => $this->generateActions($analysis),
        'tone_applied' => $tone,
        'intervention_applied' => $intervention
    ];
}
```

---

## 8. 규칙 엔진 연동

### 8.1 규칙 로드

```php
public function loadRules(): bool {
    $rulesPath = $this->config['rules_path']
        ?? __DIR__ . '/../../rules/rules.yaml';

    if (!file_exists($rulesPath)) {
        $this->logError("Rules file not found: $rulesPath");
        return false;
    }

    try {
        $content = file_get_contents($rulesPath);
        $this->rules = yaml_parse($content);
        return true;
    } catch (Exception $e) {
        $this->logError("Rules parse error: " . $e->getMessage());
        return false;
    }
}
```

### 8.2 규칙 적용

```php
private function applyRules(array $analysis): array {
    $actions = [];

    foreach ($this->rules as $rule) {
        if ($this->evaluateConditions($rule['conditions'], $analysis)) {
            $actions = array_merge($actions, $rule['actions'] ?? []);
        }
    }

    return $actions;
}
```

---

## 9. 상태 관리 연동

### 9.1 AgentStateSync 사용

```php
private function updateUserState(
    int $userId,
    array $persona,
    array $analysis
): bool {
    require_once(__DIR__ . '/../../../../ontology_engineering/persona_engine/communication/AgentStateSync.php');

    $stateSync = new AgentStateSync($this->db);

    return $stateSync->updateState(
        16,  // agent_id
        $userId,
        [
            'persona_id' => $persona['persona_id'],
            'context_data' => [
                'worldview' => $analysis['detected_worldview'],
                'worldview_confidence' => $analysis['worldview_confidence'],
                'situation_group' => $analysis['situation_group']
            ]
        ]
    );
}
```

---

## 10. 디버그 및 테스트

### 10.1 디버그 정보

```php
public function getDebugInfo(): array {
    return [
        'agent_id' => $this->agentId,
        'rules_loaded' => !empty($this->rules),
        'rules_count' => count($this->rules),
        'worldviews_count' => count($this->worldviews),
        'personas_count' => count($this->personas),
        'debug_mode' => $this->debugMode,
        'config' => $this->config
    ];
}
```

### 10.2 단위 테스트 예시

```php
class Agent16PersonaEngineTest {
    public function testWorldviewDetection() {
        $engine = new Agent16PersonaEngine('agent16');

        // 시험대비 세계관 감지 테스트
        $reflection = new ReflectionClass($engine);
        $method = $reflection->getMethod('detectWorldview');
        $method->setAccessible(true);

        $result = $method->invoke($engine, '시험 준비 도와줘');
        assert($result === 'exam_prep', 'Expected exam_prep worldview');
    }
}
```

---

## 11. 성능 최적화

### 11.1 캐싱 전략

```php
private function getCachedAnalysis(string $cacheKey): ?array {
    if (!$this->config['cache_enabled']) {
        return null;
    }

    // 세션 기반 캐시
    if (isset($_SESSION['persona_cache'][$cacheKey])) {
        return $_SESSION['persona_cache'][$cacheKey];
    }

    return null;
}

private function setCachedAnalysis(string $cacheKey, array $analysis): void {
    if ($this->config['cache_enabled']) {
        $_SESSION['persona_cache'][$cacheKey] = $analysis;
    }
}
```

### 11.2 지연 로딩

```php
private function loadPersonasLazy(): void {
    if ($this->personasLoaded) {
        return;
    }

    // 페르소나 초기화
    $this->initializePersonas();
    $this->personasLoaded = true;
}
```

---

## 12. 에러 처리

### 12.1 에러 로깅

```php
protected function logError(string $message): void {
    error_log(sprintf(
        "[%s] %s:%d - %s",
        $this->agentId,
        __FILE__,
        debug_backtrace()[0]['line'] ?? 0,
        $message
    ));
}
```

### 12.2 안전한 실패

```php
public function process(
    int $userId,
    string $message,
    array $sessionData = []
): array {
    try {
        return $this->doProcess($userId, $message, $sessionData);
    } catch (Exception $e) {
        $this->logError($e->getMessage());

        // 기본 응답 반환 (서비스 중단 방지)
        return [
            'success' => false,
            'error' => '처리 중 오류가 발생했습니다',
            'persona' => $this->getDefaultPersona(),
            'response' => [
                'text' => '죄송합니다. 잠시 후 다시 시도해주세요.'
            ]
        ];
    }
}
```

---

*이 문서는 엔진 확장 및 커스터마이징 방법을 설명합니다.*
*관련: [00_시스템_개요.md](./00_시스템_개요.md), [05_규칙_작성_가이드.md](./05_규칙_작성_가이드.md)*
