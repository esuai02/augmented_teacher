# 통합 및 배포 가이드

## 1. 개요

이 가이드는 Agent16 페르소나 시스템의 통합 및 배포 절차를 설명합니다.
Moodle 환경에서의 설정과 다른 에이전트와의 연동 방법을 다룹니다.

---

## 2. 환경 요구사항

### 2.1 서버 사양

| 항목 | 요구사항 |
|------|----------|
| PHP | 7.1.9 이상 |
| MySQL | 5.7 이상 |
| Moodle | 3.7 이상 |
| 메모리 | 256MB 이상 |

### 2.2 PHP 확장

```php
// 필수 확장
- json
- mbstring
- mysqli

// 선택 확장 (규칙 파일용)
- yaml (yaml_parse 함수 사용)
```

### 2.3 파일 권한

```bash
# 읽기 권한 필요
chmod 644 persona_system/engine/*.php
chmod 644 persona_system/api/*.php
chmod 644 persona_system/personas/*.md
chmod 644 persona_system/personas/*.jsonld
chmod 644 rules/rules.yaml

# 로그 디렉토리 (선택)
chmod 755 logs/
chmod 666 logs/*.log
```

---

## 3. 설치 절차

### 3.1 파일 배포

```bash
# 1. 파일 복사
scp -r persona_system/ server:/path/to/agents/agent16_interaction_preparation/

# 2. 소유권 설정
chown -R www-data:www-data persona_system/

# 3. 권한 설정
find persona_system/ -type f -exec chmod 644 {} \;
find persona_system/ -type d -exec chmod 755 {} \;
```

### 3.2 데이터베이스 설정

```php
<?php
/**
 * DB 설정 스크립트
 * 실행: php setup_database.php
 */

include_once("/home/moodle/public_html/moodle/config.php");
global $DB;

// 테이블 생성 SQL
$tables = [
    'at_agent_persona_state' => "
        CREATE TABLE IF NOT EXISTS `at_agent_persona_state` (
            `id` bigint(20) NOT NULL AUTO_INCREMENT,
            `agent_id` int(11) NOT NULL,
            `user_id` bigint(20) NOT NULL,
            `persona_id` varchar(20) NOT NULL,
            `context_data` text,
            `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
            `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            `last_interaction` datetime DEFAULT NULL,
            PRIMARY KEY (`id`),
            UNIQUE KEY `uk_agent_user` (`agent_id`, `user_id`),
            KEY `idx_user_id` (`user_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
    ",
    'at_agent_persona_history' => "
        CREATE TABLE IF NOT EXISTS `at_agent_persona_history` (
            `id` bigint(20) NOT NULL AUTO_INCREMENT,
            `agent_id` int(11) NOT NULL,
            `user_id` bigint(20) NOT NULL,
            `from_persona` varchar(20) DEFAULT NULL,
            `to_persona` varchar(20) NOT NULL,
            `trigger_message` text,
            `trigger_worldview` varchar(50) DEFAULT NULL,
            `confidence` decimal(3,2) DEFAULT NULL,
            `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            KEY `idx_agent_user` (`agent_id`, `user_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
    "
];

foreach ($tables as $name => $sql) {
    try {
        $DB->execute($sql);
        echo "✅ {$name} 테이블 생성 완료\n";
    } catch (Exception $e) {
        echo "❌ {$name} 테이블 생성 실패: " . $e->getMessage() . "\n";
    }
}

echo "\n설정 완료!\n";
```

### 3.3 설정 확인

```php
<?php
/**
 * 설치 확인 스크립트
 * 실행: php verify_installation.php
 */

include_once("/home/moodle/public_html/moodle/config.php");
global $DB;

$checks = [];

// 1. PHP 버전 확인
$checks['PHP 버전'] = version_compare(PHP_VERSION, '7.1.9', '>=')
    ? '✅ ' . PHP_VERSION
    : '❌ ' . PHP_VERSION . ' (7.1.9 이상 필요)';

// 2. 필수 확장 확인
$extensions = ['json', 'mbstring', 'mysqli'];
foreach ($extensions as $ext) {
    $checks["확장: {$ext}"] = extension_loaded($ext) ? '✅' : '❌';
}

// 3. 테이블 확인
$tables = ['at_agent_persona_state', 'at_agent_persona_history'];
foreach ($tables as $table) {
    try {
        $DB->get_record_sql("SELECT 1 FROM {{$table}} LIMIT 1");
        $checks["테이블: {$table}"] = '✅';
    } catch (Exception $e) {
        $checks["테이블: {$table}"] = '❌ 없음';
    }
}

// 4. 파일 확인
$files = [
    'engine/Agent16PersonaEngine.php',
    'api/chat.php',
    'personas/personas.md',
    'personas/ontology.jsonld'
];
foreach ($files as $file) {
    $path = __DIR__ . '/' . $file;
    $checks["파일: {$file}"] = file_exists($path) ? '✅' : '❌';
}

// 결과 출력
echo "=== Agent16 설치 확인 ===\n\n";
foreach ($checks as $item => $status) {
    echo "{$item}: {$status}\n";
}
```

---

## 4. Moodle 통합

### 4.1 인증 연동

```php
// 모든 API 파일 상단에 포함
include_once("/home/moodle/public_html/moodle/config.php");
global $DB, $USER;
require_login();

// 사용자 정보 접근
$userId = $USER->id;
$userName = fullname($USER);
$userEmail = $USER->email;
```

### 4.2 역할 기반 접근 제어

```php
// 사용자 역할 조회
$userRole = $DB->get_record_sql(
    "SELECT data FROM mdl_user_info_data
     WHERE userid = ? AND fieldid = '22'",
    [$USER->id]
);
$role = $userRole ? $userRole->data : 'student';

// 역할별 기능 제한
switch ($role) {
    case 'admin':
        // 모든 기능 허용
        break;
    case 'teacher':
        // 학생 이력 조회 허용
        break;
    case 'student':
    default:
        // 본인 데이터만 접근
        break;
}
```

### 4.3 코스 컨텍스트

```php
// 코스 정보 전달
$sessionData = [
    'course_id' => $courseId,
    'section_id' => $sectionId,
    'activity_id' => $activityId
];

$result = $engine->process($userId, $message, $sessionData);
```

---

## 5. 다른 에이전트와의 연동

### 5.1 에이전트 통신 구조

```
Agent16 (상호작용 준비)
    │
    ├── Agent01 (Main Orchestrator)
    │       ↑ 페르소나 상태 공유
    │
    ├── Agent17 (Adaptation)
    │       ↑ 학습 스타일 정보 전달
    │
    └── Agent18 (Learning Support)
            ↑ 세계관 컨텍스트 공유
```

### 5.2 메시지 전송

```php
require_once(__DIR__ . '/../../../../ontology_engineering/persona_engine/communication/AgentMessenger.php');

$messenger = new AgentMessenger($DB);

// Agent01에 페르소나 변경 알림
$messenger->send(
    16,  // from: Agent16
    1,   // to: Agent01
    $userId,
    'persona_change',
    [
        'new_persona' => 'A16_P3',
        'worldview' => 'exam_prep',
        'confidence' => 0.85
    ]
);
```

### 5.3 메시지 수신 및 처리

```php
// 대기 중인 메시지 조회
$messages = $messenger->receive(16, $userId, 'pending');

foreach ($messages as $msg) {
    $payload = json_decode($msg->payload, true);

    switch ($msg->message_type) {
        case 'request_context':
            // 컨텍스트 요청 처리
            $this->respondWithContext($msg);
            break;

        case 'update_state':
            // 상태 업데이트 처리
            $this->handleStateUpdate($payload);
            break;
    }

    // 메시지 처리 완료 표시
    $messenger->markProcessed($msg->id);
}
```

---

## 6. API 엔드포인트 설정

### 6.1 URL 구조

```
베이스: https://mathking.kr/moodle/local/augmented_teacher/alt42/orchestration/

Agent16 API:
agents/agent16_interaction_preparation/persona_system/api/chat.php
```

### 6.2 Apache 설정 (필요시)

```apache
# .htaccess
<IfModule mod_rewrite.c>
    RewriteEngine On

    # API 요청 라우팅
    RewriteRule ^api/agent16/(.*)$ agents/agent16_interaction_preparation/persona_system/api/$1.php [L,QSA]
</IfModule>

# CORS 설정
<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type"
</IfModule>
```

### 6.3 Nginx 설정 (필요시)

```nginx
location /moodle/local/augmented_teacher/alt42/orchestration/agents/agent16_interaction_preparation/persona_system/api/ {
    try_files $uri $uri/ =404;

    # CORS
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";

    # PHP 처리
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

---

## 7. 모니터링

### 7.1 로그 설정

```php
// 에러 로깅
error_log(sprintf(
    "[Agent16] %s:%d - %s",
    __FILE__,
    __LINE__,
    $errorMessage
));

// 커스텀 로그 파일 (선택)
$logFile = __DIR__ . '/../../logs/agent16.log';
file_put_contents($logFile, date('c') . " - $message\n", FILE_APPEND);
```

### 7.2 상태 모니터링

```php
<?php
/**
 * 상태 모니터링 스크립트
 */

include_once("/home/moodle/public_html/moodle/config.php");
global $DB;

// 활성 사용자 수
$activeUsers = $DB->count_records_sql(
    "SELECT COUNT(DISTINCT user_id) FROM {at_agent_persona_state}
     WHERE agent_id = 16
     AND updated_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)"
);

// 페르소나별 사용 현황
$personaUsage = $DB->get_records_sql(
    "SELECT persona_id, COUNT(*) as count
     FROM {at_agent_persona_state}
     WHERE agent_id = 16
     GROUP BY persona_id"
);

// 최근 에러 (error_log에서)
// tail -n 100 /var/log/apache2/error.log | grep Agent16

echo json_encode([
    'active_users' => $activeUsers,
    'persona_usage' => $personaUsage,
    'timestamp' => date('c')
]);
```

### 7.3 헬스 체크 엔드포인트

```php
<?php
/**
 * 헬스 체크 API
 * GET /api/chat.php?action=health
 */

function healthCheck(): void {
    global $DB;

    $status = [
        'status' => 'healthy',
        'checks' => []
    ];

    // DB 연결 확인
    try {
        $DB->get_record_sql("SELECT 1");
        $status['checks']['database'] = 'ok';
    } catch (Exception $e) {
        $status['status'] = 'unhealthy';
        $status['checks']['database'] = 'failed';
    }

    // 엔진 로드 확인
    try {
        require_once(__DIR__ . '/../engine/Agent16PersonaEngine.php');
        $engine = new Agent16PersonaEngine('agent16');
        $status['checks']['engine'] = 'ok';
    } catch (Exception $e) {
        $status['status'] = 'unhealthy';
        $status['checks']['engine'] = 'failed';
    }

    http_response_code($status['status'] === 'healthy' ? 200 : 503);
    echo json_encode($status);
}
```

---

## 8. 문제 해결

### 8.1 일반적인 문제

**문제**: 401 Unauthorized
```
원인: Moodle 세션 만료
해결: 재로그인 또는 세션 쿠키 확인
```

**문제**: 500 Internal Server Error
```
원인: PHP 에러 또는 DB 연결 실패
해결:
1. error_log 확인
2. DB 연결 테스트
3. 파일 권한 확인
```

**문제**: 빈 응답
```
원인: JSON 인코딩 실패
해결:
1. UTF-8 인코딩 확인
2. 데이터에 특수문자 확인
3. output buffering 확인
```

### 8.2 디버그 모드

```php
// API 요청에 debug=true 추가
{
  "message": "테스트 메시지",
  "debug": true
}

// 또는 GET 파라미터
?action=status&debug=true
```

### 8.3 로그 분석

```bash
# Apache 에러 로그
tail -f /var/log/apache2/error.log | grep Agent16

# Moodle 로그
tail -f /path/to/moodledata/logs/*.log

# 커스텀 로그
tail -f /path/to/agents/agent16_interaction_preparation/logs/agent16.log
```

---

## 9. 업데이트 절차

### 9.1 버전 업데이트

```bash
# 1. 백업
cp -r persona_system/ persona_system_backup_$(date +%Y%m%d)/

# 2. 새 파일 배포
scp -r new_version/* server:/path/to/persona_system/

# 3. 권한 재설정
chown -R www-data:www-data persona_system/

# 4. 캐시 클리어 (필요시)
php clear_cache.php

# 5. 테스트
curl -X POST '.../api/chat.php' -d '{"message":"테스트"}'
```

### 9.2 DB 마이그레이션

```php
// 마이그레이션 스크립트 예시
$migrations = [
    '1.0.1' => "ALTER TABLE at_agent_persona_state ADD COLUMN version VARCHAR(10)",
    '1.0.2' => "CREATE INDEX idx_version ON at_agent_persona_state(version)"
];

foreach ($migrations as $version => $sql) {
    try {
        $DB->execute($sql);
        echo "마이그레이션 {$version} 완료\n";
    } catch (Exception $e) {
        echo "마이그레이션 {$version} 실패: " . $e->getMessage() . "\n";
    }
}
```

### 9.3 롤백 절차

```bash
# 파일 롤백
mv persona_system/ persona_system_failed/
mv persona_system_backup_YYYYMMDD/ persona_system/

# DB 롤백 (백업에서)
mysql -u user -p database < backup_YYYYMMDD.sql
```

---

## 10. 보안 고려사항

### 10.1 입력 검증

```php
// 모든 사용자 입력 검증
$message = trim($input['message'] ?? '');
if (empty($message) || mb_strlen($message) > 2000) {
    sendResponse(false, [], '유효하지 않은 메시지', 400);
}
```

### 10.2 SQL 인젝션 방지

```php
// Moodle DB API 사용 (파라미터 바인딩)
$DB->get_record_sql(
    "SELECT * FROM {at_agent_persona_state} WHERE user_id = ?",
    [$userId]  // 파라미터 바인딩
);
```

### 10.3 XSS 방지

```php
// 출력 이스케이프
$safeOutput = htmlspecialchars($userInput, ENT_QUOTES, 'UTF-8');

// JSON 응답 (자동 이스케이프)
echo json_encode($data, JSON_UNESCAPED_UNICODE);
```

---

## 11. 체크리스트

### 11.1 배포 전 체크리스트

- [ ] PHP 버전 확인 (7.1.9+)
- [ ] MySQL 버전 확인 (5.7+)
- [ ] 필수 확장 설치 확인
- [ ] DB 테이블 생성 완료
- [ ] 파일 권한 설정 완료
- [ ] Moodle 연동 테스트 완료
- [ ] API 엔드포인트 접근 테스트
- [ ] 에러 로깅 동작 확인

### 11.2 배포 후 체크리스트

- [ ] 헬스 체크 통과
- [ ] 채팅 API 정상 동작
- [ ] 세계관 감지 정상 동작
- [ ] 페르소나 선택 정상 동작
- [ ] 상태 저장/조회 정상
- [ ] 에러 로그 확인 (에러 없음)

---

*이 문서는 통합 및 배포 절차를 설명합니다.*
*관련: [00_시스템_개요.md](./00_시스템_개요.md), [06_DB_스키마_가이드.md](./06_DB_스키마_가이드.md)*
