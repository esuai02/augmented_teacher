<?php
/**
 * Agent 22 - Module Improvement Data Provider
 * File: agent22_module_improvement/rules/data_access.php
 * 
 * ?°ì´???ŒìŠ¤:
 * - ?ì´?„íŠ¸ ?¤í–‰ ë¡œê·¸: ê°??ì´?„íŠ¸???¤í–‰ ê¸°ë¡ (?´ë? ë¡œê¹… ?œìŠ¤??
 * - ë£??Œì¼ (agent{ë²ˆí˜¸}_{?´ë”ëª?_rules.yaml): Agent 01 ~ Agent 22??ë£??Œì¼ (agent01_onboarding_rules.yaml, agent02_exam_schedule_rules.yaml ??
 * 
 * ì°¸ê³ : ???ì´?„íŠ¸???œìŠ¤???±ëŠ¥ ê°œì„ ???„í•œ ë¶„ì„ ?ì´?„íŠ¸ë¡?
 * ì£¼ë¡œ ?¤í–‰ ë¡œê·¸?€ ë£??Œì¼??ë¶„ì„?˜ë?ë¡?ì§ì ‘?ì¸ ?°ì´?°ë² ?´ìŠ¤ ?Œì´ë¸?ì°¸ì¡°???œí•œ?ìž…?ˆë‹¤.
 * 
 * TODO: ?¤ìŒ ?°ì´???ŒìŠ¤ê°€ ?„ìš”?©ë‹ˆ??
 * - ?ì´?„íŠ¸ ?¤í–‰ ?°ì´?? ê°??ì´?„íŠ¸???¤í–‰ ?œê°, ?Œìš” ?œê°„, ?íƒœ, ?…ì¶œ???°ì´?? ?ëŸ¬ ë¡œê·¸, ?±ëŠ¥ ë©”íŠ¸ë¦??€?¥ì†Œ ?„ìš”
 * - ë¶„ì„ ê²°ê³¼ ?°ì´?? ê°??ì´?„íŠ¸ê°€ ?ì„±??ë¶„ì„ ?´ìš©, ê²°ê³¼ ?¼ê??? ?•í™•??ê²€ì¦??°ì´???€?¥ì†Œ ?„ìš”
 * - ?™ìƒ ?íƒœ ?°ì´?? ?¤ì œ ?™ìƒ ?íƒœ, ?ˆì¸¡ vs ?¤ì œ ë¹„êµ, ?™ìƒ ë°˜ì‘ ë°??±ê³¼ ?°ì´???€?¥ì†Œ ?„ìš”
 * - ?œìŠ¤??ë©”íŠ¸ë¦? ?„ì²´ ?œìŠ¤???±ëŠ¥, ?ì´?„íŠ¸ ê°??µì‹  ?¨ìœ¨?? ë¦¬ì†Œ???¬ìš© ?¨í„´ ?€?¥ì†Œ ?„ìš”
 * - ?Œí¬?Œë¡œ???¤í–‰ ë¡œê·¸: ?„ì²´ ?Œí¬?Œë¡œ???¤í–‰ ê¸°ë¡ ë°??±ëŠ¥ ?°ì´???€?¥ì†Œ ?„ìš”
 */

include_once("/home/moodle/public_html/moodle/config.php");
global $DB, $USER;
require_login();

function getModuleImprovementContext($studentid) {
    global $DB;
    
    $context = [
        'student_id' => $studentid,
        'improvement_ideas' => [],
        'issue_list' => [],
        'performance_metrics' => []
    ];
    
    try {
        // ?™ìƒ ê¸°ë³¸ ?•ë³´ ?•ì¸
        $student = $DB->get_record('user', ['id' => $studentid], 'id, firstname, lastname', MUST_EXIST);
        
        // TODO: ?ì´?„íŠ¸ ?¤í–‰ ?°ì´?? ë¶„ì„ ê²°ê³¼ ?°ì´?? ?œìŠ¤??ë©”íŠ¸ë¦????˜ì§‘ ë¡œì§ êµ¬í˜„ ?„ìš”
        // ?„ìž¬??ê¸°ë³¸ êµ¬ì¡°ë§??œê³µ?˜ë©°, ?¤ì œ ?°ì´???˜ì§‘?€ ë¡œê¹… ?œìŠ¤??êµ¬ì¶• ??êµ¬í˜„ ?„ìš”
        
    } catch (Exception $e) {
        error_log("Error in getModuleImprovementContext: " . $e->getMessage() . " [File: " . __FILE__ . ", Line: " . __LINE__ . "]");
    }
    
    return $context;
}

function prepareRuleContext($studentid) {
    $context = getModuleImprovementContext($studentid);
    $context['timestamp'] = date('Y-m-d\TH:i:s\Z');
    return $context;
}
