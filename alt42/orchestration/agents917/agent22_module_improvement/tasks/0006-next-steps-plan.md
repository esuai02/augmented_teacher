# 다음 단계 작업 계획

**생성일**: 2025-01-27  
**목적**: 온톨로지 기반 에이전트 시스템 완전 동작을 위한 단계별 계획  
**현재 상태**: API 통합 완료, 룰 매칭 문제 발견

---

## 📋 현재 상태 요약

### ✅ 완료된 작업
1. **범용 온톨로지 엔진 구현**
   - `UniversalOntologyEngine.php` 생성
   - `OntologyActionHandler.php` 범용화
   - `OntologyConfig.php` 설정 관리
   - `OntologyFileLoader.php` 파일 로더

2. **에이전트 가든 통합**
   - `agent_garden.service.php`에 `processOntologyActions` 메서드 추가
   - Agent01, Agent04 온톨로지 액션 처리 로직 구현

3. **테스트 인프라 구축**
   - `test_ontology_api.php` (GET 방식)
   - `test_ontology_post.php` (POST 방식)
   - 브라우저 테스트 완료

### ⚠️ 발견된 문제
1. **룰 매칭 문제**: Q1 룰(온톨로지 액션 포함)이 S0_R6 룰에 가로막혀 매칭되지 않음
2. **온톨로지 액션 미실행**: 실제 온톨로지 인스턴스 생성 및 추론 동작 확인 불가

---

## 🎯 다음 단계 작업 계획

### Phase 1: 룰 매칭 문제 해결 (우선순위: 높음)

#### 작업 1.1: 룰 우선순위 및 조건 분석
**목표**: 룰 엔진의 매칭 로직 정확히 이해

**작업 내용**:
- [ ] `onboarding_rule_engine.py`의 룰 매칭 로직 상세 분석
- [ ] Priority 정렬 후 조건 확인 순서 확인
- [ ] Q1 룰이 매칭되지 않는 정확한 원인 파악

**예상 시간**: 1-2시간  
**담당**: 개발자

#### 작업 1.2: 룰 조건 수정
**목표**: Q1 룰이 올바르게 매칭되도록 수정

**방안 A: S0_R6 룰에 제외 조건 추가**
```yaml
- rule_id: "S0_R6_comprehensive_math_profile_verification"
  priority: 99
  conditions:
    - NOT:
        - field: "user_message"
          operator: "contains"
          value: "첫 수업"
    - OR:
        - field: "math_learning_style"
          operator: "=="
          value: null
        # ... 기존 조건들
```

**방안 B: Q1 룰 우선순위 상향**
```yaml
- rule_id: "Q1_comprehensive_first_class_strategy"
  priority: 150  # S0_R6(99)보다 훨씬 높게
  # ... 기존 조건들
```

**작업 내용**:
- [ ] 방안 A 또는 B 선택 (또는 둘 다 적용)
- [ ] `rules.yaml` 파일 수정
- [ ] 수정 사항 문서화

**예상 시간**: 30분-1시간  
**담당**: 개발자

#### 작업 1.3: 룰 매칭 테스트
**목표**: 수정된 룰이 올바르게 매칭되는지 확인

**작업 내용**:
- [ ] "첫 수업을 어떻게 시작해야 할지 알려주세요" 요청 테스트
- [ ] Q1 룰 매칭 확인
- [ ] 온톨로지 액션 실행 확인

**예상 시간**: 30분  
**담당**: 개발자

---

### Phase 2: 온톨로지 액션 실행 검증 (우선순위: 높음)

#### 작업 2.1: create_instance 액션 테스트
**목표**: 온톨로지 인스턴스 생성이 정상 동작하는지 확인

**테스트 케이스**:
- [ ] `create_instance: 'mk:OnboardingContext'` 실행 확인
- [ ] `create_instance: 'mk:LearningContextIntegration'` 실행 확인
- [ ] DB에 인스턴스 저장 확인 (`alt42_ontology_instances` 테이블)
- [ ] JSON-LD 형식 검증

**작업 내용**:
- [ ] 테스트 요청 실행
- [ ] 응답에서 `ontology_results` 확인
- [ ] DB 쿼리로 인스턴스 생성 확인
- [ ] 에러 로그 확인

**예상 시간**: 1-2시간  
**담당**: 개발자

#### 작업 2.2: reason_over 액션 테스트
**목표**: 온톨로지 추론이 정상 동작하는지 확인

**테스트 케이스**:
- [ ] `reason_over: 'mk:LearningContextIntegration'` 실행 확인
- [ ] 추론 결과 반환 확인
- [ ] 단원 추천 로직 동작 확인
- [ ] 난이도 추론 동작 확인

**작업 내용**:
- [ ] 추론 실행 후 결과 확인
- [ ] 추론 로직 코드 검토
- [ ] 예상 결과와 실제 결과 비교

**예상 시간**: 1-2시간  
**담당**: 개발자

#### 작업 2.3: generate_strategy 액션 테스트
**목표**: 전략 생성이 정상 동작하는지 확인

**테스트 케이스**:
- [ ] `generate_strategy: 'mk:FirstClassStrategy'` 실행 확인
- [ ] 전략 객체 생성 확인
- [ ] 전략 프로퍼티 설정 확인

**작업 내용**:
- [ ] 전략 생성 후 결과 확인
- [ ] 전략 객체 구조 검증
- [ ] DB 저장 확인

**예상 시간**: 1시간  
**담당**: 개발자

#### 작업 2.4: generate_procedure 액션 테스트
**목표**: 절차 생성이 정상 동작하는지 확인

**테스트 케이스**:
- [ ] `generate_procedure: 'mk:LessonProcedure'` 실행 확인
- [ ] 절차 단계 생성 확인
- [ ] 절차 객체 구조 검증

**작업 내용**:
- [ ] 절차 생성 후 결과 확인
- [ ] 절차 단계 배열 검증
- [ ] DB 저장 확인

**예상 시간**: 1시간  
**담당**: 개발자

---

### Phase 3: 다른 에이전트 통합 테스트 (우선순위: 중간)

#### 작업 3.1: Agent04 온톨로지 테스트
**목표**: Agent04의 온톨로지 액션이 정상 동작하는지 확인

**테스트 케이스**:
- [ ] Agent04 실행 테스트
- [ ] `create_instance: 'mk-a04:WeakpointDetectionContext'` 확인
- [ ] `reason_over: 'mk-a04:ActivityAnalysisContext'` 확인
- [ ] `generate_reinforcement_plan` 확인

**작업 내용**:
- [ ] Agent04 테스트 요청 생성
- [ ] 온톨로지 액션 실행 확인
- [ ] 결과 검증

**예상 시간**: 1-2시간  
**담당**: 개발자

#### 작업 3.2: 다른 에이전트 온톨로지 파일 확인
**목표**: 다른 에이전트들의 온톨로지 파일 존재 여부 및 통합 가능성 확인

**작업 내용**:
- [ ] 각 에이전트별 `.owl` 파일 존재 확인
- [ ] `OntologyConfig.php`에 설정 추가 필요 여부 확인
- [ ] 통합 우선순위 결정

**예상 시간**: 1시간  
**담당**: 개발자

---

### Phase 4: 에러 처리 및 로깅 개선 (우선순위: 중간)

#### 작업 4.1: 에러 처리 강화
**목표**: 온톨로지 액션 실패 시 적절한 에러 처리

**작업 내용**:
- [ ] 온톨로지 액션 실패 시 fallback 로직 확인
- [ ] 에러 메시지 개선 (파일 경로, 라인 번호 포함)
- [ ] 사용자에게 표시할 에러 메시지 정리

**예상 시간**: 1-2시간  
**담당**: 개발자

#### 작업 4.2: 로깅 개선
**목표**: 디버깅을 위한 상세 로깅 추가

**작업 내용**:
- [ ] 온톨로지 액션 실행 전후 로그 추가
- [ ] 인스턴스 생성/조회 로그 추가
- [ ] 추론 과정 로그 추가
- [ ] 로그 레벨 구분 (DEBUG, INFO, ERROR)

**예상 시간**: 1시간  
**담당**: 개발자

---

### Phase 5: 문서화 및 최종 검증 (우선순위: 낮음)

#### 작업 5.1: 통합 문서 작성
**목표**: 온톨로지 통합 과정 및 사용법 문서화

**작업 내용**:
- [ ] 온톨로지 통합 가이드 작성
- [ ] API 사용법 문서 작성
- [ ] 트러블슈팅 가이드 작성

**예상 시간**: 2-3시간  
**담당**: 개발자

#### 작업 5.2: 최종 통합 테스트
**목표**: 전체 시스템이 정상 동작하는지 최종 확인

**작업 내용**:
- [ ] 모든 에이전트 통합 테스트
- [ ] 다양한 시나리오 테스트
- [ ] 성능 테스트 (선택사항)

**예상 시간**: 2-3시간  
**담당**: 개발자

---

## 📊 작업 우선순위 요약

| Phase | 작업 | 우선순위 | 예상 시간 | 상태 |
|-------|------|---------|----------|------|
| Phase 1 | 룰 매칭 문제 해결 | 🔴 높음 | 2-3시간 | ⏳ 대기 |
| Phase 2 | 온톨로지 액션 검증 | 🔴 높음 | 4-6시간 | ⏳ 대기 |
| Phase 3 | 다른 에이전트 테스트 | 🟡 중간 | 2-3시간 | ⏳ 대기 |
| Phase 4 | 에러 처리 개선 | 🟡 중간 | 2-3시간 | ⏳ 대기 |
| Phase 5 | 문서화 및 최종 검증 | 🟢 낮음 | 4-6시간 | ⏳ 대기 |

**총 예상 시간**: 14-21시간

---

## 🚀 즉시 시작 가능한 작업

### 우선 작업 (오늘)
1. ✅ **작업 1.1**: 룰 매칭 로직 분석
2. ✅ **작업 1.2**: 룰 조건 수정
3. ✅ **작업 1.3**: 룰 매칭 테스트

### 다음 작업 (내일)
4. ✅ **작업 2.1**: create_instance 액션 테스트
5. ✅ **작업 2.2**: reason_over 액션 테스트

---

## 📝 참고 사항

1. **룰 엔진 동작 방식**: Priority로 정렬 후 순차적으로 조건 확인
2. **온톨로지 액션 패턴**: `create_instance`, `reason_over`, `generate_strategy`, `generate_procedure`
3. **테스트 파일 위치**: `alt42/orchestration/agents/agent22_module_improvement/ui/test_ontology_*.php`
4. **에러 로그 확인**: 서버 에러 로그에서 `[AgentGardenService]`, `[OntologyActionHandler]` 태그 검색

---

## ✅ 체크리스트

### Phase 1 완료 조건
- [ ] Q1 룰이 "첫 수업" 관련 요청에 정상 매칭됨
- [ ] 온톨로지 액션이 실행됨 (로그 확인)
- [ ] `ontology_results`가 응답에 포함됨

### Phase 2 완료 조건
- [ ] 모든 온톨로지 액션 타입이 정상 동작함
- [ ] DB에 인스턴스가 정상 저장됨
- [ ] 추론 결과가 예상대로 반환됨

### 전체 완료 조건
- [ ] 모든 Phase 완료
- [ ] 문서화 완료
- [ ] 최종 테스트 통과

