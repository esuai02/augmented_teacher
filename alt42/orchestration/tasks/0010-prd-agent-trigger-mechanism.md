# PRD: Agent Trigger Mechanism (자동 트리거 시스템)

## Introduction/Overview

학생이 수학을 푸는 **실제 학습 흐름(정오답, 힌트, 멈춤, 이탈 징후, 세션 시작/종료)**을 이벤트로 수집하고, 이벤트를 규칙 기반으로 평가하여 **22개 에이전트를 자동 실행**하는 트리거 메커니즘을 구현합니다.

현재는 에이전트 구현은 상당 부분 진행되었지만, **트리거/실시간 연동(프론트 이벤트 → 백엔드 → 오케스트레이터)**이 부족해 자동 협업이 끊깁니다. 본 기능은 그 연결부를 “최소 침습”으로 제공하는 것이 목표입니다.

## Goals

1. 학생 학습 화면에서 발생하는 핵심 이벤트를 안정적으로 수집한다.
2. 이벤트를 규칙으로 평가해 **오답 시 Agent 11 자동 실행**을 최우선으로 구현한다.
3. 연속 오답(3/5회) 등 추가 트리거를 확장 가능하게 한다.
4. 트리거 실행 결과가 장애를 유발하지 않도록(실패 격리/버퍼링/중복 최소화) 설계한다.
5. 운영 환경(Moodle 3.7, PHP 7.1.9, MySQL 5.7)에서 적용 가능한 구조로 구현한다.

## User Stories

1. As a 학생, I want to 오답을 제출하면 바로 내 오답 유형이 분석되어 다음 행동(복습/힌트/설명)이 추천되도록 so that 막힘이 길어지지 않도록 합니다.
2. As a 학생, I want to 연속 오답이 누적되면 감정/이탈 위험이 감지되어 적절한 개입이 오도록 so that 포기하지 않고 다시 풀 수 있습니다.
3. As a 교사, I want to 중요한 학습 이벤트가 발생했을 때 시스템이 자동으로 분석을 수행하도록 so that 수동 확인 부담이 줄어듭니다.
4. As a 시스템 운영자, I want to 트리거 로직을 YAML 규칙으로 관리하도록 so that 코드 수정 없이 운영 규칙을 조정할 수 있습니다.

## Functional Requirements

### FR1: 프론트엔드 이벤트 수집
1.1 시스템은 학습 화면에서 학생 활동 이벤트를 수집해야 합니다. (오답, 연속 오답, 힌트 사용, 멈춤, 비활성 등)  
1.2 이벤트는 배치(버퍼) 전송이 기본이며, 우선순위가 높은 이벤트는 즉시 전송할 수 있어야 합니다.  
1.3 이벤트는 `student_id`, `content_id`, `analysis_id`, `session_id`, `timestamp`, `event_type`, `data`, `context`를 포함해야 합니다.

### FR2: 백엔드 이벤트 수집 API
2.1 시스템은 프론트엔드 이벤트를 수신하는 API 엔드포인트를 제공해야 합니다.  
2.2 API는 입력 검증 후, 이벤트를 Event Bus로 발행(publish)해야 합니다.  
2.3 API는 Trigger Engine으로 이벤트를 평가하고, 매칭된 트리거가 있으면 에이전트 실행을 요청해야 합니다.  

### FR3: Trigger Engine (규칙 평가)
3.1 시스템은 YAML 규칙 파일(`trigger_rules.yaml`)을 로드해 이벤트를 평가해야 합니다.  
3.2 최소 규칙으로 “오답 → Agent 11 실행”을 제공해야 합니다.  
3.3 확장 규칙으로 “연속 오답 3회 → Agent 05”, “연속 오답 5회 → Agent 13”을 제공해야 합니다.  

### FR4: 에이전트 실행
4.1 시스템은 `AgentOrchestrator`를 통해 단일 에이전트를 실행할 수 있어야 합니다.  
4.2 트리거 호출이 `AgentOrchestrator.php`의 웹 엔드포인트 출력/exit와 충돌하지 않도록, 라이브러리 형태로 안전하게 include 할 수 있어야 합니다.  

### FR5: 시간 기반 스케줄링
5.1 시스템은 cron 기반 스케줄러를 제공해야 합니다.  
5.2 스케줄러는 예시로 “매일 오전 8시 Agent 02”, “매시간 정각 Agent 09” 실행 흐름을 지원해야 합니다.  

### FR6: 운영 안정성
6.1 네트워크 오류 시 이벤트 전송 실패가 UI를 깨지 않도록 해야 합니다.  
6.2 오류 응답은 파일/라인 정보를 포함해야 합니다.  
6.3 트리거 시스템 도입으로 기존 학습 기능이 깨지지 않아야 합니다.

## Non-Goals (Out of Scope)

1. 이벤트 저장용 DB 테이블 신규 설계/마이그레이션(초기 버전에서는 필수 아님)
2. WebSocket 기반 실시간 양방향 푸시(초기 버전에서는 HTTP 전송으로 충분)
3. 교사용 운영 UI(대시보드) 확장

## Technical Considerations

- 서버 환경 제약: Moodle 3.7, PHP 7.1.9, MySQL 5.7  
- 파일/라우팅: Moodle 플러그인 경로 아래 PHP endpoint 사용  
- 규칙 관리: YAML 기반(`trigger_rules.yaml`), 단순 파서 + `yaml_parse_file`(가능 시) 폴백  

## Success Metrics

1. 오답 이벤트 수신 성공률 99% 이상(클라이언트 전송 실패 제외)
2. 오답 발생 후 Agent 11 트리거 요청까지 1초 이내(일반 네트워크 기준)
3. 트리거 기능 추가로 학습 UI 오류/중단이 발생하지 않을 것

## Open Questions

1. “오답” 판정의 단일 표준 이벤트는 어디에서 확정되는가? (퀴즈 제출 / 필기 분석 / 채점 API 등)
2. cron 실행 시 인증/권한 처리는 어떤 방식(전용 계정/토큰/CLI)으로 할 것인가?


