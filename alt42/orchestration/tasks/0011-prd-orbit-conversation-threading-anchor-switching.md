# PRD: 🌌 마이 궤도 — 스레드형 대화(Conversation ID) + 앵커 스위칭(ODE) + 선택적 학생 승인

## Introduction/Overview

이 PRD는 기존 `0007-prd-conversation-based-mentoring.md`를 기반으로, **“대화 기반 장기 멘토링”을 진짜 장기 스레드로 운영**하기 위해 다음을 확장한다:

- **대화 시작점 확장(C)**: 글로벌 멘토링(🌌 마이 궤도) 대화와, 특정 홀론(에이전트) 대화를 **둘 다** 지원
- **저장 단위 전환(B)**: 브라우저 세션(`session_id`)이 아니라, **지속되는 대화방 ID(`conversation_id`)** 중심으로 대화를 묶어 장기 추적
- **앵커 자동 스위칭(B)**: “선택지(3-choice)”뿐 아니라 **시스템 프롬프트/질문유형까지** 대화 진행도에 따라 자동 전환
- **승인 정책(B)**: 특정 민감/핵심 레이어(예: worldView, abstraction)는 **학생의 승인 후 확정**(그 외는 자동 저장 가능)
- **UI 분리(A)**: Standalone UI는 유지하고, `wxsperta.php`의 채팅 패널에서 **iframe 임베드**로 연결

핵심 철학은 변하지 않는다: **AI 시대, 학생이 ‘진짜 나’를 찾는 3년 여정**을 “억지 없이” 돕고, 대화는 문서가 아니라 **상태+흐름(동적지식)** 으로 축적된다.

## Goals

1. **장기 스레드**: 세션이 끊겨도 이어지는 `conversation_id` 기반의 대화 연속성 확보
2. **자연스러운 유도(ODE)**: 학생이 “감지 못할 정도로” 스스로 선택하게 만드는 3-choice 흐름 고정
3. **앵커 스위칭**: 대화 진행도(정서/단계/막힘/의지)에 따라 대화의 중심(앵커)이 자동 전환
4. **선택적 승인**: 핵심 정체성/원리 레이어는 학생 승인 후만 “확정 앵커”로 반영
5. **멀티 뷰(학생+멘토)**: 학생 UX는 단순/친근 유지, 멘토/교사는 상태·흐름을 점검 가능한 최소 뷰 제공
6. **리텐션(A)**: 주간 대화 지속(재방문/유지율)을 최우선 성공지표로 삼는다

## User Stories

1. **학생으로서**, 나는 “글로벌 멘토링”으로 편하게 시작하고, 필요하면 특정 에이전트로 이어가고 싶다.
2. **학생으로서**, 다음에 들어와도 대화가 이어져서 “내 여정”이 계속 쌓였으면 좋겠다.
3. **학생으로서**, 선택지가 강요처럼 느껴지지 않고 “내가 고르는 느낌”이었으면 좋겠다.
4. **학생으로서**, 내 가치관/원리 같은 핵심 내용은 내가 “확인(승인)”해야 반영됐으면 좋겠다.
5. **멘토/교사로서**, 학생의 현재 상태(정서/여정단계/다음 한 걸음)를 빠르게 보고 개입 여부만 판단하고 싶다.

## Functional Requirements

### FR1: Conversation Thread(대화방) 개념 도입
- 시스템은 `conversation_id`를 생성/관리해야 한다.
- `conversation_id`는 **세션과 독립적**이어야 하며, “장기 스레드”의 기본 키가 된다.
- 글로벌 멘토링도 `agent_key='global'` 같은 방식으로 동일 구조에서 지원해야 한다.

### FR2: 데이터 스키마(Conversation ID 중심)로 확장
- 시스템은 최소 다음 관계를 만족해야 한다:
  - `conversation`(대화방) 1개 : `message`(메시지) N개
  - `message` 1개 : `layer extraction`(WXSPERTA 레이어 추출) N개(또는 0개)
- 기존 `session_id`는 “접속/브라우저 세션” 메타로 남기되, 그룹 키는 `conversation_id`가 된다.

### FR3: 대화 시작점(C) — 글로벌/에이전트 둘 다
- `wxsperta.php`에서:
  - 글로벌 멘토링 열기(iframe로 Standalone UI의 글로벌 모드/대화방 선택)
  - 에이전트 “대화하기”(특정 agent_key로 Standalone UI 또는 API 호출)
- Standalone UI에서:
  - 글로벌 대화 진입/재개
  - 특정 에이전트 대화 진입/재개

### FR4: 앵커 자동 스위칭(B) — 선택지 + 프롬프트
- 시스템은 매 턴마다 다음 상태를 추론/업데이트해야 한다:
  - `emotion_state` (예: neutral/anxious/frustrated/bored/energized 등)
  - `conversation_phase` (6단계 여정)
  - `quantum_state` (superposition/collapse/observation/entanglement/tunneling)
  - `forcedness` (억지스러움 비용: 높을수록 강요로 느껴짐)
  - `anchor_layer` (W/X/S/P/E/R/T/A 중 “이번 턴의 중심”)
- `anchor_layer`에 따라:
  - (a) **3-choice 선택지 템플릿**이 바뀌고
  - (b) **시스템 프롬프트/질문유형**도 함께 바뀌어야 한다.
- 학생에게는 “최적화/관리/KPI” 같은 내부 목적함수 언어를 직접 노출하지 않는다(표현은 전환 규칙으로 학생 언어로만 나온다).

### FR5: ODE(Orbit Drift Engine) 3-Choice 정책
- 모든 턴에서 선택지는 기본적으로 **3개**를 제공한다.
- 선택지의 역할은 고정한다:
  - **지금(상태/감정/막힘 확인)** 1개
  - **다음 한 칸(5분/한 걸음 실행)** 1개
  - **탐험(확장/연결/새 가능성)** 1개
- 학생이 선택지 대신 자유 입력을 해도 흐름이 깨지지 않아야 한다.

### FR6: 학생 승인 정책(B) — 핵심 레이어만 “확정” 필요
- 시스템은 WXSPERTA 레이어 추출을 기본적으로 저장하되, 아래 레이어는 “확정 반영”을 위해 학생 승인이 필요하다:
  - `worldView`, `abstraction` (핵심 정체성/원리)
- 승인 전 상태는 “제안/초안”으로 남고, 승인 후에만 “앵커(Anchoring) 정보”로 승격된다.
- 학생에게는 승인 요청이 “시험/평가”처럼 느껴지지 않도록, **확인 질문** 형태로 제시한다.

### FR7: 멘토/교사 뷰(C) — 최소 상태 점검 UI
- 멘토/교사는 학생별로 다음을 볼 수 있어야 한다(최소):
  - 최근 대화방 목록(글로벌/에이전트)
  - 최근 상태(정서/여정단계/앵커/다음 한 걸음)
  - 미승인(확정 대기) 항목 개수
- 멘토 뷰는 학생의 자율성을 침해하지 않는 정보만 제공한다(내부 점수/목적함수 노출 금지).

### FR8: Standalone UI(A) + iframe 임베드 유지
- Standalone UI는 `alt42/studenthome/wxsperta/standalone_ui/`에 위치한다.
- Moodle 인증/DB는 그대로 사용(`require_login()`, same-origin 쿠키).
- `wxsperta.php`에서는 iframe으로 Standalone UI를 채팅 패널에 띄운다(현재 구조 유지).

## Non-Goals (Out of Scope)

1. **벡터 DB/임베딩 고도화**(대규모 의미검색) — 향후
2. **대규모 분석 대시보드**(그래프/리포트 자동 생성) — 향후
3. **멘토 개입 자동 알림/푸시 시스템** — 향후

## Design Considerations

### 학생 UX 원칙
- “문서”가 아니라 **상태+흐름**으로 보여준다:
  - 지금 상태(한 줄)
  - 근거(최근 대화에서 한 줄)
  - 다음 한 걸음(5분/한 칸)
- 내부 목적함수 언어는 표면에 나오지 않는다.
- 선택지는 “시스템 지시”가 아니라 “네가 고르는 길”처럼 보인다.

### 멘토/교사 UX 원칙
- 개입 판단에 필요한 최소 정보만 제공(정서 위험/지속 막힘/승인 대기).
- 학생의 자기주도성을 훼손하는 “정답 강요” UI는 제공하지 않는다.

## Technical Considerations

- 환경 제약: **Moodle 3.7 / PHP 7.1.9 / MySQL 5.7 / React 금지**
- 인증: Moodle 세션 기반(`require_login()`)
- API 에러 메시지: **파일 경로 + 라인 번호** 포함(JSON 에러에 포함)
- 데이터베이스:
  - 기존 `mdl_wxsperta_conversation_*` 테이블은 `conversation_id` 중심으로 확장/마이그레이션 필요
  - 승인(확정) 레이어 승격을 위한 저장 구조(예: `approved_anchor` 테이블 또는 `is_approved` 기반 최신 승인본 조회) 필요

## Success Metrics

1. **주간 리텐션(A)**: 주 1회 이상 대화하는 학생 비율(4주 이동평균)
2. **대화 지속성**: `conversation_id` 기반으로 2회 이상 재개되는 스레드 비율
3. **억지스러움 감소**: 대화 종료 직전 “불편/강요” 표현 빈도 감소(키워드 기반)

## Open Questions

1. `conversation_id`의 “대화방 목록/선택” UI는 학생에게 어디까지 노출할까? (최근 3개만 vs 전체)
2. `worldView/abstraction` 승인 UX는 “확인(맞아?)” 형태로 턴 중에 할지, 별도 “확정함” 패널로 할지?
3. 멘토/교사 뷰는 Standalone UI 내부 탭으로 할지, 별도 PHP 페이지로 할지?


