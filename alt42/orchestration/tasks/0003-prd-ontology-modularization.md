# PRD: 온톨로지 모듈화 및 증분 로딩 시스템

## Introduction/Overview

현재 `alphatutor_ontology.owl` 파일이 10,111줄로 매우 커서 다음과 같은 문제가 발생하고 있습니다:
- 메모리 사용량 증가 및 로딩 시간 지연
- IDE/에디터에서 편집 시 성능 저하
- 버전 관리 및 병렬 작업의 어려움
- 검증 시간 증가

이 기능은 온톨로지를 Agent별/기능별 모듈로 분할하고, `owl:imports`를 사용하여 통합하며, 필요한 모듈만 증분 로딩하는 시스템을 구축합니다.

**Problem Solved**: 대용량 단일 온톨로지 파일로 인한 성능 및 유지보수성 문제

**Goal**: 온톨로지를 모듈화하여 성능을 개선하고, 유지보수성과 확장성을 향상시키며, 개발자 생산성을 높입니다.

## Goals

1. **모듈화**: 10,111줄 단일 파일을 Agent별/기능별 모듈로 분할
2. **성능 개선**: 필요한 모듈만 로드하여 메모리 사용량 및 로딩 시간 감소
3. **유지보수성 향상**: 모듈별 독립적 수정 및 버전 관리 가능
4. **병렬 작업 지원**: 여러 개발자가 동시에 다른 모듈 작업 가능
5. **검증 최적화**: 변경된 모듈만 검증하여 검증 시간 단축

## User Stories

### 모듈화
1. **As a developer**, I want 온톨로지를 Agent별로 분리된 파일로 관리하여 특정 Agent 관련 클래스만 쉽게 찾을 수 있도록 하고 싶습니다.
2. **As a developer**, I want 메인 온톨로지 파일에서 `owl:imports`를 통해 모든 모듈을 통합하여 전체 온톨로지를 한 번에 로드할 수 있도록 하고 싶습니다.
3. **As a developer**, I want 기존 단일 파일을 자동으로 모듈로 분할하는 도구를 사용하여 수동 작업을 줄이고 싶습니다.

### 증분 로딩
4. **As a system**, I want 필요한 Agent 모듈만 로드하여 메모리 사용량을 최소화하고 싶습니다.
5. **As a developer**, I want 특정 Agent 관련 클래스만 쿼리할 때 해당 모듈만 로드하여 성능을 향상시키고 싶습니다.
6. **As a system**, I want 파싱 결과를 캐싱하여 동일 모듈의 재로딩 시간을 단축하고 싶습니다.

### 검증 최적화
7. **As a developer**, I want 변경된 모듈만 검증하여 전체 검증 시간을 단축하고 싶습니다.
8. **As a CI/CD system**, I want 모듈별 검증 결과를 캐싱하여 불필요한 재검증을 방지하고 싶습니다.

## Functional Requirements

### FR1: 온톨로지 분할 도구 (split_ontology.py)
1.1. 시스템은 `alphatutor_ontology.owl` 파일을 Agent 주석(`<!-- Agent XX: ... -->`) 기반으로 자동 분할해야 합니다.
1.2. 시스템은 각 Agent별 모듈 파일을 `modules/agentXX.owl` 형식으로 생성해야 합니다.
1.3. 시스템은 핵심 클래스(Student, Goal, Plan 등)를 `modules/core.owl`로 분리해야 합니다.
1.4. 시스템은 공통 속성 정의를 `modules/properties.owl`로 분리해야 합니다.
1.5. 시스템은 각 모듈 파일에 적절한 OWL 헤더와 네임스페이스를 포함해야 합니다.
1.6. 시스템은 분할 과정에서 XML 구조 무결성을 유지해야 합니다.

### FR2: 메인 온톨로지 생성
2.1. 시스템은 모든 모듈을 import하는 메인 온톨로지 파일(`alphatutor_ontology_main.owl`)을 생성해야 합니다.
2.2. 메인 온톨로지는 `owl:imports`를 사용하여 모든 모듈을 참조해야 합니다.
2.3. 메인 온톨로지는 기존 온톨로지와 동일한 네임스페이스를 유지해야 합니다.
2.4. 메인 온톨로지는 온톨로지 메타데이터(라벨, 설명)를 포함해야 합니다.

### FR3: 증분 온톨로지 로더 (IncrementalOntologyLoader)
3.1. 시스템은 필요한 모듈만 로드하는 `IncrementalOntologyLoader` 클래스를 제공해야 합니다.
3.2. 로더는 파일 해시 기반 캐싱을 구현하여 변경되지 않은 모듈은 재로드하지 않아야 합니다.
3.3. 로더는 특정 Agent 번호로 관련 클래스만 로드하는 메서드를 제공해야 합니다.
3.4. 로더는 특정 URI 접두사로 시작하는 클래스만 로드하는 메서드를 제공해야 합니다.
3.5. 로더는 스트리밍 파싱을 사용하여 메모리 효율적으로 처리해야 합니다.
3.6. 로더는 캐시 디렉토리(`.ontology_cache`)에 파싱 결과를 저장해야 합니다.

### FR4: 기존 코드 통합
4.1. 시스템은 기존 `consistency_check.py`와 호환되도록 모듈화된 온톨로지를 지원해야 합니다.
4.2. 시스템은 기존 `generate_ontology.py`가 모듈화된 구조에서도 작동하도록 수정해야 합니다.
4.3. 시스템은 기존 `owl_parser.py`가 모듈화된 온톨로지를 파싱할 수 있도록 지원해야 합니다.

### FR5: 증분 검증 시스템 (IncrementalValidator)
5.1. 시스템은 파일 해시 기반 검증 캐시를 구현해야 합니다.
5.2. 검증기는 변경되지 않은 모듈은 캐시된 결과를 재사용해야 합니다.
5.3. 검증기는 변경된 모듈만 재검증해야 합니다.
5.4. 검증기는 검증 결과를 JSON 형식으로 캐시 파일에 저장해야 합니다.
5.5. 검증기는 캐시 무효화 메커니즘을 제공해야 합니다.

### FR6: 문서화 및 가이드
6.1. 시스템은 모듈화된 온톨로지 사용 가이드를 제공해야 합니다.
6.2. 시스템은 모듈 구조 및 네이밍 컨벤션을 문서화해야 합니다.
6.3. 시스템은 마이그레이션 가이드를 제공해야 합니다.

## Non-Goals (Out of Scope)

1. **온톨로지 내용 변경**: 이 기능은 온톨로지의 논리적 구조나 내용을 변경하지 않습니다. 단순히 물리적 파일 구조만 변경합니다.
2. **자동 리팩토링**: Agent 주석이 없는 클래스의 자동 분류는 포함하지 않습니다. 수동 분류가 필요할 수 있습니다.
3. **온라인 편집기**: 웹 기반 온톨로지 편집 도구는 포함하지 않습니다.
4. **버전 관리 시스템 통합**: Git hooks나 자동 커밋 기능은 포함하지 않습니다.
5. **Protégé 플러그인**: Protégé 전용 플러그인 개발은 포함하지 않습니다.

## Design Considerations

### 파일 구조
```
ontology_engineering/
├── alphatutor_ontology.owl          # 기존 파일 (백업용)
├── alphatutor_ontology_main.owl     # 메인 온톨로지 (imports만 포함)
├── modules/
│   ├── core.owl                     # 핵심 클래스
│   ├── properties.owl               # 공통 속성
│   ├── agent01.owl                  # Agent 01 관련
│   ├── agent02.owl                  # Agent 02 관련
│   └── ...                          # 기타 Agent 모듈들
├── tools/
│   ├── split_ontology.py            # 분할 도구
│   ├── merge_ontology.py            # 병합 도구 (선택사항)
│   └── validate_modules.py          # 모듈 검증 도구
└── .ontology_cache/                 # 캐시 디렉토리
```

### 네임스페이스 관리
- 모든 모듈은 동일한 네임스페이스(`http://mathking.kr/ontology/alphatutor#`)를 사용합니다.
- 각 모듈의 온톨로지 URI는 `http://mathking.kr/ontology/alphatutor#agentXX` 형식을 사용합니다.

## Technical Considerations

### 의존성
- Python 3.7 이상
- `xml.etree.ElementTree` (표준 라이브러리)
- `rdflib` (선택사항, 향후 확장용)

### 성능 목표
- 모듈 로딩 시간: 단일 모듈 < 100ms (기존 전체 파일 대비 90% 감소 목표)
- 메모리 사용량: 필요한 모듈만 로드하여 70% 감소 목표
- 검증 시간: 변경된 모듈만 검증하여 80% 감소 목표

### 호환성
- Protégé에서 `owl:imports`를 통한 모듈 로딩 지원 확인 필요
- 기존 SPARQL 쿼리가 모듈화 후에도 동일하게 작동해야 함

## Success Metrics

1. **파일 크기 감소**: 단일 모듈 파일 평균 크기 < 500줄 (현재 10,111줄 대비)
2. **로딩 시간**: 단일 Agent 모듈 로딩 < 100ms
3. **메모리 사용량**: 필요한 모듈만 로드 시 70% 감소
4. **검증 시간**: 변경된 모듈만 검증 시 80% 감소
5. **개발자 생산성**: 특정 Agent 관련 클래스 찾기 시간 90% 감소

## Open Questions

1. Protégé에서 `owl:imports`를 통한 모듈 로딩이 원활하게 작동하는가?
2. 기존 SPARQL 쿼리가 모듈화 후에도 동일하게 작동하는가?
3. Agent 주석이 없는 클래스들은 어떻게 분류할 것인가? (core.owl에 포함?)
4. 모듈 간 순환 참조가 발생할 가능성이 있는가?
5. CI/CD 파이프라인에 증분 검증을 통합할 계획인가?

