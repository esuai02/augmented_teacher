<?php
// ÏãúÏûë ÏãúÍ∞Ñ Ï∏°Ï†ï
$start_time = microtime(true);

include_once("/home/moodle/public_html/moodle/config.php");
global $DB, $USER;
require_login();

// ÏãúÍ∞ÑÎåÄ ÏÑ§Ï†ï
date_default_timezone_set('Asia/Seoul');

// ÏÑ∏ÏÖò ÏãúÏûë
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// Performance: Simple query result cache
class QueryCache {
    private static $cache = [];
    private static $ttl = 300; // 5 minutes
    
    public static function get($key) {
        if (isset(self::$cache[$key]) && self::$cache[$key]['expires'] > time()) {
            return self::$cache[$key]['data'];
        }
        return null;
    }
    
    public static function set($key, $data) {
        self::$cache[$key] = [
            'data' => $data,
            'expires' => time() + self::$ttl
        ];
        return $data;
    }
    
    public static function clear() {
        self::$cache = [];
    }
}

// ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏùò Ïó≠Ìï† Ï°∞Ìöå - SQL Injection ÏàòÏ†ï
$userrole = $DB->get_record_sql("SELECT data AS role FROM mdl_user_info_data WHERE userid = ? AND fieldid = ?", array($USER->id, 22)); 
$role = $userrole ? $userrole->role : 'student';

// ÍµêÏÇ¨ Í∂åÌïú ÌôïÏù∏ - lastnameÏóê TÍ∞Ä ÏûàÍ±∞ÎÇò roleÏù¥ studentÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞
$isTeacher = false;
$teacherSymbol = ''; // ÍµêÏÇ¨Ïùò Ïù¥Î™®Ìã∞ÏΩò Ïã¨Î≥º
if (strpos($USER->lastname, 'T') !== false || $USER->lastname === 'T' || trim($USER->lastname) === 'T') {
    $isTeacher = true;
} elseif ($role !== 'student') {
    $isTeacher = true;
}

if (!$isTeacher) {
    die("<h2>Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. ÍµêÏÇ¨ Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.</h2>");
}

// ÍµêÏÇ¨ Ï†ïÎ≥¥ÏóêÏÑú Îã¥Îãπ ÌïôÏÉù Ïã¨Î≥º Í∞ÄÏ†∏Ïò§Í∏∞
$teacherInfo = $DB->get_record_sql("SELECT * FROM mdl_abessi_teacher 
                                    WHERE userid = ? 
                                    ORDER BY id DESC LIMIT 1", array($USER->id));

// ÍµêÏÇ¨Î≥Ñ Ïã¨Î≥º ÏÑ§Ï†ï (firstnameÏóêÏÑú Ï∂îÏ∂úÌïòÍ±∞ÎÇò ÏßÅÏ†ë Îß§Ìïë)
// ÏòàÏãú: ÍµêÏÇ¨ Ïù¥Î¶ÑÏù¥ÎÇò IDÏóê Îî∞Îùº Ïã¨Î≥º ÏÑ§Ï†ï
$tsymbol = '';
$tsymbol1 = '';
$tsymbol2 = '';
$tsymbol3 = '';

// ÍµêÏÇ¨ firstnameÏù¥ÎÇò ÌäπÏ†ï ÌïÑÎìúÏóêÏÑú Ïã¨Î≥º Ï∂îÏ∂ú
if ($USER->firstname) {
    // ÍµêÏÇ¨ Ïù¥Î¶ÑÏóê Îî∞Î•∏ Ïã¨Î≥º Îß§Ìïë (ÏòàÏãú)
    // Ïã§Ï†ú ÏãúÏä§ÌÖúÏóê ÎßûÍ≤å ÏàòÏ†ï ÌïÑÏöî
    if (strpos($USER->firstname, 'üåü') !== false) {
        $tsymbol = 'üåü';
    } elseif (strpos($USER->firstname, '‚≠ê') !== false) {
        $tsymbol = '‚≠ê';
    } elseif (strpos($USER->firstname, '‚ú®') !== false) {
        $tsymbol = '‚ú®';
    } elseif (strpos($USER->firstname, 'üéØ') !== false) {
        $tsymbol = 'üéØ';
    } else {
        // Í∏∞Î≥∏ Ïã¨Î≥º ÎòêÎäî ÍµêÏÇ¨ ID Í∏∞Î∞ò Ïã¨Î≥º Ìï†Îãπ
        $teacherId = $USER->id;
        $symbols = array('üåü', '‚≠ê', '‚ú®', 'üéØ', 'üî•', 'üí´', 'üåà', 'üé®', 'üé™', 'üé≠');
        $symbolIndex = $teacherId % count($symbols);
        $tsymbol = $symbols[$symbolIndex];
    }
    
    // Ï∂îÍ∞Ä Ïã¨Î≥º Î≥ÄÌòï (ÌïÑÏöîÏãú)
    $tsymbol1 = $tsymbol;
    $tsymbol2 = $tsymbol;
    $tsymbol3 = $tsymbol;
}

// ÏµúÍ∑º 3Ï£º Í∏∞Ï§Ä - ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô
$threeWeeksAgo = strtotime("-3 weeks");

// Ï∂úÍ≤∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ Ìï®Ïàò (POST Ï≤òÎ¶¨ Ï†ÑÏóê Ï†ïÏùò) - ÏµúÏ†ÅÌôî Î≤ÑÏ†Ñ with caching
function calculateAttendanceHours($DB, $studentid, $threeWeeksAgo, $skipExtraStudy = false) {
    // Check cache first
    $cacheKey = "attendance_{$studentid}_{$threeWeeksAgo}_" . ($skipExtraStudy ? '1' : '0');
    $cached = QueryCache::get($cacheKey);
    if ($cached !== null) {
        return $cached;
    }
    
    // Îã®Ïùº ÏøºÎ¶¨Î°ú Í≤∞ÏÑùÍ≥º Î≥¥Í∞ï ÏãúÍ∞Ñ ÎèôÏãú Í≥ÑÏÇ∞
    $sqlCombined = "SELECT 
                        event,
                        SUM(amount) as total_amount,
                        SUM(CASE WHEN due < ? THEN amount ELSE 0 END) as past_amount,
                        SUM(CASE WHEN due >= ? THEN amount ELSE 0 END) as future_amount
                    FROM {abessi_classtimemanagement} 
                    WHERE userid = ? AND hide = 0 AND due >= ?
                    GROUP BY event";
    
    $currentTime = time();
    $records = $DB->get_records_sql($sqlCombined, array($currentTime, $currentTime, $studentid, $threeWeeksAgo));
    
    $totalAbsence = 0;
    $pastMakeup = 0;
    $futureMakeup = 0;
    
    if ($records) {
        foreach ($records as $record) {
            if ($record->event === 'absence') {
                $totalAbsence = floatval($record->total_amount);
            } elseif ($record->event === 'makeup') {
                $pastMakeup = floatval($record->past_amount);
                $futureMakeup = floatval($record->future_amount);
            }
        }
    }
    
    // Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (ÏÑ±Îä• Í∞úÏÑ†ÏùÑ ÏúÑÌï¥ ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú Í±¥ÎÑàÎúÄ)
    $extraStudyHours = 0;
    
    if (!$skipExtraStudy) {
        // ÏãúÍ∞ÑÌëú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        $schedule = $DB->get_record_sql("SELECT * FROM mdl_abessi_schedule 
                                         WHERE userid = ? AND pinned = 1 
                                         ORDER BY id DESC LIMIT 1", array($studentid));
        
        // ÎîîÎ≤ÑÍ∑∏: ÏãúÍ∞ÑÌëú ÌôïÏù∏
        error_log("Schedule for student $studentid: " . ($schedule ? "Found" : "Not found"));
        
        if ($schedule) {
        // ÏµúÍ∑º 3Ï£ºÍ∞ÑÏùò ÌïôÏäµ Í∏∞Î°ù Î∂ÑÏÑù
        $startDate = date('Y-m-d', $threeWeeksAgo);
        $endDate = date('Y-m-d');
        
        $sqlStudy = "SELECT 
                        DATE(FROM_UNIXTIME(timecreated)) as study_date,
                        MIN(timecreated) as first_time,
                        MAX(timecreated) as last_time,
                        COUNT(*) as log_count
                     FROM mdl_abessi_missionlog 
                     WHERE userid = ? 
                     AND DATE(FROM_UNIXTIME(timecreated)) BETWEEN ? AND ?
                     GROUP BY DATE(FROM_UNIXTIME(timecreated))";
        
        $studyRecords = $DB->get_records_sql($sqlStudy, array($studentid, $startDate, $endDate));
        
        // ÎîîÎ≤ÑÍ∑∏: ÌïôÏäµ Í∏∞Î°ù ÌôïÏù∏
        error_log("Study records for student $studentid: " . ($studyRecords ? count($studyRecords) . " days found" : "No records"));
        
        if ($studyRecords) {
            foreach ($studyRecords as $record) {
                // Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏöîÏùº ÌôïÏù∏
                $dayOfWeek = date('w', strtotime($record->study_date));
                
                // Ìï¥Îãπ ÏöîÏùºÏùò Ï†ïÍ∑ú ÏàòÏóÖ ÏãúÍ∞Ñ ÌôïÏù∏
                if ($dayOfWeek == 0) { // ÏùºÏöîÏùº
                    $duration_field = 'duration7';
                } else { // Ïõî(1) ~ ÌÜ†(6)
                    $duration_field = 'duration' . $dayOfWeek;
                }
                
                $regularHours = isset($schedule->$duration_field) ? floatval($schedule->$duration_field) : 0;
                
                // Ïã§Ï†ú Í≥µÎ∂Ä ÏãúÍ∞Ñ Í≥ÑÏÇ∞
                $actualStudyHours = 0;
                if ($record->log_count > 1) {
                    $actualStudyHours = ($record->last_time - $record->first_time) / 3600;
                }
                
                // Ï†ïÍ∑ú ÏàòÏóÖ ÏãúÍ∞ÑÎ≥¥Îã§ 1ÏãúÍ∞Ñ Ïù¥ÏÉÅ Îçî Í≥µÎ∂ÄÌïú Í≤ΩÏö∞Îßå Ï¥àÍ≥º ÏãúÍ∞ÑÏúºÎ°ú Ïù∏Ï†ï
                if ($regularHours > 0 && $actualStudyHours > ($regularHours + 1)) {
                    $extraHoursForDay = $actualStudyHours - $regularHours;
                    $extraStudyHours += $extraHoursForDay;
                    error_log("Extra study on {$record->study_date}: Regular={$regularHours}h, Actual={$actualStudyHours}h, Extra={$extraHoursForDay}h");
                }
            }
        }
        }
    }
    
    // Î≥¥Í∞ï ÌïÑÏöî ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞Ñ Ï∞®Í∞ê)
    // ÎßàÏù¥ÎÑàÏä§ Í∞íÎèÑ ÌóàÏö©ÌïòÏó¨ ÌëúÏãú
    $neededMakeup = $totalAbsence - ($pastMakeup + $futureMakeup + $extraStudyHours);
    
    $result = array(
        'totalAbsence' => $totalAbsence,
        'pastMakeup' => $pastMakeup,
        'futureMakeup' => $futureMakeup,
        'extraStudyHours' => round($extraStudyHours, 1),
        'neededMakeup' => round($neededMakeup, 1)
    );
    
    // Cache the result
    QueryCache::set($cacheKey, $result);
    
    return $result;
}

// Batch processing function for multiple students - Performance optimization
function batchCalculateAttendanceHours($DB, $studentIds, $threeWeeksAgo) {
    if (empty($studentIds)) {
        return array();
    }
    
    // Build placeholders for IN clause
    $placeholders = implode(',', array_fill(0, count($studentIds), '?'));
    $currentTime = time();
    
    // Batch query for all students at once
    $params = array_merge(array($currentTime, $currentTime, $threeWeeksAgo), $studentIds);
    
    $sqlBatch = "SELECT 
                    userid,
                    event,
                    SUM(amount) as total_amount,
                    SUM(CASE WHEN due < ? THEN amount ELSE 0 END) as past_amount,
                    SUM(CASE WHEN due >= ? THEN amount ELSE 0 END) as future_amount
                FROM {abessi_classtimemanagement} 
                WHERE hide = 0 AND due >= ? AND userid IN ($placeholders)
                GROUP BY userid, event";
    
    $records = $DB->get_records_sql($sqlBatch, $params);
    
    // Process results into per-student data
    $results = array();
    foreach ($studentIds as $studentId) {
        $results[$studentId] = array(
            'totalAbsence' => 0,
            'pastMakeup' => 0,
            'futureMakeup' => 0,
            'extraStudyHours' => 0,
            'neededMakeup' => 0
        );
    }
    
    if ($records) {
        foreach ($records as $record) {
            $sid = $record->userid;
            if ($record->event === 'absence') {
                $results[$sid]['totalAbsence'] = floatval($record->total_amount);
            } elseif ($record->event === 'makeup') {
                $results[$sid]['pastMakeup'] = floatval($record->past_amount);
                $results[$sid]['futureMakeup'] = floatval($record->future_amount);
            }
        }
    }
    
    // Calculate needed makeup for each student
    foreach ($results as $sid => &$data) {
        $data['neededMakeup'] = round($data['totalAbsence'] - ($data['pastMakeup'] + $data['futureMakeup']), 1);
    }
    
    return $results;
}

// URLÎ°úÎ∂ÄÌÑ∞ ÌååÎùºÎØ∏ÌÑ∞ Î∞õÍ∏∞ (POST Ï≤òÎ¶¨ Ï†ÑÏóê Ï¥àÍ∏∞Í∞íÎßå ÏÑ§Ï†ï)
$studentid = isset($_GET['userid']) ? intval($_GET['userid']) : (isset($_POST['userid']) ? intval($_POST['userid']) : 0);
$searchQuery = isset($_GET['search']) ? trim($_GET['search']) : '';
$viewMonth = isset($_GET['month']) ? $_GET['month'] : date('Y-m');

// POST ÏöîÏ≤≠ Ï≤òÎ¶¨
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $studentid > 0) {
    $action = isset($_POST['action']) ? $_POST['action'] : '';
    
    if ($action === 'absence' || $action === 'makeup') {
        $selectedDate = isset($_POST['selectedDate']) ? trim($_POST['selectedDate']) : '';
        $selectedHours = isset($_POST['selectedHours']) ? floatval($_POST['selectedHours']) : 0;
        
        if (!empty($selectedDate) && $selectedHours > 0) {
            $selectedTimestamp = strtotime($selectedDate);
            
            // ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏùò Ïõî Ï†ïÎ≥¥ Ï∂îÏ∂ú
            $selectedMonth = date('Y-m', $selectedTimestamp);
            
            $record = new stdClass();
            $record->userid = $studentid;
            $record->event = $action;
            $record->hide = 0;
            $record->amount = $selectedHours;
            $record->text = '';
            $record->due = $selectedTimestamp;
            $record->timecreated = time();
            $record->status = 'done';
            $record->role = 'teacher';
            
            if ($DB->insert_record('abessi_classtimemanagement', $record)) {
                $_SESSION['success'] = ($action === 'absence' ? "Ìú¥Í∞ï" : "Î≥¥Í∞ï") . " Í∏∞Î°ùÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.";
                // ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÍ∞Ä ÏÜçÌïú ÏõîÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
                $viewMonth = $selectedMonth;
            } else {
                $_SESSION['error'] = "Í∏∞Î°ù Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
            }
        }
        
        $redirectUrl = "?userid=" . urlencode($studentid) . "&search=" . urlencode($searchQuery) . "&month=" . urlencode($viewMonth);
        header("Location: " . $redirectUrl);
        exit;
    }
    
    // ÏÇ≠Ï†ú Ï≤òÎ¶¨
    if ($action === 'delete') {
        $recordId = isset($_POST['record_id']) ? intval($_POST['record_id']) : 0;
        
        if ($recordId > 0) {
            // Í∏∞Î°ù ÌôïÏù∏ (Î≥¥ÏïàÏùÑ ÏúÑÌï¥ useridÎèÑ ÌôïÏù∏)
            $record = $DB->get_record('abessi_classtimemanagement', array('id' => $recordId, 'userid' => $studentid));
            
            if ($record) {
                // hideÎ•º 1Î°ú ÏÑ§Ï†ïÌïòÏó¨ Ïà®ÍπÄ Ï≤òÎ¶¨ (ÏôÑÏ†Ñ ÏÇ≠Ï†ú ÎåÄÏã†)
                $record->hide = 1;
                if ($DB->update_record('abessi_classtimemanagement', $record)) {
                    $_SESSION['success'] = "Ï∂úÍ≤∞ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.";
                } else {
                    $_SESSION['error'] = "ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                }
            } else {
                $_SESSION['error'] = "Ìï¥Îãπ Í∏∞Î°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.";
            }
        }
        
        $redirectUrl = "?userid=" . urlencode($studentid) . "&search=" . urlencode($searchQuery) . "&month=" . urlencode($viewMonth);
        header("Location: " . $redirectUrl);
        exit;
    }
}

// ÏÑ∏ÏÖò Î©îÏãúÏßÄ ÏùΩÍ∏∞
$error = isset($_SESSION['error']) ? $_SESSION['error'] : null;
$success = isset($_SESSION['success']) ? $_SESSION['success'] : null;
unset($_SESSION['error']);
unset($_SESSION['success']);

// POST Ï≤òÎ¶¨ ÌõÑ URL ÌååÎùºÎØ∏ÌÑ∞ Îã§Ïãú ÏùΩÍ∏∞ (Î¶¨Îã§Ïù¥Î†âÌä∏ ÌõÑ Í∞í Î∞òÏòÅ)
$studentid = isset($_GET['userid']) ? intval($_GET['userid']) : 0;
$searchQuery = isset($_GET['search']) ? trim($_GET['search']) : '';
$viewMonth = isset($_GET['month']) ? $_GET['month'] : date('Y-m');

// ÌïôÏÉù Î™©Î°ùÏùÄ AJAXÎ°ú Î°úÎìúÌïòÎØÄÎ°ú Ï¥àÍ∏∞ÌôîÎßå
$students = array();
$totalCount = 0;

// ÏÑ†ÌÉùÎêú ÌïôÏÉùÏùò Ï∂úÍ≤∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
$attendanceData = array('totalAbsence' => 0, 'pastMakeup' => 0, 'futureMakeup' => 0, 'extraStudyHours' => 0, 'neededMakeup' => 0);
$notifications = array();
$schedule = null;
$calendarData = array();

// ÏïåÎ¶º Í∏∞Îä• - Í∞ÑÏÜåÌôîÎêú Î≤ÑÏ†Ñ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
$studentAlerts = array();

// AJAX ÏöîÏ≤≠ Ï≤òÎ¶¨
if (isset($_GET['ajax'])) {
    $ajaxType = $_GET['ajax'];
    
    // ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    if ($ajaxType === 'alerts') {
        $alertsData = array();
        
        try {
            // 1. Î≥¥Í∞ï ÌïÑÏöî ÎòêÎäî Ï∂îÍ∞Ä ÌïôÏäµ ÏãúÍ∞ÑÏù¥ ÏûàÎäî ÌïôÏÉù Ï∞æÍ∏∞
            $alertParams = array($threeWeeksAgo, $threeWeeksAgo);
            
            $sqlAlerts = "SELECT 
                        u.id,
                        u.firstname,
                        u.lastname,
                        COALESCE(absence.total, 0) as total_absence,
                        COALESCE(makeup.total, 0) as total_makeup,
                        (COALESCE(absence.total, 0) - COALESCE(makeup.total, 0)) as needed
                      FROM mdl_user u
                      LEFT JOIN (
                        SELECT userid, SUM(amount) as total 
                        FROM mdl_abessi_classtimemanagement 
                        WHERE event = 'absence' AND hide = 0 AND due >= ?
                        GROUP BY userid
                      ) absence ON u.id = absence.userid
                      LEFT JOIN (
                        SELECT userid, SUM(amount) as total 
                        FROM mdl_abessi_classtimemanagement 
                        WHERE event = 'makeup' AND hide = 0 AND due >= ?
                        GROUP BY userid
                      ) makeup ON u.id = makeup.userid
                      INNER JOIN mdl_user_info_data uid ON u.id = uid.userid
                      WHERE uid.fieldid = 22 AND uid.data = 'student'
                      AND u.deleted = 0 AND u.suspended = 0";
            
            // ÍµêÏÇ¨ Ïã¨Î≥ºÎ°ú ÌïÑÌÑ∞ÎßÅ
            if (!empty($tsymbol)) {
                $sqlAlerts .= " AND (u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ?)";
                $alertParams[] = '%' . $tsymbol . '%';
                $alertParams[] = '%' . $tsymbol1 . '%';
                $alertParams[] = '%' . $tsymbol2 . '%';
                $alertParams[] = '%' . $tsymbol3 . '%';
            }
            
            $sqlAlerts .= " HAVING needed >= 4 OR needed <= -5
                           ORDER BY ABS(needed) DESC
                           LIMIT 20";
            
            // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
            error_log("Alert SQL: " . $sqlAlerts);
            error_log("Alert Params: " . print_r($alertParams, true));
            
            $alertStudents = $DB->get_records_sql($sqlAlerts, $alertParams);
            error_log("Alert Students Found: " . ($alertStudents ? count($alertStudents) : 0));
            
            // 2. Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞ÑÏù¥ ÏûàÎäî ÌïôÏÉù Ï∞æÍ∏∞
            $extraStudyStudents = array();
            
            // Îã¥Îãπ ÌïôÏÉùÎì§Ïùò Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            $sqlExtraStudy = "SELECT DISTINCT u.id, u.firstname, u.lastname
                            FROM mdl_user u
                            INNER JOIN mdl_user_info_data uid ON u.id = uid.userid
                            INNER JOIN mdl_abessi_schedule s ON u.id = s.userid AND s.pinned = 1
                            WHERE uid.fieldid = 22 AND uid.data = 'student'
                            AND u.deleted = 0 AND u.suspended = 0";
            
            $extraParams = array();
            
            // ÍµêÏÇ¨ Ïã¨Î≥ºÎ°ú ÌïÑÌÑ∞ÎßÅ
            if (!empty($tsymbol)) {
                $sqlExtraStudy .= " AND (u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ?)";
                $extraParams[] = '%' . $tsymbol . '%';
                $extraParams[] = '%' . $tsymbol1 . '%';
                $extraParams[] = '%' . $tsymbol2 . '%';
                $extraParams[] = '%' . $tsymbol3 . '%';
            }
            
            $sqlExtraStudy .= " LIMIT 30";
            
            $candidateStudents = $DB->get_records_sql($sqlExtraStudy, $extraParams);
            
            if ($candidateStudents) {
                foreach ($candidateStudents as $student) {
                    // Ïù¥ÎØ∏ Ï≤òÎ¶¨Îêú ÌïôÏÉùÏùÄ Í±¥ÎÑàÎúÄ
                    if (isset($processedIds[$student->id])) {
                        continue;
                    }
                    
                    // Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (skipExtraStudy = falseÎ°ú ÏÑ§Ï†ï)
                    $attendanceData = calculateAttendanceHours($DB, $student->id, $threeWeeksAgo, false);
                    
                    // Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞ÑÏù¥ 0Ïù¥ ÏïÑÎãå Í≤ΩÏö∞Îßå Ï∂îÍ∞Ä
                    if ($attendanceData['extraStudyHours'] > 0) {
                        $student->extra_hours = $attendanceData['extraStudyHours'];
                        $extraStudyStudents[] = $student;
                        error_log("Extra study alert for {$student->firstname}: {$student->extra_hours}h");
                    }
                }
            }
            
            // ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
            $processedIds = array();
            
            // Î≥¥Í∞ï ÌïÑÏöî/Ï∂îÍ∞Ä ÌïôÏäµ ÏãúÍ∞Ñ ÏïåÎ¶º
            if ($alertStudents) {
                foreach ($alertStudents as $student) {
                    $type = 'makeup_needed';
                    $hours = $student->needed;
                    
                    if ($student->needed <= -5) {
                        $type = 'surplus_study';
                        $hours = abs($student->needed);
                    }
                    
                    $alertsData[] = array(
                        'id' => $student->id,
                        'name' => $student->firstname . ' ' . $student->lastname,
                        'type' => $type,
                        'hours' => round($hours, 1)
                    );
                    $processedIds[$student->id] = true;
                }
            }
            
            // Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞Ñ ÏïåÎ¶º Ï∂îÍ∞Ä
            if ($extraStudyStudents) {
                foreach ($extraStudyStudents as $student) {
                    if (!isset($processedIds[$student->id])) {
                        $alertsData[] = array(
                            'id' => $student->id,
                            'name' => $student->firstname . ' ' . $student->lastname,
                            'type' => 'extra_study',
                            'hours' => round($student->extra_hours, 1)
                        );
                        $processedIds[$student->id] = true;
                    }
                }
            }
            
            // Ï§ëÏöîÎèÑÏóê Îî∞Îùº Ï†ïÎ†¨
            usort($alertsData, function($a, $b) {
                // Î≥¥Í∞ï ÌïÑÏöî > Ï¥àÍ≥º ÌïôÏäµ > Ï∂îÍ∞Ä ÌïôÏäµ Ïàú
                $priority = array('makeup_needed' => 1, 'extra_study' => 2, 'surplus_study' => 3);
                if ($priority[$a['type']] != $priority[$b['type']]) {
                    return $priority[$a['type']] - $priority[$b['type']];
                }
                return $b['hours'] - $a['hours'];
            });
            
            // ÏµúÎåÄ 15Í∞úÎßå Î∞òÌôò
            $alertsData = array_slice($alertsData, 0, 15);
        
            header('Content-Type: application/json');
            echo json_encode($alertsData);
        } catch (Exception $e) {
            header('Content-Type: application/json');
            echo json_encode(array('error' => 'Database error: ' . $e->getMessage()));
        }
        exit;
    }
    
    // ÌïôÏÉù Î™©Î°ù Î°úÎìú
    if ($ajaxType === 'students') {
        $searchQuery = isset($_GET['search']) ? trim($_GET['search']) : '';
        $params = array();
        
        // ÍµêÏÇ¨Í∞Ä Îã¥ÎãπÌïòÎäî ÌïôÏÉùÎßå ÌëúÏãú (firstnameÏóê ÍµêÏÇ¨ Ïã¨Î≥ºÏù¥ Ìè¨Ìï®Îêú ÌïôÏÉù)
        $sql = "SELECT u.id, u.firstname, u.lastname, u.email, u.phone1 as phone
                FROM mdl_user u
                INNER JOIN mdl_user_info_data uid ON u.id = uid.userid
                WHERE uid.fieldid = 22 AND uid.data = 'student'
                AND u.deleted = 0 
                AND u.suspended = 0";
        
        // ÍµêÏÇ¨ Ïã¨Î≥ºÎ°ú ÌïÑÌÑ∞ÎßÅ (ÌïôÏÉù Ïù¥Î¶ÑÏóê ÍµêÏÇ¨ Ïã¨Î≥ºÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäî Í≤ΩÏö∞)
        if (!empty($tsymbol)) {
            $sql .= " AND (u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ? OR u.firstname LIKE ?)";
            $params[] = '%' . $tsymbol . '%';
            $params[] = '%' . $tsymbol1 . '%';
            $params[] = '%' . $tsymbol2 . '%';
            $params[] = '%' . $tsymbol3 . '%';
        }
        
        if ($searchQuery) {
            $searchTerm = '%' . $searchQuery . '%';
            $searchTermNoSpace = '%' . str_replace(' ', '', $searchQuery) . '%';
            
            $sql .= " AND (
                CONCAT(u.firstname, ' ', u.lastname) LIKE ? 
                OR CONCAT(u.firstname, u.lastname) LIKE ? 
                OR REPLACE(CONCAT(u.firstname, ' ', u.lastname), ' ', '') LIKE ?
                OR CONCAT(u.lastname, u.firstname) LIKE ?
                OR u.firstname LIKE ? 
                OR u.lastname LIKE ? 
                OR u.email LIKE ?
            )";
            $params[] = $searchTerm;
            $params[] = $searchTerm;
            $params[] = $searchTermNoSpace;
            $params[] = $searchTermNoSpace;
            $params[] = $searchTerm;
            $params[] = $searchTerm;
            $params[] = $searchTerm;
        }
        
        $sql .= " ORDER BY u.firstname ASC, u.lastname ASC";
        
        try {
            // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌï¥ ÏøºÎ¶¨ Ïã§Ìñâ Ï†Ñ Î°úÍ∑∏
            error_log("Students SQL: " . $sql);
            error_log("Params: " . print_r($params, true));
            
            if (empty($params)) {
                $students = $DB->get_records_sql($sql);
            } else {
                $students = $DB->get_records_sql($sql, $params);
            }
            
            if (!$students) {
                $students = array();
            }
            
            $studentsData = array();
            foreach ($students as $student) {
                $studentsData[] = array(
                    'id' => $student->id,
                    'name' => $student->firstname . ' ' . $student->lastname,
                    'email' => isset($student->email) ? $student->email : '',
                    'phone' => isset($student->phone) ? $student->phone : ''
                );
            }
            
            header('Content-Type: application/json');
            echo json_encode(array(
                'status' => 'success',
                'count' => count($studentsData),
                'data' => $studentsData
            ));
        } catch (Exception $e) {
            error_log("Students AJAX Error: " . $e->getMessage());
            header('Content-Type: application/json');
            echo json_encode(array(
                'status' => 'error',
                'error' => 'Database error',
                'message' => $e->getMessage(),
                'sql' => $sql
            ));
        }
        exit;
    }
}

// ÌïôÏÉù Ï†ïÎ≥¥ Ï°∞Ìöå Î∞è Îç∞Ïù¥ÌÑ∞ Î°úÎìú (POST Ï≤òÎ¶¨ ÏôÑÎ£å ÌõÑ)
$thisuser = null;
$stdname = "";
if ($studentid > 0) {
    $thisuser = $DB->get_record_sql("SELECT lastname, firstname FROM mdl_user WHERE id = ?", array($studentid));
    if ($thisuser) {
        $stdname = $thisuser->firstname . " " . $thisuser->lastname;
    }
    
    // Ï∂úÍ≤∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (ÏÑ†ÌÉùÎêú ÌïôÏÉùÎßå Ï†ÑÏ≤¥ Í≥ÑÏÇ∞) - Ï¥àÍ≥º ÌïôÏäµ ÏãúÍ∞ÑÎèÑ Í≥ÑÏÇ∞
    $attendanceData = calculateAttendanceHours($DB, $studentid, $threeWeeksAgo, false);
    
    // ÏµúÍ∑º Ï∂úÍ≤∞ Í∏∞Î°ù
    $sqlNotifications = "SELECT * FROM {abessi_classtimemanagement} 
                         WHERE userid = ? AND hide = 0 
                         ORDER BY due DESC LIMIT 20";
    $notifications = $DB->get_records_sql($sqlNotifications, array($studentid));
    
    // ÏãúÍ∞ÑÌëú Ï†ïÎ≥¥
    $schedule = $DB->get_record_sql("SELECT * FROM mdl_abessi_schedule 
                                     WHERE userid = ? AND pinned = 1 
                                     ORDER BY id DESC LIMIT 1", array($studentid));
    
    // Ï∫òÎ¶∞ÎçîÏö© Ï∂úÍ≤∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÌòÑÏû¨ viewMonth Í∏∞Ï§Ä)
    $startDate = strtotime($viewMonth . '-01');
    $endDate = strtotime($viewMonth . '-' . date('t', $startDate) . ' 23:59:59');
    
    // ÏµúÏ†ÅÌôîÎêú ÏøºÎ¶¨ - ÌïÑÏöîÌïú ÌïÑÎìúÎßå ÏÑ†ÌÉùÌïòÍ≥† ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌôî
    $sqlCalendar = "SELECT 
                        id, event, amount, due,
                        DATE(FROM_UNIXTIME(due)) as date_key
                    FROM mdl_abessi_classtimemanagement 
                    WHERE userid = ? AND hide = 0 AND due BETWEEN ? AND ?
                    ORDER BY due ASC";
    $calendarRecords = $DB->get_records_sql($sqlCalendar, array($studentid, $startDate, $endDate));
    
    // ÎÇ†ÏßúÎ≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
    if ($calendarRecords) {
        foreach ($calendarRecords as $record) {
            if (!isset($calendarData[$record->date_key])) {
                $calendarData[$record->date_key] = array();
            }
            $calendarData[$record->date_key][] = $record;
        }
    }
    
    // ÌïôÏäµ ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Îäî ÏÑ†ÌÉùÎêú ÌïôÏÉùÏù¥ ÏûàÏùÑ ÎïåÎßå Í∞ÄÏ†∏Ïò§Í∏∞
    $studyData = array();
    if ($studentid > 0) {
        try {
            // Í∞Å ÎÇ†ÏßúÎ≥ÑÎ°ú ÏµúÏ¥àÏôÄ ÏµúÌõÑ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            $startDateStr = date('Y-m-d', $startDate);
            $endDateStr = date('Y-m-d', $endDate);
            
            // ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ ÏµúÏ¥à/ÏµúÌõÑ ÏãúÍ∞Ñ Í∞ÄÏ†∏Ïò§Í∏∞ - ÏµúÏ†ÅÌôîÎêú ÏøºÎ¶¨
            $sqlStudy = "SELECT 
                            DATE(FROM_UNIXTIME(timecreated)) as study_date,
                            MIN(timecreated) as first_time,
                            MAX(timecreated) as last_time,
                            COUNT(*) as log_count
                         FROM mdl_abessi_missionlog 
                         WHERE userid = ? 
                         AND DATE(FROM_UNIXTIME(timecreated)) BETWEEN ? AND ?
                         GROUP BY DATE(FROM_UNIXTIME(timecreated))";
            
            $studyRecords = $DB->get_records_sql($sqlStudy, array($studentid, $startDateStr, $endDateStr));
            
            if ($studyRecords) {
                foreach ($studyRecords as $record) {
                    // Í≥µÎ∂Ä ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Ï¥à Îã®ÏúÑ Ï∞®Ïù¥Î•º ÏãúÍ∞ÑÏúºÎ°ú Î≥ÄÌôò)
                    $studyHours = 0;
                    if ($record->log_count > 1) {
                        $studyHours = round(($record->last_time - $record->first_time) / 3600, 1);
                    }
                    
                    // Ïã§Ï†ú Í≥µÎ∂Ä ÏãúÏûë/Ï¢ÖÎ£å ÏãúÍ∞Ñ
                    $actualStartTime = date('H:i', $record->first_time);
                    $actualEndTime = date('H:i', $record->last_time);
                    
                    $studyData[$record->study_date] = (object) array(
                        'date' => $record->study_date,
                        'hours' => $studyHours,
                        'first_time' => $record->first_time,
                        'last_time' => $record->last_time,
                        'log_count' => $record->log_count,
                        'actual_start' => $actualStartTime,
                        'actual_end' => $actualEndTime,
                        'target_start' => 0,
                        'target_end' => 0
                    );
                }
            }
        } catch (Exception $e) {
            // Ïò§Î•ò Î∞úÏÉùÏãú Îπà Î∞∞Ïó¥ Ïú†ÏßÄ
            $studyData = array();
        }
    }
}

?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ÍµêÏÇ¨Ïö© Ï∂úÍ≤∞Í¥ÄÎ¶¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1300px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }
        .notification-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: white;
            color: #667eea;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification-badge {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        .notification-dropdown {
            position: absolute;
            top: 4rem;
            right: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .notification-dropdown.show {
            display: block;
        }
        .notification-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #1f2937;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        }
        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
        }
        .notification-item:hover {
            background: #f9fafb;
            transform: translateX(4px);
        }
        .notification-item:active {
            background: #f3f4f6;
            transform: translateX(2px);
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .notification-icon.makeup {
            background: #fee2e2;
            color: #dc2626;
        }
        .notification-icon.extra {
            background: #dbeafe;
            color: #2563eb;
        }
        .notification-icon.surplus {
            background: #d1fae5;
            color: #059669;
        }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .notification-desc {
            font-size: 14px;
            color: #6b7280;
        }
        .no-notifications {
            padding: 2rem;
            text-align: center;
            color: #9ca3af;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 2rem;
        }
        .sidebar {
            background: white;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 80vh;
            position: sticky;
            top: 20px;
            overflow: hidden;
        }
        .search-box {
            position: relative;
            margin-bottom: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        .search-input {
            width: calc(100% - 60px);
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .search-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .search-btn:hover {
            background: #5a67d8;
        }
        .clear-search {
            display: inline-block;
            margin-top: 8px;
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
        }
        .clear-search:hover {
            text-decoration: underline;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
        }
        .content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .student-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: calc(80vh - 200px);
            overflow-y: auto;
        }
        .student-list::-webkit-scrollbar {
            width: 6px;
        }
        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .student-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .student-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .student-item {
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .student-item:hover {
            background: #f7fafc;
            border-color: #667eea;
            transform: translateX(3px);
        }
        .student-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .status-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .status-card {
            background: #f1f5f9;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .status-card.alert {
            background: #fee2e2;
        }
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }
        .status-label {
            color: #64748b;
            margin-top: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }
        .btn-absence {
            background-color: #f97316;
            color: white;
        }
        .btn-absence:hover {
            background-color: #ea580c;
        }
        .btn-makeup {
            background-color: #14b8a6;
            color: white;
        }
        .btn-makeup:hover {
            background-color: #0d9488;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f7fafc;
            font-weight: 600;
        }
        .record {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .record.absence {
            background-color: #fee2e2;
        }
        .record.makeup {
            background-color: #dcfce7;
        }
        .record-info {
            flex: 1;
        }
        .btn-delete {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .alert.success {
            background: #dcfce7;
            color: #166534;
        }
        .alert.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 1rem;
        }
        .schedule-day {
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }
        .schedule-day.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }
        h2 {
            color: #1e293b;
            margin-bottom: 1.5rem;
        }
        h3 {
            color: #475569;
            margin-bottom: 1rem;
            font-size: 16px;
        }
        .sidebar h3 {
            font-size: 15px;
            margin-bottom: 0.8rem;
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .calendar-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .calendar-nav button:hover {
            background: #5a67d8;
        }
        .calendar-current-month {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            min-width: 120px;
            text-align: center;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: #f7fafc;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #475569;
        }
        .calendar-day-header.sunday {
            color: #dc2626;
        }
        .calendar-day-header.saturday {
            color: #2563eb;
        }
        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .calendar-day:hover {
            background: #f0f4ff;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .calendar-day:hover::after {
            content: '+';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        .calendar-day.other-month {
            background: #f9fafb;
            color: #cbd5e1;
        }
        .calendar-day.today {
            background: #eff6ff;
            border: 2px solid #3b82f6;
        }
        .calendar-day-number {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .calendar-day.sunday .calendar-day-number {
            color: #dc2626;
        }
        .calendar-day.saturday .calendar-day-number {
            color: #2563eb;
        }
        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .calendar-event {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event.absence {
            background: #fee2e2;
            color: #dc2626;
            border-left: 3px solid #dc2626;
        }
        .calendar-event.makeup {
            background: #dcfce7;
            color: #16a34a;
            border-left: 3px solid #16a34a;
        }
        .calendar-event.regular {
            background: #e0e7ff;
            color: #4f46e5;
            border-left: 3px solid #4f46e5;
        }
        .calendar-legend {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 3px;
            border-left: 3px solid;
        }
        .legend-color.absence {
            background: #fee2e2;
            border-left-color: #dc2626;
        }
        .legend-color.makeup {
            background: #dcfce7;
            border-left-color: #16a34a;
        }
        .legend-color.regular {
            background: #e0e7ff;
            border-left-color: #4f46e5;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 1.5rem;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .modal-close:hover {
            background: #f1f5f9;
        }
        .modal-body {
            margin-bottom: 1.5rem;
        }
        .modal-date-display {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #475569;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .modal-time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .modal-time-btn {
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .modal-time-btn:hover {
            background: #f7fafc;
            border-color: #667eea;
        }
        .modal-time-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .modal-existing-events {
            background: #fef3c7;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 14px;
            color: #92400e;
        }
        .modal-existing-events strong {
            color: #78350f;
        }
    </style>
    <script>
        // Performance: DOM Cache implementation
        const DOMCache = {
            elements: {},
            get(id) {
                if (!this.elements[id]) {
                    this.elements[id] = document.getElementById(id);
                }
                return this.elements[id];
            },
            querySelector(selector) {
                const key = 'qs_' + selector;
                if (!this.elements[key]) {
                    this.elements[key] = document.querySelector(selector);
                }
                return this.elements[key];
            },
            querySelectorAll(selector) {
                // Don't cache NodeLists as they can change
                return document.querySelectorAll(selector);
            },
            clear() {
                this.elements = {};
            }
        };
        
        // Performance: Debounce utility for search and other frequent operations
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Performance: Request Animation Frame for smooth animations
        const rafSchedule = {
            queue: [],
            scheduled: false,
            schedule(callback) {
                this.queue.push(callback);
                if (!this.scheduled) {
                    this.scheduled = true;
                    requestAnimationFrame(() => {
                        const callbacks = this.queue.slice();
                        this.queue = [];
                        this.scheduled = false;
                        callbacks.forEach(cb => cb());
                    });
                }
            }
        };
        
        function deleteRecord(recordId, eventType) {
            const eventName = eventType === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï';
            if (confirm(eventName + ' Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                // Ïà®Í≤®ÏßÑ Ìèº ÏÉùÏÑ±ÌïòÏó¨ Ï†úÏ∂ú
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="record_id" value="${recordId}">
                    <input type="hidden" name="userid" value="<?php echo $studentid; ?>">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        let selectedModalDate = '';
        let selectedModalHours = 0;
        let currentDayData = null;
        
        // ÎÇ†Ïßú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ Ïó¥Í∏∞
        function openDayDetails(date, events, regularHours, studyData) {
            selectedModalDate = date;
            currentDayData = { date, events, regularHours, studyData };
            
            const modal = DOMCache.get('dayDetailsModal');
            const dateDisplay = DOMCache.get('detailsDateDisplay');
            const studyDetails = DOMCache.get('studyTimeDetails');
            const regularDetails = DOMCache.get('regularClassDetails');
            const attendanceDetails = DOMCache.get('attendanceDetails');
            
            // ÎÇ†Ïßú ÌëúÏãú
            const dateObj = new Date(date + 'T00:00:00');
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            dateDisplay.textContent = dateObj.toLocaleDateString('ko-KR', options);
            
            // ÌïôÏäµ ÏãúÍ∞Ñ Ï†ïÎ≥¥ ÌëúÏãú
            if (studyData && studyData.hours > 0) {
                let targetTimeHtml = '';
                
                // Î™©Ìëú ÏãúÍ∞ÑÍ≥º Ïã§Ï†ú ÏãúÍ∞Ñ ÎπÑÍµê
                if (studyData.targetStart > 0 && studyData.targetEnd > 0) {
                    const targetStartFormatted = String(studyData.targetStart).padStart(2, '0') + ':00';
                    const targetEndFormatted = String(studyData.targetEnd).padStart(2, '0') + ':00';
                    
                    // Î™©Ìëú Îã¨ÏÑ± Ïó¨Î∂Ä Ï≤¥ÌÅ¨
                    const actualStartHour = parseInt(studyData.actualStart.split(':')[0]);
                    const actualEndHour = parseInt(studyData.actualEnd.split(':')[0]);
                    
                    let achievementStatus = '';
                    let achievementColor = '#64748b';
                    
                    if (actualStartHour <= studyData.targetStart && actualEndHour >= studyData.targetEnd) {
                        achievementStatus = '‚úÖ Î™©Ìëú Îã¨ÏÑ±!';
                        achievementColor = '#16a34a';
                    } else if (actualStartHour <= studyData.targetStart + 1 && actualEndHour >= studyData.targetEnd - 1) {
                        achievementStatus = '‚ö†Ô∏è Î™©Ìëú Í∑ºÏ†ë';
                        achievementColor = '#f59e0b';
                    } else {
                        achievementStatus = '‚ùå Î™©Ìëú ÎØ∏Îã¨ÏÑ±';
                        achievementColor = '#dc2626';
                    }
                    
                    targetTimeHtml = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                üéØ Î™©Ìëú ÏãúÍ∞Ñ: ${targetStartFormatted} ~ ${targetEndFormatted}
                            </div>
                            <div style="color: ${achievementColor}; font-weight: 600;">
                                ${achievementStatus}
                            </div>
                        </div>
                    `;
                }
                
                studyDetails.innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af; margin-bottom: 0.5rem;">
                        ‚è±Ô∏è Ï¥ù ÌïôÏäµ ÏãúÍ∞Ñ: ${studyData.hours}ÏãúÍ∞Ñ
                    </div>
                    <div style="color: #475569; margin-bottom: 0.25rem;">
                        ‚è∞ Ïã§Ï†ú ÌïôÏäµ: ${studyData.actualStart} ~ ${studyData.actualEnd}
                    </div>
                    <div style="color: #64748b; font-size: 0.9rem;">
                        üìä ÌôúÎèô Í∏∞Î°ù: ${studyData.logCount}Í∞ú
                    </div>
                    ${targetTimeHtml}
                `;
            } else {
                studyDetails.innerHTML = '<div style="color: #94a3b8;">ÌïôÏäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
            }
            
            // Ï†ïÍ∑ú ÏàòÏóÖ Ï†ïÎ≥¥ ÌëúÏãú
            if (regularHours > 0) {
                regularDetails.innerHTML = `
                    <div style="font-size: 1.2rem; font-weight: bold; color: #15803d;">
                        ‚úÖ Ï†ïÍ∑ú ÏàòÏóÖ: ${regularHours}ÏãúÍ∞Ñ
                    </div>
                `;
            } else {
                regularDetails.innerHTML = '<div style="color: #94a3b8;">Ï†ïÍ∑ú ÏàòÏóÖÏù¥ ÏóÜÎäî ÎÇ†ÏûÖÎãàÎã§.</div>';
            }
            
            // Ï∂úÍ≤∞ Í∏∞Î°ù ÌëúÏãú
            if (events && events.length > 0) {
                let eventHtml = '';
                events.forEach(event => {
                    const eventType = event.type === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï';
                    const eventColor = event.type === 'absence' ? '#dc2626' : '#059669';
                    const eventIcon = event.type === 'absence' ? 'üö´' : '‚úÖ';
                    eventHtml += `
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem; margin-right: 0.5rem;">${eventIcon}</span>
                            <span style="color: ${eventColor}; font-weight: 600;">${eventType}: ${event.hours}ÏãúÍ∞Ñ</span>
                        </div>
                    `;
                });
                attendanceDetails.innerHTML = eventHtml;
            } else {
                attendanceDetails.innerHTML = '<div style="color: #94a3b8;">Ï∂úÍ≤∞ Î≥ÄÎèô ÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
            }
            
            modal.classList.add('show');
        }
        
        // ÎÇ†Ïßú ÏÉÅÏÑ∏ Î™®Îã¨ Îã´Í∏∞
        function closeDayDetails() {
            const modal = DOMCache.get('dayDetailsModal');
            rafSchedule.schedule(() => {
                modal.classList.remove('show');
            });
        }
        
        // Ï∂úÍ≤∞ Ï∂îÍ∞Ä Î™®Îã¨Î°ú Ï†ÑÌôò
        function switchToAttendanceModal() {
            closeDayDetails();
            if (currentDayData) {
                openModal(currentDayData.date, currentDayData.events);
            }
        }
        
        // Ï∂úÍ≤∞ Ï∂îÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞
        function openModal(date, events) {
            selectedModalDate = date;
            selectedModalHours = 0;
            
            const modal = DOMCache.get('attendanceModal');
            const dateDisplay = DOMCache.get('modalDateDisplay');
            const existingEvents = DOMCache.get('modalExistingEvents');
            
            // ÎÇ†Ïßú ÌëúÏãú
            const dateObj = new Date(date + 'T00:00:00');
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            dateDisplay.textContent = dateObj.toLocaleDateString('ko-KR', options);
            
            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ ÌëúÏãú
            if (events && events.length > 0) {
                let eventText = 'Ïù¥ ÎÇ†ÏßúÏùò Í∏∞Ï°¥ Í∏∞Î°ù: ';
                events.forEach(event => {
                    eventText += `${event.type === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï'} ${event.hours}ÏãúÍ∞Ñ, `;
                });
                existingEvents.innerHTML = `<strong>‚ö†Ô∏è Ï£ºÏùò:</strong> ${eventText.slice(0, -2)}`;
                existingEvents.style.display = 'block';
            } else {
                existingEvents.style.display = 'none';
            }
            
            // ÏãúÍ∞Ñ Î≤ÑÌäº Ï¥àÍ∏∞Ìôî - Performance: Batch DOM updates
            rafSchedule.schedule(() => {
                DOMCache.querySelectorAll('.modal-time-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            });
            
            // ÎÇ†Ïßú input ÏÑ§Ï†ï
            DOMCache.get('modalDateInput').value = date;
            
            modal.classList.add('show');
        }
        
        function closeModal() {
            const modal = DOMCache.get('attendanceModal');
            rafSchedule.schedule(() => {
                modal.classList.remove('show');
            });
        }
        
        function selectModalHours(hours, element) {
            selectedModalHours = hours;
            
            // Î™®Îì† Î≤ÑÌäºÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞ - Performance: Batch updates
            rafSchedule.schedule(() => {
                DOMCache.querySelectorAll('.modal-time-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            });
            
            // ÌÅ¥Î¶≠Îêú Î≤ÑÌäºÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            element.classList.add('selected');
        }
        
        function submitModalForm(type) {
            if (selectedModalHours === 0) {
                alert('ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ìèº ÏÉùÏÑ±ÌïòÏó¨ Ï†úÏ∂ú
            const form = document.createElement('form');
            form.method = 'POST';
            form.innerHTML = `
                <input type="hidden" name="action" value="${type}">
                <input type="hidden" name="selectedDate" value="${selectedModalDate}">
                <input type="hidden" name="selectedHours" value="${selectedModalHours}">
                <input type="hidden" name="userid" value="<?php echo $studentid; ?>">
            `;
            document.body.appendChild(form);
            form.submit();
        }
        
        // ÏïåÎ¶º ÌÜ†Í∏Ä - Performance: Use cached element
        function toggleNotifications() {
            const dropdown = DOMCache.get('notificationDropdown');
            rafSchedule.schedule(() => {
                dropdown.classList.toggle('show');
            });
        }
        
        // ÌïôÏÉù ÏÑ†ÌÉù (ÏïåÎ¶ºÏóêÏÑú)
        function selectStudent(studentId) {
            // ÌòÑÏû¨ Ïõî Ï†ïÎ≥¥ Ïú†ÏßÄÌïòÎ©¥ÏÑú ÌïôÏÉù ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            const currentMonth = '<?php echo $viewMonth; ?>';
            window.location.href = '?userid=' + studentId + '&month=' + currentMonth;
        }
        
        // Performance: Event delegation for better performance
        document.addEventListener('click', function(event) {
            // Handle modal time button clicks
            if (event.target.classList.contains('modal-time-btn')) {
                const hours = parseFloat(event.target.getAttribute('data-hours'));
                if (hours) {
                    selectModalHours(hours, event.target);
                }
                return;
            }
            
            // Handle delete button clicks
            if (event.target.classList.contains('delete-btn')) {
                const recordId = event.target.getAttribute('data-record-id');
                const eventType = event.target.getAttribute('data-event-type');
                if (recordId && eventType) {
                    deleteRecord(recordId, eventType);
                }
                return;
            }
            
            // Handle notification button click
            if (event.target.closest('.notification-btn')) {
                toggleNotifications();
                return;
            }
            
            // Handle student selection from notifications
            if (event.target.classList.contains('alert-student-link')) {
                const studentId = event.target.getAttribute('data-student-id');
                if (studentId) {
                    selectStudent(studentId);
                }
                return;
            }
            
            // Handle modal close on background click
            const attendanceModal = DOMCache.get('attendanceModal');
            const dayDetailsModal = DOMCache.get('dayDetailsModal');
            const notificationDropdown = DOMCache.get('notificationDropdown');
            const notificationBtn = DOMCache.querySelector('.notification-btn');
            
            if (event.target === attendanceModal) {
                closeModal();
            } else if (event.target === dayDetailsModal) {
                closeDayDetails();
            } else if (notificationBtn && !notificationBtn.contains(event.target) && 
                       notificationDropdown && !notificationDropdown.contains(event.target)) {
                rafSchedule.schedule(() => {
                    notificationDropdown.classList.remove('show');
                });
            }
        });
        
        // Performance: Fetch with caching and error handling
        const fetchCache = new Map();
        const CACHE_DURATION = 60000; // 1 minute cache
        
        async function cachedFetch(url, options = {}) {
            const cacheKey = url + JSON.stringify(options);
            const cached = fetchCache.get(cacheKey);
            
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return Promise.resolve(cached.data);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                fetchCache.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });
                
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
        
        // ÎπÑÎèôÍ∏∞Î°ú ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ Î°úÎìú - Optimized version
        const loadAlerts = debounce(async function() {
            try {
                const data = await cachedFetch('?ajax=alerts');
                if (data.error) {
                    console.error('Server error:', data.error);
                    updateNotificationUI([]);
                } else {
                    updateNotificationUI(data);
                }
            } catch (e) {
                console.error('Alert load error:', e);
                updateNotificationUI([]);
            }
        }, 300); // Debounce for 300ms
        
        // ÏïåÎ¶º UI ÏóÖÎç∞Ïù¥Ìä∏ - Performance: Use cached elements
        function updateNotificationUI(alerts) {
            const badge = DOMCache.get('notificationBadge');
            const dropdown = DOMCache.get('notificationDropdown');
            
            if (!alerts || alerts.length === 0) {
                // ÏïåÎ¶ºÏù¥ ÏóÜÏùÑ Îïå
                badge.style.display = 'none';
                dropdown.innerHTML = `
                    <div class="notification-header">
                        üì¢ Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌïú ÌïôÏÉù (0Î™Ö)
                    </div>
                    <div class="no-notifications">
                        ‚ú® ÌòÑÏû¨ Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌïú ÌïôÏÉùÏù¥ ÏóÜÏäµÎãàÎã§
                    </div>
                `;
            } else {
                // ÏïåÎ¶ºÏù¥ ÏûàÏùÑ Îïå
                badge.style.display = 'flex';
                badge.textContent = alerts.length;
                
                let dropdownHTML = `
                    <div class="notification-header">
                        üì¢ Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌïú ÌïôÏÉù (${alerts.length}Î™Ö)
                    </div>
                `;
                
                alerts.forEach(alert => {
                    let iconClass, icon, desc;
                    
                    if (alert.type === 'makeup_needed') {
                        iconClass = 'makeup';
                        icon = '‚ö†Ô∏è';
                        desc = `Î≥¥Í∞ï ÌïÑÏöî: ${parseFloat(alert.hours).toFixed(1)}ÏãúÍ∞Ñ`;
                    } else if (alert.type === 'extra_study') {
                        iconClass = 'extra';
                        icon = 'üåü';
                        desc = `Ï¥àÍ≥º ÌïôÏäµ: ${parseFloat(alert.hours).toFixed(1)}ÏãúÍ∞Ñ (Ïö∞Ïàò)`;
                    } else if (alert.type === 'surplus_study') {
                        iconClass = 'surplus';
                        icon = '‚úÖ';
                        desc = `Ï∂îÍ∞Ä ÌïôÏäµ: ${parseFloat(alert.hours).toFixed(1)}ÏãúÍ∞Ñ`;
                    }
                    
                    dropdownHTML += `
                        <div class="notification-item" onclick="selectStudent(${alert.id})">
                            <div class="notification-icon ${iconClass}">${icon}</div>
                            <div class="notification-content">
                                <div class="notification-title">${alert.name}</div>
                                <div class="notification-desc">${desc}</div>
                            </div>
                        </div>
                    `;
                });
                
                dropdown.innerHTML = dropdownHTML;
            }
        }
        
        // ÌïôÏÉù Î™©Î°ù Î°úÎìú
        function loadStudents(search = '') {
            const url = search ? `?ajax=students&search=${encodeURIComponent(search)}` : '?ajax=students';
            console.log('Loading students from:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Students data received:', data);
                    if (data.status === 'success') {
                        updateStudentList(data.data);
                    } else if (data.status === 'error') {
                        console.error('Server error:', data.message);
                        const studentList = document.getElementById('studentList');
                        if (studentList) {
                            studentList.innerHTML = '<li class="no-results">ÏÑúÎ≤Ñ Ïò§Î•ò: ' + (data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò') + '</li>';
                        }
                    } else {
                        // Ïù¥Ï†Ñ ÌòïÏãù Ìò∏ÌôòÏÑ±
                        updateStudentList(data);
                    }
                })
                .catch(error => {
                    console.error('ÌïôÏÉù Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                    const studentList = document.getElementById('studentList');
                    if (studentList) {
                        studentList.innerHTML = '<li class="no-results">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</li>';
                    }
                });
        }
        
        // ÌïôÏÉù Î™©Î°ù UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudentList(students) {
            const studentList = document.getElementById('studentList');
            if (!studentList) return;
            
            if (students.length === 0) {
                studentList.innerHTML = '<li class="no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</li>';
                return;
            }
            
            const currentUserId = new URLSearchParams(window.location.search).get('userid');
            const searchParam = '<?php echo urlencode($searchQuery); ?>';
            const monthParam = '<?php echo $viewMonth; ?>';
            
            studentList.innerHTML = students.map(student => `
                <li class="student-item ${student.id == currentUserId ? 'active' : ''}" 
                    onclick="window.location.href='?userid=${student.id}&search=${searchParam}&month=${monthParam}'">
                    ${student.name}
                </li>
            `).join('');
        }
        
        // Ïã§ÏãúÍ∞Ñ Í≤ÄÏÉâ Í∏∞Îä•
        document.addEventListener('DOMContentLoaded', function() {
            // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ ÎπÑÎèôÍ∏∞Î°ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            setTimeout(() => {
                loadAlerts();
                loadStudents('<?php echo addslashes($searchQuery); ?>');
            }, 50);
            
            const searchInput = document.getElementById('searchInput');
            const studentList = document.getElementById('studentList');
            
            if (searchInput) {
                let searchTimeout;
                
                // Ïã§ÏãúÍ∞Ñ Í≤ÄÏÉâ (ÎîîÎ∞îÏö¥Ïã± Ï†ÅÏö©)
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const searchTerm = this.value.trim();
                    
                    searchTimeout = setTimeout(() => {
                        loadStudents(searchTerm);
                    }, 300); // 300ms ÎîîÎ∞îÏö¥Ïã±
                });
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÍµêÏÇ¨Ïö© Ï∂úÍ≤∞Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
            <p><?php echo htmlspecialchars($USER->firstname . ' ' . $USER->lastname); ?> ÏÑ†ÏÉùÎãò 
               <?php if (!empty($tsymbol)): ?>
               <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; margin: 0 10px;">
                   Îã¥Îãπ: <?php echo $tsymbol; ?>
               </span>
               <?php endif; ?>
               | <a href="/moodle/login/logout.php" style="color: white;">Î°úÍ∑∏ÏïÑÏõÉ</a></p>
            
            <!-- ÏïåÎ¶º Î≤ÑÌäº -->
            <button class="notification-btn" onclick="toggleNotifications()" id="notificationBtn">
                üîî ÏïåÎ¶º
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            
            <!-- ÏïåÎ¶º ÎìúÎ°≠Îã§Ïö¥ -->
            <div id="notificationDropdown" class="notification-dropdown">
                <div class="notification-header">
                    üì¢ ÏïåÎ¶º Î°úÎî©Ï§ë...
                </div>
                <div class="no-notifications">
                    <div style="text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
                    </div>
                </div>
            </div>
        </div>
        
        <?php if ($success): ?>
            <div class="alert success"><?php echo htmlspecialchars($success); ?></div>
        <?php endif; ?>
        
        <?php if ($error): ?>
            <div class="alert error"><?php echo htmlspecialchars($error); ?></div>
        <?php endif; ?>
        
        <div class="main-grid">
            <div class="sidebar">
                <h3>ÌïôÏÉù Î™©Î°ù</h3>
                
                <!-- Í≤ÄÏÉâ Î∞ïÏä§ -->
                <form method="GET" action="">
                    <?php if ($studentid > 0): ?>
                        <input type="hidden" name="userid" value="<?php echo $studentid; ?>">
                    <?php endif; ?>
                    <?php if ($viewMonth): ?>
                        <input type="hidden" name="month" value="<?php echo htmlspecialchars($viewMonth); ?>">
                    <?php endif; ?>
                    <div class="search-box">
                        <input type="text" 
                               name="search" 
                               id="searchInput"
                               class="search-input" 
                               placeholder="ÌïôÏÉù Ïù¥Î¶Ñ Í≤ÄÏÉâ..." 
                               value="<?php echo htmlspecialchars($searchQuery); ?>"
                               autocomplete="off">
                        <button type="submit" class="search-btn">Í≤ÄÏÉâ</button>
                    </div>
                </form>
                
                <?php if ($searchQuery): ?>
                    <a href="?" class="clear-search">‚úñ Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî</a>
                    <div style="margin: 10px 0; font-size: 13px; color: #64748b;">
                        Í≤ÄÏÉâÍ≤∞Í≥º: <?php echo count($students); ?>Î™Ö / Ï†ÑÏ≤¥: <?php echo $totalCount; ?>Î™Ö
                    </div>
                <?php else: ?>
                    <?php if (count($students) > 0): ?>
                    <div style="margin: 10px 0; font-size: 13px; color: #64748b;">
                        Ï†ÑÏ≤¥ ÌïôÏÉù: <?php echo count($students); ?>Î™Ö
                        <?php if (count($students) != $totalCount): ?>
                            <span style="color: #ef4444;"> (DB: <?php echo $totalCount; ?>Î™Ö)</span>
                        <?php endif; ?>
                    </div>
                    <?php endif; ?>
                <?php endif; ?>
                
                <ul class="student-list" id="studentList">
                    <li class="no-results">ÌïôÏÉù Î™©Î°ù Î°úÎî©Ï§ë...</li>
                </ul>
            </div>
            
            <div class="content">
                <?php if ($studentid > 0 && $thisuser): ?>
                    <h2><?php echo htmlspecialchars($stdname); ?> ÌïôÏÉù Ï∂úÍ≤∞ Í¥ÄÎ¶¨</h2>
                    
                    <!-- ÏÉÅÌÉú Ïπ¥Îìú -->
                    <?php 
                    // ÎîîÎ≤ÑÍ∑∏: Ï∂úÍ≤∞ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                    error_log("Attendance Data for student $studentid: " . json_encode($attendanceData));
                    ?>
                    <div class="status-container">
                        <div class="status-card">
                            <div class="status-value"><?php echo number_format($attendanceData['totalAbsence'], 1); ?></div>
                            <div class="status-label">Ï¥ù Ìú¥Í∞ï ÏãúÍ∞Ñ</div>
                        </div>
                        <div class="status-card">
                            <div class="status-value"><?php echo number_format($attendanceData['pastMakeup'] + $attendanceData['futureMakeup'], 1); ?></div>
                            <div class="status-label">Î≥¥Í∞ï ÏãúÍ∞Ñ</div>
                        </div>
                        <?php if (isset($attendanceData['extraStudyHours']) && $attendanceData['extraStudyHours'] > 0): ?>
                        <div class="status-card" style="background: #e0f2fe;">
                            <div class="status-value" style="color: #0369a1;"><?php echo number_format($attendanceData['extraStudyHours'], 1); ?></div>
                            <div class="status-label">Ï¥àÍ≥º ÌïôÏäµ Ïù∏Ï†ï</div>
                        </div>
                        <?php endif; ?>
                        <div class="status-card <?php echo $attendanceData['neededMakeup'] > 0 ? 'alert' : ($attendanceData['neededMakeup'] < 0 ? '' : ''); ?>" 
                             style="<?php echo $attendanceData['neededMakeup'] < 0 ? 'background: #dcfce7;' : ''; ?>">
                            <div class="status-value" style="<?php echo $attendanceData['neededMakeup'] < 0 ? 'color: #16a34a;' : ''; ?>">
                                <?php 
                                    // ÎßàÏù¥ÎÑàÏä§ Í∞íÎèÑ ÌëúÏãú
                                    echo ($attendanceData['neededMakeup'] < 0 ? '' : '') . number_format($attendanceData['neededMakeup'], 1); 
                                ?>
                            </div>
                            <div class="status-label">
                                <?php echo $attendanceData['neededMakeup'] < 0 ? 'Ï∂îÍ∞Ä ÌïôÏäµ ÏãúÍ∞Ñ' : 'Î≥¥Í∞ï ÌïÑÏöî'; ?>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ï∫òÎ¶∞Îçî Î∑∞ -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h3>ÏõîÍ∞Ñ Ï∂úÍ≤∞ Ï∫òÎ¶∞Îçî</h3>
                            <div class="calendar-nav">
                                <button onclick="location.href='?userid=<?php echo $studentid; ?>&search=<?php echo urlencode($searchQuery); ?>&month=<?php echo date('Y-m', strtotime($viewMonth . ' -1 month')); ?>'">
                                    ‚óÄ Ïù¥Ï†ÑÎã¨
                                </button>
                                <div class="calendar-current-month">
                                    <?php echo date('YÎÖÑ nÏõî', strtotime($viewMonth . '-01')); ?>
                                </div>
                                <button onclick="location.href='?userid=<?php echo $studentid; ?>&search=<?php echo urlencode($searchQuery); ?>&month=<?php echo date('Y-m', strtotime($viewMonth . ' +1 month')); ?>'">
                                    Îã§ÏùåÎã¨ ‚ñ∂
                                </button>
                            </div>
                        </div>
                        
                        <div class="calendar-grid">
                            <?php
                            // ÏöîÏùº Ìó§Îçî
                            $weekDays = array('Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†');
                            foreach ($weekDays as $index => $day):
                                $headerClass = 'calendar-day-header';
                                if ($index === 0) $headerClass .= ' sunday';
                                if ($index === 6) $headerClass .= ' saturday';
                            ?>
                                <div class="<?php echo $headerClass; ?>"><?php echo $day; ?></div>
                            <?php endforeach; ?>
                            
                            <?php
                            // Îã¨Î†• ÎÇ†Ïßú ÏÉùÏÑ±
                            $firstDay = date('w', strtotime($viewMonth . '-01'));
                            $lastDay = date('t', strtotime($viewMonth . '-01'));
                            $today = date('Y-m-d');
                            
                            // Îπà Ïπ∏ Ï±ÑÏö∞Í∏∞ (Ïù¥Ï†Ñ Îã¨)
                            for ($i = 0; $i < $firstDay; $i++): ?>
                                <div class="calendar-day other-month"></div>
                            <?php endfor; ?>
                            
                            <?php
                            // ÎÇ†Ïßú ÌëúÏãú
                            for ($day = 1; $day <= $lastDay; $day++):
                                $currentDate = $viewMonth . '-' . str_pad($day, 2, '0', STR_PAD_LEFT);
                                $dayOfWeek = date('w', strtotime($currentDate));
                                
                                $dayClass = 'calendar-day';
                                if ($currentDate === $today) $dayClass .= ' today';
                                if ($dayOfWeek === 0) $dayClass .= ' sunday';
                                if ($dayOfWeek === 6) $dayClass .= ' saturday';
                                
                                // date_key Ìè¨Îß∑Ïù¥ Ïù¥ÎØ∏ Y-m-dÏù¥ÎØÄÎ°ú Î∞îÎ°ú ÏÇ¨Ïö©
                                $dayEvents = isset($calendarData[$currentDate]) ? $calendarData[$currentDate] : array();
                                
                                // Ï†ïÍ∑úÏàòÏóÖ Ïó¨Î∂Ä ÌôïÏù∏ (ÏãúÍ∞ÑÌëú Í∏∞Î∞ò)
                                $isRegularDay = false;
                                $regularHours = 0;
                                if ($schedule) {
                                    // ÏöîÏùºÏóê ÎßûÎäî duration ÌïÑÎìú ÌôïÏù∏
                                    // duration1=Ïõî, duration2=Ìôî, ..., duration7=Ïùº
                                    if ($dayOfWeek == 0) { // ÏùºÏöîÏùº
                                        $duration_field = 'duration7';
                                    } else { // Ïõî(1) ~ ÌÜ†(6)
                                        $duration_field = 'duration' . $dayOfWeek;
                                    }
                                    
                                    $regularHours = isset($schedule->$duration_field) ? floatval($schedule->$duration_field) : 0;
                                    $isRegularDay = $regularHours > 0;
                                }
                                
                                // JavaScriptÏö© Ïù¥Î≤§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                                $jsEvents = array();
                                foreach ($dayEvents as $event) {
                                    $jsEvents[] = array(
                                        'type' => $event->event,
                                        'hours' => $event->amount
                                    );
                                }
                                $jsEventsJson = htmlspecialchars(json_encode($jsEvents), ENT_QUOTES, 'UTF-8');
                                
                                // ÌïôÏäµ ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                                $studyInfo = isset($studyData[$currentDate]) ? $studyData[$currentDate] : null;
                                $studyHours = $studyInfo ? $studyInfo->hours : 0;
                                $actualStart = $studyInfo ? $studyInfo->actual_start : '';
                                $actualEnd = $studyInfo ? $studyInfo->actual_end : '';
                                $targetStart = $studyInfo ? $studyInfo->target_start : 0;
                                $targetEnd = $studyInfo ? $studyInfo->target_end : 0;
                                $logCount = $studyInfo ? $studyInfo->log_count : 0;
                                
                                // Ï¥àÍ≥º ÌïôÏäµ Ïó¨Î∂Ä ÌôïÏù∏ (Ï†ïÍ∑ú ÏàòÏóÖ ÏãúÍ∞ÑÎ≥¥Îã§ 1ÏãúÍ∞Ñ Ïù¥ÏÉÅ Îçî Í≥µÎ∂Ä)
                                $isExtraStudy = false;
                                $extraHours = 0;
                                if ($studyHours > 0 && $regularHours > 0 && $studyHours > ($regularHours + 1)) {
                                    $isExtraStudy = true;
                                    $extraHours = $studyHours - $regularHours;
                                }
                                
                                // JavaScriptÏóê Ï†ÑÎã¨Ìï† ÌïôÏäµ Îç∞Ïù¥ÌÑ∞
                                $studyDataJson = htmlspecialchars(json_encode(array(
                                    'hours' => $studyHours,
                                    'actualStart' => $actualStart,
                                    'actualEnd' => $actualEnd,
                                    'targetStart' => $targetStart,
                                    'targetEnd' => $targetEnd,
                                    'logCount' => $logCount
                                )), ENT_QUOTES, 'UTF-8');
                            ?>
                                <div class="<?php echo $dayClass; ?>" 
                                     onclick="openDayDetails('<?php echo $currentDate; ?>', <?php echo $jsEventsJson; ?>, <?php echo $regularHours; ?>, <?php echo $studyDataJson; ?>)"
                                     style="cursor: pointer;">
                                    <div class="calendar-day-number"><?php echo $day; ?></div>
                                    <div class="calendar-events">
                                        <?php 
                                        // ÌïôÏäµ ÏãúÍ∞Ñ ÌëúÏãú (Ïã§Ï†ú Í≥µÎ∂ÄÌïú Í≤ΩÏö∞)
                                        if ($studyHours > 0): 
                                            $studyBg = $isExtraStudy ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #3b82f6, #2563eb)';
                                            $studyTitle = "ÌïôÏäµÏãúÍ∞Ñ: " . $actualStart . " ~ " . $actualEnd;
                                            if ($isExtraStudy) {
                                                $studyTitle .= " (Ï¥àÍ≥º: +" . number_format($extraHours, 1) . "h)";
                                            }
                                        ?>
                                            <div class="calendar-event study" style="background: <?php echo $studyBg; ?>; color: white;" 
                                                 title="<?php echo $studyTitle; ?>">
                                                <?php echo $isExtraStudy ? 'üåü' : 'üìö'; ?> <?php echo number_format($studyHours, 1); ?>h
                                                <?php if ($isExtraStudy): ?>
                                                    <span style="font-size: 0.8em; margin-left: 2px;">(+<?php echo number_format($extraHours, 1); ?>)</span>
                                                <?php endif; ?>
                                            </div>
                                        <?php endif; ?>
                                        
                                        <?php 
                                        // Ï†ïÍ∑úÏàòÏóÖ ÌëúÏãú
                                        if ($isRegularDay): ?>
                                            <div class="calendar-event regular" title="Ï†ïÍ∑úÏàòÏóÖ">
                                                Ï†ïÍ∑ú <?php echo number_format($regularHours, 1); ?>h
                                            </div>
                                        <?php endif; ?>
                                        
                                        <?php 
                                        // Ìú¥Í∞ï/Î≥¥Í∞ï ÌëúÏãú
                                        if (!empty($dayEvents)):
                                            foreach ($dayEvents as $event): ?>
                                                <div class="calendar-event <?php echo htmlspecialchars($event->event); ?>" 
                                                     title="<?php echo $event->event === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï'; ?> - <?php echo date('Y-m-d', $event->due); ?>">
                                                    <?php echo $event->event === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï'; ?> 
                                                    <?php echo number_format($event->amount, 1); ?>h
                                                </div>
                                            <?php endforeach;
                                        endif; ?>
                                    </div>
                                </div>
                            <?php endfor; ?>
                            
                            <?php
                            // ÎÇ®ÏùÄ Îπà Ïπ∏ Ï±ÑÏö∞Í∏∞
                            $remainingDays = 42 - ($firstDay + $lastDay);
                            for ($i = 0; $i < $remainingDays; $i++): ?>
                                <div class="calendar-day other-month"></div>
                            <?php endfor; ?>
                        </div>
                        
                        <!-- Î≤îÎ°Ä -->
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                                <span>ÌïôÏäµÏãúÍ∞Ñ</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: linear-gradient(135deg, #10b981, #059669);"></div>
                                <span>Ï¥àÍ≥ºÌïôÏäµ üåü</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color regular"></div>
                                <span>Ï†ïÍ∑úÏàòÏóÖ</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color absence"></div>
                                <span>Ìú¥Í∞ï</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color makeup"></div>
                                <span>Î≥¥Í∞ï</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÏãúÍ∞ÑÌëú -->
                    <?php if ($schedule): ?>
                        <h3>Ï£ºÍ∞Ñ ÏãúÍ∞ÑÌëú</h3>
                        <div class="schedule-grid">
                            <?php 
                            $days = array('Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº');
                            $weektotal = 0;
                            for ($i = 1; $i <= 7; $i++):
                                $duration_field = 'duration' . $i;
                                $duration = isset($schedule->$duration_field) ? floatval($schedule->$duration_field) : 0;
                                $weektotal += $duration;
                                $is_active = $duration > 0;
                            ?>
                                <div class="schedule-day <?php echo $is_active ? 'active' : ''; ?>" 
                                     title="duration<?php echo $i; ?> = <?php echo $duration; ?>">
                                    <strong><?php echo $days[$i-1]; ?></strong><br>
                                    <?php echo $duration > 0 ? $duration . 'ÏãúÍ∞Ñ' : 'Ìú¥Î¨¥'; ?>
                                </div>
                            <?php endfor; ?>
                        </div>
                        <p style="margin-top: 1rem;">Ï£ºÍ∞Ñ Ï¥ù ÏãúÍ∞Ñ: <?php echo $weektotal; ?>ÏãúÍ∞Ñ</p>
                    <?php else: ?>
                        <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #92400e;">‚ö†Ô∏è ÏãúÍ∞ÑÌëúÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïÑ Ï†ïÍ∑úÏàòÏóÖÏù¥ ÌëúÏãúÎêòÏßÄ ÏïäÏäµÎãàÎã§.</p>
                        </div>
                    <?php endif; ?>
                    
                    <!-- ÏµúÍ∑º Í∏∞Î°ù -->
                    <h3>ÏµúÍ∑º Ï∂úÍ≤∞ Í∏∞Î°ù</h3>
                    <?php if ($notifications): ?>
                        <?php foreach ($notifications as $record): ?>
                            <div class="record <?php echo $record->event; ?>">
                                <div class="record-info">
                                    <span style="font-size: 16px; margin-right: 8px;">
                                        <?php echo $record->event === 'absence' ? 'üö´' : '‚úÖ'; ?>
                                    </span>
                                    <strong><?php echo date('Y-m-d (D)', $record->due); ?></strong> - 
                                    <?php echo $record->event === 'absence' ? 'Ìú¥Í∞ï' : 'Î≥¥Í∞ï'; ?> 
                                    <span style="font-weight: bold; font-size: 15px;"><?php echo $record->amount; ?>ÏãúÍ∞Ñ</span>
                                    <?php if ($record->text): ?>
                                        (<?php echo htmlspecialchars($record->text); ?>)
                                    <?php endif; ?>
                                    <span style="font-size: 11px; color: #6b7280; margin-left: 10px;">
                                        Îì±Î°ù: <?php echo date('m/d H:i', $record->timecreated); ?>
                                    </span>
                                </div>
                                <button type="button" 
                                        class="btn-delete"
                                        onclick="deleteRecord(<?php echo $record->id; ?>, '<?php echo $record->event; ?>')"
                                        title="Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï©ÎãàÎã§">
                                    ‚úñ ÏÇ≠Ï†ú
                                </button>
                            </div>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <p>Ï∂úÍ≤∞ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <?php endif; ?>
                    
                <?php else: ?>
                    <div class="no-data">
                        <h2>ÌïôÏÉùÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h2>
                        <p>ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú Í¥ÄÎ¶¨Ìï† ÌïôÏÉùÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ï∂úÍ≤∞ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÍ≥† Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <!-- ÎÇ†Ïßú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ -->
    <div id="dayDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ ÏùºÏùº ÌïôÏäµ Í∏∞Î°ù</h2>
                <button class="modal-close" onclick="closeDayDetails()">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-date-display" id="detailsDateDisplay">
                    <!-- ÎÇ†ÏßúÍ∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
                
                <!-- ÌïôÏäµ ÏãúÍ∞Ñ Ï†ïÎ≥¥ -->
                <div id="studyTimeSection" style="margin: 1.5rem 0; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1.1rem;">üìö ÌïôÏäµ ÏãúÍ∞Ñ</h3>
                    <div id="studyTimeDetails">
                        <!-- ÌïôÏäµ ÏãúÍ∞Ñ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                
                <!-- Ï†ïÍ∑ú ÏàòÏóÖ Ï†ïÎ≥¥ -->
                <div id="regularClassSection" style="margin: 1.5rem 0; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <h3 style="margin: 0 0 1rem 0; color: #15803d; font-size: 1.1rem;">üìñ Ï†ïÍ∑ú ÏàòÏóÖ</h3>
                    <div id="regularClassDetails">
                        <!-- Ï†ïÍ∑ú ÏàòÏóÖ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                
                <!-- Ï∂úÍ≤∞ Í∏∞Î°ù -->
                <div id="attendanceSection" style="margin: 1.5rem 0; padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h3 style="margin: 0 0 1rem 0; color: #92400e; font-size: 1.1rem;">üìù Ï∂úÍ≤∞ Í∏∞Î°ù</h3>
                    <div id="attendanceDetails">
                        <!-- Ï∂úÍ≤∞ Í∏∞Î°ùÏù¥ Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
                
                <!-- ÏàòÏóÖ Ï∂îÍ∞Ä Î≤ÑÌäº -->
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button type="button" 
                            style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;"
                            onclick="switchToAttendanceModal()">
                        ‚ûï Ìú¥Í∞ï/Î≥¥Í∞ï Ï∂îÍ∞Ä
                    </button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" 
                        style="background-color: #64748b; color: white;"
                        onclick="closeDayDetails()">
                    Îã´Í∏∞
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ï∂úÍ≤∞ Ï∂îÍ∞Ä Î™®Îã¨ -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ï∂úÍ≤∞ Í∏∞Î°ù Ï∂îÍ∞Ä</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-date-display" id="modalDateDisplay">
                    <!-- ÎÇ†ÏßúÍ∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
                
                <div class="modal-existing-events" id="modalExistingEvents" style="display: none;">
                    <!-- Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏Í∞Ä Ïó¨Í∏∞ ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
                
                <input type="hidden" id="modalDateInput" value="">
                
                <label style="font-weight: 600; color: #475569; margin-bottom: 0.5rem; display: block;">
                    ÏãúÍ∞Ñ ÏÑ†ÌÉù
                </label>
                <div class="modal-time-grid">
                    <?php for ($i = 0.5; $i <= 6; $i += 0.5): ?>
                        <button type="button" 
                                class="modal-time-btn" 
                                onclick="selectModalHours(<?php echo $i; ?>, this)">
                            <?php echo $i; ?>ÏãúÍ∞Ñ
                        </button>
                    <?php endfor; ?>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" 
                        style="background-color: #f97316; color: white;"
                        onclick="submitModalForm('absence')">
                    üö´ Ìú¥Í∞ï Ï∂îÍ∞Ä
                </button>
                <button type="button" 
                        style="background-color: #14b8a6; color: white;"
                        onclick="submitModalForm('makeup')">
                    ‚úÖ Î≥¥Í∞ï Ï∂îÍ∞Ä
                </button>
                <button type="button" 
                        style="background-color: #64748b; color: white;"
                        onclick="closeModal()">
                    Ï∑®ÏÜå
                </button>
            </div>
        </div>
    </div>
    <!-- ÌéòÏù¥ÏßÄ Î°úÎî© ÏãúÍ∞Ñ ÌëúÏãú -->
    <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px;">
        <?php 
        $end_time = microtime(true);
        $execution_time = round(($end_time - $start_time) * 1000, 2);
        echo "Î°úÎî© ÏãúÍ∞Ñ: {$execution_time}ms";
        ?>
    </div>
</body>
</html>