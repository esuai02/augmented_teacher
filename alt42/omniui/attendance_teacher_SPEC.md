# 교사용 출결관리 시스템 명세서

## 1. 개요

### 1.1 목적
교사가 담당 학생들의 출결(휴강/보강)을 관리하고, 학습 시간을 추적하여 보강 필요 여부를 판단할 수 있는 웹 기반 관리 시스템입니다.

### 1.2 핵심 의도
- **출결 관리**: 학생의 휴강 및 보강 시간을 기록하고 관리
- **학습 추적**: 실제 학습 시간을 모니터링하여 정규 수업 대비 초과 학습 시간 계산
- **보강 판단**: 최근 3주간의 휴강 시간과 보강 시간을 비교하여 보강 필요 여부 자동 계산
- **시각화**: 월간 캘린더를 통한 출결 현황 한눈에 파악
- **알림**: 보강이 필요하거나 초과 학습을 한 학생을 자동으로 알림

## 2. 기능 요구사항

### 2.1 권한 관리
- **교사 인증**: 
  - `lastname`에 'T'가 포함되거나
  - `mdl_user_info_data` 테이블의 `fieldid=22`에서 `role`이 'student'가 아닌 경우
- **담당 학생 필터링**: 
  - 교사 심볼(이모티콘)을 기반으로 담당 학생만 표시
  - 학생의 `firstname`에 교사 심볼이 포함된 경우만 조회

### 2.2 학생 목록 관리
- **학생 목록 조회**: AJAX를 통한 비동기 로드
- **검색 기능**: 이름, 이메일로 실시간 검색 (디바운싱 적용)
- **학생 선택**: 클릭 시 해당 학생의 출결 정보 표시

### 2.3 출결 기록 관리
- **휴강 기록 추가**: 날짜와 시간(0.5~6시간, 0.5시간 단위) 선택하여 추가
- **보강 기록 추가**: 날짜와 시간 선택하여 추가
- **기록 삭제**: 기존 기록을 `hide=1`로 설정하여 숨김 처리 (완전 삭제 아님)
- **기록 조회**: 최근 20개 기록 표시

### 2.4 출결 시간 계산
- **기준 기간**: 최근 3주 (21일)
- **계산 항목**:
  1. **총 휴강 시간**: `event='absence'`인 기록의 `amount` 합계
  2. **과거 보강 시간**: `event='makeup'`이고 `due < 현재시간`인 기록의 합계
  3. **미래 보강 시간**: `event='makeup'`이고 `due >= 현재시간`인 기록의 합계
  4. **초과 학습 시간**: 
     - 학생의 시간표(`mdl_abessi_schedule`)에서 정규 수업 시간 확인
     - 학습 로그(`mdl_abessi_missionlog`)에서 실제 학습 시간 계산
     - 정규 수업 시간보다 1시간 이상 더 공부한 경우 초과 시간으로 인정
  5. **보강 필요 시간**: `총 휴강 - (과거 보강 + 미래 보강 + 초과 학습)`
     - 마이너스 값 허용 (추가 학습 시간으로 표시)

### 2.5 캘린더 뷰
- **월간 캘린더**: 선택한 월의 출결 현황을 캘린더 형식으로 표시
- **날짜별 정보 표시**:
  - 학습 시간 (실제 공부한 시간)
  - 초과 학습 (정규 수업보다 1시간 이상 더 공부한 경우)
  - 정규 수업 (시간표 기반)
  - 휴강/보강 기록
- **날짜 클릭**: 해당 날짜의 상세 정보 모달 표시
- **월 이동**: 이전달/다음달 버튼으로 월 변경

### 2.6 알림 시스템
- **알림 대상**:
  1. **보강 필요**: 보강 필요 시간이 4시간 이상인 학생
  2. **초과 학습**: 초과 학습 시간이 있는 학생 (우수)
  3. **추가 학습**: 보강 필요 시간이 -5시간 이하인 학생 (추가 학습 시간)
- **알림 표시**: 헤더의 알림 버튼에 배지 표시 및 드롭다운 목록
- **알림 클릭**: 해당 학생의 상세 페이지로 이동

### 2.7 시간표 표시
- **주간 시간표**: 학생의 정규 수업 시간표 표시
- **요일별 시간**: 월~일 각 요일별 수업 시간 표시
- **주간 총 시간**: 일주일 총 수업 시간 합계

## 3. 데이터베이스 스키마

### 3.1 사용 테이블
- `mdl_user`: 사용자 기본 정보
- `mdl_user_info_data`: 사용자 역할 정보 (`fieldid=22`)
- `mdl_abessi_classtimemanagement`: 출결 기록
  - `id`: 기록 ID
  - `userid`: 학생 ID
  - `event`: 'absence' 또는 'makeup'
  - `amount`: 시간 (float)
  - `due`: 날짜 (timestamp)
  - `hide`: 숨김 여부 (0=표시, 1=숨김)
  - `timecreated`: 생성 시간
  - `role`: 'teacher'
  - `text`: 메모
- `mdl_abessi_schedule`: 학생 시간표
  - `userid`: 학생 ID
  - `pinned`: 고정 여부 (1=사용 중)
  - `duration1` ~ `duration7`: 월~일 각 요일별 수업 시간
- `mdl_abessi_missionlog`: 학습 로그
  - `userid`: 학생 ID
  - `timecreated`: 로그 생성 시간 (timestamp)
- `mdl_abessi_teacher`: 교사 정보 (선택적)

## 4. 성능 요구사항

### 4.1 최적화 기법
- **쿼리 캐싱**: `QueryCache` 클래스를 통한 5분간 쿼리 결과 캐싱
- **AJAX 로딩**: 학생 목록 및 상세 정보를 비동기로 로드
- **배치 처리**: 여러 학생의 출결 시간을 한 번에 계산
- **디바운싱**: 검색 입력에 300ms 디바운싱 적용
- **DOM 캐싱**: 자주 사용하는 DOM 요소 캐싱

### 4.2 응답 시간
- 페이지 초기 로드: 200ms 이하 목표
- AJAX 요청: 500ms 이하 목표
- 캐시 히트율: 70% 이상 목표

## 5. 보안 요구사항

### 5.1 인증 및 권한
- Moodle `require_login()` 사용
- 교사 권한 확인 필수
- 담당 학생만 조회 가능 (교사 심볼 기반 필터링)

### 5.2 입력 검증
- SQL Injection 방지: Prepared Statement 사용
- XSS 방지: `htmlspecialchars()` 사용
- 입력 값 검증: 날짜 형식, 시간 범위 검증

### 5.3 데이터 무결성
- 기록 삭제 시 완전 삭제 대신 `hide=1`로 설정
- 학생 ID와 기록 ID 일치 확인 후 삭제

## 6. 사용자 인터페이스

### 6.1 레이아웃
- **헤더**: 제목, 교사 정보, 알림 버튼
- **사이드바**: 학생 목록 및 검색
- **메인 영역**: 선택한 학생의 출결 정보
  - 상태 카드 (총 휴강, 보강, 보강 필요)
  - 월간 캘린더
  - 시간표
  - 최근 기록

### 6.2 모달
- **날짜 상세 모달**: 선택한 날짜의 학습 시간, 정규 수업, 출결 기록 표시
- **출결 추가 모달**: 휴강/보강 기록 추가

### 6.3 반응형 디자인
- 최소 기능적 UI (프로젝트 규칙 준수)
- 모바일 친화적 레이아웃

## 7. 에러 처리

### 7.1 에러 메시지
- 모든 에러 메시지에 파일명과 위치 정보 포함
- 사용자 친화적 메시지 표시
- 에러 로그 기록 (`error_log()`)

### 7.2 예외 상황
- 학생을 찾을 수 없는 경우
- 권한이 없는 경우
- 데이터베이스 오류
- AJAX 요청 실패 (재시도 버튼 제공)

## 8. 기술 스택

- **서버**: PHP 7.1.9
- **데이터베이스**: MySQL 5.7
- **프론트엔드**: HTML5, CSS3, JavaScript (Vanilla)
- **프레임워크**: Moodle (Moodle API 사용)

## 9. 제약사항

- 파일 크기: 20KB 초과 또는 500줄 초과 시 리팩토링 필요
- 서버 환경: 실제 서버에 연결된 방식 (로컬 테스트 불가)
- Moodle 의존성: Moodle 설정 파일 및 API 필수

## 10. 향후 개선 사항

- 출결 통계 리포트 생성
- 엑셀 내보내기 기능
- 알림 이메일 발송
- 출결 패턴 분석

