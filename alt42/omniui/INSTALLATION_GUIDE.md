# 교사용 출결관리 시스템 설치 가이드

## 시스템 개요
Mathking 교사용 출결관리 시스템은 학생들의 온라인 수업 출석을 자동화하고, 교사가 필요시 수정할 수 있는 스마트 출결관리 도구입니다.

## 주요 기능
- **완전 자동화 출결 감지**: 학생 접속시 자동으로 정규/보강 수업 분류
- **실시간 알림**: 결석, 예정외 접속, 수업 연장 등 즉시 알림
- **유연한 수정 권한**: 교사가 모든 자동 처리 데이터 수정 가능
- **자동 정산**: 매일 자정 일일 정산 및 리포트 생성

## 설치 방법

### 1. 데이터베이스 테이블 생성
```sql
-- attendance_tables.sql 파일의 내용을 실행
mysql -h 58.180.27.46 -u moodle -p mathking < attendance_tables.sql
```

### 2. 파일 업로드
Moodle 루트 디렉토리 기준으로 다음 위치에 파일 업로드:
- `/teacher_attendance_system.php` - 메인 인터페이스
- `/ajax_attendance.php` - AJAX 처리 파일

### 3. 권한 설정
```bash
chmod 755 teacher_attendance_system.php
chmod 755 ajax_attendance.php
```

### 4. Moodle 설정
1. 관리자로 로그인
2. 사이트 관리 > 플러그인 > 사용자 정의 필드
3. 'attendance_stats' 필드가 생성되었는지 확인

## 사용 방법

### 교사 접속
1. Mathking에 교사 계정으로 로그인
2. `/teacher_attendance_system.php` 접속
3. 담당 학생 목록 확인

### 주요 워크플로우

#### 1. 정규수업 결석 처리
- 수업 시작 15분 후 자동 결석 감지
- 상단 알림 버튼에 빨간색 숫자 표시
- 알림 클릭 → 결석 처리 모달
- 결석 사유 선택 및 보강 필요 시간 입력

#### 2. 보강수업 승인
- 학생이 비정규일 접속시 자동 감지
- 알림 확인 → 보강 승인/자습 처리 선택
- 승인시 보강 필요 시간에서 자동 차감

#### 3. 수업시간 연장 처리
- 정규 종료시간 초과시 자동 감지
- 무료 연장 / 보강 차감 / 시간 수정 선택

### 데이터 수정
- 학생 행의 편집 버튼 클릭
- 보강 예정/필요/총 휴강 시간 직접 수정
- 저장 버튼으로 확정

## 자동화 규칙

### 자동 감지 시점
- **결석**: 정규수업 시작 15분 후
- **예정외 접속**: 비정규일 접속 즉시
- **수업 연장**: 정규 종료시간 초과시

### 시간 계산 방식
- `abessi_missionlog` 테이블의 최초-최후 접속 시간 차이로 계산
- 5분 이상 활동 없으면 세션 종료로 간주
- 교사 승인 후에만 보강 시간 차감

### 일일 정산 (자정)
- 당일 모든 수업 기록 집계
- 보강 시간 자동 계산
- 주간/월간 리포트 생성

## 문제 해결

### 학생이 표시되지 않는 경우
1. 교사-학생 연결 확인 (course enrollment)
2. 교사 역할 권한 확인 (roleid 3,4,5)

### 실시간 알림이 작동하지 않는 경우
1. `abessi_missionlog` 테이블 확인
2. `abessi_schedule` 테이블의 pinned=1 데이터 확인

### 시간 계산이 잘못된 경우
1. 서버 시간대 설정 확인
2. `timecreated` 필드 값 확인

## 데이터베이스 구조

### 주요 테이블
- `mdl_user`: 사용자 정보
- `mdl_abessi_missionlog`: 학생 활동 로그
- `mdl_abessi_schedule`: 정규 수업 스케줄
- `mdl_abessi_attendance_record`: 출결 기록
- `mdl_abessi_attendance_log`: 변경 이력

### 데이터 흐름
1. 학생 접속 → `missionlog` 기록
2. 시스템 자동 감지 → 알림 생성
3. 교사 처리 → `attendance_record` 저장
4. 통계 업데이트 → `user_info_data` 갱신

## 향후 개선사항
- 학부모 SMS 알림 연동
- 월별 리포트 자동 생성
- 보강 스케줄링 캘린더
- 출석률 통계 대시보드