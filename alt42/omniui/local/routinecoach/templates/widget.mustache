{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template local_routinecoach/widget

    Routine Coach widget template for today's tasks

    Example context (json):
    {
        "hastasks": true,
        "tasks": [
            {
                "id": 1,
                "title": "ÏÑ†ÌñâÌïôÏäµ - 30Ïùº Ï†Ñ",
                "type": "concept",
                "durationmin": 60,
                "completed": 0,
                "countdown_label": "D-30"
            }
        ],
        "stats": {
            "exam_label": "3Ïõî Ï§ëÍ∞ÑÍ≥†ÏÇ¨",
            "days_left": 30,
            "ratio": "7:3",
            "completed_count": 1,
            "total_count": 3
        }
    }
}}

<div id="routinecoach-widget" class="routine-coach-widget">
    <div class="widget-header">
        <span class="widget-title">{{#str}}today_tasks, local_routinecoach{{/str}}</span>
        <span class="widget-toggle">‚ñº</span>
    </div>
    <div class="widget-body">
        {{#stats}}
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value">{{exam_label}}</div>
                <div class="stat-label">Îã§Ïùå ÏãúÌóò</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">D-{{days_left}}</div>
                <div class="stat-label">ÎÇ®ÏùÄ ÏùºÏàò</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ratio}}</div>
                <div class="stat-label">ÌïôÏäµ ÎπÑÏú®</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{progress_percent}}%;"></div>
        </div>
        <div class="progress-text">
            {{completed_count}} / {{total_count}} ÏôÑÎ£å ({{progress_percent}}%)
        </div>
        {{/stats}}
        
        {{#hastasks}}
        <div class="task-list">
            {{#tasks}}
            <div class="task-item" data-taskid="{{id}}">
                <div class="task-content">
                    <input type="checkbox" 
                           class="task-checkbox" 
                           id="task-{{id}}" 
                           data-taskid="{{id}}"
                           {{#completed}}checked{{/completed}}>
                    <label class="task-label" for="task-{{id}}">
                        <div class="task-title">{{title}}</div>
                        <div class="task-meta">
                            <span class="badge badge-{{type}}">
                                {{#str}}task_{{type}}, local_routinecoach{{/str}}
                            </span>
                            {{#durationmin}}
                            <span class="badge badge-duration">{{durationmin}}Î∂Ñ</span>
                            {{/durationmin}}
                            {{#countdown_label}}
                            <span class="badge badge-countdown">{{countdown_label}}</span>
                            {{/countdown_label}}
                        </div>
                    </label>
                </div>
            </div>
            {{/tasks}}
        </div>
        {{/hastasks}}
        
        {{^hastasks}}
        <div class="no-tasks">
            <p>Ïò§Îäò Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§! üéâ</p>
        </div>
        {{/hastasks}}
    </div>
</div>

<style>
#routinecoach-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
}

.widget-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.widget-title {
    font-weight: 600;
    font-size: 14px;
}

.widget-toggle {
    font-size: 18px;
    transition: transform 0.3s;
}

#routinecoach-widget.minimized {
    height: 48px;
}

#routinecoach-widget.minimized .widget-body {
    display: none;
}

#routinecoach-widget.minimized .widget-toggle {
    transform: rotate(-90deg);
}

.widget-body {
    max-height: 400px;
    overflow-y: auto;
}

.stats-row {
    display: flex;
    justify-content: space-around;
    padding: 12px;
    background: #fafafa;
    border-bottom: 1px solid #e0e0e0;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.stat-label {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.progress-bar {
    height: 4px;
    background: #e0e0e0;
    margin: 12px 16px 4px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-text {
    text-align: center;
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
}

.task-list {
    padding: 8px 0;
}

.task-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}

.task-item:hover {
    background: #f8f9fa;
}

.task-content {
    display: flex;
    align-items: flex-start;
}

.task-checkbox {
    margin-right: 10px;
    margin-top: 2px;
    cursor: pointer;
}

.task-label {
    cursor: pointer;
    flex: 1;
}

.task-checkbox:checked + .task-label .task-title {
    text-decoration: line-through;
    opacity: 0.6;
}

.task-title {
    font-size: 14px;
    color: #333;
    margin-bottom: 4px;
}

.task-meta {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
}

.badge-concept {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-review {
    background: #e8f5e9;
    color: #388e3c;
}

.badge-wrongnote {
    background: #fff3e0;
    color: #f57c00;
}

.badge-duration {
    background: #f5f5f5;
    color: #666;
}

.badge-countdown {
    background: #ffebee;
    color: #c62828;
    font-weight: 600;
}

.no-tasks {
    padding: 20px;
    text-align: center;
    color: #666;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.widget-loading {
    padding: 20px;
    text-align: center;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
</style>

{{#js}}
require(['jquery', 'local_routinecoach/routinecoach'], function($, RoutineCoach) {
    // Widget toggle functionality
    $('#routinecoach-widget .widget-header').on('click', function() {
        $('#routinecoach-widget').toggleClass('minimized');
    });
    
    // Task checkbox handling
    $('.task-checkbox').on('change', function() {
        var $checkbox = $(this);
        var taskid = $checkbox.data('taskid');
        var completed = $checkbox.is(':checked') ? 1 : 0;
        
        $.ajax({
            url: M.cfg.wwwroot + '/local/routinecoach/index.php',
            type: 'POST',
            data: {
                action: 'complete',
                taskid: taskid,
                completed: completed,
                userid: M.cfg.userid,
                sesskey: M.cfg.sesskey
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Update UI with new data
                    if (response.data && response.data.stats) {
                        var stats = response.data.stats;
                        var progress = Math.round((stats.completed_count / stats.total_count) * 100);
                        
                        $('.progress-fill').css('width', progress + '%');
                        $('.progress-text').text(stats.completed_count + ' / ' + stats.total_count + ' ÏôÑÎ£å (' + progress + '%)');
                    }
                } else {
                    // Revert checkbox on error
                    $checkbox.prop('checked', !$checkbox.prop('checked'));
                    console.error('Task update failed:', response.message);
                }
            },
            error: function() {
                // Revert checkbox on error
                $checkbox.prop('checked', !$checkbox.prop('checked'));
                console.error('Task update request failed');
            }
        });
    });
});
{{/js}}