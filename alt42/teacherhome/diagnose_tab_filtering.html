<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Filtering Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #444;
            margin-bottom: 10px;
        }
        .info-item {
            margin: 8px 0;
            padding: 5px 10px;
            background: #f9f9f9;
            border-radius: 3px;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 10px 10px 10px 0;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .fix-button {
            background: #28a745;
        }
        .fix-button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>Tab Filtering Diagnostic Tool</h1>
        
        <button onclick="runDiagnostic()">Run Diagnostic</button>
        <button onclick="showFixOptions()" class="fix-button">Show Fix Options</button>
        
        <div id="diagnosticResults"></div>
        <div id="fixOptions" style="display:none;"></div>
    </div>

    <script src="plugin_settings_client.js"></script>
    <script>
        // Initialize plugin client
        window.ktmPluginClient = new KTMPluginSettingsClient('plugin_settings_api_real.php');
        
        // Expected tab structure
        const expectedTabs = {
            'quarterly': ['계획관리', '학부모상담'],
            'weekly': ['계획관리', '완성도 관리', '종합진단', '시험대비 진단'],
            'daily': ['시험대비', '복습전략', '학습분석'],
            'realtime': ['모니터링', '개입관리', '조정관리'],
            'interaction': ['소통관리', '피드백', '적응관리'],
            'bias': ['개념공부', '문제풀이', '학습관리', '시험대비', '실전연습', '출결관련'],
            'development': ['컨텐츠 개발', '앱 개발', '개발도구']
        };
        
        async function runDiagnostic() {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML = '<div class="info-item">Running diagnostic...</div>';
            
            let html = '';
            let issues = [];
            
            try {
                // Check each category
                for (const [category, expectedTabTitles] of Object.entries(expectedTabs)) {
                    html += `<div class="section">`;
                    html += `<div class="section-title">Category: ${category}</div>`;
                    
                    // Load all cards for this category
                    await window.ktmPluginClient.loadCardSettings(category);
                    const allCards = window.ktmPluginClient.getCardSettings(category) || [];
                    
                    html += `<div class="info-item">Total cards: ${allCards.length}</div>`;
                    
                    // Group cards by card_title
                    const cardsByTitle = {};
                    allCards.forEach(card => {
                        const title = card.card_title || '[EMPTY]';
                        if (!cardsByTitle[title]) {
                            cardsByTitle[title] = [];
                        }
                        cardsByTitle[title].push(card);
                    });
                    
                    // Check expected tabs
                    html += '<div style="margin-top: 10px;">';
                    html += '<strong>Expected tabs:</strong>';
                    for (const expectedTitle of expectedTabTitles) {
                        const count = cardsByTitle[expectedTitle] ? cardsByTitle[expectedTitle].length : 0;
                        if (count === 0) {
                            html += `<div class="warning">❌ "${expectedTitle}" - No cards found</div>`;
                        } else {
                            html += `<div class="success">✅ "${expectedTitle}" - ${count} cards</div>`;
                        }
                    }
                    html += '</div>';
                    
                    // Check for unexpected tabs
                    const unexpectedTitles = Object.keys(cardsByTitle).filter(title => 
                        title !== '[EMPTY]' && !expectedTabTitles.includes(title)
                    );
                    
                    if (unexpectedTitles.length > 0) {
                        html += '<div style="margin-top: 10px;">';
                        html += '<strong>Unexpected card_title values:</strong>';
                        unexpectedTitles.forEach(title => {
                            const count = cardsByTitle[title].length;
                            html += `<div class="error">⚠️ "${title}" - ${count} cards (not a valid tab)</div>`;
                            issues.push({
                                category: category,
                                issue: 'unexpected_title',
                                title: title,
                                cards: cardsByTitle[title]
                            });
                        });
                        html += '</div>';
                    }
                    
                    // Check for empty titles
                    if (cardsByTitle['[EMPTY]']) {
                        html += `<div class="error">⚠️ ${cardsByTitle['[EMPTY]'].length} cards with empty card_title</div>`;
                        issues.push({
                            category: category,
                            issue: 'empty_title',
                            cards: cardsByTitle['[EMPTY]']
                        });
                    }
                    
                    html += '</div>';
                }
                
                // Summary
                html += '<div class="section">';
                html += '<div class="section-title">Diagnostic Summary</div>';
                if (issues.length === 0) {
                    html += '<div class="success">✅ No issues found! All plugins are correctly assigned to tabs.</div>';
                } else {
                    html += `<div class="error">❌ Found ${issues.length} issues that need fixing.</div>`;
                    
                    // Store issues for fixing
                    window.diagnosticIssues = issues;
                }
                html += '</div>';
                
            } catch (error) {
                html += `<div class="error">Error running diagnostic: ${error.message}</div>`;
                console.error('Diagnostic error:', error);
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function showFixOptions() {
            const fixDiv = document.getElementById('fixOptions');
            
            if (!window.diagnosticIssues || window.diagnosticIssues.length === 0) {
                fixDiv.innerHTML = '<div class="success">No issues to fix!</div>';
                fixDiv.style.display = 'block';
                return;
            }
            
            let html = '<div class="section">';
            html += '<div class="section-title">Fix Options</div>';
            html += '<p>Found issues that can be fixed:</p>';
            
            // Group issues by type
            const emptyTitleIssues = window.diagnosticIssues.filter(i => i.issue === 'empty_title');
            const unexpectedTitleIssues = window.diagnosticIssues.filter(i => i.issue === 'unexpected_title');
            
            if (emptyTitleIssues.length > 0) {
                html += '<div class="warning">';
                html += `<strong>Cards with empty card_title:</strong> ${emptyTitleIssues.reduce((sum, i) => sum + i.cards.length, 0)} total<br>`;
                html += 'These cards need to be assigned to specific tabs.';
                html += '</div>';
            }
            
            if (unexpectedTitleIssues.length > 0) {
                html += '<div class="warning">';
                html += '<strong>Cards with unexpected card_title values:</strong><br>';
                unexpectedTitleIssues.forEach(issue => {
                    html += `- "${issue.title}" in ${issue.category} (${issue.cards.length} cards)<br>`;
                });
                html += 'These might be typos or old tab names that need updating.';
                html += '</div>';
            }
            
            html += '<button onclick="generateFixScript()">Generate Fix Script</button>';
            html += '<div id="fixScript" style="margin-top: 10px;"></div>';
            html += '</div>';
            
            fixDiv.innerHTML = html;
            fixDiv.style.display = 'block';
        }
        
        function generateFixScript() {
            const scriptDiv = document.getElementById('fixScript');
            
            let sql = '-- SQL script to fix card_title issues\n\n';
            
            window.diagnosticIssues.forEach(issue => {
                if (issue.issue === 'unexpected_title') {
                    // Suggest mapping to closest matching tab
                    const expectedTabs = expectedTabs[issue.category];
                    sql += `-- Fix unexpected title "${issue.title}" in category ${issue.category}\n`;
                    sql += `-- Suggested: map to one of: ${expectedTabs.join(', ')}\n`;
                    sql += `-- UPDATE mdl_alt42DB_card_plugin_settings \n`;
                    sql += `-- SET card_title = 'CHOOSE_CORRECT_TAB' \n`;
                    sql += `-- WHERE category = '${issue.category}' AND card_title = '${issue.title}';\n\n`;
                }
            });
            
            scriptDiv.innerHTML = `<pre>${sql}</pre>`;
        }
        
        // Auto-run diagnostic on load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 500);
        });
    </script>
</body>
</html>