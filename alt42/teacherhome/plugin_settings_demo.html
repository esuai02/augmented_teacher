<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTM ì½”íŒŒì¼ëŸ¿ í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ë°ëª¨</title>
    <link rel="stylesheet" href="plugin_settings_styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            color: #1f2937;
            font-size: 24px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            color: #6b7280;
        }
        
        .demo-section {
            margin-bottom: 30px;
        }
        
        .demo-section h2 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .demo-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .demo-button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .demo-button:hover {
            background: #2563eb;
        }
        
        .demo-button.secondary {
            background: #6b7280;
        }
        
        .demo-button.secondary:hover {
            background: #4b5563;
        }
        
        .demo-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .demo-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ KTM ì½”íŒŒì¼ëŸ¿ í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ë°ëª¨</h1>
            <p>teacherhome/index.htmlì—ì„œ ì‚¬ìš©í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</p>
        </div>
        
        <div class="grid">
            <div class="demo-section">
                <h2>ğŸ“‹ ì‚¬ìš©ì ì„¤ì • ê´€ë¦¬</h2>
                <div class="demo-buttons">
                    <button class="demo-button" onclick="loadUserSettings()">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="demo-button" onclick="saveUserSetting()">ì„¤ì • ì €ì¥</button>
                    <button class="demo-button secondary" onclick="clearOutput('userOutput')">ì¶œë ¥ ì§€ìš°ê¸°</button>
                </div>
                
                <div id="userSettingsContainer"></div>
                <div id="userOutput" class="demo-output"></div>
            </div>
            
            <div class="demo-section">
                <h2>ğŸƒ ì¹´ë“œ ì„¤ì • ê´€ë¦¬</h2>
                <div class="demo-buttons">
                    <button class="demo-button" onclick="loadCardSettings()">ì¹´ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="demo-button" onclick="saveCardSetting()">ì¹´ë“œ ì„¤ì • ì €ì¥</button>
                    <button class="demo-button secondary" onclick="clearOutput('cardOutput')">ì¶œë ¥ ì§€ìš°ê¸°</button>
                </div>
                
                <div id="cardSettingsContainer"></div>
                <div id="cardOutput" class="demo-output"></div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>ğŸ® í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ë°ëª¨</h2>
            <div class="demo-buttons">
                <button class="demo-button" onclick="executeInternalLink()">ë‚´ë¶€ ë§í¬ ì‹¤í–‰</button>
                <button class="demo-button" onclick="executeExternalLink()">ì™¸ë¶€ ë§í¬ ì‹¤í–‰</button>
                <button class="demo-button" onclick="executeSendMessage()">ë©”ì‹œì§€ ë°œì†¡</button>
                <button class="demo-button secondary" onclick="clearOutput('executeOutput')">ì¶œë ¥ ì§€ìš°ê¸°</button>
            </div>
            <div id="executeOutput" class="demo-output"></div>
        </div>
        
        <div class="demo-section">
            <h2>ğŸ“Š í”ŒëŸ¬ê·¸ì¸ í†µê³„</h2>
            <div class="demo-buttons">
                <button class="demo-button" onclick="getPluginStats()">ì‚¬ìš© í†µê³„ í™•ì¸</button>
                <button class="demo-button" onclick="getPluginHistory()">ë³€ê²½ íˆìŠ¤í† ë¦¬</button>
                <button class="demo-button secondary" onclick="clearOutput('statsOutput')">ì¶œë ¥ ì§€ìš°ê¸°</button>
            </div>
            <div id="statsOutput" class="demo-output"></div>
            
            <!-- íˆìŠ¤í† ë¦¬ ì‹œê°í™” ì˜ì—­ -->
            <div id="historyVisualization" style="margin-top: 20px; display: none;">
                <h3 style="color: #1f2937; margin-bottom: 10px;">ğŸ“œ ìµœê·¼ ë³€ê²½ ë‚´ì—­</h3>
                <div id="historyTimeline" style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
    </div>

    <script src="plugin_settings_client.js"></script>
    <script>
        // ë°ëª¨ í•¨ìˆ˜ë“¤
        function log(output, message) {
            const outputElement = document.getElementById(output);
            outputElement.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        
        function clearOutput(outputId) {
            document.getElementById(outputId).textContent = '';
        }
        
        // ì‚¬ìš©ì ì„¤ì • ê´€ë¦¬ ë°ëª¨
        async function loadUserSettings() {
            try {
                log('userOutput', 'ì‚¬ìš©ì ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                const settings = await window.ktmPluginSettings.loadUserSettings('weekly');
                log('userOutput', `ì‚¬ìš©ì ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${JSON.stringify(settings, null, 2)}`);
                
                // UI ìƒì„±
                const container = document.getElementById('userSettingsContainer');
                container.innerHTML = '';
                window.ktmPluginSettings.createPluginSettingsUI(container, 'weekly');
                
            } catch (error) {
                log('userOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function saveUserSetting() {
            try {
                log('userOutput', 'ì‚¬ìš©ì ì„¤ì •ì„ ì €ì¥í•˜ëŠ” ì¤‘...');
                const result = await window.ktmPluginSettings.saveUserSetting(
                    'internal_link',
                    'demo_setting',
                    { url: '/demo/page', new_tab: false },
                    'weekly'
                );
                log('userOutput', `ì‚¬ìš©ì ì„¤ì • ì €ì¥ ì™„ë£Œ: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log('userOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // ì¹´ë“œ ì„¤ì • ê´€ë¦¬ ë°ëª¨
        async function loadCardSettings() {
            try {
                log('cardOutput', 'ì¹´ë“œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                const settings = await window.ktmPluginSettings.loadCardSettings('weekly');
                log('cardOutput', `ì¹´ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${JSON.stringify(settings, null, 2)}`);
                
                // UI ìƒì„±
                const container = document.getElementById('cardSettingsContainer');
                container.innerHTML = '';
                window.ktmPluginSettings.createPluginSettingsUI(container, 'weekly', 'ì£¼ê°„ ê³„íší‘œ');
                
            } catch (error) {
                log('cardOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function saveCardSetting() {
            try {
                log('cardOutput', 'ì¹´ë“œ ì„¤ì •ì„ ì €ì¥í•˜ëŠ” ì¤‘...');
                const result = await window.ktmPluginSettings.saveCardSetting(
                    'weekly',
                    'ì£¼ê°„ ê³„íší‘œ',
                    0,
                    'external_link',
                    { url: 'https://example.com', new_tab: true },
                    1
                );
                log('cardOutput', `ì¹´ë“œ ì„¤ì • ì €ì¥ ì™„ë£Œ: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log('cardOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ë°ëª¨
        async function executeInternalLink() {
            try {
                log('executeOutput', 'ë‚´ë¶€ ë§í¬ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì¤‘...');
                await window.ktmPluginSettings.executePlugin('internal_link', {
                    internal_url: '#demo-section',
                    open_new_tab: false
                });
                log('executeOutput', 'ë‚´ë¶€ ë§í¬ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì™„ë£Œ');
                
            } catch (error) {
                log('executeOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function executeExternalLink() {
            try {
                log('executeOutput', 'ì™¸ë¶€ ë§í¬ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì¤‘...');
                await window.ktmPluginSettings.executePlugin('external_link', {
                    external_url: 'https://github.com',
                    open_new_tab: true
                });
                log('executeOutput', 'ì™¸ë¶€ ë§í¬ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì™„ë£Œ');
                
            } catch (error) {
                log('executeOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function executeSendMessage() {
            try {
                log('executeOutput', 'ë©”ì‹œì§€ ë°œì†¡ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì¤‘...');
                await window.ktmPluginSettings.executePlugin('send_message', {
                    message_content: 'í”ŒëŸ¬ê·¸ì¸ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤!',
                    message_type: 'success'
                });
                log('executeOutput', 'ë©”ì‹œì§€ ë°œì†¡ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì™„ë£Œ');
                
            } catch (error) {
                log('executeOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // í”ŒëŸ¬ê·¸ì¸ í†µê³„ ë°ëª¨
        async function getPluginStats() {
            try {
                log('statsOutput', 'í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© í†µê³„ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
                
                // í”ŒëŸ¬ê·¸ì¸ íƒ€ì… ì •ë³´
                const pluginTypes = window.ktmPluginSettings.getPluginTypes();
                log('statsOutput', `í”ŒëŸ¬ê·¸ì¸ íƒ€ì…: ${JSON.stringify(pluginTypes, null, 2)}`);
                
                // ì‚¬ìš©ì ì„¤ì • ì •ë³´
                const userSettings = window.ktmPluginSettings.getUserSettings();
                log('statsOutput', `ì‚¬ìš©ì ì„¤ì •: ${JSON.stringify(userSettings, null, 2)}`);
                
                // ì¹´ë“œ ì„¤ì • ì •ë³´
                const cardSettings = window.ktmPluginSettings.getCardSettings();
                log('statsOutput', `ì¹´ë“œ ì„¤ì •: ${JSON.stringify(cardSettings, null, 2)}`);
                
            } catch (error) {
                log('statsOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function getPluginHistory() {
            try {
                log('statsOutput', 'í”ŒëŸ¬ê·¸ì¸ ë³€ê²½ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
                
                // API í˜¸ì¶œí•˜ì—¬ ë³€ê²½ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('plugin_settings_api_real.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_setting_history',
                        user_id: window.ktmPluginSettings.userId || 'demo_user',
                        limit: 20
                    })
                });
                
                const result = await response.json();
                if (result.success && result.data) {
                    log('statsOutput', 'ë³€ê²½ íˆìŠ¤í† ë¦¬:');
                    
                    // íˆìŠ¤í† ë¦¬ ì‹œê°í™”
                    displayHistoryTimeline(result.data);
                    
                    result.data.forEach(history => {
                        const date = new Date(history.timecreated * 1000).toLocaleString();
                        log('statsOutput', `\n[${date}] ${history.plugin_title || history.plugin_id}`);
                        log('statsOutput', `  íƒ€ì…: ${history.setting_type}`);
                        log('statsOutput', `  ì°¸ì¡°: ${history.reference_id}`);
                        log('statsOutput', `  ë³€ê²½ì‚¬ìœ : ${history.change_reason || 'ì—†ìŒ'}`);
                        log('statsOutput', `  ì´ì „ê°’: ${JSON.stringify(history.old_value)}`);
                        log('statsOutput', `  ìƒˆê°’: ${JSON.stringify(history.new_value)}`);
                    });
                } else {
                    log('statsOutput', 'ë³€ê²½ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                log('statsOutput', `ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ í‘œì‹œ í•¨ìˆ˜
        function displayHistoryTimeline(historyData) {
            const visualizationContainer = document.getElementById('historyVisualization');
            const timelineContainer = document.getElementById('historyTimeline');
            
            if (!historyData || historyData.length === 0) {
                visualizationContainer.style.display = 'none';
                return;
            }
            
            visualizationContainer.style.display = 'block';
            timelineContainer.innerHTML = '';
            
            // íƒ€ì„ë¼ì¸ HTML ìƒì„±
            const timeline = document.createElement('div');
            timeline.style.cssText = 'position: relative; padding-left: 30px;';
            
            historyData.slice(0, 10).forEach((history, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'position: relative; padding: 15px 0; border-left: 2px solid #e5e7eb;';
                
                // íƒ€ì„ë¼ì¸ í¬ì¸íŠ¸
                const point = document.createElement('div');
                point.style.cssText = 'position: absolute; left: -7px; top: 20px; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; border: 2px solid #fff;';
                item.appendChild(point);
                
                // ì»¨í…ì¸ 
                const content = document.createElement('div');
                content.style.cssText = 'padding-left: 20px;';
                
                const date = new Date(history.timecreated * 1000);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                // ë³€ê²½ íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                let actionText = '';
                let actionColor = '#3b82f6';
                
                if (history.old_value === null && history.new_value !== null) {
                    actionText = 'ìƒì„±ë¨';
                    actionColor = '#10b981';
                    point.style.background = '#10b981';
                } else if (history.old_value !== null && history.new_value === null) {
                    actionText = 'ì‚­ì œë¨';
                    actionColor = '#ef4444';
                    point.style.background = '#ef4444';
                } else {
                    actionText = 'ìˆ˜ì •ë¨';
                    actionColor = '#f59e0b';
                    point.style.background = '#f59e0b';
                }
                
                content.innerHTML = `
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">${dateStr}</div>
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 3px;">
                        ${history.plugin_title || history.plugin_id}
                        <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: ${actionColor}20; color: ${actionColor}; margin-left: 8px;">${actionText}</span>
                    </div>
                    <div style="font-size: 14px; color: #4b5563;">
                        ${history.setting_type === 'user_setting' ? 'ì‚¬ìš©ì ì„¤ì •' : 'ì¹´ë“œ ì„¤ì •'}
                        ${history.reference_id ? ` - ${history.reference_id}` : ''}
                    </div>
                    ${history.change_reason ? `<div style="font-size: 13px; color: #6b7280; margin-top: 3px;">ì‚¬ìœ : ${history.change_reason}</div>` : ''}
                `;
                
                item.appendChild(content);
                timeline.appendChild(item);
            });
            
            timelineContainer.appendChild(timeline);
        }
        
        // ì‹¤ì‹œê°„ ë³€ê²½ ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ
        function setupChangeListeners() {
            // ì‚¬ìš©ì ì„¤ì • ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
            window.ktmPluginSettings.addEventListener('userSettingChanged', (data) => {
                showChangeNotification(`ì‚¬ìš©ì ì„¤ì • ë³€ê²½: ${data.pluginId}`, 'info');
                // íˆìŠ¤í† ë¦¬ ìë™ ìƒˆë¡œê³ ì¹¨
                if (document.getElementById('historyVisualization').style.display !== 'none') {
                    getPluginHistory();
                }
            });
            
            // ì¹´ë“œ ì„¤ì • ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
            window.ktmPluginSettings.addEventListener('cardSettingChanged', (data) => {
                showChangeNotification(`ì¹´ë“œ ì„¤ì • ë³€ê²½: ${data.pluginId} - ${data.cardTitle}`, 'success');
                // íˆìŠ¤í† ë¦¬ ìë™ ìƒˆë¡œê³ ì¹¨
                if (document.getElementById('historyVisualization').style.display !== 'none') {
                    getPluginHistory();
                }
            });
            
            // í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ë¦¬ìŠ¤ë„ˆ
            window.ktmPluginSettings.addEventListener('afterPluginExecute', (data) => {
                if (data.success) {
                    showChangeNotification(`í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰: ${data.pluginId}`, 'success');
                } else {
                    showChangeNotification(`í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ì‹¤íŒ¨: ${data.pluginId}`, 'error');
                }
            });
        }
        
        // ë³€ê²½ ì•Œë¦¼ í‘œì‹œ
        function showChangeNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'plugin-change-notification';
            notification.innerHTML = `
                <span class="change-icon">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                <span class="change-message">${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            // ì‚¬ìš©ì ID ì„¤ì • (ë°ëª¨ìš©)
            if (window.ktmPluginSettings) {
                window.ktmPluginSettings.setUserId('demo_user_1');
            }
            
            log('userOutput', 'KTM í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
            log('cardOutput', 'UI ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ');
            log('executeOutput', 'í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ');
            log('statsOutput', 'í†µê³„ ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ');
            
            // ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupChangeListeners();
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ë§í¬ ì¶”ê°€
            log('userOutput', 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ test_plugin_db.phpë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
        });
    </script>
</body>
</html> 