<?php 
include_once("/home/moodle/public_html/moodle/config.php"); 
global $DB, $USER;
require_login();

// Get parameters
$studentid = $_GET["id"]; 
$cid = $_GET["cid"]; 
$access = $_GET["access"];
if($studentid == NULL) $studentid = $USER->id;

// Check user role and permissions
$userrole = $DB->get_record_sql("SELECT data FROM mdl_user_info_data where userid='$USER->id' AND fieldid='22'"); 
$role = $userrole->data;

if($USER->id != $studentid && $role === 'student') {
    echo '<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì •ë³´ì— ì ‘ê·¼í•˜ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    exit;
}

// Get user data
$timecreated = time();
$username = $DB->get_record_sql("SELECT id, hideinput, lastname, firstname, timezone FROM mdl_user WHERE id='$studentid' ORDER BY id DESC LIMIT 1");
$studentname = $username->firstname.$username->lastname;
$tabtitle = $username->lastname;

// Get user additional data
$userdata2 = $DB->get_records_sql("SELECT data,fieldid FROM mdl_user_info_data where userid='$studentid' AND (fieldid='107' OR fieldid='88' OR fieldid='89' OR fieldid='82' OR fieldid='90' OR fieldid='64')"); 
$thisuser = json_decode(json_encode($userdata2), True);
foreach($thisuser as $value) {
    if($value['fieldid'] == 107) $usersex = $value['data'];
    if($value['fieldid'] == 88) $institute = $value['data'];
    if($value['fieldid'] == 89) $birthyear = $value['data'];
    if($value['fieldid'] == 82) $AutopilotMode = $value['data'];
    if($value['fieldid'] == 90) $usrdata = $value['data'];
    if($value['fieldid'] == 64) $tsymbol = $value['data'];			
} 

// Redirect for teacher accessing via 'my'
if($access === 'my' && $role !== 'student') {
    header('Location: https://mathking.kr/moodle/local/augmented_teacher/teachers/timetable.php?id='.$USER->id.'&tb=7');
}

// Log access for students
if($role === 'student') {
    $DB->execute("INSERT INTO {abessi_missionlog} (userid,page,timecreated) VALUES('$studentid','studentindex','$timecreated')");
}

// Time calculations
$timestart = time() - 604800 * 2;
$aweekago = time() - 604800;
$timestart2 = time() - 43200;
$timestart3 = time() - 86400;

// Get review notes
$reviewnotes = $DB->get_records_sql("SELECT * FROM mdl_abessi_messages WHERE userid='$studentid' AND timemodified > '$aweekago' AND mtype='audio' ORDER BY timemodified DESC LIMIT 30"); 
$rvresult = json_decode(json_encode($reviewnotes), True);
$reviewhistory = '';
foreach($rvresult as $rvvalue) {
    $url = $rvvalue['url'];
    $cnttitle = $rvvalue['contentstitle'];
    $nreview = $rvvalue['nreview'];
    $nlastview = round(($timecreated - $rvvalue['timemodified']) / 86400, 0);
    $reviewhistory .= '<tr><td><a href="https://mathking.kr/moodle/local/augmented_teacher/books/mynote.php?'.$url.'" target="_blank">ğŸ§ ë³µìŠµ : '.$cnttitle.' ('.$nreview.') </a></td></tr>';
}

// Get mission lists
$trecent2 = time() - 31104000;  // 1 year ago
$missionlist = $DB->get_records_sql("SELECT * FROM mdl_abessi_mission WHERE timecreated>'$trecent2' AND userid='$studentid' ORDER by norder ASC");
$result = json_decode(json_encode($missionlist), True);

// Initialize mission type arrays
$mt01 = $mt02 = $mt03 = $mt04 = $mt05 = $mt06 = $mt07 = $mt08 = '';

foreach($result as $value) {
    $mtid = 0;
    $mid = $value['id'];
    $subject = $value['subject'];	
    $deadline = $value['deadline']; 	
    $unixtimedeadline = strtotime($deadline);	
    if($unixtimedeadline > time() + 31536000 || $unixtimedeadline < time() - 31536000) continue;
    $passgrade = $value['grade'];
    $mtname = $DB->get_record_sql("SELECT * FROM mdl_abessi_curriculum WHERE id='$subject'");
    $contentslist = $mtname->contentslist;
    $subjectname = $mtname->name;
    $mtid = $mtname->mtid;
    $subjectname = str_replace("ê°œë… :", "", $subjectname);
    $subjectname = str_replace("ì‹¬í™” :", "", $subjectname);
    $subjectname = str_replace("ë‚´ì‹  :", "", $subjectname);
    $subjectname = str_replace("ìˆ˜ëŠ¥ :", "", $subjectname);
    
    if($value['complete'] == 0) {
        if($mtid == 1 || $mtid == 7) {
            $mt01 .= '<tr><td><a href="https://mathking.kr/moodle/local/augmented_teacher/books/chapter.php?cid='.$subject.'&nch=1&studentid='.$studentid.'&type=init" target="_blank"><img loading="lazy" style="margin-bottom:4px;" src="https://mathking.kr/moodle/local/augmented_teacher/IMAGES/gpt3.png" width="20"> GPT '.$subjectname.' </a> &nbsp; <a href="https://mathking.kr/moodle/local/augmented_teacher/books/ankisystem.php?dmn=math&sbjt=h3&studentid='.$studentid.'&nch=9" target="_blank"><img src="https://ankiweb.net/logo.png" width="20"></a></td>
            <td width="4%" style=""></td><td width="30%" align="left" style="font-size:12pt">  </td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td>
            <td width="4%"><div class="form-check"> ì™„ë£Œ &nbsp;<label style="margin-bottom:5px;" class="form-check-label"><input type="checkbox" onclick="changecheckbox(1,'.$studentid.','.$mid.', this.checked)"/><span style="margin-bottom:5px;" class="form-check-sign"></span></label></div></td></tr>';
        } elseif($mtid == 2) {
            if(strpos($subjectname, 'ì´ˆë“±') !== false) {
                $mt02 .= '<tr><td width="30%" align="left" style="font-size:12pt"><img loading="lazy" style="margin-bottom:5px;" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1654400635.png" width="20"> <a href="https://mathking.kr/moodle/mod/checklist/view.php?id='.$contentslist.'&studentid='.$studentid.'"><b>'.$subjectname.'</b></td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì™„ë£Œ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(1,'.$studentid.','.$mid.', this.checked)"/><span style="margin-bottom:5px;" class="form-check-sign"></span></label></div></td></tr>';
            } else {
                $mt02 .= '<tr><td width="30%" align="left" style="font-size:12pt"><img loading="lazy" style="margin-bottom:5px;" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1654400635.png" width="20"> <a href="https://mathking.kr/moodle/local/augmented_teacher/students/missionhome.php?id='.$studentid.'&mtid='.$mtid.'&cid='.$subject.'&tb=90"><b>'.$subjectname.'</b></td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì™„ë£Œ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(1,'.$studentid.','.$mid.', this.checked)"/><span style="margin-bottom:5px;" class="form-check-sign"></span></label></div></td></tr>';
            }
        } elseif($mtid == 3) {
            $mt03 .= '<tr><td width="30%" align="left" style="font-size:12pt"><img loading="lazy" style="margin-bottom:5px;" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1654400635.png" width="20"> <a href="https://mathking.kr/moodle/local/augmented_teacher/students/missionhome.php?id='.$studentid.'&mtid='.$mtid.'&cid='.$subject.'&tb=90"><b>'.$subjectname.'</b></td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì™„ë£Œ &nbsp;<label style="margin-bottom:5px;" class="form-check-label"><input type="checkbox" onclick="changecheckbox(1,'.$studentid.','.$mid.', this.checked)"/><span class="form-check-sign"></span></label></div></td></tr>';
        } elseif($mtid == 4) {
            $mt04 .= '<tr><td width="30%" align="left" style="font-size:12pt"><img loading="lazy" style="margin-bottom:5px;" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1654400635.png" width="20"> <a href="https://mathking.kr/moodle/mod/checklist/view.php?id='.$contentslist.'&studentid='.$studentid.'"><b>'.$subjectname.'</b></td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì™„ë£Œ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(1,'.$studentid.','.$mid.', this.checked)"/><span class="form-check-sign"></span></label></div></td></tr>';
        }
    } else {
        if($mtid == 1 || $mtid == 7) {
            $mt05 .= '<tr><td width="30%" align="left" style="color:grey;font-size:10pt"><img loading="lazy" style="" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1655184717.png" width="15"> <a href="https://mathking.kr/moodle/local/augmented_teacher/students/missionhome.php?id='.$studentid.'&mtid='.$mtid.'&cid='.$subject.'&tb=90">ê°œë… : '.$subjectname.'</a> &nbsp; <a href="https://mathking.kr/moodle/local/augmented_teacher/books/ankisystem.php?dmn=math&sbjt=h3&studentid='.$studentid.'&nch=9" target="_blank"><img src="https://ankiweb.net/logo.png" width="20"></a></td><td width="4%" style=""></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td>
            <td width="4%"><div class="form-check"> ì¶”ê°€ &nbsp;<label style="" class="form-check-label"><input type="checkbox" onclick="changecheckbox(13,'.$studentid.','.$mid.', this.checked)"/><span style="" class="form-check-sign"></span></label></div></td></tr>';
        } elseif($mtid == 2) {
            if(strpos($subjectname, 'ì´ˆë“±') !== false) {
                $mt06 .= '<tr><td width="30%" align="left" style="font-size:10pt"><img loading="lazy" style="" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1655184717.png" width="15"> <a href="https://mathking.kr/moodle/mod/checklist/view.php?id='.$contentslist.'&studentid='.$studentid.'">ì‹¬í™” : '.$subjectname.'</td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì¶”ê°€ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(13,'.$studentid.','.$mid.', this.checked)"/><span style="" class="form-check-sign"></span></label></div></td></tr>';
            } else {
                $mt06 .= '<tr><td width="30%" align="left" style="color:grey;font-size:10pt"><img loading="lazy" style="" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1655184717.png" width="15"> <a href="https://mathking.kr/moodle/local/augmented_teacher/students/missionhome.php?id='.$studentid.'&mtid='.$mtid.'&cid='.$subject.'&tb=90">ì‹¬í™” : '.$subjectname.'</td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì¶”ê°€ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(13,'.$studentid.','.$mid.', this.checked)"/><span style="" class="form-check-sign"></span></label></div></td></tr>';
            }
        } elseif($mtid == 3) {
            $mt07 .= '<tr><td width="30%" align="left" style="color:grey;font-size:10pt"><img loading="lazy" style="" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1655184717.png" width="15"> <a href="https://mathking.kr/moodle/local/augmented_teacher/students/missionhome.php?id='.$studentid.'&mtid='.$mtid.'&cid='.$subject.'&tb=90">ë‚´ì‹  : '.$subjectname.'</td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì¶”ê°€ &nbsp;<label style="" class="form-check-label"><input type="checkbox" onclick="changecheckbox(13,'.$studentid.','.$mid.', this.checked)"/><span class="form-check-sign"></span></label></div></td></tr>';
        } elseif($mtid == 4) {
            $mt08 .= '<tr><td width="30%" align="left" style="color:grey;font-size:10pt"><img loading="lazy" style="" src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/bessi21_1655184717.png" width="15"> <a href="https://mathking.kr/moodle/mod/checklist/view.php?id='.$contentslist.'&studentid='.$studentid.'">ìˆ˜ëŠ¥ : '.$subjectname.'</td><td width="4%"></td><td width="20%" style="font-size:10pt">í•©ê²© : '.$passgrade.'ì </td><td width="4%"><div class="form-check"> ì¶”ê°€ &nbsp;<label class="form-check-label"><input type="checkbox" onclick="changecheckbox(13,'.$studentid.','.$mid.', this.checked)"/><span style="" class="form-check-sign"></span></label></div></td></tr>';
        }
    }
}

// Additional navigation for teachers
if($role !== 'student') {
    $inspect_fixnotes = ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a style="text-decoration:none;color:white;font-size:18px;" href="https://mathking.kr/moodle/local/augmented_teacher/students/beactivelearner.php?userid='.$studentid.'" target="_blank">ê·€ê°€í‰ê°€</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a style="text-decoration:none;color:white;font-size:14px;" href="https://mathking.kr/moodle/local/augmented_teacher/students/dashboard_fixnotes.php?userid='.$studentid.'" target="_blank">ì˜¤ë‹µë…¸íŠ¸ ê²€ì‚¬</a> ';
}

// Save last accessed course for each mission type
if($cid) {
    // Save to user preferences or session
    $_SESSION['last_advanced_course'] = $cid;
}

?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title><?php echo $tabtitle; ?> - í•™ìŠµ í™ˆ</title>
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
    <link rel="icon" href="../assets/img/icon.ico" type="image/x-icon"/>
    
    <!-- Fonts and icons -->
    <script src="../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: {"families":["Open+Sans:300,400,600,700"]},
            custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands"], urls: ['../assets/css/fonts.css']},
            active: function() {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/azzara.min.css">
    <link rel="stylesheet" href="../assets/css/demo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        .header-top {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .user-info h2 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .user-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .header-nav {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .content-wrapper {
            padding: 0 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .view-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .view-btn {
            padding: 8px 16px;
            background: white;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .view-btn:hover {
            background: #f1f3f4;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Tab View Styles */
        .tab-view {
            display: none;
        }
        
        .tab-view.active {
            display: block;
        }
        
        .tab-header {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scroll View Styles */
        .scroll-view {
            display: none;
        }
        
        .scroll-view.active {
            display: block;
        }
        
        /* Mission Section Styles */
        .mission-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }
        
        .mission-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mission-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .badge-concept {
            background: #E05D22;
            color: white;
        }
        
        .badge-advanced {
            background: #f093fb;
            color: white;
        }
        
        .badge-exam {
            background: #4facfe;
            color: white;
        }
        
        .badge-sat {
            background: #fa709a;
            color: white;
        }
        
        .add-mission-btn {
            padding: 8px 20px;
            background: #3383FF;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .add-mission-btn:hover {
            background: #2968d6;
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .mission-list {
            margin-top: 15px;
        }
        
        .mission-list table {
            width: 100%;
        }
        
        .mission-list tr {
            border-bottom: 1px solid #f1f3f4;
        }
        
        .mission-list tr:last-child {
            border-bottom: none;
        }
        
        .mission-list td {
            padding: 12px 5px;
            vertical-align: middle;
        }
        
        .mission-link {
            color: #3383FF;
            text-decoration: none;
            font-weight: 500;
        }
        
        .mission-link:hover {
            color: #2968d6;
            text-decoration: underline;
        }
        
        .review-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .review-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .review-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .review-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .review-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .review-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .form-check {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-check-label {
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state img {
            width: 80px;
            opacity: 0.5;
            margin-bottom: 15px;
        }
        
        /* Additional Info Section */
        .info-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .info-header {
            background: #0082D8;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .info-links {
            display: flex;
            gap: 15px;
        }
        
        .info-links a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            transition: all 0.3s;
        }
        
        .info-links a:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @media (max-width: 768px) {
            .user-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .tab-btn {
                font-size: 14px;
                padding: 10px 15px;
            }
            
            .mission-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        
        /* Interactive Goal Panel Styles */
        .goal-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            z-index: 9999;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .goal-panel.active {
            right: 0;
        }

        .panel-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s;
            cursor: pointer;
        }

        .panel-content {
            position: absolute;
            right: 0;
            width: 550px;
            height: 100%;
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .goal-panel.active .panel-content {
            transform: translateX(0);
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .header-title h3 {
            margin: 0;
            font-size: 22px;
            font-weight: bold;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .goal-type-selector {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .type-btn {
            flex: 1;
            padding: 15px 10px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .type-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .type-btn.active {
            background: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .type-btn i {
            font-size: 24px;
            color: #667eea;
            display: block;
            margin-bottom: 8px;
        }

        .type-btn span {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .type-btn small {
            display: block;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .conversation-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.assistant {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .assistant-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .assistant .message-bubble {
            background: #f1f3f4;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .user .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .input-area {
            padding: 15px 20px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .smart-suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            min-height: 32px;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: #f0f4ff;
            color: #667eea;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .goal-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
            outline: none;
        }

        .goal-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .progress-indicator {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.5s ease;
            width: 25%;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
        }

        .step {
            font-size: 12px;
            color: #999;
            transition: color 0.3s;
        }

        .step.active {
            color: #667eea;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .status-badge.complete {
            background: #d4f4dd;
            color: #059669;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.required {
            background: #fee2e2;
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .panel-content {
                width: 100%;
            }
            
            .goal-type-selector {
                padding: 15px;
            }
            
            .type-btn {
                padding: 12px 8px;
            }
            
            .type-btn small {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header-top">
        <div class="user-header">
            <div class="user-info">
                <h2><?php echo $username->lastname; ?>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!</h2>
                <p>ë°°ì›€ì˜ ë³¸ëŠ¥ì´ ì¼ê¹¨ì›Œì§„ ì‹¬ì¥ì´ ë›°ê¸° ì‹œì‘í•œë‹¤ë©´ ìˆ˜í•™ì—ë„ ë´„ë‚ ì´ ì˜¬ê±°ì˜ˆìš”.</p>
            </div>
            <div class="header-nav">
                <button type="button" class="nav-btn" onclick="openGoalPanel('daily')">
                    <i class="fas fa-calendar-day"></i> ì˜¤ëŠ˜ëª©í‘œ
                </button>
                <button type="button" class="nav-btn" onclick="openGoalPanel('weekly')">
                    <i class="fas fa-calendar-week"></i> ì£¼ê°„ê³„íš
                </button>
                <button type="button" class="nav-btn" onclick="openGoalPanel('quarterly')">
                    <i class="fas fa-calendar-alt"></i> ë¶„ê¸°ëª©í‘œ
                </button>
                <a href="mynote.php?id=<?php echo $studentid; ?>" class="nav-btn">
                    <i class="fas fa-book"></i> ë§ˆì´ë…¸íŠ¸
                </a>
            </div>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="view-controls">
            <button class="view-btn active" onclick="switchView('tab')">íƒ­ ë·°</button>
            <button class="view-btn" onclick="switchView('scroll')">ìŠ¤í¬ë¡¤ ë·°</button>
        </div>

        <!-- Tab View -->
        <div id="tabView" class="tab-view active">
            <div class="tab-header">
                <button class="tab-btn active" onclick="openTab('concept')">
                    <span class="mission-badge badge-concept">ê°œë…</span>
                </button>
                <button class="tab-btn" onclick="openTab('advanced')">
                    <span class="mission-badge badge-advanced">ì‹¬í™”</span>
                </button>
                <button class="tab-btn" onclick="openTab('exam')">
                    <span class="mission-badge badge-exam">ë‚´ì‹ </span>
                </button>
                <button class="tab-btn" onclick="openTab('sat')">
                    <span class="mission-badge badge-sat">ìˆ˜ëŠ¥</span>
                </button>
                <button class="tab-btn" onclick="openTab('ktm')">KTM ì„œìˆ í‰ê°€</button>
            </div>

            <!-- Concept Tab -->
            <div id="concept" class="tab-content active">
                <div class="mission-section">
                    <div class="mission-header">
                        <div class="mission-title">
                            <span class="mission-badge badge-concept">ê°œë…</span>
                            ê°œë…í•™ìŠµ ë¯¸ì…˜
                        </div>
                        <div>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=7&cid=0" class="add-mission-btn">
                                ì¶”ê°€ <i class="flaticon-plus"></i>
                            </a>
                            <a href="http://mathking.kr/moodle/local/augmented_teacher/twinery/topiclearning.html" target="_blank" class="add-mission-btn" style="background: #6c757d;">
                                ë„ì›€ë§
                            </a>
                        </div>
                    </div>
                    <div class="mission-list">
                        <?php if($mt01): ?>
                            <table><?php echo $mt01; ?></table>
                        <?php else: ?>
                            <div class="empty-state">
                                <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                                <p>ì§„í–‰ì¤‘ì¸ ê°œë…í•™ìŠµ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        <?php endif; ?>
                    </div>
                    
                    <?php if($reviewhistory): ?>
                    <div class="review-section">
                        <div class="review-title">ğŸ“š ê°œë…ë³µìŠµ ì¶”ì²œ</div>
                        <div class="review-list">
                            <table width="100%"><?php echo $reviewhistory; ?></table>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>

                <!-- Completed Concept Missions -->
                <?php if($mt05): ?>
                <div class="mission-section">
                    <div class="mission-title" style="color: #999;">ì™„ë£Œëœ ê°œë…í•™ìŠµ ë¯¸ì…˜</div>
                    <div class="mission-list">
                        <table><?php echo $mt05; ?></table>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- Advanced Tab -->
            <div id="advanced" class="tab-content">
                <div class="mission-section">
                    <div class="mission-header">
                        <div class="mission-title">
                            <span class="mission-badge badge-advanced">ì‹¬í™”</span>
                            ì‹¬í™”í•™ìŠµ ë¯¸ì…˜
                        </div>
                        <div>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=2&cid=0" class="add-mission-btn">
                                ì¶”ê°€ <i class="flaticon-plus"></i>
                            </a>
                            <a href="http://mathking.kr/moodle/local/augmented_teacher/twinery/deeperlearning.html" target="_blank" class="add-mission-btn" style="background: #6c757d;">
                                ë„ì›€ë§
                            </a>
                        </div>
                    </div>
                    <div class="mission-list">
                        <?php if($mt02): ?>
                            <table><?php echo $mt02; ?></table>
                        <?php else: ?>
                            <div class="empty-state">
                                <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                                <p>ì§„í–‰ì¤‘ì¸ ì‹¬í™”í•™ìŠµ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Completed Advanced Missions -->
                <?php if($mt06): ?>
                <div class="mission-section">
                    <div class="mission-title" style="color: #999;">ì™„ë£Œëœ ì‹¬í™”í•™ìŠµ ë¯¸ì…˜</div>
                    <div class="mission-list">
                        <table><?php echo $mt06; ?></table>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- Exam Tab -->
            <div id="exam" class="tab-content">
                <div class="mission-section">
                    <div class="mission-header">
                        <div class="mission-title">
                            <span class="mission-badge badge-exam">ë‚´ì‹ </span>
                            ë‚´ì‹ ëŒ€ë¹„ ë¯¸ì…˜
                        </div>
                        <div>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=3&cid=0" class="add-mission-btn">
                                ì¶”ê°€ <i class="flaticon-plus"></i>
                            </a>
                            <a href="#" class="add-mission-btn" style="background: #6c757d;">
                                ë„ì›€ë§
                            </a>
                        </div>
                    </div>
                    <div class="mission-list">
                        <?php if($mt03): ?>
                            <table><?php echo $mt03; ?></table>
                        <?php else: ?>
                            <div class="empty-state">
                                <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                                <p>ì§„í–‰ì¤‘ì¸ ë‚´ì‹ ëŒ€ë¹„ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Completed Exam Missions -->
                <?php if($mt07): ?>
                <div class="mission-section">
                    <div class="mission-title" style="color: #999;">ì™„ë£Œëœ ë‚´ì‹ ëŒ€ë¹„ ë¯¸ì…˜</div>
                    <div class="mission-list">
                        <table><?php echo $mt07; ?></table>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- SAT Tab -->
            <div id="sat" class="tab-content">
                <div class="mission-section">
                    <div class="mission-header">
                        <div class="mission-title">
                            <span class="mission-badge badge-sat">ìˆ˜ëŠ¥</span>
                            ìˆ˜ëŠ¥ëŒ€ë¹„ ë¯¸ì…˜
                        </div>
                        <div>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=4&cid=0" class="add-mission-btn">
                                ì¶”ê°€ <i class="flaticon-plus"></i>
                            </a>
                            <a href="#" class="add-mission-btn" style="background: #6c757d;">
                                ë„ì›€ë§
                            </a>
                        </div>
                    </div>
                    <div class="mission-list">
                        <?php if($mt04): ?>
                            <table><?php echo $mt04; ?></table>
                        <?php else: ?>
                            <div class="empty-state">
                                <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                                <p>ì§„í–‰ì¤‘ì¸ ìˆ˜ëŠ¥ëŒ€ë¹„ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Completed SAT Missions -->
                <?php if($mt08): ?>
                <div class="mission-section">
                    <div class="mission-title" style="color: #999;">ì™„ë£Œëœ ìˆ˜ëŠ¥ëŒ€ë¹„ ë¯¸ì…˜</div>
                    <div class="mission-list">
                        <table><?php echo $mt08; ?></table>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- KTM Tab -->
            <div id="ktm" class="tab-content">
                <div class="info-section">
                    <div class="info-header">
                        <h3>KTM ì„œìˆ í‰ê°€</h3>
                        <div class="info-links">
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/synergetic_step.php?userid=<?php echo $studentid; ?>" target="_blank">ì¶œì œëª©ë¡</a>
                            <?php if($role !== 'student'): ?>
                                <a href="https://mathking.kr/moodle/local/augmented_teacher/students/beactivelearner.php?userid=<?php echo $studentid; ?>" target="_blank">ê·€ê°€í‰ê°€</a>
                                <a href="https://mathking.kr/moodle/local/augmented_teacher/students/dashboard_fixnotes.php?userid=<?php echo $studentid; ?>" target="_blank">ì˜¤ë‹µë…¸íŠ¸ ê²€ì‚¬</a>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div>
                        <?php include("SPEC Intelligence.php"); ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scroll View -->
        <div id="scrollView" class="scroll-view">
            <!-- Concept Section -->
            <div class="mission-section">
                <div class="mission-header">
                    <div class="mission-title">
                        <span class="mission-badge badge-concept">ê°œë…</span>
                        ê°œë…í•™ìŠµ ë¯¸ì…˜
                    </div>
                    <div>
                        <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=7&cid=0" class="add-mission-btn">
                            ì¶”ê°€ <i class="flaticon-plus"></i>
                        </a>
                        <a href="http://mathking.kr/moodle/local/augmented_teacher/twinery/topiclearning.html" target="_blank" class="add-mission-btn" style="background: #6c757d;">
                            ë„ì›€ë§
                        </a>
                    </div>
                </div>
                <div class="mission-list">
                    <?php if($mt01): ?>
                        <table><?php echo $mt01; ?></table>
                    <?php else: ?>
                        <div class="empty-state">
                            <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                            <p>ì§„í–‰ì¤‘ì¸ ê°œë…í•™ìŠµ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>
                
                <?php if($reviewhistory): ?>
                <div class="review-section">
                    <div class="review-title">ğŸ“š ê°œë…ë³µìŠµ ì¶”ì²œ</div>
                    <div class="review-list">
                        <table width="100%"><?php echo $reviewhistory; ?></table>
                    </div>
                </div>
                <?php endif; ?>
            </div>

            <!-- Advanced Section -->
            <div class="mission-section">
                <div class="mission-header">
                    <div class="mission-title">
                        <span class="mission-badge badge-advanced">ì‹¬í™”</span>
                        ì‹¬í™”í•™ìŠµ ë¯¸ì…˜
                    </div>
                    <div>
                        <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=2&cid=0" class="add-mission-btn">
                            ì¶”ê°€ <i class="flaticon-plus"></i>
                        </a>
                        <a href="http://mathking.kr/moodle/local/augmented_teacher/twinery/deeperlearning.html" target="_blank" class="add-mission-btn" style="background: #6c757d;">
                            ë„ì›€ë§
                        </a>
                    </div>
                </div>
                <div class="mission-list">
                    <?php if($mt02): ?>
                        <table><?php echo $mt02; ?></table>
                    <?php else: ?>
                        <div class="empty-state">
                            <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                            <p>ì§„í–‰ì¤‘ì¸ ì‹¬í™”í•™ìŠµ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Exam Section -->
            <div class="mission-section">
                <div class="mission-header">
                    <div class="mission-title">
                        <span class="mission-badge badge-exam">ë‚´ì‹ </span>
                        ë‚´ì‹ ëŒ€ë¹„ ë¯¸ì…˜
                    </div>
                    <div>
                        <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=3&cid=0" class="add-mission-btn">
                            ì¶”ê°€ <i class="flaticon-plus"></i>
                        </a>
                        <a href="#" class="add-mission-btn" style="background: #6c757d;">
                            ë„ì›€ë§
                        </a>
                    </div>
                </div>
                <div class="mission-list">
                    <?php if($mt03): ?>
                        <table><?php echo $mt03; ?></table>
                    <?php else: ?>
                        <div class="empty-state">
                            <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                            <p>ì§„í–‰ì¤‘ì¸ ë‚´ì‹ ëŒ€ë¹„ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- SAT Section -->
            <div class="mission-section">
                <div class="mission-header">
                    <div class="mission-title">
                        <span class="mission-badge badge-sat">ìˆ˜ëŠ¥</span>
                        ìˆ˜ëŠ¥ëŒ€ë¹„ ë¯¸ì…˜
                    </div>
                    <div>
                        <a href="https://mathking.kr/moodle/local/augmented_teacher/students/selectmission.php?id=<?php echo $studentid; ?>&mtid=4&cid=0" class="add-mission-btn">
                            ì¶”ê°€ <i class="flaticon-plus"></i>
                        </a>
                        <a href="#" class="add-mission-btn" style="background: #6c757d;">
                            ë„ì›€ë§
                        </a>
                    </div>
                </div>
                <div class="mission-list">
                    <?php if($mt04): ?>
                        <table><?php echo $mt04; ?></table>
                    <?php else: ?>
                        <div class="empty-state">
                            <img src="https://mathking.kr/Contents/MATH%20MATRIX/MATH%20images/IMG/MXArti1634548406001.png" alt="Empty">
                            <p>ì§„í–‰ì¤‘ì¸ ìˆ˜ëŠ¥ëŒ€ë¹„ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Long-term Planning Section -->
            <div class="mission-section">
                <div class="mission-header">
                    <div class="mission-title">
                        <span class="mission-badge" style="background: #6c757d; color: white;">í›„ì†</span>
                        ì¥ê¸°ê³„íš
                    </div>
                    <a href="https://mathking.kr/moodle/local/augmented_teacher/students/fullplan.php?id=<?php echo $studentid; ?>" class="add-mission-btn">
                        ì¥ê¸°ê³„íš ì„¤ì • <i class="flaticon-plus"></i>
                    </a>
                </div>
                <div class="mission-list">
                    <?php if($mt05 || $mt06 || $mt07 || $mt08): ?>
                        <table><?php echo $mt05.$mt06.$mt07.$mt08; ?></table>
                    <?php else: ?>
                        <div class="empty-state">
                            <p>ì™„ë£Œëœ ë¯¸ì…˜ì„ í›„ì† ê³„íšìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- KTM Section -->
            <div class="info-section">
                <div class="info-header">
                    <h3>KTM ì„œìˆ í‰ê°€</h3>
                    <div class="info-links">
                        <a href="https://mathking.kr/moodle/local/augmented_teacher/students/synergetic_step.php?userid=<?php echo $studentid; ?>" target="_blank">ì¶œì œëª©ë¡</a>
                        <?php if($role !== 'student'): ?>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/beactivelearner.php?userid=<?php echo $studentid; ?>" target="_blank">ê·€ê°€í‰ê°€</a>
                            <a href="https://mathking.kr/moodle/local/augmented_teacher/students/dashboard_fixnotes.php?userid=<?php echo $studentid; ?>" target="_blank">ì˜¤ë‹µë…¸íŠ¸ ê²€ì‚¬</a>
                        <?php endif; ?>
                    </div>
                </div>
                <div>
                    <?php include("SPEC Intelligence.php"); ?>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <script src="../assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script src="../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../assets/js/ready.min.js"></script>

    <script>
        // View switching
        function switchView(viewType) {
            const tabView = document.getElementById('tabView');
            const scrollView = document.getElementById('scrollView');
            const viewBtns = document.querySelectorAll('.view-btn');
            
            viewBtns.forEach(btn => btn.classList.remove('active'));
            
            if(viewType === 'tab') {
                tabView.classList.add('active');
                scrollView.classList.remove('active');
                viewBtns[0].classList.add('active');
                localStorage.setItem('indexPreferredView', 'tab');
            } else {
                tabView.classList.remove('active');
                scrollView.classList.add('active');
                viewBtns[1].classList.add('active');
                localStorage.setItem('indexPreferredView', 'scroll');
            }
        }

        // Tab switching
        function openTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            tabContents.forEach(content => content.classList.remove('active'));
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the corresponding button
            const tabIndex = {
                'concept': 0,
                'advanced': 1,
                'exam': 2,
                'sat': 3,
                'ktm': 4
            };
            
            if(tabBtns[tabIndex[tabName]]) {
                tabBtns[tabIndex[tabName]].classList.add('active');
            }
            
            localStorage.setItem('indexActiveTab', tabName);
        }

        // Checkbox functions
        function changecheckbox(Eventid, Userid, Missionid, Checkvalue) {
            var checkimsi = 0;
            if(Checkvalue == true) {
                checkimsi = 1;
            }
            $.ajax({
                url: "check.php",
                type: "POST",
                dataType: "json",
                data: {
                    "eventid": Eventid,
                    "userid": Userid,
                    "missionid": Missionid,
                    "checkimsi": checkimsi
                },
                success: function(data) {
                    location.reload();
                }
            });
        }

        // Load user preferences on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load preferred view
            const preferredView = localStorage.getItem('indexPreferredView');
            if(preferredView) {
                switchView(preferredView);
            }
            
            // Load active tab
            const activeTab = localStorage.getItem('indexActiveTab');
            if(activeTab) {
                openTab(activeTab);
            }
        });
    </script>
    
    <!-- Interactive Goal Panel -->
    <div id="goalPanel" class="goal-panel">
        <div class="panel-overlay" onclick="closeGoalPanel()"></div>
        <div class="panel-content">
            <!-- Panel Header -->
            <div class="panel-header">
                <div class="header-title">
                    <h3>ëª©í‘œ ì„¤ì • ë„ìš°ë¯¸</h3>
                    <span class="subtitle">AIê°€ ëª©í‘œ ì„¤ì •ì„ ë„ì™€ë“œë ¤ìš”</span>
                </div>
                <button class="close-btn" onclick="closeGoalPanel()">Ã—</button>
            </div>
            
            <!-- Goal Type Selector -->
            <div class="goal-type-selector">
                <button class="type-btn active" data-type="daily" onclick="switchGoalType('daily')">
                    <i class="fas fa-calendar-day"></i>
                    <span>ì˜¤ëŠ˜ëª©í‘œ</span>
                    <small>ì˜¤ëŠ˜ í•  ì¼</small>
                </button>
                <button class="type-btn" data-type="weekly" onclick="switchGoalType('weekly')">
                    <i class="fas fa-calendar-week"></i>
                    <span>ì£¼ê°„ëª©í‘œ</span>
                    <small>7ì¼ ì‹¤í–‰ ê³„íš</small>
                </button>
                <button class="type-btn" data-type="quarterly" onclick="switchGoalType('quarterly')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>ë¶„ê¸°ëª©í‘œ</span>
                    <small>3ê°œì›” ì¥ê¸° ê³„íš</small>
                </button>
            </div>
            
            <!-- Conversational Interface -->
            <div class="conversation-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Dynamic messages will be inserted here -->
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="smart-suggestions" id="smartSuggestions">
                        <!-- Dynamic suggestions -->
                    </div>
                    <div class="input-wrapper">
                        <input type="text" 
                               id="goalInput" 
                               class="goal-input" 
                               placeholder="ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                               autocomplete="off"
                               onkeypress="if(event.key === 'Enter') processGoalInput()">
                        <button class="send-btn" onclick="processGoalInput()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-steps">
                    <span class="step active">ëª©í‘œ ìœ í˜•</span>
                    <span class="step">ë‚´ìš© ì…ë ¥</span>
                    <span class="step">ì„¸ë¶€ ì„¤ì •</span>
                    <span class="step">í™•ì¸</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Interactive Goal Panel JavaScript -->
    <script>
    // Goal Panel State Management
    class GoalPanelManager {
        constructor(studentId) {
            this.studentId = studentId;
            this.state = {
                isOpen: false,
                currentType: 'daily',
                currentStep: 1,
                conversation: [],
                goalData: {
                    daily: { tasks: [], completed: false },
                    weekly: { goals: [], dates: [], completed: false },
                    quarterly: { goal: '', deadline: '', details: [], completed: false }
                },
                existingGoals: {},
                questionIndex: 0
            };
            
            this.templates = {
                daily: {
                    greeting: "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ í•˜ë£¨ ëª©í‘œë¥¼ í•¨ê»˜ ì„¸ì›Œë³¼ê¹Œìš”? â˜€ï¸",
                    questions: [
                        "ì˜¤ëŠ˜ ê°€ì¥ ì¤‘ìš”í•œ ì¼ 3ê°€ì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                        "ê° ì‘ì—…ì— ì–¼ë§ˆë‚˜ ì‹œê°„ì´ í•„ìš”í•œê°€ìš”?",
                        "ì–¸ì œ ì‹œì‘í•˜ì‹¤ ì˜ˆì •ì¸ê°€ìš”?"
                    ],
                    suggestions: [
                        "ìˆ˜í•™ ë¬¸ì œì§‘ 10í˜ì´ì§€ í’€ê¸°",
                        "ì˜ì–´ ë‹¨ì–´ 50ê°œ ì•”ê¸°",
                        "ê³¼í•™ ì‹¤í—˜ ë³´ê³ ì„œ ì‘ì„±",
                        "ë…ì„œ 1ì‹œê°„"
                    ]
                },
                weekly: {
                    greeting: "ì´ë²ˆ ì£¼ ê³„íšì„ í•¨ê»˜ ì„¸ì›Œë³¼ê¹Œìš”? ğŸ“… ì¼ì£¼ì¼ê°„ì˜ ëª©í‘œë¥¼ ì„¤ì •í•´ë´…ì‹œë‹¤.",
                    questions: [
                        "ì´ë²ˆ ì£¼ì— ê¼­ ì™„ì„±í•´ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?",
                        "ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ ê° ìš”ì¼ë³„ë¡œ í•  ì¼ì„ ë‚˜ëˆ„ì–´ë³¼ê¹Œìš”?",
                        "ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë†’ì€ 3ê°€ì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"
                    ],
                    suggestions: [
                        "ì›”: ìˆ˜í•™ ê°œë… ì •ë¦¬",
                        "í™”: ì˜ì–´ ì—ì„¸ì´ ì‘ì„±",
                        "ìˆ˜: ê³¼í•™ ì‹¤í—˜ ì¤€ë¹„",
                        "ëª©: ì—­ì‚¬ ë°œí‘œ ì¤€ë¹„"
                    ]
                },
                quarterly: {
                    greeting: "ì•ˆë…•í•˜ì„¸ìš”! ë¶„ê¸°ëª©í‘œ ì„¤ì •ì„ ë„ì™€ë“œë¦´ê²Œìš”. ğŸ¯ ì•ìœ¼ë¡œ 3ê°œì›”ê°„ì˜ í° ëª©í‘œë¥¼ ì„¸ì›Œë´…ì‹œë‹¤.",
                    questions: [
                        "ì•ìœ¼ë¡œ 3ê°œì›” ë™ì•ˆ ë‹¬ì„±í•˜ê³  ì‹¶ì€ ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                        "ì´ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë§ˆì¼ìŠ¤í†¤ì„ 3ê°€ì§€ ì•Œë ¤ì£¼ì„¸ìš”.",
                        "ëª©í‘œ ë‹¬ì„± ê¸°í•œì„ ì–¸ì œë¡œ ì„¤ì •í•˜ì‹œê² ì–´ìš”?"
                    ],
                    suggestions: [
                        "ìˆ˜í•™ ì„±ì  20ì  ì˜¬ë¦¬ê¸°",
                        "ì˜ì–´ íšŒí™” ì¤‘ê¸‰ ë ˆë²¨ ë‹¬ì„±",
                        "ì½”ë”© í”„ë¡œì íŠ¸ ì™„ì„±í•˜ê¸°",
                        "ì²´ë ¥ ì¦ì§„ - 5km ë‹¬ë¦¬ê¸°"
                    ]
                }
            };
            
            this.init();
        }
        
        init() {
            this.loadExistingGoals();
        }
        
        loadExistingGoals() {
            // Load existing goals from the server
            const self = this;
            $.ajax({
                url: 'check.php',
                method: 'POST',
                data: {
                    eventid: 99, // Special event ID for fetching goals
                    userid: this.studentId
                },
                success: function(response) {
                    if (response && typeof response === 'object') {
                        self.state.existingGoals = response;
                    }
                },
                error: function() {
                    console.log('Could not load existing goals');
                }
            });
        }
        
        openPanel(type = 'daily') {
            this.state.isOpen = true;
            this.state.currentType = type;
            this.state.currentStep = 1;
            this.state.questionIndex = 0;
            
            document.getElementById('goalPanel').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Set active type button
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
            
            this.startConversation(type);
            this.updateProgressBar(25);
        }
        
        closePanel() {
            if (this.hasUnsavedChanges()) {
                if (!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            
            this.state.isOpen = false;
            document.getElementById('goalPanel').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        switchGoalType(type) {
            this.state.currentType = type;
            this.state.questionIndex = 0;
            
            // Update active button
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
            
            this.startConversation(type);
        }
        
        startConversation(type) {
            const template = this.templates[type];
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear previous conversation
            chatMessages.innerHTML = '';
            this.state.conversation = [];
            
            // Add greeting message
            this.addAssistantMessage(template.greeting);
            
            // Check for existing goals
            const hasExisting = this.checkExistingGoal(type);
            if (hasExisting) {
                setTimeout(() => {
                    this.addAssistantMessage(
                        `í˜„ì¬ ì„¤ì •ëœ ${this.getTypeName(type)}ì´(ê°€) ìˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ, ì•„ë‹ˆë©´ ìƒˆë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`,
                        [
                            {text: 'ìˆ˜ì •í•˜ê¸°', action: 'edit'},
                            {text: 'ìƒˆë¡œ ë§Œë“¤ê¸°', action: 'new'}
                        ]
                    );
                }, 1000);
            } else {
                // Start with first question
                setTimeout(() => {
                    this.askNextQuestion();
                }, 1500);
            }
            
            // Update suggestions
            this.updateSuggestions(template.suggestions);
        }
        
        addAssistantMessage(text, quickActions = []) {
            const message = document.createElement('div');
            message.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'assistant-avatar';
            avatar.innerHTML = 'ğŸ¤–';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text;
            
            if (quickActions.length > 0) {
                const actions = document.createElement('div');
                actions.className = 'quick-actions';
                
                quickActions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-action-btn';
                    btn.textContent = action.text;
                    btn.onclick = () => this.handleQuickAction(action);
                    actions.appendChild(btn);
                });
                
                bubble.appendChild(actions);
            }
            
            message.appendChild(avatar);
            message.appendChild(bubble);
            
            document.getElementById('chatMessages').appendChild(message);
            this.scrollToBottom();
        }
        
        addUserMessage(text) {
            const message = document.createElement('div');
            message.className = 'message user';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            
            message.appendChild(bubble);
            
            document.getElementById('chatMessages').appendChild(message);
            this.scrollToBottom();
        }
        
        processGoalInput() {
            const input = document.getElementById('goalInput');
            const value = input.value.trim();
            
            if (!value) return;
            
            // Add user message
            this.addUserMessage(value);
            
            // Clear input
            input.value = '';
            
            // Process based on current context
            this.handleUserInput(value);
        }
        
        handleUserInput(input) {
            const type = this.state.currentType;
            
            // Store input based on current question
            this.storeGoalData(type, input);
            
            // Provide feedback
            setTimeout(() => {
                this.provideAIFeedback(input);
            }, 500);
        }
        
        storeGoalData(type, input) {
            const data = this.state.goalData[type];
            
            if (type === 'daily') {
                data.tasks.push(input);
            } else if (type === 'weekly') {
                data.goals.push(input);
            } else if (type === 'quarterly') {
                if (this.state.questionIndex === 0) {
                    data.goal = input;
                } else if (this.state.questionIndex === 1) {
                    data.details.push(input);
                } else if (this.state.questionIndex === 2) {
                    data.deadline = input;
                }
            }
        }
        
        provideAIFeedback(input) {
            const feedback = this.analyzeGoalQuality(input);
            
            if (feedback.needsImprovement) {
                this.addAssistantMessage(
                    `ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ${feedback.suggestion}`,
                    [
                        {text: 'ìˆ˜ì •í•˜ê¸°', action: 'revise'},
                        {text: 'ê³„ì†í•˜ê¸°', action: 'continue'}
                    ]
                );
            } else {
                this.addAssistantMessage(`í›Œë¥­í•´ìš”! ${feedback.praise}`);
                
                // Move to next question or complete
                this.state.questionIndex++;
                const template = this.templates[this.state.currentType];
                
                if (this.state.questionIndex < template.questions.length) {
                    setTimeout(() => {
                        this.askNextQuestion();
                    }, 1000);
                } else {
                    // All questions answered, show summary
                    setTimeout(() => {
                        this.showGoalSummary();
                    }, 1000);
                }
            }
            
            // Update progress
            const progress = Math.min(100, 25 + (this.state.questionIndex * 25));
            this.updateProgressBar(progress);
        }
        
        analyzeGoalQuality(input) {
            const analysis = {
                needsImprovement: false,
                suggestion: '',
                praise: ''
            };
            
            // Check for SMART criteria
            if (input.length < 10) {
                analysis.needsImprovement = true;
                analysis.suggestion = 'ë” êµ¬ì²´ì ìœ¼ë¡œ ë§Œë“¤ì–´ë³¼ê¹Œìš”? ì˜ˆë¥¼ ë“¤ì–´, "ìˆ˜í•™ ë¬¸ì œì§‘ 2ë‹¨ì› 10í˜ì´ì§€ ì™„ì„±" ê°™ì€ í˜•ì‹ì€ ì–´ë–¨ê¹Œìš”?';
            } else if (!this.containsNumbers(input) && this.state.currentType !== 'quarterly') {
                analysis.needsImprovement = true;
                analysis.suggestion = 'ì¸¡ì • ê°€ëŠ¥í•œ ëª©í‘œë¥¼ ìœ„í•´ ìˆ«ìë¥¼ í¬í•¨ì‹œì¼œë³´ì„¸ìš”. ì˜ˆ: "ì˜ì–´ ë‹¨ì–´ 30ê°œ ì•”ê¸°"';
            } else {
                const praises = [
                    'êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ëª©í‘œë„¤ìš”!',
                    'ì•„ì£¼ ì˜ ì„¤ì •í•˜ì…¨ì–´ìš”!',
                    'í›Œë¥­í•œ ëª©í‘œì…ë‹ˆë‹¤!',
                    'ì‹¤ì²œ ê°€ëŠ¥í•œ ì¢‹ì€ ëª©í‘œì˜ˆìš”!'
                ];
                analysis.praise = praises[Math.floor(Math.random() * praises.length)];
            }
            
            return analysis;
        }
        
        askNextQuestion() {
            const template = this.templates[this.state.currentType];
            const question = template.questions[this.state.questionIndex];
            
            if (question) {
                this.addAssistantMessage(question);
                
                // Update suggestions based on question
                this.updateContextualSuggestions();
            }
        }
        
        updateSuggestions(suggestions) {
            const container = document.getElementById('smartSuggestions');
            container.innerHTML = '';
            
            suggestions.forEach(text => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = text;
                chip.onclick = () => {
                    document.getElementById('goalInput').value = text;
                    this.processGoalInput();
                };
                container.appendChild(chip);
            });
        }
        
        updateContextualSuggestions() {
            const type = this.state.currentType;
            const questionIndex = this.state.questionIndex;
            
            let suggestions = [];
            
            if (type === 'daily') {
                if (questionIndex === 0) {
                    suggestions = [
                        "ìˆ˜í•™ 2ë‹¨ì› ë³µìŠµ",
                        "ì˜ì–´ ì—ì„¸ì´ ì´ˆì•ˆ ì‘ì„±",
                        "ê³¼í•™ ì‹¤í—˜ ë³´ê³ ì„œ",
                        "ìš´ë™ 30ë¶„"
                    ];
                } else if (questionIndex === 1) {
                    suggestions = ["30ë¶„", "1ì‹œê°„", "2ì‹œê°„", "3ì‹œê°„"];
                } else if (questionIndex === 2) {
                    suggestions = ["ì˜¤ì „ 9ì‹œ", "ì˜¤ì „ 10ì‹œ", "ì˜¤í›„ 2ì‹œ", "ì˜¤í›„ 4ì‹œ"];
                }
            } else if (type === 'weekly') {
                if (questionIndex === 0) {
                    suggestions = [
                        "ì¤‘ê°„ê³ ì‚¬ ëŒ€ë¹„ ì™„ë£Œ",
                        "í”„ë¡œì íŠ¸ 50% ì§„í–‰",
                        "ì˜ì–´ Chapter 3 ë§ˆìŠ¤í„°",
                        "ìˆ˜í•™ ë¬¸ì œì§‘ 1ê¶Œ ì™„ë£Œ"
                    ];
                } else if (questionIndex === 1) {
                    suggestions = [
                        "ì›”: ê°œë… ì •ë¦¬",
                        "í™”: ë¬¸ì œ í’€ì´",
                        "ìˆ˜: ì˜¤ë‹µ ì •ë¦¬",
                        "ëª©: ì‹¬í™” í•™ìŠµ"
                    ];
                }
            } else if (type === 'quarterly') {
                if (questionIndex === 0) {
                    suggestions = [
                        "ì „ ê³¼ëª© í‰ê·  90ì  ë‹¬ì„±",
                        "í† ìµ 800ì  ë‹¬ì„±",
                        "ì½”ë”© í¬íŠ¸í´ë¦¬ì˜¤ ì™„ì„±",
                        "ëŒ€í•™ ì…ì‹œ ì¤€ë¹„ ì™„ë£Œ"
                    ];
                } else if (questionIndex === 1) {
                    suggestions = [
                        "1ê°œì›”ì°¨: ê¸°ì´ˆ ë‹¤ì§€ê¸°",
                        "2ê°œì›”ì°¨: ì‹¬í™” í•™ìŠµ",
                        "3ê°œì›”ì°¨: ì‹¤ì „ ì—°ìŠµ",
                        "ë§¤ì£¼ ëª¨ì˜ê³ ì‚¬"
                    ];
                }
            }
            
            this.updateSuggestions(suggestions);
        }
        
        showGoalSummary() {
            const type = this.state.currentType;
            const data = this.state.goalData[type];
            
            let summaryHtml = `<h4>ğŸ“ ${this.getTypeName(type)} ì„¤ì • ì™„ë£Œ!</h4><br>`;
            
            if (type === 'daily') {
                summaryHtml += '<strong>ì˜¤ëŠ˜ì˜ ëª©í‘œ:</strong><ul>';
                data.tasks.forEach(task => {
                    summaryHtml += `<li>${task}</li>`;
                });
                summaryHtml += '</ul>';
            } else if (type === 'weekly') {
                summaryHtml += '<strong>ì£¼ê°„ ëª©í‘œ:</strong><ul>';
                data.goals.forEach(goal => {
                    summaryHtml += `<li>${goal}</li>`;
                });
                summaryHtml += '</ul>';
            } else if (type === 'quarterly') {
                summaryHtml += `<strong>ë¶„ê¸° ëª©í‘œ:</strong> ${data.goal}<br>`;
                if (data.details.length > 0) {
                    summaryHtml += '<strong>ì„¸ë¶€ ê³„íš:</strong><ul>';
                    data.details.forEach(detail => {
                        summaryHtml += `<li>${detail}</li>`;
                    });
                    summaryHtml += '</ul>';
                }
                if (data.deadline) {
                    summaryHtml += `<strong>ëª©í‘œ ê¸°í•œ:</strong> ${data.deadline}`;
                }
            }
            
            this.addAssistantMessage(summaryHtml);
            
            // Add save button
            setTimeout(() => {
                this.addAssistantMessage(
                    'ëª©í‘œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    [
                        {text: 'ì €ì¥í•˜ê¸°', action: 'save'},
                        {text: 'ìˆ˜ì •í•˜ê¸°', action: 'edit_summary'}
                    ]
                );
            }, 1000);
            
            this.updateProgressBar(100);
        }
        
        handleQuickAction(action) {
            if (action.action === 'save') {
                this.saveGoals();
            } else if (action.action === 'continue') {
                this.state.questionIndex++;
                this.askNextQuestion();
            } else if (action.action === 'revise') {
                this.addAssistantMessage('ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”. ë” êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ë³´ì„¸ìš”!');
            } else if (action.action === 'new') {
                this.state.goalData[this.state.currentType] = 
                    this.state.currentType === 'daily' ? { tasks: [], completed: false } :
                    this.state.currentType === 'weekly' ? { goals: [], dates: [], completed: false } :
                    { goal: '', deadline: '', details: [], completed: false };
                this.state.questionIndex = 0;
                this.askNextQuestion();
            } else if (action.action === 'edit') {
                this.loadExistingGoalData();
            }
        }
        
        saveGoals() {
            const type = this.state.currentType;
            const data = this.state.goalData[type];
            const studentId = this.studentId;
            
            // Prepare data based on type
            let saveData = {
                eventid: 2,
                userid: studentId,
                checkimsi: 1
            };
            
            if (type === 'daily') {
                saveData.type = 'ì˜¤ëŠ˜ëª©í‘œ';
                saveData.inputtext = data.tasks.join(' / ');
            } else if (type === 'weekly') {
                saveData.type = 'ì£¼ê°„ëª©í‘œ';
                saveData.inputtext = data.goals.join(' / ');
            } else if (type === 'quarterly') {
                saveData.type = 'ì‹œí—˜ëª©í‘œ';
                saveData.inputtext = data.goal;
                saveData.deadline = data.deadline;
            }
            
            // Save to server
            $.ajax({
                url: 'check.php',
                method: 'POST',
                data: saveData,
                success: () => {
                    this.addAssistantMessage('ëª©í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰ í™”ì´íŒ…í•˜ì„¸ìš”!');
                    
                    // Mark as completed
                    data.completed = true;
                    
                    // Close panel after 2 seconds
                    setTimeout(() => {
                        this.closePanel();
                        location.reload();
                    }, 2000);
                },
                error: () => {
                    this.addAssistantMessage('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        }
        
        checkExistingGoal(type) {
            // Check if there are existing goals for this type
            return this.state.existingGoals && this.state.existingGoals[type];
        }
        
        loadExistingGoalData() {
            // Load and display existing goal data for editing
            const type = this.state.currentType;
            const existing = this.state.existingGoals[type];
            
            if (existing) {
                this.addAssistantMessage(`í˜„ì¬ ì„¤ì •ëœ ${this.getTypeName(type)}: "${existing}"`);
                setTimeout(() => {
                    this.addAssistantMessage('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }, 1000);
            }
        }
        
        updateProgressBar(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
            
            // Update step indicators
            const steps = document.querySelectorAll('.step');
            const currentStep = Math.floor((percentage / 100) * 4);
            
            steps.forEach((step, index) => {
                if (index <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }
        
        scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTop = messages.scrollHeight;
        }
        
        getTypeName(type) {
            const names = {
                daily: 'ì˜¤ëŠ˜ëª©í‘œ',
                weekly: 'ì£¼ê°„ëª©í‘œ',
                quarterly: 'ë¶„ê¸°ëª©í‘œ'
            };
            return names[type] || type;
        }
        
        containsNumbers(str) {
            return /\d/.test(str);
        }
        
        hasUnsavedChanges() {
            return Object.keys(this.state.goalData).some(type => {
                const data = this.state.goalData[type];
                if (type === 'daily') return data.tasks.length > 0 && !data.completed;
                if (type === 'weekly') return data.goals.length > 0 && !data.completed;
                if (type === 'quarterly') return data.goal !== '' && !data.completed;
                return false;
            });
        }
    }
    
    // Initialize Goal Panel Manager
    let goalManager;
    document.addEventListener('DOMContentLoaded', () => {
        const studentId = <?php echo $studentid; ?>;
        goalManager = new GoalPanelManager(studentId);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && goalManager.state.isOpen) {
                goalManager.closePanel();
            }
        });
    });
    
    // Global functions for HTML onclick
    function openGoalPanel(type) {
        if (!goalManager) {
            const studentId = <?php echo $studentid; ?>;
            goalManager = new GoalPanelManager(studentId);
        }
        goalManager.openPanel(type);
    }
    
    function closeGoalPanel() {
        if (goalManager) {
            goalManager.closePanel();
        }
    }
    
    function processGoalInput() {
        if (goalManager) {
            goalManager.processGoalInput();
        }
    }
    
    function switchGoalType(type) {
        if (goalManager) {
            goalManager.switchGoalType(type);
        }
    }
    </script>
</body>
</html>