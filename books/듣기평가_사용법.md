# 수학 듣기평가 시스템 사용법

## 개요
`@` 기호를 사용하여 대본을 구간별로 나누고, 각 구간이 재생 완료된 후 "다음" 버튼을 클릭해야 다음 구간이 재생되는 시스템입니다.

## 파일 위치
- **메인 파일**: `c:\1 Project\augmented_teacher\books\openai_tts_pmemory.php`

## 사용 방법

### 1. 듣기평가 모드 (@ 기호 사용)

대본에 `@` 기호를 포함하면 자동으로 듣기평가 모드로 전환됩니다.

**예시 대본:**
```
지금 문제의 전체 그림을 먼저 바라보세요. 무엇을 구하라고 했는지 귀로 또렷하게 말해볼까요? 맞아요! 옆모습 그림처럼 정육면체를 엑스 길이로 오개 쌓아 만든 입체도형에서, 부피를 에이, 겉넓이를 비라 두고, 에이가 이비 빼기 삼백이십과 같을 때 엑스를 찾으라는 것이에요.@

지금 그림의 오른쪽 위를 보세요. 가장 위에 놓인 정육면체가 보이나요? 맞아요! 정육면체 하나의 부피는 변이 엑스인 정육면체의 기본식으로 표현돼요.@

지금 그림의 아래쪽을 보세요. 맨 아래 줄에 정육면체가 세 개가 나란히 붙어 있나요? 맞아요! 서로 맞닿은 면들은 겉으로 드러나지 않으니 겉넓이에서 빠진다는 점이 핵심이에요.@
```

### 2. 일반 모드 (@ 기호 없음)

`@` 기호가 없으면 기존 방식대로 연속 재생됩니다.

## 동작 흐름

1. **대본 입력**: 텍스트 영역에 `@` 기호를 포함한 대본 입력
2. **음성 생성 버튼 클릭**: "음성 생성" 버튼을 클릭
3. **자동 구간 분리**: 시스템이 자동으로 `@` 기호를 기준으로 구간 분리
4. **TTS 생성**: 각 구간별로 음성 파일 생성
5. **첫 구간 자동 재생**: 생성 완료 후 첫 번째 구간 자동 재생
6. **재생 완료 대기**: 첫 구간 재생이 끝나면 "다음" 버튼 활성화
7. **다음 구간 재생**: "다음" 버튼을 클릭하면 다음 구간 재생
8. **반복**: 모든 구간이 끝날 때까지 반복
9. **완료 및 업로드**: 모든 구간 재생 완료 후 전체 오디오 병합 및 서버 자동 업로드

## UI 안내

### "다음" 버튼 상태
- **비활성화 (회색)**: 현재 구간이 재생 중일 때
- **활성화 (녹색)**: 구간 재생이 완료되어 클릭 가능할 때
- **버튼 텍스트**: "다음 구간 재생 (현재구간/전체구간)" 형식으로 표시

### 진행 상황 표시
- **파란색 박스**: 현재 재생 중인 구간 번호 표시
- **회색 박스**: 현재 재생 중인 대본 텍스트 미리보기 (최대 200자)
- **녹색 체크**: 각 구간 재생 완료 시 표시

## 주요 기능

### 1. 구간별 재생 제어
- 각 `@` 기호로 완전히 독립된 구간으로 분리
- 한 구간이 끝나야 다음 구간 재생 가능
- 중간에 멈추고 싶을 때도 구간 단위로 제어 가능

### 2. 진행 상황 추적
- 실시간으로 "구간 N/M" 형식으로 진행도 표시
- 현재 재생 중인 내용을 화면에 표시
- 재생 완료된 구간은 ✅ 마크로 확인 가능

### 3. 자동 병합 및 업로드
- 모든 구간 재생 완료 후 자동으로 하나의 오디오 파일로 병합
- 서버에 자동 업로드되어 나중에 재사용 가능

## 기술적 세부사항

### 오디오 생성
- **TTS 모델**: OpenAI TTS-1
- **음성**: alloy
- **형식**: WAV (서버 업로드용)

### 구간 분리
- **구분자**: `@` 기호
- **전처리**: 앞뒤 공백 제거
- **최소 구간**: 빈 텍스트는 자동 제외

### 재생 제어
- **Web Audio API** 사용
- **BufferSource** 기반 재생
- **onended 이벤트**로 재생 완료 감지

## 문제 해결

### Q: "다음" 버튼이 활성화되지 않아요
A: 현재 구간의 재생이 완료될 때까지 기다려주세요. 재생이 끝나면 자동으로 활성화됩니다.

### Q: 음성이 생성되지 않아요
A: OpenAI API 키가 유효한지 확인하고, 인터넷 연결을 확인해주세요.

### Q: 구간이 너무 길어요
A: `@` 기호를 더 자주 사용하여 구간을 더 작게 나눌 수 있습니다.

### Q: 일반 모드로 돌아가고 싶어요
A: 대본에서 모든 `@` 기호를 제거하면 일반 모드로 동작합니다.

## 업데이트 내역

### 2025-10-13
- `@` 기호 기반 듣기평가 모드 추가
- 순차 재생 시스템 구현
- "다음" 버튼 UI 추가
- 진행 상황 표시 기능 추가
- 현재 재생 중인 텍스트 표시 기능 추가
- 자동 병합 및 업로드 기능 추가
- CSS 스타일 개선

## 참고

- 기존 기능(일반 모드)은 그대로 유지됩니다.
- `@` 기호의 유무에 따라 자동으로 모드가 전환됩니다.
- 두 모드를 섞어서 사용할 수 없습니다. (한 대본에서는 하나의 모드만 사용)


