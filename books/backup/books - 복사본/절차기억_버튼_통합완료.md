# 🎓 mynotepause.php 절차기억 버튼 → 듣기평가 인터페이스 통합 완료!

## 🎯 해결한 문제

### Before (문제 상황)
```
mynotepause.php에서 🟡 아이콘 클릭
  ↓
절차기억 나레이션 생성됨
  ↓
❌ 듣기평가 인터페이스가 나타나지 않음
  ↓
openai_tts_pmemory.php에서만 인터페이스 표시됨
```

### After (해결 완료)
```
mynotepause.php에서 🟡 아이콘 클릭
  ↓
절차기억 나레이션 생성 (@ 구간 분리 포함)
  ↓
TTS 자동 생성 (각 구간별)
  ↓
✅ 페이지 새로고침 후 듣기평가 인터페이스 자동 표시!
  ↓
중앙 하단에 미니 플레이어 나타남
```

---

## 🔧 수정 내용

### 1. `generate_dialog_narration.php` 프롬프트 수정

**Line 122-130 추가:**

```php
출력 규칙:
- 한글만 사용 (숫자, 특수문자, 기호 사용 금지)
- 자연스러운 흐름의 단일 문단 (목록화 금지)
- 관찰자 시점에서 학생과 함께 탐구하는 어조
- **각 주요 단계마다 @ 기호를 삽입하여 구간을 나누세요**  ← NEW!
- @ 기호는 학생이 생각할 시간을 갖도록 일시정지 지점으로 사용됩니다
- 각 @ 구간은 30초-1분 분량의 설명으로 구성하세요

마무리:
- 절차를 스스로 정리해보도록 유도
- "이제 우리가 관찰한 절차를 정리하면..."
- 유사 문제에 적용 가능한 일반화된 절차 제시
- 마지막에 "절차기억 형성활동을 시작합니다.@"를 추가하고, 중요한 사실들을 다시 강조하며 정리  ← NEW!
```

---

## 📊 전체 동작 흐름

### A. 사용자 액션
```
mynotepause.php 페이지 열기
  ↓
🟡 아이콘 클릭 (절차기억 나레이션 생성)
  ↓
확인 대화상자 → "생성" 클릭
```

### B. 백엔드 처리
```
generateDialogNarration(contentsid) 함수 실행
  ↓
AJAX → generate_dialog_narration.php
  ↓
GPT-4o-mini 호출 (수정된 프롬프트)
  ↓
나레이션 텍스트 생성 (@ 기호 포함)
  ↓
@ 기호 감지 → 듣기평가 모드
```

### C. 듣기평가 모드 처리
```
나레이션을 @ 기호로 split
  ↓
각 구간별로 TTS 생성 (OpenAI TTS API)
  ↓
파일 저장: /audiofiles/pmemory/sections/
  - cid30093ct1_section1.mp3
  - cid30093ct1_section2.mp3
  - cid30093ct1_section3.mp3
  - ...
  ↓
JSON 데이터 구성:
{
  "mode": "listening_test",
  "sections": ["URL1", "URL2", "URL3", ...],
  "text_sections": ["텍스트1", "텍스트2", "텍스트3", ...]
}
  ↓
DB 저장:
- reflections1 ← JSON 데이터
- audiourl2 ← 첫 번째 구간 URL
```

### D. 페이지 새로고침
```
setTimeout(function() {
  location.reload();
}, 3000);
  ↓
mynotepause.php 다시 로드
  ↓
reflections1 데이터 확인
  ↓
✅ 듣기평가 인터페이스 렌더링!
```

---

## 💡 핵심 로직

### 1. 프롬프트 수정이 핵심!

**Before (GPT가 @ 기호를 생성하지 않음):**
```
"자, 이 문제를 살펴볼까요. 먼저 문제의 구조를 관찰해봅시다. 
다음으로 이 부분에서 패턴을 찾아봅시다..."
```

**After (GPT가 @ 기호를 생성함):**
```
"자, 이 문제를 살펴볼까요. 먼저 문제의 구조를 관찰해봅시다.@
다음으로 이 부분에서 패턴을 찾아봅시다.@
이제 계산 절차를 따라가 봅시다.@
절차기억 형성활동을 시작합니다.@
중요한 사실을 다시 정리하면..."
```

### 2. 이미 구현된 듣기평가 시스템 활용

`generate_dialog_narration.php`는 이미 듣기평가 모드를 지원하고 있었습니다!

**Line 213-289:**
```php
// @ 기호로 분리된 듣기평가 모드 확인
$isListeningTest = (strpos($narrationText, '@') !== false);

if ($isListeningTest) {
    debug_log("듣기평가 모드 감지됨");
    
    // @ 기호로 구간 분리
    $sections = array_filter(array_map('trim', explode('@', $narrationText)));
    $sectionCount = count($sections);
    
    // 각 구간별로 TTS 생성
    foreach ($sections as $index => $sectionText) {
        // TTS API 호출
        // 파일 저장
    }
    
    // reflections1 필드에 구간 정보 저장
    $sectionsInfo = json_encode([
        'mode' => 'listening_test',
        'sections' => $sectionFiles,
        'text_sections' => $sections
    ]);
    
    $DB->execute("UPDATE {icontent_pages} SET reflections1 = ? WHERE id = ?",
        array($sectionsInfo, $contentsid));
}
```

---

## 🎨 UI 표시

### mynotepause.php에서 확인

**Line 290-330:**
```php
// reflections1 필드 확인
$reflections1 = $cnttext->reflections1;

if (!empty($reflections1)) {
  $sectionData = json_decode($reflections1, true);
  
  if ($sectionData && isset($sectionData['mode']) && $sectionData['mode'] === 'listening_test') {
    // 듣기평가 인터페이스 렌더링
    $sectionFiles = $sectionData['sections'];
    $textSections = $sectionData['text_sections'];
    $sectionCount = count($sectionFiles);
    
    // 중앙 하단 플로팅 플레이어 생성
    $audiocnt .= '
    <style>
      /* 중앙 하단 플로팅 미니 플레이어 */
      .listening-test-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        ...
      }
    </style>
    <div class="listening-test-container" id="listeningContainer">
      ...
    </div>';
  }
}
```

---

## 📝 사용 시나리오

### 시나리오 1: 새 문제에 절차기억 생성

```
1. mynotepause.php에서 문제 페이지 열기
2. 🟡 아이콘 클릭 (상단 목차 오른쪽)
3. "절차기억 나레이션 생성하시겠습니까?" → "생성"
4. 로딩 중... (약 1-2분)
5. "절차기억 나레이션 생성 완료!" 
6. 3초 후 자동 새로고침
7. ✅ 중앙 하단에 듣기평가 플레이어 나타남!
```

### 시나리오 2: 기존 절차기억 재생성

```
1. mynotepause.php에서 이미 절차기억이 있는 페이지 열기
2. 🟢 아이콘 클릭 (audiourl2 존재)
3. "절차기억 나레이션 재생성하시겠습니까?" → "생성"
4. 로딩 중...
5. 생성 완료 → 자동 새로고침
6. ✅ 업데이트된 듣기평가 플레이어 표시
```

---

## 🔍 디버깅 정보

### 로그 파일 위치
```
/home/moodle/public_html/moodle/local/augmented_teacher/books/dialog_narration_error.log
```

### 확인 사항

#### 1. GPT가 @ 기호를 생성했는지
```php
debug_log("나레이션 텍스트: " . $narrationText);
```

#### 2. 듣기평가 모드로 감지되었는지
```php
debug_log("듣기평가 모드 감지됨");
debug_log("총 {$sectionCount}개 구간으로 분리됨");
```

#### 3. TTS 파일이 생성되었는지
```php
debug_log("구간 {$sectionNum} 저장 완료: {$fileName}");
```

#### 4. DB에 저장되었는지
```php
debug_log("구간 정보 DB 저장 완료");
```

---

## 🧪 테스트 방법

### 테스트 1: 기본 생성
```
1. https://mathking.kr/moodle/local/augmented_teacher/books/mynotepause.php?cid=59&nch=7&cmid=87729&page=6&studentid=2&quizid=
2. 🟡 아이콘 클릭
3. 생성 확인
4. 새로고침 후 플레이어 확인
```

### 테스트 2: 구간 재생
```
1. "다음 구간" 버튼 클릭
2. 구간 2로 이동 확인
3. 진행 표시: 🎧 구간 2/12
4. 텍스트 표시 업데이트 확인
```

### 테스트 3: 진행바 점프
```
1. 하단 진행바 점(dot) 클릭
2. 해당 구간으로 점프 확인
3. 활성 점 색상 변경 확인
4. 이전 점들 완료 상태 표시 확인
```

---

## 📊 데이터 구조

### DB 테이블: `mdl_icontent_pages`

| 필드 | 용도 | 예시 |
|------|------|------|
| `reflections0` | 나레이션 텍스트 원본 | "자, 이 문제를 살펴볼까요...@..." |
| `reflections1` | 듣기평가 JSON 데이터 | `{"mode":"listening_test",...}` |
| `audiourl2` | 첫 번째 구간 URL | `https://mathking.kr/audiofiles/...` |

### reflections1 JSON 구조
```json
{
  "mode": "listening_test",
  "sections": [
    "https://mathking.kr/audiofiles/pmemory/sections/cid30093ct1_section1.mp3",
    "https://mathking.kr/audiofiles/pmemory/sections/cid30093ct1_section2.mp3",
    "https://mathking.kr/audiofiles/pmemory/sections/cid30093ct1_section3.mp3"
  ],
  "text_sections": [
    "자, 이 문제를 살펴볼까요. 먼저 문제의 구조를 관찰해봅시다.",
    "다음으로 이 부분에서 패턴을 찾아봅시다.",
    "이제 계산 절차를 따라가 봅시다."
  ]
}
```

---

## 🎯 장점

### Before (openai_tts_pmemory.php만 사용)
```
- 별도 페이지 이동 필요
- 텍스트 직접 입력해야 함
- 수동으로 @ 기호 추가
- 페이지 이탈
```

### After (mynotepause.php 통합)
```
✅ 현재 페이지에서 즉시 생성
✅ 콘텐츠 자동 인식
✅ GPT가 자동으로 @ 구간 분리
✅ 생성 후 바로 사용 가능
✅ 페이지 이탈 없음
✅ 원클릭 생성
```

---

## 🔄 업데이트 히스토리

### Version 1.0 (현재)
- `generate_dialog_narration.php` 프롬프트에 @ 기호 지시 추가
- GPT가 자동으로 구간 분리
- mynotepause.php에서 원클릭 생성 → 자동 인터페이스 표시

### Future (예정)
- 구간 개수 조절 옵션
- 구간 시간 설정
- 음성 속도 조절
- 목소리 선택 (alloy, nova, shimmer 등)

---

## 🐛 트러블슈팅

### 문제 1: 생성 후에도 인터페이스가 안 나타남
**원인:** reflections1에 데이터가 없음

**확인:**
```sql
SELECT reflections1 FROM mdl_icontent_pages WHERE id=30093;
```

**해결:**
- 로그 파일 확인: `dialog_narration_error.log`
- GPT 응답에 @ 기호가 있는지 확인
- DB 저장 로그 확인

### 문제 2: GPT가 @ 기호를 생성하지 않음
**원인:** 프롬프트 업데이트 안 됨

**해결:**
- `generate_dialog_narration.php` Line 122-130 확인
- "각 주요 단계마다 @ 기호를 삽입하여 구간을 나누세요" 문구 있는지 확인

### 문제 3: TTS 파일 생성 실패
**원인:** 디렉토리 권한 또는 API 키 문제

**확인:**
```bash
ls -la /home/moodle/public_html/audiofiles/pmemory/sections/
```

**해결:**
```bash
chmod 755 /home/moodle/public_html/audiofiles/pmemory/sections/
```

---

## 📁 수정된 파일

### 1. `books/generate_dialog_narration.php`
- **Line 122-130**: 프롬프트에 @ 기호 지시 추가
- **기능**: GPT가 자동으로 @ 기호로 구간 분리하도록 함

---

## 🎉 완성!

이제 **mynotepause.php**에서 🟡 아이콘만 클릭하면:

```
원클릭 → 자동 생성 → 자동 TTS → 자동 인터페이스!
```

**특징:**
- ✅ GPT가 자동으로 @ 구간 분리
- ✅ 각 구간별 TTS 자동 생성
- ✅ DB에 자동 저장
- ✅ 페이지 새로고침 후 즉시 사용 가능
- ✅ 중앙 하단 미니 플레이어
- ✅ 드래그로 이동 가능
- ✅ 최소화/최대화 가능
- ✅ 진행바 점프 기능

---

**최종 업데이트:** 2025-10-14  
**버전:** 4.0  
**상태:** 완료 ✅

**지금 바로 테스트해 보세요!** 🎓✨

---

## 📹 데모 시나리오

```
Step 1: mynotepause.php 접속
Step 2: 🟡 아이콘 클릭
Step 3: "생성" 버튼 클릭
Step 4: 로딩 중... (약 1-2분)
Step 5: "생성 완료!" 메시지
Step 6: 3초 후 자동 새로고침
Step 7: 🎧 중앙 하단에 플레이어 나타남!
Step 8: "다음 구간" 클릭하여 순차 재생
Step 9: 진행바 점 클릭하여 원하는 구간 점프
```

**Perfect!** 🎯


