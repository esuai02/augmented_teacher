# 🧪 JSON 절차기억 나레이션 시스템 테스트 계획

## 📋 테스트 개요

**목적**: JSON 기반 절차기억 나레이션 생성부터 재생까지 전체 워크플로우 검증

**범위**:
- GPT 프롬프트 → JSON 생성
- JSON 파싱 → TTS 생성
- DB 저장 → 플레이어 로드
- UI 인터랙션 → 오디오 재생

---

## 🎯 테스트 시나리오

### 시나리오 1: 전체 워크플로우 (End-to-End)
**목표**: 나레이션 생성부터 재생까지 완전한 흐름 검증

#### 단계:
1. **나레이션 생성**
   - URL: `openai_tts_pmemory.php?contentsid=TEST001&contentstype=1`
   - 테스트 문제 입력:
     ```
     문제: 다음 식을 간단히 하시오. (x²+2x+1)/(x+1)
     풀이: x²+2x+1 = (x+1)² 이므로, (x+1)²/(x+1) = x+1
     답: x+1
     ```
   - "🎓 절차기억 나레이션 생성" 버튼 클릭

2. **생성 결과 확인**
   - ✅ JSON 포맷 출력 확인
   - ✅ 구조 검증:
     ```json
     {
       "문제설명": "...",
       "기본지시문1": "...",
       "보조지시문1": [...],
       "기본지시문2": "...",
       ...
       "전체정리": "...",
       "핵심정리": "...",
       "구조기억": "..."
     }
     ```
   - ✅ DB 저장 확인 메시지

3. **TTS 음성 생성**
   - "🎵 음성 생성" 버튼 클릭
   - ✅ JSON 모드 감지 확인: "🎯 JSON 절차기억 모드"
   - ✅ 순차 생성 진행상황 확인:
     ```
     [Q1] 문제설명 음성 생성 중...
     ✅ Q1 생성 완료
     [B1] 기본지시문1 음성 생성 중...
     ✅ B1 생성 완료
     [E1_1] 보조지시문1-1 음성 생성 중...
     ✅ E1_1 생성 완료
     ...
     ```
   - ✅ DB 저장 완료 메시지

4. **플레이어 접근**
   - URL: `mynote_json_player.php?contentsid=TEST001&contentstype=1`
   - ✅ 페이지 로드 성공
   - ✅ 데이터 로드 확인: "총 N개 음성 파일"

5. **UI 요소 확인**
   - ✅ 레벨 선택 버튼 표시
   - ✅ 모든 오디오 버튼 렌더링
   - ✅ 버튼 타입별 색상/크기 정확성:
     - Q1: 파란색 원형 중간
     - B1, B2...: 주황색 원형 중간
     - E1_1, E1_2...: 회색 원형 작게 (상세 모드에서만)
     - T1: 보라색 둥근사각형
     - K1: 보라색 둥근사각형
     - S1: 보라색 둥근사각형

6. **기본 모드 테스트**
   - ✅ 기본 모드 활성화 (기본값)
   - ✅ Q, B, T, K, S 버튼만 표시
   - ✅ E 버튼 숨김 확인

7. **상세 모드 테스트**
   - "📗 상세 모드" 버튼 클릭
   - ✅ 모드 전환 애니메이션
   - ✅ E 버튼 표시 확인
   - ✅ 버튼 레이아웃 정상

8. **오디오 재생 테스트**
   - Q1 버튼 클릭
   - ✅ "🎵 재생 중: Q1" 표시
   - ✅ 오디오 재생 시작
   - ✅ 버튼에 `pulse` 애니메이션
   - ✅ 음성 내용이 문제설명과 일치

9. **버튼 전환 테스트**
   - Q1 재생 중 B1 클릭
   - ✅ Q1 애니메이션 종료
   - ✅ B1 애니메이션 시작
   - ✅ 오디오 즉시 전환

10. **재생 완료 테스트**
    - 짧은 파일 끝까지 재생
    - ✅ "✅ 재생 완료" 표시
    - ✅ 버튼 애니메이션 종료

**예상 결과**:
- 전체 흐름 정상 동작
- 모든 음성 파일 재생 가능
- UI 인터랙션 부드러움

**실패 조건**:
- JSON 생성 실패
- TTS 생성 중단
- 오디오 파일 로드 실패
- 버튼 클릭 무반응

---

### 시나리오 2: 다양한 JSON 구조 테스트

#### 2-1. 최소 구조 (문제설명 + 구조기억만)
**입력**: 매우 간단한 문제
```
문제: 2+3 = ?
답: 5
```

**검증**:
- ✅ 최소 2개 키 생성 (문제설명, 구조기억)
- ✅ 플레이어에서 2개 버튼만 표시
- ✅ 정상 재생

#### 2-2. 대량 구조 (기본지시문 5개 + 보조 각 3개)
**입력**: 복잡한 증명 문제
```
문제: 피타고라스 정리를 증명하시오.
풀이: [상세한 단계별 증명...]
```

**검증**:
- ✅ 5개 이상의 기본지시문 생성
- ✅ 각 보조지시문 3개씩 생성
- ✅ 총 20개 이상 버튼 렌더링
- ✅ 스크롤 정상 동작
- ✅ 레벨 전환 시 성능 저하 없음

#### 2-3. 불균형 구조 (보조지시문 개수 다름)
**검증**:
- ✅ B1: 3개 보조
- ✅ B2: 1개 보조
- ✅ B3: 보조 없음
- ✅ 그룹화 정확성

---

### 시나리오 3: 에러 처리 테스트

#### 3-1. JSON 파싱 실패 (하위 호환성)
**방법**: 기존 @ 기호 방식 텍스트 입력
```
첫 번째 구간@두 번째 구간@세 번째 구간
```

**검증**:
- ✅ JSON 파싱 실패 감지
- ✅ 기존 @ 방식으로 자동 전환
- ✅ 듣기평가 모드로 처리
- ✅ 정상 음성 생성

#### 3-2. 음성 파일 없음
**방법**: DB에서 임의 contentsid로 플레이어 접근
```
mynote_json_player.php?contentsid=NOTEXIST&contentstype=1
```

**검증**:
- ✅ "📭 데이터 없음" 메시지 표시
- ✅ 나레이션 생성 페이지 링크 제공
- ✅ 에러 없이 정상 렌더링

#### 3-3. 오디오 파일 URL 오류
**방법**: DB에서 URL 수동 변경 (존재하지 않는 파일)

**검증**:
- ✅ 버튼 클릭 시 에러 메시지
- ✅ 콘솔 에러 로그: `[mynote_json_player.php:393] 오디오 재생 오류`
- ✅ 다른 버튼은 정상 동작

---

### 시나리오 4: 사용성 테스트

#### 4-1. 모바일 반응형
**환경**: Chrome DevTools 모바일 시뮬레이션

**검증**:
- ✅ 레이아웃 모바일 최적화
- ✅ 버튼 터치 영역 충분 (최소 44px)
- ✅ 스크롤 부드러움
- ✅ 텍스트 가독성

#### 4-2. 접근성 (Accessibility)
**도구**: Chrome Lighthouse

**검증**:
- ✅ 색상 대비 충분
- ✅ 포커스 표시 명확
- ✅ 키보드 네비게이션 가능
- ✅ ARIA 레이블 (필요 시 추가)

#### 4-3. 성능
**측정**:
- ✅ 페이지 로드 시간 < 2초
- ✅ 버튼 렌더링 시간 < 500ms
- ✅ 레벨 전환 반응 시간 < 100ms
- ✅ 오디오 로딩 시간 < 1초

---

## 🔍 DB 검증 체크리스트

### generate_procedural_narration.php 실행 후
```sql
SELECT * FROM mdl_abrainalignment_gptresults
WHERE type='pmemory' AND contentsid='TEST001'
ORDER BY id DESC LIMIT 1;
```

**확인 사항**:
- ✅ `outputtext` 필드에 JSON 문자열 저장
- ✅ JSON 유효성
- ✅ 모든 키 존재

### openai_tts_pmemory.php 실행 후
```sql
SELECT * FROM mdl_reflections1
WHERE contentsid='TEST001' AND contentstype='1'
ORDER BY id DESC LIMIT 1;
```

**확인 사항**:
- ✅ `audiourls` 필드에 proceduraldata JSON 저장
- ✅ `mode: 'procedural_json'` 확인
- ✅ `files` 배열 존재
- ✅ 각 파일에 `key`, `url`, `text`, `type` 포함

---

## 🐛 알려진 이슈 및 해결 방법

### Issue 1: GPT가 JSON 대신 일반 텍스트 출력
**원인**: 프롬프트 해석 오류
**해결**:
- "중요: 응답은 반드시 순수 JSON 형식으로만 출력하세요" 강조
- 예시 JSON 구조 제공
- temperature 낮추기 (0.5)

### Issue 2: 파일명 규칙 불일치
**원인**: 코드 로직 오류
**해결**:
- `uploadAudioFile()` 함수에서 key 그대로 사용
- 검증 로직 추가

### Issue 3: 보조지시문 그룹화 오류
**원인**: parent-child 매칭 실패
**해결**:
- E 버튼 생성 시 currentGroup 추적
- 정규식으로 인덱스 추출: `/^기본지시문(\d+)$/`

---

## 📊 테스트 결과 기록 템플릿

```markdown
## 테스트 실행 기록

**일시**: YYYY-MM-DD HH:MM
**테스터**: [이름]
**환경**: [브라우저, OS]

### 시나리오 1: 전체 워크플로우
- [ ] 1. 나레이션 생성
- [ ] 2. JSON 검증
- [ ] 3. TTS 생성
- [ ] 4. 플레이어 로드
- [ ] 5-10. UI/재생 테스트

**결과**: PASS / FAIL
**비고**:

### 시나리오 2: 다양한 JSON 구조
- [ ] 2-1. 최소 구조
- [ ] 2-2. 대량 구조
- [ ] 2-3. 불균형 구조

**결과**: PASS / FAIL
**비고**:

### 시나리오 3: 에러 처리
- [ ] 3-1. 하위 호환성
- [ ] 3-2. 데이터 없음
- [ ] 3-3. URL 오류

**결과**: PASS / FAIL
**비고**:

### 발견된 버그
1. [버그 설명]
   - 재현 방법:
   - 우선순위: High/Medium/Low
   - 수정 필요:

2. ...

### 개선 제안
1. [제안 내용]
2. ...
```

---

## ✅ 테스트 통과 기준

### 필수 (Must Have)
- [x] 전체 워크플로우 정상 동작
- [x] 모든 버튼 타입 렌더링 성공
- [x] 오디오 재생 정상
- [x] 레벨 전환 정상
- [x] 에러 핸들링 동작

### 권장 (Should Have)
- [ ] 모바일 반응형 완벽
- [ ] 성능 최적화 (2초 이내 로드)
- [ ] 접근성 점수 90+ (Lighthouse)

### 선택 (Nice to Have)
- [ ] 순차 재생 기능
- [ ] 재생 목록 관리
- [ ] 키보드 단축키

---

**작성일**: 2025-10-23
**버전**: 1.0
**다음 업데이트**: 테스트 실행 후
