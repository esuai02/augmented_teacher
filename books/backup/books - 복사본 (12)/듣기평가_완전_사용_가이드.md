# 🎧 듣기평가 시스템 완전 사용 가이드

## ✅ 모든 수정 완료 항목

### 1. **코드 수정 완료**
- ✅ `openai_tts_pmemory.php`: 듣기평가 모드 구현
  - @ 기호로 대본 분리
  - 각 구간별 TTS 생성 및 서버 업로드
  - DB에 듣기평가 정보 저장 (reflections1 필드)
  - 순차 재생 UI (다음 버튼)
  
- ✅ `file_pmemory.php`: 구간별 파일 업로드 처리
  - section 파라미터 지원
  - 구간별 파일명 생성 (예: `cid30101ct1_section1.wav`)
  
- ✅ `check_status.php`: 듣기평가 정보 DB 저장
  - eventid=52로 reflections1 필드 업데이트
  - 에러 로깅 추가
  
- ✅ `mynotepause.php`: 듣기평가 전용 인터페이스
  - reflections1 필드에서 듣기평가 데이터 읽기
  - 구간별 순차 재생 UI
  - 디버깅 메시지 표시

### 2. **경로 오류 수정**
- ✅ `check_status.php` 경로를 `../check_status.php`로 수정
- ✅ `saveText()` 함수의 경로도 동일하게 수정

---

## 🚀 사용 방법

### 1단계: 듣기평가 음성 생성

**URL 접속:**
```
https://mathking.kr/moodle/local/augmented_teacher/books/openai_tts_pmemory.php?cid=30101&ctype=1
```

**대본 입력 (@ 기호로 구간 분리):**
```
오늘은 피타고라스 정리에 대해 알아보겠습니다. 직각삼각형에서 빗변의 제곱은 두 직각변의 제곱의 합과 같다는 아주 중요한 정리입니다.@이제 예제를 풀어보겠습니다. 직각삼각형의 두 변이 3과 4일 때, 빗변의 길이를 구하세요.@빗변의 제곱은 3의 제곱 더하기 4의 제곱입니다. 9 더하기 16은 25입니다.@따라서 빗변의 길이는 루트 25, 즉 5입니다.
```

**"음성 생성" 버튼 클릭 후 확인할 메시지:**

✅ **정상 작동 시:**
```
🎯 듣기평가 모드: @ 기호로 구간을 분리합니다.
총 4개 구간으로 분리되었습니다.

[구간 1/4] 음성 생성 중...
"오늘은 피타고라스 정리에 대해 알아보겠습니다..."
✅ 구간 1 음성 생성 완료
🔄 구간 1 서버 업로드 중...
✅ 구간 1 업로드 완료!

[구간 2/4] 음성 생성 중...
...

🎉 모든 구간의 음성 생성 및 업로드 완료!
✅ 총 4개 파일이 서버에 업로드되었습니다.
🔄 듣기평가 정보를 DB에 저장 중...
✅ 듣기평가 정보 DB 저장 완료!
→ mynotepause.php 페이지에서 듣기평가 인터페이스를 사용할 수 있습니다.
첫 번째 구간 재생을 시작합니다...
```

❌ **오류 발생 시:**
```
❌ 구간 X 처리 실패: [오류 메시지]
❌ DB 저장 실패: [오류 메시지]
⚠️ 재생은 가능하지만 mynotepause.php에서는 표시되지 않을 수 있습니다.
```
→ 브라우저 콘솔(F12)에서 상세 에러 확인

---

### 2단계: mynotepause.php에서 듣기평가 실행

**URL 접속:**
```
https://mathking.kr/moodle/local/augmented_teacher/books/mynotepause.php?cid=30101&nch=7&cmid=87729&page=6&studentid=2&quizid=
```

**✅ 정상 작동 시 표시:**
```
🔍 디버깅 정보:
reflections1 내용: {"mode":"listening_test","sections":["https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section1.wav",...

[듣기평가 인터페이스]
┌─────────────────────────────────────┐
│ 듣기평가 모드 - 구간 1/4             │
├─────────────────────────────────────┤
│ 🔊 [오디오 자동 재생]                │
│                                     │
│ 📝 현재 구간:                        │
│ "오늘은 피타고라스 정리에 대해..."    │
│                                     │
│ [다음 구간 (2/4)] ← 재생 완료 후 활성화│
└─────────────────────────────────────┘
```

**❌ 오류 발생 시 표시:**
```
❌ reflections1 필드가 비어있습니다
audiourl2: https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_pmemory.wav
듣기평가 데이터가 저장되지 않았습니다. openai_tts_pmemory.php에서 @ 기호로 구분된 대본으로 음성을 생성하세요.
```
→ 1단계를 다시 실행

---

## 🔍 트러블슈팅

### 문제 1: "reflections1 필드가 비어있습니다"
**원인:** 듣기평가 데이터가 DB에 저장되지 않음
**해결:**
1. openai_tts_pmemory.php에서 @ 기호로 구분된 대본 사용 확인
2. "✅ 듣기평가 정보 DB 저장 완료!" 메시지 확인
3. 메시지가 안 보이면 브라우저 콘솔(F12)에서 에러 확인

### 문제 2: "DB 저장 실패" 에러
**원인:** check_status.php 파일 경로 또는 권한 문제
**해결:**
1. 브라우저 콘솔에서 실제 에러 메시지 확인
2. 서버 로그 확인: `/home/moodle/logs/`
3. check_status.php 파일 권한 확인

### 문제 3: 일반 모드로 생성됨 (_pmemory.wav)
**원인:** @ 기호 없이 대본 입력
**해결:**
1. 대본에 반드시 @ 기호로 구간 분리
2. 예: `텍스트1@텍스트2@텍스트3`

### 문제 4: 업로드는 되는데 DB 저장 안됨
**원인:** eventid=52 처리 로직 오류
**해결:**
1. check_status.php 파일 확인
2. 40-70번 줄의 eventid==52 로직 확인
3. 서버 에러 로그 확인

---

## 📊 데이터 흐름

```
사용자 입력 (@ 기호 포함 대본)
    ↓
openai_tts_pmemory.php
    ↓ @ 기호로 분리 (sections 배열)
    ↓
각 구간별 TTS 생성 (OpenAI API)
    ↓
각 구간별 서버 업로드
    ├→ file_pmemory.php (section 파라미터 포함)
    └→ audiofiles/pmemory/cid[X]ct[Y]_section[Z].wav
    ↓
uploadedSectionUrls 배열에 URL 수집
    ↓
듣기평가 정보 JSON 생성
    {
      "mode": "listening_test",
      "sections": [URL1, URL2, ...],
      "text_sections": [텍스트1, 텍스트2, ...]
    }
    ↓
check_status.php (eventid=52)
    ↓
DB 업데이트 (reflections1 필드)
    ├→ mdl_icontent_pages (contentstype=1)
    └→ mdl_question (contentstype=2)
    ↓
mynotepause.php
    ↓ reflections1 필드 읽기
    ↓ mode='listening_test' 확인
    ↓
듣기평가 인터페이스 렌더링
    ├→ 진행 상황 표시
    ├→ 오디오 플레이어 (숨김)
    ├→ 텍스트 표시 (구간별)
    └→ "다음 구간" 버튼
```

---

## 🎯 주요 파일 및 역할

| 파일 | 역할 | 핵심 기능 |
|------|------|-----------|
| `openai_tts_pmemory.php` | 음성 생성 페이지 | @ 분리, TTS 생성, 업로드, DB 저장 |
| `file_pmemory.php` | 파일 업로드 처리 | 구간별 파일 저장, 파일명 생성 |
| `check_status.php` | 범용 이벤트 핸들러 | eventid=52로 reflections1 저장 |
| `mynotepause.php` | 컨텐츠 표시 페이지 | reflections1 읽기, 듣기평가 UI |

---

## 🔐 데이터베이스 스키마

### mdl_icontent_pages (contentstype=1)
```sql
- id: 30101 (contentsid)
- audiourl2: https://.../cid30101ct1_section1.wav (첫 구간 URL)
- reflections1: JSON {
    "mode": "listening_test",
    "sections": ["URL1", "URL2", ...],
    "text_sections": ["텍스트1", "텍스트2", ...]
  }
```

### mdl_question (contentstype=2)
동일한 구조

---

## 💡 개발자 노트

### 왜 reflections1 필드를 사용하나요?
- `reflections0`: 원본 대본 저장
- `reflections1`: 듣기평가 메타데이터 (구간 URL, 텍스트)
- `audiourl2`: 첫 번째 구간 URL (하위 호환성)

### 왜 section 파일과 combined 파일을 모두 생성하나요?
- section 파일: mynotepause.php에서 구간별 재생용
- combined 파일: 일반 플레이어에서 전체 재생용 (현재 미사용)

### 파일명 규칙
- 구간 파일: `cid{contentsid}ct{contentstype}_section{N}.wav`
- 병합 파일: `cid{contentsid}ct{contentstype}_combined.wav`
- 일반 파일: `cid{contentsid}ct{contentstype}_pmemory.wav`

---

## ✨ 마지막 체크리스트

듣기평가 시스템이 정상 작동하려면:

- [ ] @ 기호로 대본을 구분했는가?
- [ ] "✅ 듣기평가 정보 DB 저장 완료!" 메시지가 나왔는가?
- [ ] mynotepause.php에서 디버깅 정보가 노란색 박스로 나타나는가?
- [ ] 듣기평가 인터페이스가 보이는가?
- [ ] 오디오가 자동 재생되는가?
- [ ] "다음 구간" 버튼이 재생 완료 후 활성화되는가?

모든 항목이 체크되면 성공! 🎉

---

**작성일:** 2025-10-13
**버전:** 1.0
**최종 수정:** 경로 오류 수정 완료


