# 나레이션 자동 생성 기능 구현 문서

## 개요
mynote1.php의 목차에서 헤드폰 아이콘을 클릭하면 자동으로 나레이션과 TTS를 생성하는 기능입니다.

## 구현된 파일

### 1. api_config.php (새 파일)
- OpenAI API 키 관리
- TTS 및 GPT 모델 설정
- 오디오 파일 경로 설정
- 보안상 중요한 정보를 별도 파일로 분리

### 2. generate_narration.php (개선)
- 에러 처리 및 로깅 강화
- 메모리 및 실행시간 제한 증가 (256M, 120초)
- API 설정 파일 사용
- 디버그 모드 추가
- 오디오 디렉토리 자동 생성

### 3. mynote1.php (수정)
- 오디오가 없는 콘텐츠에 클릭 가능한 헤드폰 아이콘 추가
- JavaScript로 나레이션 생성 함수 구현
- SweetAlert2를 이용한 사용자 인터랙션
- 생성 완료 후 페이지 자동 새로고침

### 4. test_narration.php (새 파일)
- 나레이션 생성 기능 테스트 도구
- 환경 점검 기능
- 로그 확인 기능

## 사용 방법

1. **헤드폰 아이콘 클릭**
   - 목차에서 오디오가 없는 항목의 🎧 아이콘을 클릭
   - 확인 대화상자에서 '생성' 클릭

2. **자동 처리 과정**
   - 나레이션 텍스트 생성 (GPT-4o-mini)
   - TTS 음성 파일 생성 (OpenAI TTS)
   - 파일 업로드 및 DB 저장
   - 페이지 자동 새로고침

3. **생성된 오디오**
   - audiourl2 필드에 저장 (절차기억 연습하기)
   - 바로 재생 가능

## 나레이션 생성 프롬프트 특징

- 수학 문제 설명에 특화
- 모든 숫자와 기호를 한글로 변환
- 절차기억 형성활동 포함
- 도제학습 스타일의 설명
- 시각적 관찰 지시 포함

## 문제 해결

### HTTP ERROR 500 해결
1. API 키 설정 확인
2. 오디오 디렉토리 권한 확인 (755)
3. PHP 메모리 제한 증가
4. 에러 로그 확인: `/books/narration_error.log`

### 테스트 방법
1. 브라우저에서 `test_narration.php` 접속
2. 환경 점검 확인
3. 콘텐츠 ID 입력 후 테스트 실행

## 주의사항

1. **API 키 보안**
   - api_config.php를 .gitignore에 추가
   - 실제 운영 시 환경변수 사용 권장

2. **리소스 제한**
   - OpenAI API 사용량 모니터링
   - 대량 생성 시 속도 제한 고려

3. **오디오 저장 공간**
   - `/home/moodle/public_html/audiofiles/` 디스크 용량 확인
   - 정기적인 미사용 파일 정리

## 향후 개선사항

1. 음성 선택 옵션 추가
2. 나레이션 재생성 기능
3. 배치 처리 기능
4. 나레이션 편집 기능
5. 다국어 지원

## 작성일
2025년 1월 27일