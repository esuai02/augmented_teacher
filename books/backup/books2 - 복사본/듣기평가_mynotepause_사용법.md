# mynotepause.php 듣기평가 시스템 사용법

## 개요
`mynotepause.php`에 통합된 듣기평가 시스템으로, `@` 기호로 구분된 절차기억 나레이션을 구간별로 재생하는 기능입니다.

## 주요 특징

### 1. 자동 모드 감지
- 절차기억 나레이션 생성 시 `@` 기호가 포함되어 있으면 자동으로 듣기평가 모드로 전환
- `@` 기호가 없으면 기존 방식대로 일반 재생

### 2. 서버 자동 업로드
- 모든 구간별 음성 파일이 자동으로 서버에 업로드
- 경로: `https://mathking.kr/audiofiles/pmemory/sections/`
- 파일명 형식: `cid{contentsid}ct{contentstype}_section{번호}.mp3`

### 3. 맞춤 재생 인터페이스
- 기존 audioPlayer2 위치에 듣기평가 전용 인터페이스 표시
- 진행 상황 표시 (구간 N/M)
- 현재 재생 중인 텍스트 미리보기
- "다음 구간" 버튼

## 사용 방법

### 1단계: 절차기억 나레이션 생성

1. `mynotepause.php`에서 콘텐츠 페이지 열기
2. 🟡 또는 🟢 깃발 아이콘 클릭
3. "절차기억 나레이션 생성" 확인

### 2단계: @ 기호 포함 대본 작성

GPT가 자동으로 절차기억 나레이션을 생성할 때, `@` 기호를 포함하여 구간을 구분합니다.

**예시:**
```
지금 문제의 전체 그림을 먼저 바라보세요. 무엇을 구하라고 했는지 귀로 또렷하게 말해볼까요? 맞아요!@

지금 그림의 오른쪽 위를 보세요. 가장 위에 놓인 정육면체가 보이나요? 맞아요!@

지금 그림의 아래쪽을 보세요. 맨 아래 줄에 정육면체가 세 개가 나란히 붙어 있나요?@
```

### 3단계: 자동 처리

시스템이 자동으로:
1. `@` 기호를 감지
2. 각 구간별로 TTS 생성
3. 모든 구간 파일을 서버에 업로드
4. DB에 구간 정보 저장 (reflections1 필드)
5. 페이지 새로고침

### 4단계: 듣기평가 재생

페이지가 새로고침되면:
1. audioPlayer2 위치에 듣기평가 인터페이스 표시
2. 첫 번째 구간 자동 재생 (자동재생 차단된 경우 수동 클릭 필요)
3. 구간 재생 완료 시 "다음 구간" 버튼 활성화 (녹색)
4. "다음 구간" 버튼 클릭 → 다음 구간 재생
5. 모든 구간 완료 시 "✅ 듣기평가 완료!" 표시

## 인터페이스 설명

### 듣기평가 모드
```
┌─────────────────────────────────┐
│  듣기평가 모드 - 구간 1/5       │
├─────────────────────────────────┤
│ [숨겨진 오디오 플레이어]        │
├─────────────────────────────────┤
│ 구간 1:                         │
│ 지금 문제의 전체 그림을...      │
│ (최대 150자 표시)               │
├─────────────────────────────────┤
│ [다음 구간 (2/5)] 버튼          │
│ - 재생 중: 비활성화 (회색)      │
│ - 재생 완료: 활성화 (녹색)      │
└─────────────────────────────────┘
```

### 일반 모드 (@ 없을 때)
```
┌─────────────────────────────────┐
│ [오디오 플레이어] [속도 슬라이더]│
│ 절차기억 연습하기               │
└─────────────────────────────────┘
```

## 기술적 세부사항

### 데이터 저장 구조

**reflections1 필드 (JSON):**
```json
{
  "mode": "listening_test",
  "sections": [
    "https://mathking.kr/audiofiles/pmemory/sections/cid123ct1_section1.mp3",
    "https://mathking.kr/audiofiles/pmemory/sections/cid123ct1_section2.mp3",
    ...
  ],
  "text_sections": [
    "첫 번째 구간 텍스트...",
    "두 번째 구간 텍스트...",
    ...
  ]
}
```

**audiourl2 필드:**
- 듣기평가 모드: 첫 번째 구간 파일 URL
- 일반 모드: 전체 음성 파일 URL

### 파일 구조

```
/home/moodle/public_html/audiofiles/pmemory/sections/
├── cid123ct1_section1.mp3
├── cid123ct1_section2.mp3
├── cid123ct1_section3.mp3
└── ...
```

## 재생 흐름

1. **첫 구간 자동 재생**
   - 페이지 로드 후 0.5초 뒤 자동 재생 시도
   - 브라우저 정책에 따라 차단될 수 있음

2. **구간 완료 감지**
   - `ended` 이벤트 감지
   - "다음 구간" 버튼 활성화

3. **다음 구간 재생**
   - 버튼 클릭 시 현재 텍스트 숨김
   - 다음 구간 텍스트 표시
   - 다음 오디오 파일 로드 및 재생

4. **마지막 구간 완료**
   - "✅ 듣기평가 완료!" 표시
   - 버튼 숨김

## 주의사항

### 1. 자동재생 차단
- 일부 브라우저는 자동재생을 차단할 수 있습니다
- 사용자가 직접 오디오 플레이어를 클릭해야 할 수 있습니다

### 2. @ 기호 위치
- @ 기호는 구간의 **끝**에 위치해야 합니다
- 앞뒤 공백은 자동으로 제거됩니다

### 3. 구간 개수
- 최소: 1개 (@ 없으면 일반 모드)
- 최대: 제한 없음 (권장: 10개 이하)

### 4. 텍스트 길이
- 각 구간당 권장: 200-500자
- 너무 길면 TTS 생성 시간 증가

## 문제 해결

### Q: "다음 구간" 버튼이 활성화되지 않아요
**A:** 현재 구간의 재생이 완전히 끝날 때까지 기다리세요. 오디오가 끝까지 재생되면 자동으로 활성화됩니다.

### Q: 첫 구간이 자동으로 재생되지 않아요
**A:** 브라우저의 자동재생 차단 정책 때문입니다. 오디오 플레이어를 수동으로 클릭하세요.

### Q: 일반 모드로 돌아가고 싶어요
**A:** 
1. 절차기억 나레이션을 다시 생성할 때 @ 기호를 제거하거나
2. DB의 reflections1 필드를 수동으로 수정

### Q: 음성 파일이 생성되지 않아요
**A:** 
1. OpenAI API 키 확인
2. 서버 디렉토리 권한 확인 (`/home/moodle/public_html/audiofiles/pmemory/sections/`)
3. 브라우저 콘솔에서 에러 로그 확인

## 향후 개선 계획

- [ ] 구간별 재생 속도 조절 기능
- [ ] 이전 구간으로 돌아가기 기능
- [ ] 특정 구간 반복 재생 기능
- [ ] 전체 진행 상황 바 표시
- [ ] 구간별 학생 응답 입력 기능

## 관련 파일

- `mynotepause.php` - 메인 페이지 (듣기평가 인터페이스 포함)
- `generate_dialog_narration.php` - 절차기억 나레이션 생성 + 듣기평가 처리
- `file_pmemory.php` - 음성 파일 업로드 (필요시 참고)

## 버전 정보

- **버전**: 1.0
- **최종 업데이트**: 2025-10-13
- **호환성**: PHP 7.4+, MySQL 5.7+

## 지원

문제가 발생하면 다음을 확인하세요:
1. 브라우저 콘솔 로그
2. 서버 로그: `/home/moodle/logs/pmemory_upload.log`
3. 에러 로그: `books/dialog_narration_error.log`


