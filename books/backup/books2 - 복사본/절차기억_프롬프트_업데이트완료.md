# 🎓 절차기억 나레이션 프롬프트 업데이트 완료!

## 🎯 변경 내용

`generate_dialog_narration.php`의 기본 시스템 프롬프트를 상세하고 구체적인 프롬프트로 전면 교체했습니다.

---

## 📝 새 프롬프트 핵심 특징

### 1. Role (역할)
```
수학 문제와 풀이를 절차기억(procedural memory) 형성용 나레이션으로 변환하는 전문가
한국어로 단계별 풀이를 안내하는 수학 듣기평가 대본 작성
```

### 2. 목적
```
- 계산 등 자세한 내용보다 절차에 대한 구조 강화
- 선생님이 직접 채점하는 상황 가정
```

### 3. 전개 방식 (7단계)

#### ① 문제 내용 정리로 시작
```
탐구를 유도하고 해소작용으로 답을 제시하는 방식
```

#### ② 도제학습 스타일
```
무엇을 생각해야 할지를 궁금하게 만들고, 답을 하며 실행사항을 제시
```

#### ③ 관찰 지시
```
"지금 그림의 오른쪽 위를 보세요"와 같이 구체적 시각 지침 제공
```

#### ④ 구조 중심 설명
```
구체적인 계산 과정은 최소화
풀이의 핵심 흐름과 구조를 간결하면서도 몰입감 있게 설명
```

#### ⑤ 절차기억 형성 단계
```
설명이 끝난 뒤 반드시 '절차기억 형성활동을 시작합니다' 문장으로 전환
```

#### ⑥ 강조 및 요약
```
앞서 설명한 내용을 다시 한 번 강조·요약
유사한 방식으로 더 중요한 사실들을 정리
```

#### ⑦ 자가 학습 유도
```
"이제 문제만 보고 풀 수 있는지 생각해 보세요. 
스스로 머릿속으로 풀어 보세요."로 마무리
```

---

## 📋 Instructions (지시사항)

### 핵심 규칙
1. ✅ 모든 숫자, 기호, 알파벳은 반드시 한글 발음으로 변환
2. ✅ 계산식의 디테일보다는 문제 구조, 조건, 풀이 절차의 흐름을 강조
3. ✅ 관찰 지시 시 구체적 시각 지침 제공
4. ✅ 설명은 단계마다 요약을 포함하여 기억 정착 도움
5. ✅ 절차기억 형성 단계에서 반드시 다시 정리, 중요한 사실 강조, 스스로 풀어보기 유도
6. ✅ **각 단락 끝에 @ 기호 필수**

---

## 🔤 Guidelines (세부 가이드라인)

### 언어 규칙
| 규칙 | 예시 | ❌ 잘못된 예시 | ✅ 올바른 예시 |
|------|------|---------------|---------------|
| 한글만 사용 | 숫자, 기호 금지 | "1, 2, 3" | "일, 이, 삼" |
| 숫자 발음 | 아라비아숫자 | "하나, 둘, 셋" | "일, 이, 삼, 사" |
| 소숫점 | 영점으로 읽기 | "0.35" | "영점삼오" |
| 분수 | 올바른 순서 | "삼의 사분" | "사분의 삼" |
| 출력 형식 | 대본 형식만 | "1. 단계별 설명" | "지금 그림을 보세요..." |
| @ 기호 | 각 단락 끝 | 단락 끝에 없음 | "...써보세요.@" |

---

## 📖 샘플 예시 스타일

프롬프트에 포함된 샘플 예시:

```
지금 문제의 전체 그림을 천천히 훑어보세요. 
무엇을 구하라는지 본문에서 찾아서 한 줄로 직접 써보세요. 
맞아요! 정육면체를 엑스 길이로 오 개 쌓아 만든 입체에서, 
부피를 에이, 겉넓이를 비로 두고, 에이가 이 비 빼기 삼백 이십과 
같을 때의 엑스를 찾는 문제예요. 
그럼 이제, 왜 에이와 비를 엑스로 표현해야 하는지 
이유를 짧게 적어보세요.@

지금 그림의 오른쪽 위를 보세요. 
가장 위에 있는 정육면체 하나를 손가락으로 가리키듯 
마음속으로 표시하고, 정육면체 하나의 부피는 엑스의 세제곱이라고 
공책 위에 글로 적어보세요. 
맞아요! 그럼 이제, 입체 전체의 부피가 왜 정육면체 오 개의 합으로 
자연스럽게 연결되는지, 문장 한 줄로 써보세요.@

절차기억 형성활동을 시작합니다.@

방금의 절차를 다시 써보세요. 
문제 재정리, 부피를 엑스로 표현, 겉넓이를 엑스로 표현, 
조건에 대입하여 엑스만 남기는 방정식 구성, 양수 해 선별. 
맞아요! 이 다섯 제목을 한 줄씩 크게 적고, 
각 줄 옆에 핵심 단서를 짧게 덧붙여 보세요.@

이제 스스로 풀어보기를 유도합니다. 
지금 만든 구조만 보고 본문을 가리지 말고 한 번 더 천천히 읽은 뒤, 
종이를 새로 펴서 동일한 절차를 당신의 문장으로 다시 써보세요. 
마지막 줄에는 이제 문제만 보고 풀 수 있는지 생각해 보세요. 
스스로 머릿속으로 풀어 보세요.라고 직접 적고 
눈을 감고 흐름을 마음속에서 재생해 보세요.@
```

---

## 🔄 Before vs After

### Before (이전 프롬프트)
```
- 간단한 원칙 중심
- 관찰 표현 사용
- 단계별 진행
- @ 기호 삽입 지시
```

### After (새 프롬프트)
```
✅ 7단계 상세 전개 방식
✅ 구체적인 관찰 지시 예시
✅ 도제학습 스타일 명시
✅ 절차기억 형성 단계 명확화
✅ 숫자/기호 한글 변환 규칙 상세화
✅ 샘플 예시 전체 포함
✅ @ 기호 필수 명시
✅ 자가 학습 유도 문구 명시
```

---

## 📊 예상 효과

### 1. 더 일관된 나레이션
```
Before: GPT가 스타일을 임의로 해석
After: 샘플 예시를 따라 일관된 스타일 생성
```

### 2. 정확한 @ 구간 분리
```
Before: @ 기호가 간헐적으로 누락
After: "각 단락 끝에 @ 기호 필수" 명시로 누락 방지
```

### 3. 절차기억 형성 단계 보장
```
Before: 전환 문구가 불명확
After: "절차기억 형성활동을 시작합니다" 명확히 지정
```

### 4. 숫자/기호 변환 정확도
```
Before: 간헐적으로 숫자가 그대로 출력
After: "반드시 한글만 사용", "숫자나 기호 절대 금지" 강조
```

### 5. 관찰 지시 구체화
```
Before: 일반적인 관찰 표현
After: "지금 그림의 오른쪽 위를 보세요" 같은 구체적 지침
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 기본 생성
```
1. mynotepause.php에서 🟡 아이콘 클릭
2. "절차기억 나레이션 생성하시겠습니까?" → "생성"
3. 1-2분 대기 (GPT 처리 중)
4. "생성 완료!" 메시지
5. 페이지 새로고침
6. 중앙 하단에 듣기평가 플레이어 확인
```

### 시나리오 2: 나레이션 품질 확인
```
✅ 모든 숫자가 한글로 표현되었는가?
   예: "1" → "일", "0.5" → "영점오"

✅ @ 기호가 각 단락 끝에 있는가?
   예: "...써보세요.@"

✅ "절차기억 형성활동을 시작합니다" 전환 문구가 있는가?

✅ 마지막에 자가 학습 유도 문구가 있는가?
   "이제 문제만 보고 풀 수 있는지 생각해 보세요..."

✅ 관찰 지시가 구체적인가?
   예: "지금 그림의 오른쪽 위를 보세요"
```

---

## 🔍 디버깅

### 로그 확인
```
파일 위치: 
/home/moodle/public_html/moodle/local/augmented_teacher/books/dialog_narration_error.log

확인 내용:
- "OpenAI API 호출 준비"
- "API 응답 코드: 200"
- "나레이션 텍스트 생성 완료 (길이: XXXX자)"
- "듣기평가 모드 감지됨"
- "총 XX개 구간으로 분리됨"
```

### 생성된 나레이션 확인
```sql
-- DB에서 확인
SELECT reflections0 FROM mdl_icontent_pages WHERE id=30093;

-- 확인 사항:
-- 1. 숫자가 한글로 변환되었는지
-- 2. @ 기호가 각 단락 끝에 있는지
-- 3. "절차기억 형성활동을 시작합니다" 문구가 있는지
-- 4. 관찰 지시가 구체적인지
```

---

## 📁 수정된 파일

### `books/generate_dialog_narration.php`
- **Line 90-134**: 시스템 프롬프트 전면 교체
- **변경 전**: 간단한 원칙 기반 프롬프트 (40줄)
- **변경 후**: 상세한 지시사항 포함 프롬프트 (45줄)

---

## 🎯 핵심 차별점

### 이전 프롬프트
```
"절차기억 형성활동을 시작합니다.

당신은 수학 학습에서 절차기억 형성을 위한 전문 교수자입니다.
...
나레이션 스타일:
- "자, 이 문제를 같이 살펴볼까요?..."
```

### 새 프롬프트
```
# Role: 
당신은 수학 문제와 풀이를 절차기억 형성용 나레이션으로 변환하는 전문가입니다.
입력된 수학문제와 풀이 정보를 분석 후 한국어로 단계별 풀이를 안내하는
수학 듣기평가를 위한 대본을 작성합니다.

# 목적:
계산 등 자세한 내용보다 절차에 대한 구조를 강화시키는 것이 목적입니다.
서술한 내용을 선생님이 직접 채점하는 상황을 가정합니다.

# 전개 방식:
1. **문제 내용 정리로 시작**: 탐구를 유도하고 해소작용으로 답을 제시하는 방식
2. **도제학습 스타일**: 무엇을 생각해야 할지를 궁금하게 만들고, 답을 하며 실행사항을 제시
...

# 샘플 예시 스타일:
"지금 문제의 전체 그림을 천천히 훑어보세요. 
무엇을 구하라는지 본문에서 찾아서 한 줄로 직접 써보세요. 
맞아요! 정육면체를 엑스 길이로 오 개 쌓아 만든 입체에서, 
부피를 에이, 겉넓이를 비로 두고, 에이가 이 비 빼기 삼백 이십과 
같을 때의 엑스를 찾는 문제예요. 
그럼 이제, 왜 에이와 비를 엑스로 표현해야 하는지 
이유를 짧게 적어보세요.@
...
절차기억 형성활동을 시작합니다.@
...
이제 문제만 보고 풀 수 있는지 생각해 보세요. 
스스로 머릿속으로 풀어 보세요.라고 직접 적고 
눈을 감고 흐름을 마음속에서 재생해 보세요.@"

이와 같은 방식과 내용 스타일로 작성하세요.
```

---

## 💡 주요 개선점

### 1. 구조화된 섹션
```
# Role
# 목적
# 전개 방식
# Instructions
# Guidelines
# 샘플 예시 스타일
```
→ GPT가 프롬프트를 더 명확하게 이해

### 2. 상세한 전개 방식 (7단계)
```
1. 문제 내용 정리로 시작
2. 도제학습 스타일
3. 관찰 지시
4. 구조 중심 설명
5. 절차기억 형성 단계
6. 강조 및 요약
7. 자가 학습 유도
```
→ 나레이션의 전체 흐름을 명확히 지정

### 3. 구체적인 샘플 예시
```
전체 샘플 나레이션 포함 (4개 구간)
- 문제 정리 구간
- 관찰 지시 구간
- 절차기억 형성 전환
- 자가 학습 유도
```
→ GPT가 정확한 스타일을 학습

### 4. 명확한 금지 사항
```
- "반드시 한글만 사용 (숫자나 기호 절대 금지)"
- "하나, 둘, 셋 같은 표현은 쓰지 말고"
- "각 단락 끝에 @ 기호 필수"
```
→ 오류 가능성 최소화

---

## 🎉 완성!

이제 `mynotepause.php`에서 🟡 아이콘 클릭 시:

```
원클릭
  ↓
새 프롬프트로 GPT 호출
  ↓
구체적이고 일관된 나레이션 생성
  ↓
자동 @ 구간 분리
  ↓
각 구간별 TTS 생성
  ↓
듣기평가 인터페이스 표시
```

**특징:**
- ✅ 7단계 전개 방식으로 구조화된 나레이션
- ✅ 도제학습 스타일의 몰입감 있는 설명
- ✅ 구체적인 관찰 지시로 시각적 이해 강화
- ✅ "절차기억 형성활동을 시작합니다" 전환 보장
- ✅ 모든 숫자/기호 한글 변환 보장
- ✅ @ 기호로 구간 자동 분리
- ✅ 자가 학습 유도 문구 포함
- ✅ 샘플 예시 기반 일관된 품질

---

**최종 업데이트:** 2025-10-14  
**버전:** 5.0  
**상태:** 완료 ✅

**지금 바로 테스트해 보세요!** 🎓✨

---

## 📌 다음 테스트 시 확인 사항

```
□ 숫자가 모두 한글로 변환되었는가?
□ @ 기호가 각 단락 끝에 있는가?
□ "절차기억 형성활동을 시작합니다" 문구가 있는가?
□ 관찰 지시가 "지금 그림의 ~를 보세요" 형태인가?
□ 도제학습 스타일("맞아요!", "그럼 이제~")이 사용되었는가?
□ 마지막에 자가 학습 유도 문구가 있는가?
□ 구간 개수가 적절한가? (10-15개 권장)
□ 각 구간이 30초-1분 분량인가?
□ 계산 과정보다 절차와 구조에 집중하는가?
□ 듣기평가 플레이어가 중앙 하단에 표시되는가?
```

**Perfect!** 🎯


