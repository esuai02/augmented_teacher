# 수업 엿듣기 자동화 시스템 가이드

## 📋 목차
1. [개요](#개요)
2. [시스템 아키텍처](#시스템-아키텍처)
3. [사용 방법](#사용-방법)
4. [기술 세부사항](#기술-세부사항)
5. [테스트 가이드](#테스트-가이드)
6. [트러블슈팅](#트러블슈팅)

---

## 개요

### 기능 설명
**수업 엿듣기 자동화 시스템**은 수학 콘텐츠를 선생님-학생 대화 형식의 나레이션으로 자동 변환하고, TTS(Text-to-Speech) 음성 파일까지 한 번에 생성하는 통합 시스템입니다.

### 주요 특징
- ✅ **원클릭 자동화**: 헤드폰 아이콘 클릭만으로 나레이션 생성 → TTS 변환 → DB 저장까지 자동 진행
- ✅ **실시간 진행 상태 표시**: 각 단계별 진행 상황을 시각적으로 확인
- ✅ **상세한 에러 처리**: 발생 가능한 모든 에러에 대한 명확한 메시지 제공
- ✅ **재생성 기능**: 기존 콘텐츠 재생성 가능

### 업데이트 날짜
- **최초 작성**: 2025-01-24
- **최종 수정**: 2025-01-24

---

## 시스템 아키텍처

### 파일 구조
```
/mnt/c/1 Project/augmented_teacher/books/
├── mynote2.php                           # 메인 페이지 (UI + JavaScript)
├── generate_classroom_narration.php      # 수업 엿듣기 전용 API (NEW)
├── generate_narration.php                # 절차기억 나레이션 API (기존)
├── api_config.php                        # API 설정 파일
└── 수업엿듣기_자동화_가이드.md           # 본 문서
```

### 데이터베이스 구조

#### 1. `mdl_abrainalignment_gptresults` 테이블
나레이션 텍스트 저장

| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | 기본키 |
| type | varchar | 'conversation' (수업 엿듣기) 또는 'pmemory' (절차기억) |
| contentsid | int | 콘텐츠 ID |
| contentstype | int | 1 (icontent_pages) 또는 2 (question) |
| gid | varchar | '71280' (고정값) |
| outputtext | longtext | 생성된 나레이션 텍스트 |
| timecreated | int | 생성 시각 (timestamp) |
| timemodified | int | 수정 시각 (timestamp) |

#### 2. `mdl_icontent_pages` 테이블
음성 파일 URL 저장

| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | 기본키 (contentsid) |
| audiourl | varchar | 수업 엿듣기 음성 파일 URL (NEW) |
| audiourl2 | varchar | 절차기억 음성 파일 URL (기존) |
| timemodified | int | 수정 시각 (timestamp) |

---

## 사용 방법

### 1. 수업 엿듣기 최초 생성

#### 단계별 진행
1. **mynote2.php 페이지 접속**
   - URL 예시: `https://mathking.kr/moodle/local/augmented_teacher/books/mynote2.php?dmn=120&cid=66&nch=1&cmid=87618&page=1&studentid=2&quizid=`

2. **헤드폰 아이콘 클릭** 🎧
   - 오디오가 없는 콘텐츠의 경우 파란색 헤드폰 아이콘 표시
   - 아이콘 위에 마우스를 올리면 "나레이션 생성" 툴팁 표시

3. **확인 대화상자**
   ```
   제목: 수업 엿듣기 생성
   내용: 이 콘텐츠의 수업 엿듣기 나레이션을 자동으로 생성하시겠습니까?
   버튼: [생성] [취소]
   ```

4. **진행 상태 표시**
   ```
   📝 나레이션 생성 중...
   🎤 TTS 생성 대기 중...
   💾 저장 대기 중...
   ```

   각 단계가 완료되면 ✓ 표시로 변경

5. **완료 메시지**
   ```
   제목: 생성 완료!
   내용: 수업 엿듣기 컨텐츠가 성공적으로 생성되었습니다.
         페이지를 새로고침합니다...
   ```

6. **자동 새로고침**
   - 2초 후 자동으로 페이지 새로고침
   - 헤드폰 아이콘이 일반 아이콘으로 변경됨

### 2. 수업 엿듣기 재생성

#### 재생성이 필요한 경우
- 나레이션 내용을 수정하고 싶을 때
- 음성 품질을 개선하고 싶을 때
- 프롬프트가 업데이트되어 재생성이 필요할 때

#### 단계별 진행
1. **헤드폰 아이콘 클릭** 🎧
   - 오디오가 있는 콘텐츠의 경우 일반 헤드폰 아이콘 표시
   - 툴팁: "수업 엿듣기 재생성"

2. **재생성 확인 대화상자**
   ```
   제목: 수업 엿듣기 재생성
   내용: 수업 엿듣기 컨텐츠를 새로 생성하시겠습니까?
   버튼: [재생성] [취소]
   ```

3. **진행 상태 표시** (최초 생성과 동일)

4. **완료 및 새로고침**

---

## 기술 세부사항

### 1. 프롬프트 시스템

#### 시스템 프롬프트 (System Prompt)
```
Role: act as a mathematics content narrator specialized in converting written math content into engaging, clear, and accurate narration scripts for video content.

핵심 규칙:
1. 모든 숫자는 한글로 변환 (1 → 일, 2 → 이)
2. 선생님-학생 대화 형식
3. 콜론(:)은 "선생님:" "학생:" 뒤에만 사용
4. 목록 형식 금지, 대화식으로만 진행
5. 소주제별 완결성 있는 설명
```

#### 사용자 프롬프트 (User Prompt)
```
작은 의미단위로 완결성있게 설명 후 요약.
그리고 준비하는 시간을 가지고 준비가 되면 다음 소주제로 넘어 가는 방식으로
잘게 잘게 쪼개서 진행해줘.

제목: [콘텐츠 제목]
내용: [콘텐츠 본문]
```

### 2. API 흐름도

```
[사용자 클릭]
    ↓
[JavaScript: generateClassroomNarration()]
    ↓
[AJAX POST: generate_classroom_narration.php]
    ↓
┌─────────────────────────────────────┐
│ Step 1: 나레이션 생성                │
│ - OpenAI GPT-4o API 호출            │
│ - 대화식 나레이션 텍스트 생성        │
│ - DB 저장 (abrainalignment_gptresults)│
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Step 2: TTS 생성                    │
│ - OpenAI TTS API 호출               │
│ - MP3 파일 생성                     │
│ - 파일 저장 (/audiofiles/)          │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Step 3: DB 업데이트                 │
│ - icontent_pages.audiourl 업데이트  │
│ - 파일 경로 저장                    │
└─────────────────────────────────────┘
    ↓
[성공 응답 → 페이지 새로고침]
```

### 3. 에러 처리 시스템

#### 에러 타입별 처리

| HTTP 코드 | 에러 타입 | 사용자 메시지 | 복구 방법 |
|-----------|----------|--------------|----------|
| 401 | API 키 오류 | "API 키가 유효하지 않습니다. 관리자에게 문의하세요." | api_config.php 확인 |
| 429 | 사용량 초과 | "API 사용량 한도를 초과했습니다. 잠시 후 다시 시도해주세요." | 5분 대기 후 재시도 |
| 500 | 서버 오류 | "OpenAI 서버 오류입니다. 잠시 후 다시 시도해주세요." | 10분 대기 후 재시도 |
| 404 | 파일 없음 | "서버 파일을 찾을 수 없습니다." | 파일 경로 확인 |
| 0 | 타임아웃 | "요청 시간이 초과되었습니다. (3분)" | 네트워크 확인 |

#### 로깅 시스템

**로그 파일 위치**:
- PHP 에러 로그: `/mnt/c/1 Project/augmented_teacher/books/classroom_narration_error.log`
- 브라우저 콘솔: Chrome DevTools → Console 탭

**로그 메시지 형식**:
```
[파일: generate_classroom_narration.php, 라인: 123] 메시지 내용
```

### 4. 성능 최적화

#### 타임아웃 설정
- **PHP 실행 시간**: 180초 (3분)
- **AJAX 타임아웃**: 180초 (3분)
- **API 타임아웃**:
  - GPT API: 60초
  - TTS API: 90초

#### 메모리 설정
- **PHP 메모리 제한**: 512MB
- **예상 사용량**:
  - 나레이션 생성: ~50MB
  - TTS 생성: ~200MB

---

## 테스트 가이드

### 테스트 환경
- **서버**: https://mathking.kr/moodle/
- **브라우저**: Chrome 최신 버전 권장
- **권한**: 로그인 필요 (교사 또는 관리자 권한)

### 테스트 시나리오

#### 1. 정상 작동 테스트 (Happy Path)

**준비사항**:
- audiourl이 NULL인 콘텐츠 선택
- OpenAI API 키 유효성 확인
- 네트워크 연결 확인

**실행 단계**:
```
1. mynote2.php 페이지 접속
2. 파란색 헤드폰 아이콘 확인
3. 헤드폰 아이콘 클릭
4. "생성" 버튼 클릭
5. 진행 상태 관찰:
   - "나레이션 생성 중..." 표시 확인
   - "TTS 음성 생성 중..." 표시 확인
   - "데이터베이스 저장 중..." 표시 확인
6. 완료 메시지 확인
7. 페이지 자동 새로고침 확인
8. 헤드폰 아이콘 변경 확인
```

**예상 소요시간**: 1-2분

**검증 포인트**:
- [ ] 나레이션 텍스트 생성 확인 (DB 확인)
  ```sql
  SELECT outputtext FROM mdl_abrainalignment_gptresults
  WHERE type='conversation' AND contentsid=[ID]
  ORDER BY id DESC LIMIT 1;
  ```
- [ ] 음성 파일 생성 확인
  ```bash
  ls -lh /home/moodle/public_html/audiofiles/cid[ID]ct1_classroom.mp3
  ```
- [ ] DB audiourl 업데이트 확인
  ```sql
  SELECT audiourl FROM mdl_icontent_pages WHERE id=[ID];
  ```

#### 2. 재생성 테스트

**준비사항**:
- audiourl이 이미 존재하는 콘텐츠 선택

**실행 단계**:
```
1. mynote2.php 페이지 접속
2. 일반 헤드폰 아이콘 확인
3. 헤드폰 아이콘 클릭
4. "재생성" 버튼 클릭
5. 진행 상태 관찰
6. 완료 확인
```

**검증 포인트**:
- [ ] 기존 파일이 덮어쓰기 되는지 확인
- [ ] timemodified 필드 업데이트 확인

#### 3. 에러 처리 테스트

##### 3-1. API 키 오류 테스트
```php
// api_config.php에서 임시로 잘못된 API 키 설정
define('OPENAI_API_KEY', 'invalid-key-test');
```

**예상 결과**:
```
제목: API 키 오류
내용: OpenAI API 키가 유효하지 않습니다.
```

##### 3-2. 타임아웃 테스트
```javascript
// mynote2.php에서 임시로 타임아웃 설정
timeout: 1000, // 1초로 변경
```

**예상 결과**:
```
제목: 요청 시간이 초과되었습니다.
내용: 서버 응답이 3분 이내에 완료되지 않았습니다.
```

##### 3-3. 네트워크 오류 테스트
- 개발자 도구 → Network 탭 → Offline 체크

**예상 결과**:
```
제목: 나레이션 생성 중 오류가 발생했습니다.
내용: (네트워크 관련 메시지)
```

#### 4. UI 반응성 테스트

**테스트 항목**:
- [ ] 진행 중 다른 페이지로 이동 시도 → 차단되는지 확인
- [ ] 진행 중 브라우저 새로고침 → 작업 중단 확인
- [ ] 모바일 화면에서 정상 표시 확인
- [ ] 다크모드에서 정상 표시 확인

#### 5. 성능 테스트

**측정 항목**:
```
- 나레이션 생성 시간: ___ 초
- TTS 생성 시간: ___ 초
- DB 저장 시간: ___ 초
- 총 소요 시간: ___ 초
- 생성된 파일 크기: ___ MB
```

**성능 기준**:
- 총 소요 시간: 2분 이내
- 파일 크기: 5MB 이내

### 브라우저 콘솔 확인

**정상 로그 예시**:
```javascript
[파일: mynote2.php, 함수: generateClassroomNarration] 시작 - contentsid: 123, isRegenerate: false
[파일: mynote2.php, 함수: generateClassroomNarration] API 응답: {success: true, step: "completed", ...}
[파일: mynote2.php, 함수: generateClassroomNarration] 페이지 새로고침
```

---

## 트러블슈팅

### 문제 1: 헤드폰 아이콘이 보이지 않음

**증상**:
- mynote2.php 페이지에 헤드폰 아이콘이 표시되지 않음

**원인**:
1. audiourl이 이미 존재함
2. JavaScript 로딩 실패
3. 권한 문제 (학생 계정)

**해결 방법**:
```sql
-- DB 확인
SELECT id, title, audiourl, audiourl2
FROM mdl_icontent_pages
WHERE id = [콘텐츠ID];

-- audiourl이 있으면 NULL로 설정하여 테스트
UPDATE mdl_icontent_pages
SET audiourl = NULL
WHERE id = [콘텐츠ID];
```

### 문제 2: "서버 파일을 찾을 수 없습니다" 에러

**증상**:
- 404 에러 발생
- 에러 메시지: "generate_classroom_narration.php 파일이 존재하는지 확인하세요."

**원인**:
- API 파일이 없거나 경로가 잘못됨

**해결 방법**:
```bash
# 파일 존재 확인
ls -la /mnt/c/1\ Project/augmented_teacher/books/generate_classroom_narration.php

# 파일 권한 확인
chmod 644 /mnt/c/1\ Project/augmented_teacher/books/generate_classroom_narration.php
```

### 문제 3: "API 키가 유효하지 않습니다" 에러

**증상**:
- 401 에러 발생
- OpenAI API 호출 실패

**원인**:
- API 키가 만료되었거나 잘못됨

**해결 방법**:
```php
// api_config.php 파일 확인
cat /mnt/c/1\ Project/augmented_teacher/books/api_config.php

// API 키 업데이트
// 1. https://platform.openai.com/api-keys 에서 새 키 발급
// 2. api_config.php 파일에서 OPENAI_API_KEY 값 교체
```

### 문제 4: 타임아웃 발생

**증상**:
- "요청 시간이 초과되었습니다" 에러
- 3분 이상 대기 후 실패

**원인**:
1. 콘텐츠가 너무 길어서 처리 시간 초과
2. OpenAI API 응답 지연
3. 서버 리소스 부족

**해결 방법**:
```php
// generate_classroom_narration.php 파일 수정
set_time_limit(300); // 5분으로 연장
ini_set('memory_limit', '1024M'); // 메모리 증가
```

```javascript
// mynote2.php 파일 수정
timeout: 300000, // 5분으로 연장
```

### 문제 5: 진행 상태가 업데이트되지 않음

**증상**:
- 로딩 스피너만 계속 돌아감
- 진행 상태 텍스트가 변경되지 않음

**원인**:
- API 응답에 `step` 필드가 없음
- JavaScript 함수 오류

**해결 방법**:
```javascript
// 브라우저 콘솔에서 확인
console.log(response);

// response.step 값 확인
// 없으면 API 파일에서 step 응답 추가 필요
```

### 문제 6: 음성 파일이 재생되지 않음

**증상**:
- audiourl은 정상적으로 저장됨
- 음성 플레이어에서 재생 불가

**원인**:
1. 파일 권한 문제
2. 파일 경로 오류
3. MP3 파일 손상

**해결 방법**:
```bash
# 파일 권한 확인 및 수정
chmod 644 /home/moodle/public_html/audiofiles/cid*_classroom.mp3

# 파일 무결성 확인
file /home/moodle/public_html/audiofiles/cid123ct1_classroom.mp3

# 브라우저에서 직접 접근 테스트
# https://mathking.kr/audiofiles/cid123ct1_classroom.mp3
```

### 문제 7: DB 저장 실패

**증상**:
- 나레이션과 TTS는 생성되었으나 DB 저장 실패
- 에러 메시지: "오디오 URL 데이터베이스 저장 실패"

**원인**:
- DB 연결 오류
- 권한 문제
- 필드 타입 불일치

**해결 방법**:
```sql
-- DB 연결 확인
SELECT 1;

-- 테이블 구조 확인
DESCRIBE mdl_icontent_pages;

-- audiourl 필드 확인
SHOW FIELDS FROM mdl_icontent_pages LIKE 'audiourl';

-- 수동 업데이트 테스트
UPDATE mdl_icontent_pages
SET audiourl = 'https://mathking.kr/audiofiles/test.mp3'
WHERE id = [콘텐츠ID];
```

---

## 추가 정보

### 관련 파일
- **메인 페이지**: `/mnt/c/1 Project/augmented_teacher/books/mynote2.php`
- **API 파일**: `/mnt/c/1 Project/augmented_teacher/books/generate_classroom_narration.php`
- **설정 파일**: `/mnt/c/1 Project/augmented_teacher/books/api_config.php`
- **음성 파일 저장 경로**: `/home/moodle/public_html/audiofiles/`

### DB 테이블
- **mdl_abrainalignment_gptresults**: 나레이션 텍스트 저장
- **mdl_icontent_pages**: 음성 파일 URL 저장

### API 사용량
- **GPT-4o**: 요청당 ~$0.03 예상 (콘텐츠 길이에 따라 변동)
- **TTS**: 요청당 ~$0.015 예상 (텍스트 길이에 따라 변동)

### 향후 개선 사항
1. 실시간 진행률 표시 (Server-Sent Events 사용)
2. 배치 생성 기능 (여러 콘텐츠 한번에 처리)
3. 음성 미리듣기 기능
4. 나레이션 편집 기능
5. 다양한 음성 선택 옵션

---

## 문의 및 지원

### 개발자 정보
- **작성자**: Claude Code (Anthropic)
- **작성일**: 2025-01-24

### 이슈 보고
문제가 발생하거나 개선 사항이 있으면 다음 정보와 함께 보고해주세요:
1. 발생한 에러 메시지 (전체 내용)
2. 브라우저 콘솔 로그
3. PHP 에러 로그 (`classroom_narration_error.log`)
4. 재현 단계
5. 사용 환경 (브라우저, OS 등)

---

**마지막 업데이트**: 2025-01-24
