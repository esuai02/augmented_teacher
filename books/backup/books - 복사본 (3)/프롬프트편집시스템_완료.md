# 🎓 프롬프트 편집 및 TTS 재생성 시스템 - 구현 완료!

## ✅ 완성된 기능

### 1. **듣기평가 플레이어에 연필 아이콘 추가**
- 위치: 우측 하단 플로팅 플레이어 헤더 (🎧 구간 1/12 옆)
- 표시 조건: `$role !== 'student'` (선생님/관리자만)
- 클릭 시: `improveprompt.php` 새 탭에서 열림
- 스타일: 작은 연필 아이콘 ✏️

### 2. **프롬프트 편집 UI (improveprompt.php)**
- 깔끔한 그라디언트 디자인
- 두 개의 주요 섹션:
  - **GPT 프롬프트 편집**: 나레이션 생성 방식 정의
  - **TTS 대본 편집**: 현재 생성된 대본 수정
- 버튼:
  - 💾 프롬프트 저장
  - 🔄 기본값으로 복원
  - ⚡ 다시 생성 (GPT 재구성 + TTS)

### 3. **DB 테이블 (mdl_gptprompts)**
- 사용자별 커스텀 프롬프트 저장
- 필드:
  - `userid`: 사용자 ID
  - `type`: 프롬프트 유형 (pmemory)
  - `prompttext`: 프롬프트 내용
  - `timecreated`: 생성 시간
  - `timemodified`: 수정 시간

### 4. **커스텀 프롬프트 적용**
- `generate_procedural_narration.php`에서 자동 적용
- 사용자가 저장한 프롬프트 우선 사용
- 없으면 기본 프롬프트 사용

### 5. **GPT 재구성 기능**
- 수정된 대본을 GPT로 재구성
- 저장된 커스텀 프롬프트 적용
- DB에 자동 저장
- TTS 생성 페이지로 자동 연결

---

## 📁 생성된 파일

### 신규 파일 (4개)

#### 1. `books/create_gptprompts_table.php`
- DB 테이블 생성 스크립트
- 최초 1회 실행 필요

#### 2. `books/improveprompt.php`
- 프롬프트 및 대본 편집 UI
- 파라미터: `?cid={contentsid}&ctype={contentstype}`
- 권한 체크: role !== 'student'

#### 3. `books/save_prompt.php`
- 프롬프트 저장 API
- POST: `promptText`
- JSON 응답

#### 4. `books/regenerate_with_gpt.php`
- GPT 재구성 및 DB 저장 API
- POST: `scriptText`, `contentsid`, `contentstype`
- JSON 응답 (narration 포함)

### 수정된 파일 (2개)

#### 1. `books/mynotepause.php` (Line 476)
```php
🎧 구간 1/'.$sectionCount.'
'.($role !== 'student' ? '<a href="improveprompt.php?cid='.$contentsid.'&ctype='.$contentstype.'" target="_blank" ...>✏️</a>' : '').'
```

#### 2. `books/generate_procedural_narration.php` (Line 20-69)
```php
// 사용자 커스텀 프롬프트 확인
$customPrompt = $DB->get_record_sql(...);

// 커스텀 프롬프트가 있으면 사용, 없으면 기본 프롬프트 사용
$systemPrompt = ($customPrompt && !empty($customPrompt->prompttext)) 
    ? $customPrompt->prompttext 
    : $defaultPrompt;
```

---

## 🚀 사용 방법

### 1단계: DB 테이블 생성 (최초 1회)
```
https://mathking.kr/moodle/local/augmented_teacher/books/create_gptprompts_table.php
```
→ 접속하여 테이블 생성 확인

### 2단계: 듣기평가 페이지에서 연필 아이콘 클릭
```
https://mathking.kr/moodle/local/augmented_teacher/books/mynotepause.php?cid=59&...
```
→ 플로팅 플레이어 헤더에서 ✏️ 클릭

### 3단계: 프롬프트 편집
1. **GPT 프롬프트 수정** (선택사항)
   - 나레이션 생성 방식 변경
   - "💾 프롬프트 저장" 클릭
   
2. **TTS 대본 수정**
   - 현재 대본 직접 수정
   - "⚡ 다시 생성" 클릭
   - GPT가 재구성 → DB 저장
   - TTS 생성 페이지 열림

### 4단계: TTS 생성
- `openai_tts_pmemory.php`에서 "🎵 음성 생성" 클릭
- 자동으로 듣기평가 모드 구간 생성

---

## 🎯 작동 흐름

### A. 프롬프트 저장 흐름
```
improveprompt.php
  ↓ (프롬프트 수정)
  ↓ "저장" 버튼 클릭
  ↓
save_prompt.php
  ↓
mdl_gptprompts 테이블에 저장
  ↓
✅ 완료!
```

### B. GPT 재구성 흐름
```
improveprompt.php
  ↓ (대본 수정)
  ↓ "다시 생성" 버튼 클릭
  ↓
regenerate_with_gpt.php
  ↓ (커스텀 프롬프트 로드)
  ↓ GPT API 호출 (재구성)
  ↓
mdl_abrainalignment_gptresults 테이블에 저장
  ↓
improveprompt.php에 새 대본 표시
  ↓
openai_tts_pmemory.php 열기 (새 탭)
  ↓
✅ TTS 생성!
```

### C. 커스텀 프롬프트 자동 적용
```
openai_tts_pmemory.php
  ↓ "🎓 절차기억 나레이션 생성" 버튼 클릭
  ↓
generate_procedural_narration.php
  ↓
mdl_gptprompts에서 커스텀 프롬프트 확인
  ↓ (있으면 사용, 없으면 기본 프롬프트)
  ↓
GPT API 호출
  ↓
✅ 나레이션 생성!
```

---

## 💻 화면 예시

### 듣기평가 플레이어 (연필 아이콘)
```
┌─────────────────────────────┐
│ 🎧 구간 1/12 ✏️       [ − ] │ ← 연필 아이콘 클릭!
├─────────────────────────────┤
│ [오디오 플레이어]            │
│ ...                          │
└─────────────────────────────┘
```

### improveprompt.php
```
🎓 프롬프트 및 대본 편집
────────────────────────────────────

💡 사용 방법
1. GPT 프롬프트를 수정하여 나레이션 생성 방식 변경
2. TTS 대본을 직접 수정하고 "다시 생성" 클릭
3. 수정된 프롬프트는 이후 자동 적용

────────────────────────────────────

📝 1. GPT 프롬프트
┌──────────────────────────────┐
│ # Role: act as a mathematics │
│ content narrator...          │
│                              │
│ (프롬프트 내용)               │
└──────────────────────────────┘

[💾 프롬프트 저장] [🔄 기본값으로 복원]

────────────────────────────────────

🎤 2. TTS 대본
┌──────────────────────────────┐
│ 지금 문제의 전체 그림을...    │
│ @ 지금 그림의 오른쪽 위를...  │
│                              │
│ (대본 내용)                  │
└──────────────────────────────┘

[⚡ 다시 생성 (GPT 재구성 + TTS)]
```

---

## 🔧 기술 세부사항

### API 엔드포인트

#### save_prompt.php
```php
POST /books/save_prompt.php
Body: promptText={text}

Response:
{
  "success": true,
  "action": "updated", // or "created"
  "message": "프롬프트가 저장되었습니다."
}
```

#### regenerate_with_gpt.php
```php
POST /books/regenerate_with_gpt.php
Body: 
  scriptText={text}
  contentsid={id}
  contentstype={type}

Response:
{
  "success": true,
  "narration": "재구성된 대본...",
  "sectionCount": 12,
  "message": "GPT 재구성 완료! (총 12개 구간)"
}
```

### 데이터베이스 스키마

#### mdl_gptprompts
```sql
CREATE TABLE mdl_gptprompts (
    id BIGINT(10) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    userid BIGINT(10) NOT NULL,
    type VARCHAR(50) NOT NULL,
    prompttext LONGTEXT,
    timecreated BIGINT(10) NOT NULL,
    timemodified BIGINT(10) NOT NULL,
    INDEX idx_user_type (userid, type)
);
```

### 프롬프트 우선순위
```
1. mdl_gptprompts 테이블 (사용자 커스텀)
   ↓ 없으면
2. 기본 프롬프트 (generate_procedural_narration.php 내장)
```

---

## 🎨 UI 디자인 특징

### improveprompt.php
- **그라디언트 배경**: #667eea → #764ba2
- **섹션 구분**: 명확한 1, 2 섹션
- **상태 메시지**: 성공/오류/정보 색상 구분
- **반응형**: 모바일/태블릿 대응
- **로딩 애니메이션**: 처리 중 표시

### 색상 팔레트
```
Primary: #667eea (보라)
Success: #28a745 (초록)
Danger: #dc3545 (빨강)
Info: #0c5460 (청록)
Background: linear-gradient(#667eea, #764ba2)
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 프롬프트 수정
```
1. mynotepause.php 접속 (선생님 계정)
2. ✏️ 아이콘 클릭
3. improveprompt.php 열림
4. "GPT 프롬프트" 텍스트 수정
5. "💾 프롬프트 저장" 클릭
6. ✅ "프롬프트가 저장되었습니다." 확인
7. openai_tts_pmemory.php로 이동
8. "🎓 절차기억 나레이션 생성" 클릭
9. 수정된 프롬프트로 생성 확인
```

### 시나리오 2: 대본 재구성
```
1. improveprompt.php 접속
2. "TTS 대본" 텍스트 수정
3. "⚡ 다시 생성" 클릭
4. GPT 재구성 대기...
5. ✅ "GPT 재구성 완료! (총 12개 구간)" 확인
6. 새 대본이 textarea에 표시됨
7. 확인 다이얼로그: "TTS 생성 페이지를 여시겠습니까?"
8. "확인" 클릭
9. openai_tts_pmemory.php 새 탭 열림
10. "🎵 음성 생성" 클릭하여 TTS 생성
```

### 시나리오 3: 기본값 복원
```
1. improveprompt.php 접속
2. "🔄 기본값으로 복원" 클릭
3. 확인 다이얼로그: "프롬프트를 기본값으로 복원하시겠습니까?"
4. "확인" 클릭
5. 기본 프롬프트로 textarea 내용 변경
6. "💾 프롬프트 저장" 클릭
7. ✅ 저장 완료
```

---

## 🐛 트러블슈팅

### 문제 1: ✏️ 아이콘이 보이지 않음
**원인:** 
- `$role === 'student'`로 로그인
- 듣기평가 모드가 아님 (reflections1 데이터 없음)

**해결:**
- 선생님/관리자 계정으로 로그인
- 듣기평가 모드 컨텐츠에서만 표시됨

### 문제 2: "테이블이 존재하지 않습니다" 오류
**원인:** mdl_gptprompts 테이블 미생성

**해결:**
```
https://.../books/create_gptprompts_table.php
```
접속하여 테이블 생성

### 문제 3: 프롬프트가 적용되지 않음
**원인:** 
- 프롬프트 저장 후 캐시
- DB 연결 오류

**해결:**
1. improveprompt.php에서 "💾 프롬프트 저장" 재클릭
2. 브라우저 새로고침
3. DB 연결 확인 (error_log 체크)

### 문제 4: GPT 재구성 실패
**원인:**
- API 키 만료
- 네트워크 오류
- 대본이 너무 긺 (max_tokens 초과)

**해결:**
1. regenerate_with_gpt.php에서 API 키 확인
2. 네트워크 연결 확인
3. 대본 분량 줄이기 또는 max_tokens 증가

---

## 📊 데이터 흐름

### 프롬프트 데이터
```
사용자 입력 (improveprompt.php)
  ↓
save_prompt.php
  ↓
mdl_gptprompts 테이블
  ↓
generate_procedural_narration.php (읽기)
  ↓
GPT API (system prompt로 사용)
  ↓
나레이션 생성
```

### 대본 데이터
```
원본 문제/풀이
  ↓
generate_procedural_narration.php (GPT 처리)
  ↓
mdl_abrainalignment_gptresults 테이블
  ↓
improveprompt.php (표시)
  ↓
사용자 수정
  ↓
regenerate_with_gpt.php (GPT 재처리)
  ↓
mdl_abrainalignment_gptresults 테이블 (업데이트)
  ↓
openai_tts_pmemory.php (TTS 생성)
```

---

## 🎓 활용 시나리오

### 시나리오 A: 선생님이 나레이션 스타일 변경
```
"학생들이 더 친근한 말투를 선호한다"
  ↓
improveprompt.php에서 프롬프트 수정:
"존댓말 대신 반말 사용"
"~해요 대신 ~해 형태"
  ↓
저장 후 이후 모든 나레이션에 자동 적용
```

### 시나리오 B: 특정 컨텐츠 대본 미세 조정
```
"구간 3의 설명이 너무 길다"
  ↓
improveprompt.php에서 해당 구간 대본 축약
  ↓
"⚡ 다시 생성" 클릭
  ↓
GPT가 전체 흐름 유지하며 재구성
  ↓
새 TTS 생성
```

### 시나리오 C: 다른 과목 적용
```
수학 → 과학 나레이션으로 변경
  ↓
프롬프트에서 "수학" → "과학 실험" 변경
"계산 과정" → "실험 절차"
  ↓
저장 후 과학 컨텐츠에 적용
```

---

## 🚀 향후 확장 가능성

### 1. 다중 프롬프트 프리셋
```sql
ALTER TABLE mdl_gptprompts ADD COLUMN preset_name VARCHAR(100);
```
- "친근한 말투"
- "엄격한 말투"
- "유머러스한 말투"
등 프리셋 관리

### 2. 프롬프트 버전 관리
```sql
ALTER TABLE mdl_gptprompts ADD COLUMN version INT;
```
- 이전 버전으로 롤백
- 버전별 비교

### 3. 프롬프트 공유
```sql
ALTER TABLE mdl_gptprompts ADD COLUMN is_public TINYINT;
ALTER TABLE mdl_gptprompts ADD COLUMN shared_by BIGINT;
```
- 다른 선생님과 프롬프트 공유
- 우수 프롬프트 라이브러리

### 4. A/B 테스트
- 두 가지 프롬프트로 생성
- 학생 반응 비교
- 더 효과적인 프롬프트 자동 선택

---

## 📝 체크리스트

### 초기 설정
- [ ] `create_gptprompts_table.php` 실행하여 테이블 생성
- [ ] 선생님/관리자 계정으로 로그인
- [ ] 듣기평가 컨텐츠 접속하여 ✏️ 아이콘 확인

### 기능 테스트
- [ ] 프롬프트 저장 기능 확인
- [ ] 기본값 복원 기능 확인
- [ ] GPT 재구성 기능 확인
- [ ] TTS 생성 페이지 자동 열림 확인
- [ ] 커스텀 프롬프트 자동 적용 확인

### 권한 테스트
- [ ] 학생 계정에서 ✏️ 아이콘 미표시 확인
- [ ] 학생이 improveprompt.php 직접 접속 시 권한 오류 확인

### 통합 테스트
- [ ] 전체 워크플로우 (편집 → 저장 → 재생성 → TTS 생성) 확인
- [ ] 여러 컨텐츠에서 독립적으로 작동 확인

---

## 🎉 완성 요약

| 기능 | 상태 | 비고 |
|------|------|------|
| DB 테이블 생성 | ✅ | mdl_gptprompts |
| 연필 아이콘 추가 | ✅ | role !== student만 표시 |
| 프롬프트 편집 UI | ✅ | improveprompt.php |
| 프롬프트 저장 API | ✅ | save_prompt.php |
| GPT 재구성 API | ✅ | regenerate_with_gpt.php |
| 커스텀 프롬프트 적용 | ✅ | generate_procedural_narration.php |
| 권한 체크 | ✅ | 모든 파일 |
| 에러 처리 | ✅ | try-catch, JSON 응답 |
| UI/UX | ✅ | 그라디언트, 반응형 |

---

**최종 업데이트:** 2025-10-14  
**버전:** 1.0  
**상태:** 구현 완료 및 배포 준비 완료 ✅

**완성!** 이제 선생님들이 듣기평가 나레이션의 프롬프트와 대본을 자유롭게 편집하고 재생성할 수 있습니다! 🎓✨


