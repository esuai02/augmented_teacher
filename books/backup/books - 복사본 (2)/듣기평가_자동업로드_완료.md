# 듣기평가 자동 업로드 시스템 완료

## 업데이트 날짜
2025-10-13

## 문제 해결
❌ **기존 문제**: `openai_tts_pmemory.php`에서 듣기평가 모드 사용 시 각 구간 파일이 서버에 업로드되지 않음

✅ **해결 완료**: 각 구간별 파일 + 전체 병합 파일 모두 자동 업로드

## 주요 변경사항

### 1. `openai_tts_pmemory.php` 수정

#### 각 구간별 자동 업로드 추가 (라인 691-764)

```javascript
// 서버에 업로드된 구간 파일 URL 저장
let uploadedSectionUrls = [];

// 각 구간별로 TTS 생성 및 서버 업로드
for (let i = 0; i < sections.length; i++) {
    const sectionText = sections[i].trim();
    const sectionNum = i + 1;
    
    // 1. TTS 생성
    const audioBuffer = await generateEnhancedSpeech(sectionText, "alloy", false);
    
    // 2. WAV로 변환
    const audioData = audioBufferToWav(audioBuffer);
    const audioBlob = new Blob([audioData], { type: 'audio/wav' });
    
    // 3. 파일명 생성 (구간 번호 포함)
    const fileName = `tts_${contentsid}_${contentstype}_section${sectionNum}.wav`;
    
    // 4. FormData 생성 (section 번호 포함)
    const formData = new FormData();
    formData.append('audio', audioFile);
    formData.append('contentsid', contentsid);
    formData.append('contentstype', contentstype);
    formData.append('section', sectionNum); // ← 구간 번호
    
    // 5. 서버 업로드 (Promise로 대기)
    await new Promise((resolve, reject) => {
        $.ajax({
            url: "../LLM/file_pmemory.php",
            ...
        });
    });
}
```

#### 업로드 진행 상황 표시
- ✅ 구간 N 음성 생성 완료
- 🔄 구간 N 서버 업로드 중...
- ✅ 구간 N 업로드 완료!

#### 전체 병합 파일 업로드 (라인 461-520)
```javascript
const uploadCombinedAudio = (audioBuffer) => {
    // 1. 병합 파일 생성
    const audioBlob = new Blob([audioData], { type: 'audio/wav' });
    
    // 2. FormData 생성 (section 없음 = DB 업데이트)
    formData.append('audio', audioFile);
    formData.append('contentsid', contentsid);
    formData.append('contentstype', contentstype);
    // section 파라미터 없음!
    
    // 3. 서버 업로드
    $.ajax({
        url: "../LLM/file_pmemory.php",
        ...
    });
};
```

### 2. `file_pmemory.php` 수정

#### 구간 번호 처리 (라인 10)
```php
$section = isset($_POST['section']) ? $_POST['section'] : null;
```

#### 파일명 생성 로직 (라인 46-52)
```php
// 구간 번호가 있으면 파일명에 포함 (듣기평가 모드)
if($section !== null && $section !== '') {
    $actual_audio_name = 'cid'.$contentsid.'ct'.$contentstype.'_section'.$section.'.'.$ext;
} else {
    $actual_audio_name = 'cid'.$contentsid.'ct'.$contentstype.'_pmemory.'.$ext;
}
```

#### DB 업데이트 로직 (라인 92-113)
```php
// 구간별 파일은 DB 업데이트 하지 않음
// 마지막 전체 병합 파일만 DB 업데이트
if($section === null || $section === '') {
    // DB 업데이트 (audiourl2 필드)
    $DB->execute("UPDATE {icontent_pages} SET audiourl2=? WHERE id=?", 
        array($audiourl, $contentsid));
} else {
    // 구간 파일은 URL만 반환 (DB 업데이트 안 함)
    $data['audiourl'] = $audiourl;
}
```

## 파일 저장 구조

### 서버 경로
```
/home/moodle/public_html/Contents/audiofiles/pmemory/
├── cid30101ct1_section1.wav     ← 구간 1
├── cid30101ct1_section2.wav     ← 구간 2
├── cid30101ct1_section3.wav     ← 구간 3
├── cid30101ct1_section4.wav     ← 구간 4
├── cid30101ct1_section5.wav     ← 구간 5
└── cid30101ct1_pmemory.wav      ← 전체 병합 파일 (DB 저장)
```

### URL 구조
```
https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section1.wav
https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section2.wav
https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section3.wav
...
https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_pmemory.wav  ← DB 저장
```

## 동작 흐름

### 1. 음성 생성 버튼 클릭
```
사용자가 "음성 생성" 버튼 클릭
↓
@ 기호 감지
↓
듣기평가 모드 활성화
```

### 2. 각 구간 처리 (순차적)
```
구간 1:
├─ TTS 생성
├─ WAV 변환
├─ 서버 업로드 (section=1)
└─ ✅ 완료

구간 2:
├─ TTS 생성
├─ WAV 변환
├─ 서버 업로드 (section=2)
└─ ✅ 완료

... (반복)
```

### 3. 전체 병합 및 최종 업로드
```
모든 구간 완료
↓
오디오 버퍼 병합
↓
서버 업로드 (section 없음)
↓
DB 업데이트 (audiourl2)
↓
🎉 완료!
```

## UI 메시지 흐름

```
🎯 듣기평가 모드: @ 기호로 구간을 분리합니다.
총 5개 구간으로 분리되었습니다.

[구간 1/5] 음성 생성 중...
"지금 문제의 전체 그림을 먼저 바라보세요..."
✅ 구간 1 음성 생성 완료
🔄 구간 1 서버 업로드 중...
✅ 구간 1 업로드 완료!

[구간 2/5] 음성 생성 중...
"지금 그림의 오른쪽 위를 보세요..."
✅ 구간 2 음성 생성 완료
🔄 구간 2 서버 업로드 중...
✅ 구간 2 업로드 완료!

... (반복)

🎉 모든 구간의 음성 생성 및 업로드 완료!
✅ 총 5개 파일이 서버에 업로드되었습니다.
첫 번째 구간 재생을 시작합니다...

🔄 전체 병합 파일을 서버에 업로드 중...
✅ 전체 병합 파일 업로드 완료!
DB 업데이트됨: https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_pmemory.wav
```

## 업로드 확인 방법

### 1. 브라우저 콘솔
```javascript
console.log('업로드된 구간 파일 URLs:', uploadedSectionUrls);
```

출력 예시:
```javascript
[
  "https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section1.wav",
  "https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section2.wav",
  "https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section3.wav",
  "https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section4.wav",
  "https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section5.wav"
]
```

### 2. 서버 로그
```bash
tail -f /home/moodle/logs/pmemory_upload.log
```

로그 예시:
```
[2025-10-13 14:30:15] [info] User:123 CID:30101 CT:1 - Upload request received
[2025-10-13 14:30:15] [info] User:123 CID:30101 CT:1 - File info - Name: tts_30101_1_section1.wav, Size: 45678 bytes
[2025-10-13 14:30:15] [info] User:123 CID:30101 CT:1 - Attempting to save file as: cid30101ct1_section1.wav
[2025-10-13 14:30:15] [success] User:123 CID:30101 CT:1 - File uploaded successfully: cid30101ct1_section1.wav
[2025-10-13 14:30:15] [info] User:123 CID:30101 CT:1 - Section file uploaded (no DB update): https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_section1.wav
```

### 3. 서버 파일 확인
```bash
ls -lh /home/moodle/public_html/Contents/audiofiles/pmemory/ | grep "cid30101ct1"
```

출력 예시:
```
-rw-r--r-- 1 www-data www-data  45K Oct 13 14:30 cid30101ct1_section1.wav
-rw-r--r-- 1 www-data www-data  52K Oct 13 14:30 cid30101ct1_section2.wav
-rw-r--r-- 1 www-data www-data  48K Oct 13 14:30 cid30101ct1_section3.wav
-rw-r--r-- 1 www-data www-data  51K Oct 13 14:30 cid30101ct1_section4.wav
-rw-r--r-- 1 www-data www-data  49K Oct 13 14:30 cid30101ct1_section5.wav
-rw-r--r-- 1 www-data www-data 245K Oct 13 14:31 cid30101ct1_pmemory.wav
```

### 4. DB 확인
```sql
SELECT id, title, audiourl2 
FROM mdl_icontent_pages 
WHERE id = 30101;
```

결과:
```
id    | title     | audiourl2
------|-----------|--------------------------------------------------
30101 | 정육면체  | https://mathking.kr/Contents/audiofiles/pmemory/cid30101ct1_pmemory.wav
```

## 테스트 시나리오

### 정상 동작 확인
1. ✅ 각 구간별 파일 서버 업로드
2. ✅ 구간별 파일명에 section 번호 포함
3. ✅ 전체 병합 파일 서버 업로드
4. ✅ 병합 파일만 DB 업데이트
5. ✅ UI에 업로드 진행 상황 표시
6. ✅ 콘솔에 URL 배열 출력

### 예외 처리 확인
1. ✅ 업로드 실패 시 에러 메시지 표시
2. ✅ 응답 파싱 오류 시 에러 메시지 표시
3. ✅ 중간 구간 실패 시 전체 프로세스 중단

## 성능 개선

### 순차 업로드
- 각 구간을 **순차적으로** 처리
- 하나의 구간이 완료된 후 다음 구간 시작
- 서버 부하 분산

### Promise 기반 대기
```javascript
await new Promise((resolve, reject) => {
    $.ajax({
        ...
        success: resolve,
        error: reject
    });
});
```

## 주의사항

### 1. 파일명 충돌 방지
- 구간 파일: `_section{N}` 접미사
- 병합 파일: `_pmemory` 접미사
- 동일 콘텐츠 재생성 시 기존 파일 덮어쓰기

### 2. DB 업데이트
- ❌ 구간 파일: DB 업데이트 안 함
- ✅ 병합 파일: DB 업데이트 (audiourl2)

### 3. 네트워크 고려
- 구간이 많을수록 업로드 시간 증가
- 권장: 5-10개 구간 이내

## 문제 해결

### Q: 특정 구간만 업로드 실패
**A:** 
- 브라우저 콘솔에서 에러 확인
- 서버 로그 확인
- 해당 구간 텍스트 길이 확인 (너무 길면 TTS 실패 가능)

### Q: 병합 파일이 DB에 저장 안 됨
**A:**
- `section` 파라미터가 없는지 확인
- DB 권한 확인
- 에러 로그 확인

### Q: 파일이 서버에 없음
**A:**
```bash
# 디렉토리 권한 확인
ls -ld /home/moodle/public_html/Contents/audiofiles/pmemory/

# 필요시 권한 수정
chmod 755 /home/moodle/public_html/Contents/audiofiles/pmemory/
```

## 다음 단계

mynotepause.php에서도 동일하게 동작하도록 통합되어 있습니다:
- ✅ `generate_dialog_narration.php`에서 자동 업로드
- ✅ `mynotepause.php`에서 듣기평가 인터페이스 자동 표시

## 관련 파일

1. **수정된 파일**
   - `books/openai_tts_pmemory.php` (라인 691-764, 461-520)
   - `LLM/file_pmemory.php` (라인 10, 46-52, 92-113)

2. **참고 문서**
   - `books/듣기평가_사용법.md`
   - `books/듣기평가_mynotepause_사용법.md`
   - `books/듣기평가_통합_완료.md`

---
**작성자**: Claude AI Assistant  
**날짜**: 2025-10-13  
**버전**: 2.0 (자동 업로드 추가)


